<!DOCTYPE html>
<html lang="tr">
<head>
  <!-- TEST: Otomatik deploy kapatÄ±ldÄ± mÄ±? - 21 KasÄ±m 2025 -->
  <meta charset="UTF-8" />
  <title>PaylaÅŸÄ±m Takvimi</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    :root {
      --calendar-shell-height: auto;
    }
    html, body {
      min-height: 100%;
      height: auto;
      overflow-y: auto;
      margin: 0;
    }
    body {
      font-family: 'Open Sans', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      color: #111827;
      font-size: 14px;
    }
    h1, h2, h3, label { font-weight: 700; }

.header {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  min-height: 48px;
  padding: 8px 0;
  margin-bottom: 12px;
  gap: 16px;
}
    .header-left {
      justify-self: start;
    }
    .header-left h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    .header-center {
      justify-self: center;
    }
    .logo-link {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .logo-link:hover {
      opacity: 0.8;
    }
.header-right {
  justify-self: end;
  display: flex;
  align-items: center;
  gap: 10px;
}
.header-right button {
  padding: 5px 10px;
  font-size: 12px;
}
    .logo { height: 32px; }

    /* Responsive: kÃ¼Ã§Ã¼k ekranlarda logo gizle */
    @media (max-width: 768px) {
      .header {
        grid-template-columns: auto 1fr;
      }
      .header-center {
        display: none;
      }
    }
    .login-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(17, 24, 39, 0.65);
      z-index: 1500;
      padding: 16px;
    }
    .login-overlay.active { display: flex; }
    .login-card {
      width: min(340px, 96vw);
      background: #ffffff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .login-card h2 {
      margin: 0;
      font-size: 18px;
      text-align: center;
    }
    .login-card form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .login-card .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
    }
    .login-card input {
      padding: 7px 9px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
    }
    .login-card button {
      width: 100%;
      justify-content: center;
      padding: 6px 10px;
      font-size: 13px;
    }
    .login-card .secondary-btn {
      background: #e2e8f0;
      color: #111827;
    }
    .login-card .secondary-btn:hover {
      background: #d1d5db;
    }
    .login-card-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: center;
    }
    #loginError {
      min-height: 16px;
      color: #dc2626;
      font-size: 12px;
    }
    #loginError.success {
      color: #16a34a;
    }
    body.dark .login-card {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .login-card input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .login-card .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .login-card .secondary-btn:hover {
      background: #2c3a52;
    }
    #appRoot {
      width: 100%;
      max-width: none; /* GeniÅŸ ekranlarda sÄ±nÄ±rsÄ±z geniÅŸlik */
      margin: 0;
      padding: 10px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 100vh;
    }

    /* GeniÅŸ ekranlarda padding artÄ±r */
    @media (min-width: 1440px) {
      #appRoot {
        padding: 10px 32px 16px;
      }
    }

    /* Orta ekranlarda eski davranÄ±ÅŸÄ± koru */
    @media (max-width: 1280px) {
      #appRoot {
        max-width: 1240px;
        margin: 0 auto;
        padding: 10px 14px 16px;
      }
    }

#viewCalendar {
  width: 100%;
  display: block;
}
    #viewReports {
      display: block;
    }
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1400;
    }
    .admin-overlay.active { display: flex; }
    .admin-panel {
      width: min(680px, 96vw);
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.26);
    }
    .admin-panel-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 8px;
      margin-bottom: -4px;
      flex-wrap: wrap;
    }
    .admin-tab-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 9999px;
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .admin-tab-btn.active {
      background: #0f172a;
      color: #ffffff;
    }
    .admin-tab-view {
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .admin-tab-view.active {
      display: flex;
    }
    .color-description-scroll {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 6px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
    }
    .admin-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .admin-panel-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }
    .admin-panel-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .admin-close-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 8px;
    }
    .admin-user-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
    }
    .admin-user-row {
      display: grid;
      grid-template-columns: 1.6fr 0.9fr 0.9fr auto;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .admin-user-row .role-select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }
    .admin-section {
      border-top: 1px solid #e2e8f0;
      padding-top: 16px;
      margin-top: 8px;
    }
    .admin-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .color-description-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
      align-items: center;
    }
    .color-description-row:last-child {
      border-bottom: none;
    }
    .pending-count-badge {
      font-weight: 600;
      color: #9a3412;
      margin-left: 4px;
    }
.pending-count-badge.has-pending {
  color: #b91c1c;
}
.notification-wrapper {
  position: relative;
  display: inline-flex;
  align-items: center;
}
.notification-bell {
  border: 1px solid #d1d5db;
  background: #ffffff;
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  min-width: 42px;
}
.notification-bell .notification-icon {
  font-size: 16px;
  line-height: 1;
}
.notification-badge {
  position: absolute;
  top: -4px;
  right: -2px;
  display: none;
  min-width: 16px;
  height: 16px;
  border-radius: 999px;
  background: #ef4444;
  color: #ffffff;
  font-size: 10px;
  font-weight: 700;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}
.notification-panel {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  width: 340px;
  max-height: 450px;
  background: #ffffff;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 16px;
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
  padding: 14px;
  display: none;
  flex-direction: column;
  z-index: 60;
}
.notification-panel.open {
  display: flex;
}
.notification-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
  font-size: 14px;
  color: #0f172a;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #f1f5f9;
}
.notification-mark-all-read {
  font-size: 12px;
  font-weight: 500;
  color: #3b82f6;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background 0.15s ease;
}
.notification-mark-all-read:hover {
  background: #eff6ff;
}
.notification-clear-all {
  font-size: 12px;
  font-weight: 500;
  color: #ef4444;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background 0.15s ease;
  margin-left: 4px;
}
.notification-clear-all:hover {
  background: #fef2f2;
}
.notification-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  overflow-y: auto;
  max-height: 360px;
  flex: 1 1 auto;
  min-height: 0;
}
.notification-item {
  width: 100%;
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid transparent;
  background: #ffffff;
  cursor: pointer;
  text-align: left;
  font-family: inherit;
  transition: all 0.15s ease;
}
.notification-item:hover {
  background: #f8fafc;
  border-color: #e5e7eb;
}
.notification-item.unread {
  background: #f0f7ff;
}
.notification-item.unread:hover {
  background: #e0f2fe;
  border-color: #bfdbfe;
}
.notification-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  flex-shrink: 0;
  margin-top: 5px;
}
.notification-content {
  flex: 1;
  min-width: 0;
}
.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 4px;
}
.notification-item-title {
  font-size: 13px;
  font-weight: 700;
  color: #0f172a;
  line-height: 1.3;
  flex: 1;
}
.notification-timestamp {
  font-size: 11px;
  color: #94a3b8;
  white-space: nowrap;
  flex-shrink: 0;
}
.notification-item-body {
  font-size: 12px;
  color: #64748b;
  line-height: 1.4;
}
.notification-empty {
  text-align: center;
  font-size: 12px;
  color: #94a3b8;
  margin: 20px 0;
}
    .color-description-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.15);
    }
    .color-description-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .color-description-fields input,
    .color-description-fields textarea {
      font-size: 12px;
      padding: 6px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
    }
    .color-description-fields textarea {
      resize: vertical;
      min-height: 48px;
    }
    .color-description-actions {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-user-row > div:first-child {
      word-break: break-all;
    }
    .admin-user-row.selected {
      border-color: #3b82f6;
      background: #e0f2fe;
    }
    .admin-user-row.actions {
      justify-content: flex-end;
    }
    .admin-user-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e2e8f0;
      color: #1f2937;
    }
    .badge.success {
      background: #dcfce7;
      color: #166534;
    }
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    .badge.info {
      background: #dbeafe;
      color: #1d4ed8;
    }
    body.dark .admin-panel {
      background: #0f172a;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .admin-user-row {
      background: #111827;
      border-color: #1f2937;
    }
    body.dark .admin-user-row.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.2);
    }
    body.dark .admin-close-btn {
      color: #f9fafb;
    }
    body.dark .badge {
      background: #1e293b;
      color: #f9fafb;
    }
    body.dark .badge.success {
      background: rgba(22, 101, 52, 0.2);
      color: #bbf7d0;
    }
    body.dark .badge.warning {
      background: rgba(146, 64, 14, 0.2);
      color: #fde68a;
    }
    body.dark .badge.info {
      background: rgba(37, 99, 235, 0.2);
      color: #bfdbfe;
    }

    body.blurred {
      backdrop-filter: blur(6px);
    }
    body.blurred #appRoot {
      filter: blur(6px);
      pointer-events: none;
      user-select: none;
    }
    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1600;
      pointer-events: none;
    }
    .toast-message {
      min-width: 220px;
      max-width: 320px;
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.2);
      opacity: 0;
      transform: translateY(12px);
      animation: toast-in 0.2s ease forwards, toast-out 0.3s ease forwards 1.3s;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      to { opacity: 0; transform: translateY(12px); }
    }

    /* Sekmeler */
.tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
    #adminViewInfo {
      margin: -8px 0 16px 0;
      color: #1d4ed8;
      font-weight: 600;
    }
    body.dark #adminViewInfo {
      color: #93c5fd;
    }
.tab-button {
  cursor: pointer;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  padding: 5px 12px;
  background: #f3f4f6;
  font-size: 12px;
}
    .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }

.container {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 340px;
  gap: 12px;
  align-items: stretch;
  width: 100%;
}
/* Takvim + saÄŸ panel hizasÄ± (3 kolonlu: Takvim | GÃ¼n DetayÄ± | GÃ¶rev Panosu) */
.container.calendar-layout {
  display: grid;
  grid-template-columns: 1.7fr 0.65fr 1.65fr; /* Takvim daraltÄ±ldÄ±, GÃ¶revler geniÅŸletildi */
  gap: 24px;
  align-items: flex-start;
  width: 100%;
  min-height: 0;
  justify-content: flex-start;
}

/* Ã‡ok geniÅŸ ekranlarda (1920px+) maximum geniÅŸlik sÄ±nÄ±rÄ± */
@media (min-width: 1920px) {
  .container.calendar-layout {
    max-width: 1800px;
    margin: 0; /* Sola dayalÄ± */
  }
}

/* GeniÅŸ ekranlar (1440px - 1919px) */
@media (min-width: 1440px) and (max-width: 1919px) {
  .container.calendar-layout {
    grid-template-columns: 1.7fr 0.65fr 1.65fr; /* Takvim daraltÄ±ldÄ±, GÃ¶revler geniÅŸletildi */
  }
}

/* Orta ekranlar - 2 kolon (1024px - 1439px) */
@media (max-width: 1439px) {
  .container.calendar-layout {
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
    gap: 20px;
  }
  .task-board-panel {
    display: none !important;
  }
}

/* KÃ¼Ã§Ã¼k ekranlar - tek kolon */
@media (max-width: 900px) {
  .container.calendar-layout {
    grid-template-columns: 1fr;
    gap: 16px;
  }
}
.calendar-shell {
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 8px;
  border-radius: 12px;
  background: #f9faff;
  border: 1px solid #dde2ff;
}
.calendar {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.calendar-grid-wrapper {
  flex: 0 0 auto;
  display: block;
  overflow: visible;
}
.calendar-grid-wrapper .days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-auto-rows: 104px;
  gap: 3px;
  width: 100%;
}
.channel-filter {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
  font-size: 12px;
  color: #475569;
}
.assignee-filter {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  font-size: 12px;
  color: #475569;
}
.assignee-filter-label {
  font-weight: 600;
}
.assignee-filter-toggle {
  display: inline-flex;
  gap: 4px;
  background: #f1f5f9;
  border-radius: 999px;
  padding: 3px;
}
.assignee-filter-btn {
  border: none;
  background: transparent;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  color: #475569;
  cursor: pointer;
  transition: background 0.15s ease, color 0.15s ease;
}
.assignee-filter-btn.active {
  background: #0f172a;
  color: #ffffff;
}
.channel-filter-btn {
  font-size: 11px;
  padding: 3px 9px;
  border-radius: 999px;
  border: 1px solid #d5dbf5;
  background: #ffffff;
  color: #1f2937;
}
.channel-filter-btn.active {
  background: #1d4ed8;
  border-color: #1e40af;
  color: #ffffff;
  box-shadow: 0 6px 16px rgba(30, 64, 175, 0.25);
}
    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 4px 0;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #c4d0ff;
      padding: 4px 10px;
      background: #f2f5ff;
      font-size: 12px;
      font-weight: 600;
      color: #152052;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease,
        box-shadow 0.12s ease;
    }
    button:hover { background: #e4ebff; }
    .secondary-btn {
      background: #e2e8f0;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .secondary-btn:hover {
      background: #d1d5db;
    }
    .primary-btn {
      background: #2563eb;
      border-color: #1d4ed8;
      color: #ffffff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }
    .primary-btn:hover {
      background: #1d4ed8;
    }
    .month-nav-btn {
      min-width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      border-radius: 8px;
      background: #ffffff;
      border-color: #c4d0ff;
      color: #1a275a;
      padding: 0;
    }
    .month-nav-btn:hover {
      background: #dde5ff;
    }
    .month-nav-btn {
      min-width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border-radius: 10px;
      background: #ffffff;
      border-color: #c4d0ff;
      color: #1a275a;
    }
    .month-nav-btn:hover {
      background: #dde5ff;
    }
    .danger-btn {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .danger-btn:hover {
      background: #fecaca;
    }
    #themeToggleBtn {
      font-size: 11px;
      padding-inline: 10px;
    }
    .month-label {
      font-weight: 700;
      font-size: 17px;
      color: #152052;
    }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
.calendar-grid-wrapper .days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-auto-rows: 104px;
  gap: 3px;
  width: 100%;
}
    .weekday {
      text-align: center;
      font-weight: 700;
      font-size: 10px;
      padding: 2px 0;
      background: #f0f3ff;
      border-radius: 6px;
      color: #1a275a;
    }
    .day {
      --day-surface: #ffffff;
      --day-text: #0f172a;
      --day-border: #e1e5ff;
      --day-chip-bg: rgba(15, 23, 42, 0.06);
      --day-chip-color: #0f172a;
      --day-chip-border: transparent;
      --day-highlight-shadow: rgba(15, 23, 42, 0.08);
      border-radius: 7px;
      border: 1px solid var(--day-border);
      padding: 3px;
      height: 100%;
      font-size: 11px;
      cursor: pointer;
      background: var(--day-surface);
      color: var(--day-text);
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .day:hover {
      border-color: #3b5bdb;
      box-shadow: 0 0 0 1px rgba(59, 91, 219, 0.12);
      background: #f4f6ff;
    }
    .day.today .day-number-inner {
      background: #ef4444;
      color: #ffffff;
      border-radius: 9999px;
      padding: 2px 6px;
      display: inline-block;
      box-sizing: border-box;
    }
    .day.filtered-out {
      opacity: 0.35;
    }
    .day-number {
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 2px;
      color: var(--day-text);
    }
.day-counter {
      font-size: 9px;
      font-weight: 600;
      color: #6b21a8;
      margin-bottom: 1px;
    }
    .day.day-highlighted {
      background: var(--day-surface, #ffffff);
      border-color: var(--day-border, #e1e5ff);
      box-shadow: 0 12px 28px var(--day-highlight-shadow, rgba(15, 23, 42, 0.12));
    }
    .day-summary {
      font-size: 10px;
      color: #33415c;
    }
    .day-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding-right: 2px;
      overflow: hidden;
    }
    .day-summary + .day-summary { margin-top: 2px; }
    .day-summary.excel {
      color: #0369a1;
    }
    .day-summary-chip {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 1px 5px; /* Padding azaltÄ±ldÄ± (7px â†’ 5px) - Daralan takvim iÃ§in */
      margin-top: 1px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 8.5px; /* Font boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ (9px â†’ 8.5px) - Daralan takvim iÃ§in */
      color: #0f172a;
      font-weight: 600;
      /* Metin taÅŸmasÄ±nÄ± Ã¶nle */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .day[data-color] .day-summary {
      color: var(--day-text);
    }
    .day[data-color="blue"] {
      --day-surface: #dbeafe;
      --day-border: #93c5fd;
      --day-text: #1e3a8a;
      --day-chip-bg: #c7d2fe;
      --day-chip-color: #1e3a8a;
      --day-chip-border: rgba(30, 64, 175, 0.45);
      --day-highlight-shadow: rgba(37, 99, 235, 0.35);
    }
    .day[data-color="red"] {
      --day-surface: #fee2e2;
      --day-border: #fca5a5;
      --day-text: #7f1d1d;
      --day-chip-bg: #fecaca;
      --day-chip-color: #7f1d1d;
      --day-chip-border: rgba(127, 29, 29, 0.4);
      --day-highlight-shadow: rgba(239, 68, 68, 0.32);
    }
    .day[data-color="green"] {
      --day-surface: #d1fae5;
      --day-border: #6ee7b7;
      --day-text: #065f46;
      --day-chip-bg: #a7f3d0;
      --day-chip-color: #065f46;
      --day-chip-border: rgba(6, 95, 70, 0.35);
      --day-highlight-shadow: rgba(34, 197, 94, 0.3);
    }
    .day[data-color="yellow"] {
      --day-surface: #fef9c3;
      --day-border: #fde68a;
      --day-text: #92400e;
      --day-chip-bg: #fde68a;
      --day-chip-color: #92400e;
      --day-chip-border: rgba(146, 64, 14, 0.35);
      --day-highlight-shadow: rgba(250, 204, 21, 0.32);
    }
    .day[data-color="purple"] {
      --day-surface: #ede9fe;
      --day-border: #c4b5fd;
      --day-text: #4c1d95;
      --day-chip-bg: #ddd6fe;
      --day-chip-color: #4c1d95;
      --day-chip-border: rgba(76, 29, 149, 0.35);
      --day-highlight-shadow: rgba(124, 58, 237, 0.32);
    }
    .day[data-color="orange"] {
      --day-surface: #ffedd5;
      --day-border: #fdba74;
      --day-text: #9a3412;
      --day-chip-bg: #fed7aa;
      --day-chip-color: #9a3412;
      --day-chip-border: rgba(154, 52, 18, 0.35);
      --day-highlight-shadow: rgba(249, 115, 22, 0.32);
    }
    .day[data-color="white"] {
      --day-surface: #f8fafc;
      --day-border: #e5e7eb;
      --day-text: #1f2937;
      --day-chip-bg: #e2e8f0;
      --day-chip-color: #1f2937;
      --day-chip-border: rgba(107, 114, 128, 0.35);
      --day-highlight-shadow: rgba(15, 23, 42, 0.15);
    }
.schedule-item.summary[data-color] .schedule-summary-header {
  color: var(--summary-text);
}
    .schedule-item.summary[data-color="blue"] {
      --summary-border: #2563eb;
      --summary-surface: #eef2ff;
      --summary-text: #1d4ed8;
      --summary-chip-bg: #dbeafe;
      --summary-chip-color: #1d4ed8;
      --summary-chip-border: #bfdbfe;
      --summary-shadow: rgba(37, 99, 235, 0.2);
    }
    .schedule-item.summary[data-color="red"] {
      --summary-border: #ef4444;
      --summary-surface: #fef2f2;
      --summary-text: #b91c1c;
      --summary-chip-bg: #fee2e2;
      --summary-chip-color: #b91c1c;
      --summary-chip-border: #fecaca;
      --summary-shadow: rgba(239, 68, 68, 0.2);
    }
    .schedule-item.summary[data-color="green"] {
      --summary-border: #22c55e;
      --summary-surface: #ecfdf5;
      --summary-text: #047857;
      --summary-chip-bg: #d1fae5;
      --summary-chip-color: #047857;
      --summary-chip-border: #a7f3d0;
      --summary-shadow: rgba(34, 197, 94, 0.2);
    }
    .schedule-item.summary[data-color="yellow"] {
      --summary-border: #facc15;
      --summary-surface: #fffbeb;
      --summary-text: #92400e;
      --summary-chip-bg: #fef3c7;
      --summary-chip-color: #92400e;
      --summary-chip-border: #fde68a;
      --summary-shadow: rgba(250, 204, 21, 0.2);
    }
    .schedule-item.summary[data-color="purple"] {
      --summary-border: #7c3aed;
      --summary-surface: #f5f3ff;
      --summary-text: #5b21b6;
      --summary-chip-bg: #ede9fe;
      --summary-chip-color: #5b21b6;
      --summary-chip-border: #ddd6fe;
      --summary-shadow: rgba(124, 58, 237, 0.2);
    }
    .schedule-item.summary[data-color="orange"] {
      --summary-border: #f97316;
      --summary-surface: #fff7ed;
      --summary-text: #9a3412;
      --summary-chip-bg: #ffedd5;
      --summary-chip-color: #9a3412;
      --summary-chip-border: #fed7aa;
      --summary-shadow: rgba(249, 115, 22, 0.2);
    }
    .schedule-item.summary[data-color="white"] {
      --summary-border: #e5e7eb;
      --summary-surface: #ffffff;
      --summary-text: #1f2937;
      --summary-chip-bg: #f3f4f6;
      --summary-chip-color: #1f2937;
      --summary-chip-border: #e5e7eb;
      --summary-shadow: rgba(15, 23, 42, 0.08);
    }

    .color-blue {
      --summary-card-color: #2563eb;
      --daily-card-color: #2563eb;
    }
    .color-red {
      --summary-card-color: #ef4444;
      --daily-card-color: #ef4444;
    }
    .color-green {
      --summary-card-color: #22c55e;
      --daily-card-color: #22c55e;
    }
    .color-yellow {
      --summary-card-color: #facc15;
      --daily-card-color: #facc15;
    }
    .color-purple {
      --summary-card-color: #7c3aed;
      --daily-card-color: #7c3aed;
    }
    .color-orange {
      --summary-card-color: #f97316;
      --daily-card-color: #f97316;
    }
    .color-white {
      --summary-card-color: #94a3b8;
      --daily-card-color: #94a3b8;
    }

.side {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.summary-shell {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-width: none; /* GeniÅŸ ekranlarda sÄ±nÄ±rsÄ±z */
  width: 100%;
}

/* Orta ekranlarda max-width sÄ±nÄ±rÄ± */
@media (max-width: 1439px) {
  .summary-shell {
    max-width: 360px;
  }
}
.summary-shell .form {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  border: 1px solid #dde2ff;
  border-radius: 10px;
  padding: 6px 8px; /* Kompakt: 8px 10px â†’ 6px 8px */
  background: #ffffff;
}

.summary-shell .form h2 {
  font-size: 14px; /* Daha kompakt baÅŸlÄ±k */
  margin: 0 0 4px 0;
}
/* GÃ¶rev Panosu - GÃ¼n DetayÄ± Paneli ile aynÄ± yapÄ± */
.task-board-panel {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
  max-width: none; /* GeniÅŸ ekranlarda sÄ±nÄ±rsÄ±z */
  flex: 1; /* GÃ¼n DetayÄ± Paneli ile aynÄ± hizada esneyecek */
  min-height: 0; /* Flexbox scroll iÃ§in gerekli */
  overflow: hidden; /* Panel kendisi taÅŸmayacak */
}

/* Orta ekranlarda max-width sÄ±nÄ±rÄ± */
@media (max-width: 1439px) {
  .task-board-panel {
    max-width: 340px;
  }
}

.task-board-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  flex-shrink: 0; /* Header sabit kalacak, scroll etmeyecek */
}

.task-board-header h2 {
  margin: 0;
  font-size: 15px;
  font-weight: 700;
  color: #111827;
}

.task-board-add-btn {
  padding: 4px 10px;
  font-size: 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

.task-board-add-btn:hover {
  background: #2563eb;
}

/* Scroll wrapper - GÃ¼n DetayÄ± Paneli ile aynÄ± mantÄ±k */
.task-board-scroll-wrapper {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 4px;
  overscroll-behavior: contain;
}

.task-board-scroll-wrapper::-webkit-scrollbar {
  width: 6px;
}

.task-board-scroll-wrapper::-webkit-scrollbar-thumb {
  background: #cbd5f5;
  border-radius: 999px;
}

.task-board-scroll-wrapper::-webkit-scrollbar-track {
  background: transparent;
}

.task-board-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3 kolon yan yana */
  gap: 12px;
  padding: 10px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  height: 100%; /* TÃ¼m yÃ¼ksekliÄŸi kullan - Kanban stili iÃ§in gerekli */
}

/* Tablet ve kÃ¼Ã§Ã¼k ekranlarda tek kolon */
@media (max-width: 1200px) {
  .task-board-container {
    grid-template-columns: 1fr;
    height: auto; /* Tek sÃ¼tunda auto yÃ¼kseklik */
  }
}

/* Kanban/Trello Stili - Her sÃ¼tun baÄŸÄ±msÄ±z scroll */
.task-board-column {
  display: flex;
  flex-direction: column;
  height: 100%; /* TÃ¼m yÃ¼ksekliÄŸi kullan */
  background: #ffffff;
  border-radius: 8px;
  padding: 10px;
  border: 1px solid #e5e7eb;
  min-height: 0; /* Flexbox scroll iÃ§in gerekli */
  overflow: hidden; /* SÃ¼tunun kendisi taÅŸmayacak */
}

.task-board-column-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0; /* BaÅŸlÄ±k sabit kalacak, scroll etmeyecek - Trello stili */
  margin-bottom: 10px;
  padding: 8px 12px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  flex-shrink: 0; /* Header SABÄ°T KALACAK - scroll etmeyecek */
  flex-grow: 0; /* Boyutu deÄŸiÅŸmeyecek */
}

.task-board-column-title {
  font-size: 9px;
  font-weight: 700;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Kartlar container - SADECE BU KISIM SCROLL OLACAK */
.task-board-cards {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto; /* Dikey scroll - Kanban stili */
  overflow-x: hidden;
  flex: 1; /* Kalan tÃ¼m alanÄ± kapla */
  min-height: 0; /* Flexbox scroll trick */
  padding-right: 4px;
  overscroll-behavior: contain; /* Scroll dÄ±ÅŸarÄ± taÅŸmasÄ±n */
}

/* Custom Scrollbar - Ä°nce ve estetik (Trello/Kanban stili) */
.task-board-cards::-webkit-scrollbar {
  width: 5px; /* Ä°nce scrollbar */
}

.task-board-cards::-webkit-scrollbar-track {
  background: transparent; /* GÃ¶rÃ¼nmez track */
  border-radius: 4px;
}

.task-board-cards::-webkit-scrollbar-thumb {
  background: #cbd5e1; /* Gri scrollbar */
  border-radius: 4px;
  transition: background 0.2s;
}

.task-board-cards::-webkit-scrollbar-thumb:hover {
  background: #94a3b8; /* Hover'da daha koyu */
}

.task-board-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.task-board-card:hover {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  transform: translateY(-1px);
}

.task-board-card-title {
  font-size: 12px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 4px;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.task-board-card-description {
  font-size: 11px;
  color: #6b7280;
  line-height: 1.4;
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.task-board-card-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  padding-top: 6px;
  border-top: 1px solid #f3f4f6;
  flex-wrap: wrap;
}

.task-board-card-assignee {
  font-size: 10px;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 3px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

.task-board-card-assignee::before {
  content: "ðŸ‘¤";
  font-size: 11px;
  flex-shrink: 0;
}

.task-board-card-priority {
  font-size: 9px;
  font-weight: 600;
  padding: 2px 5px;
  border-radius: 4px;
  text-transform: uppercase;
  flex-shrink: 0;
}

.task-board-card-priority.high {
  background: #fee2e2;
  color: #991b1b;
}

.task-board-card-priority.medium {
  background: #fef3c7;
  color: #92400e;
}

.task-board-card-priority.low {
  background: #dbeafe;
  color: #1e40af;
}

/* Kolon renkleri */
.task-board-column[data-status="todo"] .task-board-column-title::before {
  content: "ðŸ“‹";
  font-size: 14px;
}

.task-board-column[data-status="in-progress"] .task-board-column-title::before {
  content: "âš¡";
  font-size: 14px;
}

.task-board-column[data-status="done"] .task-board-column-title::before {
  content: "âœ…";
  font-size: 14px;
}

.task-board-empty-state {
  text-align: center;
  padding: 20px;
  color: #9ca3af;
  font-size: 12px;
  font-style: italic;
}

.summary-scroll-area {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  min-height: 0;
}
.day-summary-scroll {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  padding-right: 4px;
  overscroll-behavior: contain;
}
.summary-scroll-area::-webkit-scrollbar {
  width: 6px;
}
.summary-scroll-area::-webkit-scrollbar-thumb {
  background: #cbd5f5;
  border-radius: 999px;
}
.excel-upload-container {
  margin-top: auto;
  padding-top: 10px;
  border-top: 1px dashed #e5e7eb;
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
  flex-shrink: 0;
}
    .excel-upload-actions {
      display: flex;
      gap: 10px;
    }
    .excel-upload-actions button {
      flex: 1 1 0;
    }
    .reset-options {
      display: none;
      position: absolute;
      left: 0;
      right: 0;
      bottom: 58px;
      flex-direction: column;
      gap: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
      z-index: 20;
    }
    .reset-options .danger-btn {
      justify-content: center;
    }
    .reset-options .secondary-btn {
      justify-content: center;
    }
    .excel-note {
      font-size: 11px;
      color: #4b5563;
    }
    .excel-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #2563eb;
      color: #f8fafc;
      border: 1px solid #1d4ed8;
    }
    .small {
      font-size: 11px;
      color: #4b5563;
    }
.schedule-list {
  margin-top: 6px;
  border-top: 1px solid #eef0ff;
  padding-top: 6px;
}
#scheduleList {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overscroll-behavior: contain;
  padding-bottom: 12px;
}
.schedule-search {
  margin-top: 2px;
  display: flex;
  align-items: center;
}
.schedule-search input {
  width: 100%;
  padding: 5px 7px; /* Kompakt: 6px 9px â†’ 5px 7px */
  border-radius: 6px;
  border: 1px solid #d1d5db;
  font-size: 11px; /* Kompakt: 12px â†’ 11px */
  outline: none;
}
    .schedule-view-toggle {
      margin: 3px 0 2px;
      display: inline-flex;
      gap: 4px; /* Kompakt: 6px â†’ 4px */
      background: #f1f5f9;
      border-radius: 999px;
      padding: 2px; /* Kompakt: 3px â†’ 2px */
    }
    .schedule-view-btn {
      border: none;
      background: transparent;
      padding: 3px 8px; /* Kompakt: 4px 11px â†’ 3px 8px */
      font-size: 10px; /* Kompakt: 11px â†’ 10px */
      font-weight: 600;
      border-radius: 999px;
      color: #475569;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .schedule-view-btn.active {
      background: #0f172a;
      color: #ffffff;
    }
.schedule-item.summary {
  --summary-surface: #ffffff;
  --summary-text: #0f172a;
  --summary-border: transparent;
  --summary-chip-bg: rgba(15, 23, 42, 0.06);
  --summary-chip-color: #0f172a;
  --summary-chip-border: rgba(15, 23, 42, 0.16);
  --summary-shadow: rgba(15, 23, 42, 0.08);
  padding: 8px;
  margin-bottom: 6px;
  border-radius: 8px;
  border: 1px solid rgba(226, 232, 240, 0.8);
  border-left: 4px solid var(--summary-border, rgba(226, 232, 240, 0.9));
  background: var(--summary-surface);
  color: var(--summary-text);
  transition: border-color 0.12s ease, border-left-color 0.12s ease,
    background 0.12s ease, box-shadow 0.12s ease;
}
    .schedule-item.summary:hover {
      box-shadow: 0 6px 16px var(--summary-shadow, rgba(15, 23, 42, 0.12));
      border-color: #cbd5f5;
      border-left-color: #2563eb;
    }
    .schedule-item.summary.active {
      border-color: rgba(37, 99, 235, 0.45);
      border-left-color: #2563eb;
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18);
    }
    .daily-entry-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .daily-entry-heading {
      font-weight: 600;
      color: #1e293b;
      font-size: 13.5px;
      margin: 4px 0 6px;
      padding: 6px 8px;
      background: #f1f5f9;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
.daily-entry-row {
  --daily-card-color: rgba(15, 23, 42, 0.12);
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-left: 4px solid rgba(226, 232, 240, 0.9);
  border-radius: 9px;
  padding: 6px 8px;
  background: #ffffff;
  display: block;
  cursor: pointer;
  transition: box-shadow 0.12s ease, border-color 0.12s ease;
  margin-bottom: 4px;
  min-height: 76px;
}
.daily-entry-row:last-child {
  margin-bottom: 0;
}
    .daily-entry-row:hover {
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border-color: #dbe3ff;
      /* Mavi ÅŸerit kaldÄ±rÄ±ldÄ± - kartÄ±n kendi rengi hover'da da korunuyor */
    }
    .daily-entry-row.active {
      border-color: rgba(59, 91, 219, 0.3);
      border-left-color: var(--daily-card-color, rgba(59, 91, 219, 0.3));
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.15);
    }
    
    /* Daily entry row renk border'larÄ± - sadece renk tanÄ±mlÄ± kartlarda */
    .daily-entry-row.color-default { border-left-color: rgba(226, 232, 240, 0.9); --daily-card-color: #94a3b8; }
    .daily-entry-row.color-blue:not(.color-default) { border-left-color: #3b82f6; --daily-card-color: #3b82f6; }
    .daily-entry-row.color-red:not(.color-default) { border-left-color: #ef4444; --daily-card-color: #ef4444; }
    .daily-entry-row.color-green:not(.color-default) { border-left-color: #22c55e; --daily-card-color: #22c55e; }
    .daily-entry-row.color-yellow:not(.color-default) { border-left-color: #facc15; --daily-card-color: #facc15; }
    .daily-entry-row.color-purple:not(.color-default) { border-left-color: #a855f7; --daily-card-color: #a855f7; }
    .daily-entry-row.color-orange:not(.color-default) { border-left-color: #f97316; --daily-card-color: #f97316; }
    .daily-entry-row.color-pink:not(.color-default) { border-left-color: #ec4899; --daily-card-color: #ec4899; }
    .daily-entry-row.color-cyan:not(.color-default) { border-left-color: #06b6d4; --daily-card-color: #06b6d4; }
    .daily-entry-row.color-emerald:not(.color-default) { border-left-color: #10b981; --daily-card-color: #10b981; }
    .daily-entry-row.color-amber:not(.color-default) { border-left-color: #f59e0b; --daily-card-color: #f59e0b; }
    .daily-entry-row.color-sky:not(.color-default) { border-left-color: #0ea5e9; --daily-card-color: #0ea5e9; }
    .daily-entry-row.color-violet:not(.color-default) { border-left-color: #8b5cf6; --daily-card-color: #8b5cf6; }
    .daily-entry-row.color-rose:not(.color-default) { border-left-color: #f43f5e; --daily-card-color: #f43f5e; }
    .daily-entry-row.color-gray:not(.color-default) { border-left-color: #6b7280; --daily-card-color: #6b7280; }
    .daily-entry-row.color-white:not(.color-default) { border-left-color: #d1d5db; --daily-card-color: #9ca3af; }
    .daily-entry-row.color-black:not(.color-default) { border-left-color: #374151; --daily-card-color: #374151; }
    
    .daily-entry-row:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    .daily-entry-status {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;
      line-height: 1;
    }
    .daily-entry-status.status-done {
      color: #16a34a;
      font-size: 14px;
    }
    .daily-entry-status.status-missed {
      color: #dc2626;
      font-size: 10px;
    }
    .daily-entry-status.status-scheduled {
      color: #2563eb;
    }
    .daily-entry-status.status-pending {
      color: #64748b;
    }
    .daily-entry-body {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .daily-entry-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    .daily-entry-time-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 500;
      color: #1e40af;
      flex-shrink: 0;
      line-height: 1.2;
    }
    .daily-entry-time-chip-icon {
      font-size: 8px;
      line-height: 1;
    }
    .daily-entry-title {
      font-size: 11px;
      font-weight: 600;
      color: #0f172a;
      line-height: 1.3;
      flex: 1;
    }
    .daily-entry-meta {
      font-size: 9.5px;
      color: #475569;
      margin: 0;
      line-height: 1.25;
    }
    .daily-entry-meta.daily-entry-time {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .daily-entry-time-icon {
      font-size: 9px;
      color: #2563eb;
      line-height: 1;
      margin-right: 3px;
    }
    .daily-entry-footer {
      margin-top: auto;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      min-height: 18px;
      gap: 4px;
      padding-top: 2px;
    }
    .daily-entry-badges {
      margin-top: auto;
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      flex-wrap: wrap;
    }
    .schedule-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--summary-text);
    }
    .schedule-summary-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .summary-chip {
      padding: 1px 6px;
      border-radius: 999px;
      background: var(--summary-chip-bg);
      border: 1px solid var(--summary-chip-border);
      color: var(--summary-chip-color);
      font-size: 10px;
      font-weight: 600;
    }
    .schedule-item {
      padding: 5px 0;
      border-bottom: 1px solid #f1f3ff;
      cursor: pointer;
    }
    .schedule-item.from-excel {
      background: rgba(14, 165, 233, 0.08);
      border-color: #bae6fd;
      border-radius: 8px;
      padding: 6px;
    }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-date {
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 2px;
      color: #111827;
    }
    .schedule-text {
      font-size: 11px;
      margin-bottom: 2px;
      color: #374151;
    }

    /* Raporlar gÃ¶rÃ¼nÃ¼mÃ¼ */
    #viewReports {
      border: 1px solid #dde2ff;
      border-radius: 12px;
      padding: 16px;
      background: #ffffff;
    }
    .report-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0 10px 0;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .report-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .report-section { margin-bottom: 16px; }
    .report-section h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    .report-list {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
    }
    .report-range-inputs {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .report-range-inputs input[type="date"] {
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #ffffff;
      color: #111827;
    }
    .report-range-inputs .range-separator {
      font-size: 12px;
      color: #6b7280;
    }
    .quick-range-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin: 0 0 14px 0;
      flex-wrap: wrap;
    }
    .quick-range-buttons span {
      color: #6b7280;
      font-weight: 600;
    }
    .quick-range-buttons button {
      font-size: 11px;
      padding: 4px 10px;
    }
    .report-content-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0 0 14px 0;
    }
    .report-view-btn {
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #0f172a;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
    }
    .report-view-btn.active {
      background: #2563eb;
      border-color: #1d4ed8;
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    }
    .report-view-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .report-summary-line {
      font-size: 13px;
      color: #0f172a;
    }
    .report-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #475569;
      cursor: pointer;
    }
    .report-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 640px;
    }
    .report-table thead {
      background: #f8fafc;
    }
    .report-table th,
    .report-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    .report-table th {
      font-weight: 600;
      color: #0f172a;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .report-table td {
      color: #0f172a;
    }
    .report-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .report-status-done {
      background: rgba(34, 197, 94, 0.18);
      color: #166534;
    }
    .report-status-missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .report-status-planned {
      background: rgba(15, 23, 42, 0.05);
      color: #0f172a;
    }
    @media (max-width: 768px) {
      .report-table {
        min-width: 100%;
      }
      .report-table thead {
        display: none;
      }
      .report-table tr {
        display: block;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 12px;
        padding: 10px 12px;
      }
      .report-table td {
        border: none;
        padding: 6px 0;
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .report-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #475569;
        margin-right: 8px;
      }
    }
    body.dark .report-range-inputs input[type="date"] {
      background: #111827;
      border-color: #374151;
      color: #f3f4f6;
    }
    body.dark .quick-range-buttons span {
      color: #9ca3af;
    }
    body.dark .report-view-btn {
      background: #111827;
      color: #f3f4f6;
      border-color: #374151;
    }
    body.dark .report-view-btn.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #1d4ed8;
    }
    body.dark .report-table thead {
      background: #111827;
    }
    body.dark .report-table th,
    body.dark .report-table td {
      color: #f1f5f9;
      border-bottom-color: #1f2937;
    }
    body.dark .report-status-planned {
      background: rgba(248, 250, 252, 0.08);
      color: #f1f5f9;
    }
    .report-chart-wrapper {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .report-chart-wrapper canvas {
      width: 100%;
      height: 260px;
    }
    body.dark .report-chart-wrapper {
      background: #1f2937;
      border-color: #374151;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overscroll-behavior: contain;
      overflow: hidden;
      pointer-events: auto;
    }
    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 0;
      max-width: 960px;
      width: min(96vw, 960px);
      height: 85vh;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
      pointer-events: auto;
    }
    /* Modal aÃ§Ä±kken body scroll'u engelle */
    body.modal-open {
      overflow: hidden !important;
    }
    .modal-header-block {
      flex-shrink: 0;
      background: #f9fbff;
      padding: 20px 24px 12px;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 16px 16px 0 0;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .modal-body {
      flex: 1;
      overflow: hidden; /* Modal body scroll etmez, iÃ§indeki elementler scroll eder */
      padding: 16px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }
    .modal-toolbar {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      position: relative;
      margin-top: 12px;
    }
    .highlight-picker {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .highlight-help-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .highlight-help-btn:hover {
      background: #f3f4f6;
    }
    .color-help-panel {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 280px;
      border-radius: 14px;
      border: 1px solid #e4e7f5;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      padding: 12px;
      display: none;
      z-index: 40;
    }
    .color-help-panel.active {
      display: block;
    }
    .color-help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .color-help-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }
    .color-help-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      color: #0f172a;
    }
    .color-help-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
    }
    .color-help-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #0f172a;
    }
    .color-help-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.12);
      flex-shrink: 0;
    }
    .copy-popover-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1600;
      padding: 16px;
    }
    .copy-popover-backdrop.active {
      display: flex;
    }
    .copy-popover {
      width: min(360px, 100%);
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 18px;
      padding: 18px;
      background: #ffffff;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .copy-popover-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 13px;
      color: #0f172a;
    }
    .copy-popover-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .color-picker-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }
    .highlight-label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
    }
    .color-picker-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-size: 12px;
    }
    .color-picker-toggle .toggle-swatch {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
      display: inline-block;
    }
    .color-picker {
      display: none;
      opacity: 0;
      pointer-events: none;
      transform: translateY(4px) scale(0.98);
      transition: opacity 120ms ease, transform 120ms ease;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 14px;
      background: #fff;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 168px;
      z-index: 30;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.2);
      grid-template-columns: repeat(4, 32px);
      gap: 8px;
    }
    .color-picker.open {
      display: grid;
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }
    .color-picker-wrapper.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .color-picker.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      outline: none;
      background: transparent;
    }
    .color-swatch span {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }
    .color-swatch.active {
      border-color: #111;
    }
    .modal-columns {
      display: grid;
      grid-template-columns: minmax(230px, 320px) minmax(420px, 1fr);
      gap: 18px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    .modal-summary {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 0;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 100%;
    }
    .modal-summary-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      min-height: 0;
      overscroll-behavior: contain;
    }
    .modal-summary-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .modal-summary-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }
    .modal-summary-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    .modal-summary-footer {
      border-top: 1px dashed #e5e7eb;
      padding: 10px 12px;
      background: #ffffff;
      border-radius: 0 0 12px 12px;
      flex-shrink: 0;
    }
    .modal-form-section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px; /* 16px â†’ 14px (biraz daha kompakt) */
      display: flex;
      flex-direction: column;
      gap: 8px; /* 12px â†’ 8px (form elemanlarÄ± arasÄ± daha yakÄ±n) */
      background: #ffffff;
      overflow-y: auto;
      max-height: 100%;
      overscroll-behavior: contain;
    }
    .modal-form-section::-webkit-scrollbar {
      width: 6px;
    }
    .modal-form-section::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 999px;
    }
    .modal-form-section::-webkit-scrollbar-track {
      background: transparent;
    }
    .form-row {
      margin-bottom: 10px; /* 8px â†’ 10px (biraz daha kompakt) */
      display: flex;
      flex-direction: column;
      gap: 3px; /* 4px â†’ 3px (label ile input arasÄ± daha yakÄ±n) */
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      padding: 6px;
      font-family: inherit;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    select {
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      font-family: inherit;
      background: #ffffff;
      color: #0f172a;
    }
    .form-success-message {
      font-size: 12px;
      color: #16a34a;
      margin-top: 6px;
      display: none;
    }
    input[type="text"],
    input[type="time"],
    input[type="date"] {
      padding: 6px;
      font-size: 12px;
      font-family: inherit;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    #filesInput {
      min-height: 48px;
    }
    .platforms {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 8px;
      font-size: 12px;
    }
    .platforms label {
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .platform-presets {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #475569;
    }
    .platform-presets .preset-btn {
      font-size: 11px;
      padding: 4px 10px;
    }
    .form-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .inline-color-control {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #111827;
    }
    .inline-color-control .color-picker-toggle {
      margin-left: 2px;
    }
    .form-button-actions {
      display: inline-flex;
      gap: 6px;
      margin-left: auto;
    }
    #toggleFormBtn {
      border-radius: 999px;
      padding-inline: 14px;
      padding-block: 6px;
    }

    /* GÃ¼n iÃ§i iÃ§erik listesi - kompakt */
    #modalSummary {
      margin-top: 4px;
      font-size: 10.5px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .summary-item {
      --summary-card-color: rgba(15, 23, 42, 0.25);
      position: relative;
      padding: 8px 10px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: none;
      cursor: pointer;
      color: #0f172a;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
      margin-bottom: 8px;
    }
    .summary-item:focus-visible {
      outline: 2px solid rgba(59, 91, 219, 0.4);
      outline-offset: 2px;
    }
    .summary-item + .summary-item {
      margin-top: 0px;
    }
    .summary-item:last-child {
      margin-bottom: 0;
    }
    .summary-item.excel {
      background: #ffffff;
    }
    .summary-item.active {
      background: #f0f4ff;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.12);
      border-width: 2px;
      padding: 7px 9px;
    }
    .summary-item.active::before {
      content: "";
      position: absolute;
      left: -1px;
      top: 6px;
      bottom: 6px;
      width: 3px;
      border-radius: 999px;
      background: var(--summary-card-color, #cbd5e1);
    }
    .summary-item:hover {
      border-color: #cbd5f5;
    }
    
    /* Kart renk border'larÄ± - sadece renk tanÄ±mlÄ± kartlarda */
    .summary-item.color-default { border-color: #e5e7eb; --summary-card-color: #94a3b8; }
    .summary-item.color-blue:not(.color-default) { border-color: #3b82f6; --summary-card-color: #3b82f6; }
    .summary-item.color-red:not(.color-default) { border-color: #ef4444; --summary-card-color: #ef4444; }
    .summary-item.color-green:not(.color-default) { border-color: #22c55e; --summary-card-color: #22c55e; }
    .summary-item.color-yellow:not(.color-default) { border-color: #facc15; --summary-card-color: #facc15; }
    .summary-item.color-purple:not(.color-default) { border-color: #a855f7; --summary-card-color: #a855f7; }
    .summary-item.color-orange:not(.color-default) { border-color: #f97316; --summary-card-color: #f97316; }
    .summary-item.color-pink:not(.color-default) { border-color: #ec4899; --summary-card-color: #ec4899; }
    .summary-item.color-cyan:not(.color-default) { border-color: #06b6d4; --summary-card-color: #06b6d4; }
    .summary-item.color-emerald:not(.color-default) { border-color: #10b981; --summary-card-color: #10b981; }
    .summary-item.color-amber:not(.color-default) { border-color: #f59e0b; --summary-card-color: #f59e0b; }
    .summary-item.color-sky:not(.color-default) { border-color: #0ea5e9; --summary-card-color: #0ea5e9; }
    .summary-item.color-violet:not(.color-default) { border-color: #8b5cf6; --summary-card-color: #8b5cf6; }
    .summary-item.color-rose:not(.color-default) { border-color: #f43f5e; --summary-card-color: #f43f5e; }
    .summary-item.color-gray:not(.color-default) { border-color: #6b7280; --summary-card-color: #6b7280; }
    .summary-item.color-white:not(.color-default) { border-color: #d1d5db; --summary-card-color: #9ca3af; }
    .summary-item.color-black:not(.color-default) { border-color: #374151; --summary-card-color: #374151; }
    
    .summary-color-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: transparent;
      border: 1.5px solid #cbd5e1;
      flex-shrink: 0;
      box-shadow: none;
    }
    /* SeÃ§ili kartlarda dot dolsun */
    .summary-item.active .summary-color-dot {
      background: var(--summary-card-color, #94a3b8);
      border-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.08);
    }
    .summary-item-header-left {
      display: flex;
      align-items: center;
      gap: 3px;
      min-width: 0;
      flex: 1;
    }
    .summary-item-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .summary-item-title {
      font-size: 10.5px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 2px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: normal;
      max-width: 240px;
    }
    .summary-item-time-chip {
      font-size: 9px;
      color: #475569;
      border: 1px solid #dbeafe;
      background: #eef2ff;
      border-radius: 999px;
      padding: 1px 4px 1px 5px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
    }
    .summary-item-time-chip .time-value {
      font-weight: 600;
    }
    .icon-clock {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      border: 1px solid #c7d2fe;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 7px;
      color: #1d4ed8;
      background: #eef2ff;
    }
    .summary-item-platforms {
      font-size: 9.5px;
      color: #475569;
      line-height: 1.3;
      margin-bottom: 1px;
    }
    .summary-item-owner {
      font-size: 9.5px;
      color: #1f2937;
      margin-top: 1px;
    }
    .summary-item-badge {
      font-size: 8px;
      color: #0f172a;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 999px;
      padding: 1px 5px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .summary-item-badge.excel {
      background: #e0e7ff;
      color: #1d4ed8;
      border-color: #c7d2fe;
      font-size: 7px;
      padding: 1px 5px;
    }
    .summary-item-footer {
      margin-top: 0px;
      display: flex;
      justify-content: flex-end;
    }
    .summary-item-copy-icon {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      border: 1px dashed #c7d2fe;
      background: #eef2ff;
      color: #4338ca;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .summary-item-copy-icon:hover {
      background: #e0e7ff;
    }
    .summary-item-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 5px;
      margin-bottom: 3px;
    }
    .summary-item-status-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .summary-item-status {
      font-size: 9.5px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      white-space: nowrap;
    }
    .summary-item-status.status-done {
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }
    .summary-item-status.status-missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .summary-item-status.status-planned {
      background: rgba(248, 250, 252, 1);
      color: #0f172a;
    }
    .modal-control-section {
      display: none;
      overflow-y: auto;
      overscroll-behavior: contain;
      max-height: 100%;
    }
    .control-card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 18px;
      padding: 16px;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .control-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 2px;
    }
    .control-title {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      margin: 0;
    }
    .control-meta {
      font-size: 14px;
      color: #475569;
      line-height: 1.4;
      margin: 0;
    }
    .control-note label {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: block;
      margin-bottom: 4px;
    }
    .control-note textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }
    .control-note textarea:read-only {
      background: #f8fafc;
      cursor: not-allowed;
    }
    .control-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .success-btn,
    .link-btn {
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
    }
    .success-btn {
      background: #dcfce7;
      border: 1px solid #86efac;
      color: #166534;
    }
    .success-btn:hover {
      background: #bbf7d0;
    }
    .control-actions .danger-btn {
      flex: none;
    }
    .link-btn {
      background: transparent;
      border: none;
      color: #2563eb;
      padding: 0;
      font-weight: 600;
      cursor: pointer;
    }
    .link-btn:disabled {
      color: #94a3b8;
      cursor: not-allowed;
    }
    .control-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }
    .control-status-badge.missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .control-note-display {
      font-size: 14px;
      color: #334155;
      background: #f8fafc;
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
    }
    .control-checked-at {
      font-size: 12px;
      color: #94a3b8;
    }
    .plan-return-banner {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      font-size: 12px;
      color: #9a3412;
      margin-bottom: 10px;
    }
    .plan-return-banner span {
      flex: 1;
    }
    .summary-empty {
      padding: 20px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      color: #6b7280;
      width: 100%;
      text-align: center;
    }

    /* DARK MODE: yÃ¼ksek kontrast */
    body.dark {
      background: #0b1120;
      color: #e5e7eb;
    }
    body.dark .calendar,
    body.dark .form,
    body.dark #viewReports {
      background: #0b1120;
      border-color: #1f2937;
    }
    body.dark .calendar-header {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .weekday {
      background: #0f172a;
      color: #e5e7eb;
    }
    body.dark .day {
      --day-surface: #0b1120;
      --day-text: #e5e7eb;
      --day-border: #1f2937;
      --day-chip-bg: rgba(226, 232, 240, 0.08);
      --day-chip-color: #e5e7eb;
      --day-chip-border: rgba(226, 232, 240, 0.18);
      --day-highlight-shadow: rgba(0, 0, 0, 0.45);
      background: var(--day-surface);
      border-color: var(--day-border);
    }
    body.dark .day.day-highlighted {
      box-shadow: 0 14px 30px var(--day-highlight-shadow, rgba(15, 23, 42, 0.45));
    }
    body.dark .day.today .day-number-inner {
      background: #ef4444;
      color: #ffffff;
    }
    body.dark .day-number { color: var(--day-text); }
    body.dark .day-summary { color: #cbd5f5; }
    body.dark .day-counter {
      color: #c4b5fd;
    }

    /* Koyu mod modal daha aydÄ±nlÄ±k ve kontrastlÄ± */
    /* Dark mode - Bildirimler */
    body.dark .notification-panel {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.6);
    }
    body.dark .notification-panel-header {
      color: #f9fafb;
      border-bottom-color: #1f2937;
    }
    body.dark .notification-mark-all-read {
      color: #60a5fa;
    }
    body.dark .notification-mark-all-read:hover {
      background: #1e3a8a;
    }
    body.dark .notification-clear-all {
      color: #f87171;
    }
    body.dark .notification-clear-all:hover {
      background: #7f1d1d;
    }
    body.dark .notification-item {
      background: #0b1120;
      border-color: transparent;
    }
    body.dark .notification-item:hover {
      background: #1e293b;
      border-color: #374151;
    }
    body.dark .notification-item.unread {
      background: #172554;
    }
    body.dark .notification-item.unread:hover {
      background: #1e3a8a;
      border-color: #3b82f6;
    }
    body.dark .notification-dot {
      background: #60a5fa;
    }
    body.dark .notification-item-title {
      color: #f9fafb;
    }
    body.dark .notification-timestamp {
      color: #94a3b8;
    }
    body.dark .notification-item-body {
      color: #cbd5e1;
    }
    body.dark .notification-empty {
      color: #6b7280;
    }
    
    body.dark .modal {
      background: rgba(15, 23, 42, 0.85);
    }
    body.dark .modal-content {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
    }
    body.dark .modal-header-block {
      background: #1e293b;
      border-color: #1f2937;
    }
    body.dark .modal-title { color: #f9fafb; }
    body.dark textarea,
    body.dark input[type="text"],
    body.dark input[type="time"],
    body.dark input[type="date"] {
      background: #020617;
      color: #f9fafb;
      border-color: #475569;
    }
    body.dark .color-help-panel {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
    }
    body.dark .color-help-title {
      color: #f9fafb;
    }
    body.dark .color-help-row {
      color: #f9fafb;
    }

    /* Dark mode - GÃ¶rev Panosu Kanban Stili */
    body.dark .task-board-column-header {
      background: #1f2937;
      border-color: #374151;
    }
    body.dark .task-board-column-title {
      color: #9ca3af;
    }
    body.dark .task-board-column-count {
      background: #1e3a8a;
      color: #93c5fd;
      border-color: #1e40af;
    }
    body.dark .task-board-column {
      background: #111827;
      border-color: #1f2937;
    }
    body.dark .task-board-card {
      background: #1f2937;
      border-color: #374151;
    }
    body.dark .task-board-card:hover {
      border-color: #3b82f6;
    }
    /* Dark mode - Kolon scrollbar */
    body.dark .task-board-cards::-webkit-scrollbar-thumb {
      background: #475569;
    }
    body.dark .task-board-cards::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    /* Dark mode - Panel scrollbar */
    body.dark .task-board-scroll-wrapper::-webkit-scrollbar-thumb {
      background: #475569;
    }
    body.dark .task-board-container {
      background: #111827;
      border-color: #1f2937;
    }

    body.dark .summary-item {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      color: #f8fafc;
    }
    body.dark .summary-item.excel {
      background: #111827;
    }
    body.dark .summary-item.active {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 45px rgba(59, 130, 246, 0.25);
    }
    /* Dark mode - dot seÃ§ili olmayan kartlarda boÅŸ */
    body.dark .summary-color-dot {
      background: transparent;
      border-color: #475569;
    }
    body.dark .summary-item.active .summary-color-dot {
      background: var(--summary-card-color, #94a3b8);
      border-color: rgba(255, 255, 255, 0.9);
    }
    body.dark .summary-empty {
      background: #020617;
      border-color: #475569;
      color: #9ca3af;
    }
    body.dark .summary-item-title,
    body.dark .summary-item-platforms,
    body.dark .summary-item-owner {
      color: #f8fafc;
    }
    body.dark .summary-item-time-chip {
      border-color: #475569;
      background: #1e293b;
      color: #e2e8f0;
    }
    body.dark .summary-item-time-chip .time-value {
      color: #e2e8f0;
    }
    body.dark .icon-clock {
      border-color: #475569;
      background: #111827;
      color: #93c5fd;
    }
    body.dark .summary-item-badge,
    body.dark .excel-chip {
      background: #1d4ed8;
      border-color: transparent;
      color: #f8fafc;
    }
    body.dark .summary-item-badge.excel {
      background: #1d4ed8;
      border-color: transparent;
      color: #f8fafc;
    }
    body.dark .summary-item-copy-icon {
      border-color: #4c1d95;
      background: #1e1b4b;
      color: #c4b5fd;
    }
    body.dark .form-success-message {
      color: #4ade80;
    }
    body.dark .copy-popover-backdrop {
      background: rgba(0, 0, 0, 0.6);
    }
    body.dark .copy-popover {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
      color: #f9fafb;
    }
    body.dark .control-card {
      background: #ffffff;
      color: #0f172a;
    }
    body.dark .control-note textarea {
      background: #f8fafc;
      color: #0f172a;
      border-color: rgba(15, 23, 42, 0.15);
    }
    body.dark .excel-upload-container {
      border-top-color: #374151;
    }
    body.dark .schedule-search input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .day-summary.excel {
      color: #bae6fd;
    }
    body.dark .schedule-item {
      border-color: #1f2937;
    }
    body.dark .schedule-text,
    body.dark .schedule-date {
      color: #e5e7eb;
    }
    body.dark .schedule-item.summary {
      --summary-surface: #111827;
      --summary-text: #f5f6fb;
      --summary-border: rgba(59, 130, 246, 0.6);
      --summary-chip-bg: rgba(226, 232, 240, 0.12);
      --summary-chip-color: #f5f6fb;
      --summary-chip-border: rgba(226, 232, 240, 0.25);
      border-color: #1f2937;
      box-shadow: none;
    }
    body.dark .day-summary-chip {
      background: var(--day-chip-bg, #1e3a8a);
      color: var(--day-chip-color, #c7d2fe);
      border-color: var(--day-chip-border, transparent);
    }
    body.dark .summary-chip {
      background: #1e3a8a;
      color: #c7d2fe;
    }
    body.dark .schedule-view-toggle {
      background: #1f2937;
    }
    body.dark .schedule-view-btn {
      color: #cbd5f5;
    }
    body.dark .schedule-view-btn.active {
      background: #f8fafc;
      color: #0f172a;
    }
    body.dark .daily-entry-heading {
      background: #1e293b;
      color: #f1f5f9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    body.dark .daily-entry-row {
      background: #111827;
      border-color: #1f2937;
      border-left-color: rgba(30, 41, 59, 0.9);
    }
    body.dark .daily-entry-row:hover {
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.6);
      /* Mavi ÅŸerit kaldÄ±rÄ±ldÄ± - kartÄ±n kendi rengi hover'da da korunuyor */
    }
    body.dark .daily-entry-row.active {
      border-color: rgba(59, 130, 246, 0.5);
      border-left-color: var(--daily-card-color, rgba(59, 130, 246, 0.5));
    }
    body.dark .daily-entry-title {
      color: #f8fafc;
    }
    body.dark .daily-entry-meta {
      color: #cbd5f5;
    }
    body.dark .daily-entry-status.status-done {
      color: #22c55e;
    }
    body.dark .daily-entry-status.status-missed {
      color: #ef4444;
    }
    body.dark .daily-entry-status.status-scheduled {
      color: #60a5fa;
    }
    body.dark .daily-entry-status.status-pending {
      color: #94a3b8;
    }
    body.dark .daily-entry-time-chip {
      background: #1e3a5f;
      border-color: #1e40af;
      color: #93c5fd;
    }
    body.dark .daily-entry-time-icon {
      color: #facc15;
    }

    body.dark button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark button:hover {
      background: #1e293b;
    }
    body.dark .primary-btn {
      background: #2563eb;
      border-color: #3b82f6;
      color: #ffffff;
    }
    body.dark .primary-btn:hover {
      background: #1d4ed8;
    }
    body.dark .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .secondary-btn:hover {
      background: #2c3a52;
    }
    body.dark .admin-user-row .role-select {
      background: #0f172a;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .admin-section {
      border-top-color: #1f2937;
    }
    body.dark .color-description-row {
      border-bottom-color: #1f2937;
    }
    body.dark .color-description-fields input,
    body.dark .color-description-fields textarea {
      background: #0f172a;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .color-swatch.active {
      border-color: #f9fafb;
    }
    body.dark .danger-btn {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }
    body.dark .danger-btn:hover {
      background: #991b1b;
    }
    body.dark .tab-button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }
    body.dark .report-controls { color: #e5e7eb; }
    body.dark .modal-summary {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .modal-summary-footer {
      background: #111827;
      border-top-color: #374151;
    }
    body.dark .modal-summary-scroll::-webkit-scrollbar-thumb {
      background: #475569;
    }
    body.dark .modal-form-section {
      background: #0b1120;
      border-color: #1f2937;
    }
    body.dark .modal-form-section::-webkit-scrollbar-thumb {
      background: #475569;
    }

    @media (max-width: 780px) {
      .modal-columns {
        grid-template-columns: 1fr;
      }
    }

    /* === HATA YÃ–NETÄ°MÄ° TOAST STÄ°LLERÄ° === */
    .error-toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .error-toast {
      background: #dc2626;
      color: #ffffff;
      padding: 14px 18px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 14px;
      font-weight: 500;
      max-width: 350px;
      word-wrap: break-word;
      pointer-events: auto;
      animation: slideInRight 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .error-toast.hiding {
      animation: slideOutRight 0.3s ease-in forwards;
    }
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    @media (max-width: 640px) {
      .error-toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }
      .error-toast {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- GLOBAL HATA YÃ–NETÄ°MÄ°: Toast mesajlarÄ± iÃ§in container -->
  <div id="errorToastContainer" class="error-toast-container"></div>
  
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <h2>PaylaÅŸÄ±m Takvimi</h2>
      <form id="loginForm">
        <div class="form-row">
          <label for="loginEmail">E-posta</label>
          <input type="email" id="loginEmail" autocomplete="email" placeholder="ornek@site.com" required />
        </div>
        <div class="form-row">
          <label for="loginPassword">Åžifre</label>
          <input type="password" id="loginPassword" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
        </div>
        <div class="login-card-footer">
          <button type="submit" id="loginSubmitBtn" class="primary-btn">GiriÅŸ yap</button>
          <button type="button" id="switchAuthModeBtn" class="secondary-btn">KayÄ±t olmak istiyorum</button>
          <span id="loginError"></span>
        </div>
      </form>
    </div>
  </div>
  <div id="adminOverlay" class="admin-overlay">
    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2>Admin Paneli</h2>
        <button id="adminCloseBtn" class="admin-close-btn" aria-label="Kapat">Ã—</button>
      </div>
      <div class="admin-panel-tabs" id="adminPanelTabs">
        <button type="button" class="admin-tab-btn active" data-panel="users">KullanÄ±cÄ± yÃ¶netimi</button>
        <button
          type="button"
          class="admin-tab-btn"
          data-panel="colors"
          id="colorTabBtn"
          style="display:none;"
        >
          Renk aÃ§Ä±klamalarÄ±nÄ± dÃ¼zenle
        </button>
      </div>
      <div class="admin-tab-view active" id="adminUsersSection" data-panel="users">
        <p class="small">
          Bekleyen kullanÄ±cÄ± kayÄ±tlarÄ±nÄ± onaylayabilir, herhangi bir kullanÄ±cÄ±nÄ±n takvimini gÃ¶rÃ¼ntÃ¼leyebilirsin.
          <span id="pendingCountBadge" class="pending-count-badge">(0 bekleyen kayÄ±t)</span>
        </p>
        <div class="admin-panel-actions">
          <button type="button" id="adminViewSelfBtn" class="primary-btn">Kendi takvimimi gÃ¶ster</button>
        </div>
        <div class="admin-user-list" id="adminUserList"></div>
      </div>
      <div
        class="admin-tab-view admin-section"
        id="colorDescriptionsSection"
        data-panel="colors"
        style="display:none;"
      >
        <h3>Renk aÃ§Ä±klamalarÄ±nÄ± dÃ¼zenle</h3>
        <p class="small">
          GÃ¼n rengi panelinde gÃ¶rÃ¼nen metinleri burada dÃ¼zenleyebilirsin. Bu ayarlar tÃ¼m kullanÄ±cÄ±lar iÃ§in geÃ§erlidir.
        </p>
        <div class="color-description-scroll">
          <div id="colorDescriptionsForm"></div>
        </div>
        <div class="color-description-actions">
          <button type="button" id="colorDescriptionSaveBtn" class="secondary-btn">Kaydet</button>
          <span class="small" id="colorDescriptionSaveStatus"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container" id="toastContainer" aria-live="polite"></div>
  <div id="appRoot">
  <div class="header">
    <div class="header-left">
      <h1>PaylaÅŸÄ±m Takvimi</h1>
    </div>
    <div class="header-center">
      <a href="https://www.goartworlds.com/" target="_blank" rel="noopener noreferrer" class="logo-link">
        <img src="goart-logo.png" alt="GoArt Worlds" class="logo" />
      </a>
    </div>
    <div class="header-right">
      <div class="notification-wrapper" id="notificationWrapper" style="display:none;">
        <button
          type="button"
          class="notification-bell"
          id="notificationToggleBtn"
          aria-label="Bildirimleri gÃ¶ster"
          aria-expanded="false"
        >
          <span class="notification-icon" aria-hidden="true">ðŸ””</span>
          <span class="notification-badge" id="notificationBadge"></span>
        </button>
        <div class="notification-panel" id="notificationPanel" role="region" aria-label="Bildirimler">
          <div class="notification-panel-header">
            <span>Bildirimler</span>
            <button type="button" class="notification-mark-all-read" id="markAllReadBtn" style="display:none;">TÃ¼mÃ¼nÃ¼ okundu yap</button>
            <button type="button" class="notification-clear-all" id="clearAllNotificationsBtn" style="display:none;">TÃ¼mÃ¼nÃ¼ sil</button>
          </div>
          <div class="notification-list" id="notificationList"></div>
          <p class="notification-empty" id="notificationEmptyState">Bildirim yok</p>
        </div>
      </div>
      <button id="adminPanelBtn" style="display:none;">Admin paneli</button>
      <button id="logoutBtn" style="display:none;">Ã‡Ä±kÄ±ÅŸ yap</button>
      <button id="themeToggleBtn">Koyu mod</button>
    </div>
  </div>

  <div class="tabs" style="margin-bottom:8px;">
    <button class="tab-button active" id="tabCalendar">Takvim</button>
    <button class="tab-button" id="tabReports">Raporlar</button>
  </div>
  <p class="small" id="adminViewInfo" style="display:none;"></p>

  <!-- TAKVÄ°M GÃ–RÃœNÃœMÃœ -->
  <div id="viewCalendar">
    <div class="container calendar-layout" id="calendarLayout">
      <div class="calendar-shell">
        <div class="calendar">
        <div class="channel-filter" id="channelFilter">
          <span>Kanallar:</span>
          <button type="button" class="channel-filter-btn" data-channel="all">TÃ¼mÃ¼</button>
          <button type="button" class="channel-filter-btn" data-channel="instagram">Instagram</button>
          <button type="button" class="channel-filter-btn" data-channel="x">X</button>
          <button type="button" class="channel-filter-btn" data-channel="telegram">Telegram</button>
          <button type="button" class="channel-filter-btn" data-channel="facebook">Facebook</button>
          <button type="button" class="channel-filter-btn" data-channel="linkedin">LinkedIn</button>
          <button type="button" class="channel-filter-btn" data-channel="youtube">YouTube</button>
          <button type="button" class="channel-filter-btn" data-channel="tiktok">TikTok</button>
          <button type="button" class="channel-filter-btn" data-channel="discord">Discord</button>
          <button type="button" class="channel-filter-btn" data-channel="reddit">Reddit</button>
          <button type="button" class="channel-filter-btn" data-channel="website">Website</button>
          <button type="button" class="channel-filter-btn" data-channel="medium">Medium</button>
        </div>
        <div class="assignee-filter" id="assigneeFilter">
          <span class="assignee-filter-label">GÃ¶rÃ¼nÃ¼m:</span>
          <div class="assignee-filter-toggle">
            <button type="button" class="assignee-filter-btn" data-assignee="all">TÃ¼m kartlar</button>
            <button type="button" class="assignee-filter-btn" data-assignee="mine">Sadece benim kartlarÄ±m</button>
          </div>
        </div>
        <div class="calendar-header">
          <button id="prevMonthBtn" class="month-nav-btn" aria-label="Ã–nceki ay">&larr;</button>
          <div class="month-label" id="monthLabel"></div>
          <button id="nextMonthBtn" class="month-nav-btn" aria-label="Sonraki ay">&rarr;</button>
        </div>
        <div class="weekdays">
          <div class="weekday">Pzt</div>
          <div class="weekday">Sal</div>
          <div class="weekday">Ã‡ar</div>
          <div class="weekday">Per</div>
          <div class="weekday">Cum</div>
          <div class="weekday">Cmt</div>
          <div class="weekday">Paz</div>
        </div>
        <div class="calendar-grid-wrapper">
          <div class="days" id="daysContainer"></div>
        </div>
      </div>
      </div>

      <div class="side summary-shell">
        <div class="form">
          <h2>GÃ¼n DetayÄ± / Takvim Ã–zeti</h2>
          <div class="summary-scroll-area day-summary-scroll">
            <div class="schedule-search">
              <input
                type="text"
                id="scheduleSearchInput"
                placeholder="Ä°Ã§erik ara"
                aria-label="Takvim aramasÄ±"
              />
            </div>
            <div class="schedule-view-toggle" id="scheduleViewToggle">
              <button type="button" class="schedule-view-btn active" data-view="daily">GÃ¼nlÃ¼k</button>
              <button type="button" class="schedule-view-btn" data-view="weekly">HaftalÄ±k</button>
              <button type="button" class="schedule-view-btn" data-view="monthly">AylÄ±k</button>
            </div>
            <div id="scheduleList" class="schedule-list small"></div>
          </div>
          <div class="excel-upload-container">
            <p class="excel-note">
              Excel yÃ¼klediÄŸinde Ã¶nceki Excel kayÄ±tlarÄ± silinir, manuel eklediÄŸin iÃ§eriklere dokunulmaz.
            </p>
            <div class="excel-upload-actions">
              <button id="excelUploadBtn" class="secondary-btn" style="display:none;">Excel yÃ¼kle</button>
              <button id="resetEntriesBtn" class="danger-btn" style="display:none;">SÄ±fÄ±rla</button>
            </div>
            <div id="resetOptions" class="reset-options">
              <button type="button" class="danger-btn" data-scope="excel">Excel giriÅŸlerini sÄ±fÄ±rla</button>
              <button type="button" class="danger-btn" data-scope="manual">Manuel giriÅŸleri sÄ±fÄ±rla</button>
              <button type="button" class="danger-btn" data-scope="highlights">GÃ¼n renklerini sÄ±fÄ±rla</button>
              <button type="button" class="danger-btn" data-scope="all">TÃ¼m kayÄ±tlarÄ± sÄ±fÄ±rla</button>
              <button type="button" class="secondary-btn" id="resetCancelBtn">VazgeÃ§</button>
            </div>
            <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none;" />
          </div>
        </div>
      </div>

      <!-- GÃ–REV PANOSU -->
      <div class="task-board-panel">
        <div class="task-board-header">
          <h2>GÃ¶revler</h2>
          <button class="task-board-add-btn" id="taskBoardAddBtn" title="Yeni gÃ¶rev ekle">+ GÃ¶rev OluÅŸtur</button>
        </div>
        <div class="task-board-scroll-wrapper">
          <div class="task-board-container" id="taskBoardContainer">
            <!-- TODO: GÃ¶revler iÃ§in backend entegrasyonu eklenecek (Firestore/DB modeli) -->
            <!-- GÃ¶rev kolonlarÄ± JavaScript ile render edilecek -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RAPORLAR -->
  <div id="viewReports" style="display:none;">
    <h2>Raporlar</h2>
    <p class="small" id="reportMonthLabel"></p>
    <p class="small" id="reportFilterLabel"></p>

    <div class="report-controls">
      <span>GÃ¶rÃ¼nÃ¼m:</span>
      <label>
        <input type="radio" name="reportMode" value="month" checked />
        AylÄ±k
      </label>
      <label>
        <input type="radio" name="reportMode" value="range" />
        Tarih aralÄ±ÄŸÄ±
      </label>
      <div class="report-range-inputs" id="reportRangeInputs" style="display:none;">
        <input type="date" id="reportRangeStart" />
        <span class="range-separator">â†’</span>
        <input type="date" id="reportRangeEnd" />
      </div>
    </div>
    <div class="quick-range-buttons" id="quickRangeButtons" style="display:none;">
      <span>KÄ±sayol:</span>
      <button type="button" data-range="7">Son 7 gÃ¼n</button>
      <button type="button" data-range="14">Son 14 gÃ¼n</button>
      <button type="button" data-range="30">Son 30 gÃ¼n</button>
      <button type="button" data-range="90">Son 90 gÃ¼n</button>
    </div>

    <div class="report-content-toggle" id="reportContentToggle">
      <span>Ä°Ã§erik gÃ¶rÃ¼nÃ¼mÃ¼:</span>
      <button type="button" class="report-view-btn active" data-report-view="summary">Ã–zet</button>
      <button type="button" class="report-view-btn" data-report-view="executed">PaylaÅŸÄ±lan iÃ§erikler</button>
    </div>

    <div id="reportsSummaryContainer">
      <div class="report-section">
        <h3>Toplam iÃ§erik</h3>
        <p class="small" id="reportTotal"></p>
      </div>

      <div class="report-section">
        <h3>Platforma gÃ¶re iÃ§erik sayÄ±sÄ±</h3>
        <div class="report-chart-wrapper" id="platformChartWrapper" style="display:none;">
          <canvas id="platformChart"></canvas>
        </div>
        <ul class="report-list" id="reportPlatforms"></ul>
      </div>

      <div class="report-section">
        <h3>Saat aralÄ±ÄŸÄ±na gÃ¶re daÄŸÄ±lÄ±m</h3>
        <div class="report-chart-wrapper" id="timeChartWrapper" style="display:none;">
          <canvas id="timeChart"></canvas>
        </div>
        <ul class="report-list" id="reportTimes"></ul>
      </div>

      <div class="report-section">
        <h3>Ä°Ã§erik olan gÃ¼n sayÄ±sÄ±</h3>
        <p class="small" id="reportDays"></p>
      </div>
    </div>

    <div class="report-section" id="reportsExecutedSection" style="display:none;">
      <div class="report-executed-header">
        <p class="report-summary-line" id="executedSummaryLine"></p>
        <label class="report-checkbox">
          <input type="checkbox" id="executedShowMissedToggle" />
          KaÃ§anlarÄ± da gÃ¶ster
        </label>
      </div>
      <div class="report-table-wrapper">
        <table class="report-table">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Saat</th>
              <th>Metin</th>
              <th>Platformlar</th>
              <th>Durum</th>
              <th>Sorumlu</th>
              <th>Not</th>
            </tr>
          </thead>
          <tbody id="executedTableBody"></tbody>
        </table>
        <p class="small" id="executedEmptyMessage" style="display:none;">Bu aralÄ±kta paylaÅŸÄ±lan iÃ§erik bulunamadÄ±.</p>
      </div>
    </div>
  </div>

  <!-- Modal: SeÃ§ili GÃ¼n -->
  <div class="modal" id="dayModal">
    <div class="modal-content">
      <div class="modal-header-block">
        <div class="modal-header">
          <div class="modal-title" id="modalDateTitle"></div>
          <button class="modal-close" id="modalCloseBtn" aria-label="Kapat">&times;</button>
        </div>
        <div class="modal-toolbar">
        <button id="toggleFormBtn">PaylaÅŸÄ±m oluÅŸtur +</button>
        <div class="highlight-picker color-picker-wrapper" id="highlightColorWrapper">
          <span class="highlight-label">GÃ¼n rengi</span>
          <button type="button" class="color-picker-toggle" id="highlightColorToggle" aria-label="GÃ¼n rengini seÃ§">
            <span class="toggle-swatch"></span>
            <span>SeÃ§</span>
          </button>
          <button type="button" class="highlight-help-btn" id="colorHelpBtn" aria-label="GÃ¼n rengi aÃ§Ä±klamalarÄ±nÄ± gÃ¶ster">?</button>
          <div class="color-picker" id="highlightColorPicker"></div>
          <input type="hidden" id="highlightColorInput" value="white" />
          <div class="color-help-panel" id="colorHelpPanel">
            <div class="color-help-header">
              <span class="color-help-title">GÃ¼n rengi aÃ§Ä±klamalarÄ±</span>
              <button type="button" class="color-help-close" id="colorHelpCloseBtn" aria-label="Kapat">Ã—</button>
            </div>
            <div class="color-help-list" id="colorHelpList"></div>
          </div>
        </div>
      </div>
      </div>
      <div class="modal-body">
        <div class="modal-columns">
          <div class="modal-summary">
            <div class="modal-summary-scroll">
              <div id="modalSummary" class="small"></div>
            </div>
          </div>

          <div id="modalFormSection" class="modal-form-section" style="display: none;">
            <div class="plan-return-banner" id="planReturnBanner">
              <span>Bu paylaÅŸÄ±m geÃ§miÅŸ. Åžu anda planlama formunu dÃ¼zenliyorsun.</span>
              <button type="button" class="link-btn" id="returnToControlBtn">Kontrol moduna dÃ¶n</button>
            </div>
            <div class="form-row">
              <label for="filesInput">PaylaÅŸÄ±lacak dosyalar / linkler</label>
              <textarea
                id="filesInput"
                placeholder="Ã–rn: Drive linki, dosya adlarÄ±"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="textInput">PaylaÅŸÄ±m metni</label>
            <textarea
              id="textInput"
              placeholder="Post metnini buraya yaz"
            ></textarea>
          </div>

          <!-- PaylaÅŸÄ±m saati ve Sorumlu kiÅŸi yan yana (50%-50%) -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-row">
              <label for="timeInput">PaylaÅŸÄ±m saati</label>
              <input type="time" id="timeInput" />
            </div>

            <div class="form-row">
              <label for="ownerSelect">Sorumlu kiÅŸi</label>
              <select id="ownerSelect" style="font-size:12px;padding:6px;border-radius:6px;">
                <option value="">SeÃ§ilmedi</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label for="noteInput">Not (isteÄŸe baÄŸlÄ±)</label>
            <textarea
              id="noteInput"
              placeholder="Ã–rn: gÃ¶rsel gÃ¼ncellenmeli, farklÄ± link kullanÄ±lacak"
            ></textarea>
          </div>

          <div class="form-row">
            <label>Hangi sosyal medya?</label>
            <div class="platform-presets">
              <span>HÄ±zlÄ± seÃ§im:</span>
              <button type="button" class="preset-btn secondary-btn" data-platforms="Instagram Post|Instagram Story|Instagram Reels">Instagram paketi</button>
              <button type="button" class="preset-btn secondary-btn" data-platforms="Instagram Post|Instagram Story|Instagram Reels|Facebook|X|Telegram|Website">Ã‡oklu sosyal</button>
              <button type="button" class="preset-btn secondary-btn" data-platforms="">Temizle</button>
            </div>
            <div class="platforms">
              <label><input type="checkbox" value="Instagram Post" />Instagram Post</label>
              <label><input type="checkbox" value="Instagram Story" />Instagram Story</label>
              <label><input type="checkbox" value="Instagram Reels" />Instagram Reels</label>
              <label><input type="checkbox" value="Facebook" />Facebook</label>
              <label><input type="checkbox" value="X" />X</label>
              <label><input type="checkbox" value="Reddit" />Reddit</label>
              <label><input type="checkbox" value="Discord" />Discord</label>
              <label><input type="checkbox" value="YouTube" />YouTube</label>
              <label><input type="checkbox" value="LinkedIn" />LinkedIn</label>
              <label><input type="checkbox" value="TikTok" />TikTok</label>
              <label><input type="checkbox" value="Telegram" />Telegram</label>
              <label><input type="checkbox" value="Website" />Website</label>
              <label><input type="checkbox" value="Medium" />Medium</label>
            </div>
          </div>

          <div class="form-buttons">
            <div class="inline-color-control color-picker-wrapper" id="entryColorWrapper">
              <span>Kart rengi</span>
              <button type="button" class="color-picker-toggle" id="entryColorToggle" aria-label="PaylaÅŸÄ±m rengini seÃ§">
                <span class="toggle-swatch"></span>
                <span>SeÃ§</span>
              </button>
              <div class="color-picker" id="entryColorPicker"></div>
              <input type="hidden" id="entryColorInput" value="blue" />
            </div>
            <div class="form-button-actions">
              <button id="deleteBtn">Sil</button>
              <button id="clearBtn">Temizle</button>
              <button id="saveBtn">Kaydet</button>
            </div>
          </div>
          <p class="form-success-message" id="saveSuccessMessage">DeÄŸiÅŸiklikler kaydedildi.</p>

          <p class="small">
            Not: Veriler hesabÄ±nÄ±za baÄŸlÄ± olarak sunucuda saklanÄ±r.
          </p>
        </div>
          <div id="modalControlSection" class="modal-control-section" style="display:none;">
            <div class="control-card">
              <div class="control-header">
                <div>
                  <p class="control-label">Planlanan paylaÅŸÄ±m</p>
                  <p class="control-title" id="controlSummaryTitle"></p>
                </div>
                <button type="button" class="link-btn" id="controlEditBtn">DÃ¼zenle</button>
              </div>
              <p class="control-meta" id="controlSummaryMeta"></p>
              <p class="control-meta" id="controlSummaryPlatforms"></p>
              <p class="control-meta" id="controlSummaryOwner"></p>
              <div class="control-note">
                <label for="controlNoteInput">Not ekle (isteÄŸe baÄŸlÄ±)</label>
                <textarea id="controlNoteInput" placeholder="Ã–rn: Link gÃ¼ncellendi, farklÄ± dosya paylaÅŸÄ±ldÄ±..."></textarea>
              </div>
              <div class="control-actions">
                <button type="button" class="success-btn" id="markDoneBtn">âœ… PaylaÅŸÄ±ldÄ±</button>
                <button type="button" class="danger-btn" id="markMissedBtn">âŒ PaylaÅŸÄ±lmadÄ±</button>
              </div>
            </div>
          </div>

          <div id="modalCheckedSection" class="modal-control-section" style="display:none;">
            <div class="control-card">
              <div class="control-header">
                <div>
                  <p class="control-label">Durum</p>
                  <span class="control-status-badge" id="checkedStatusBadge">PaylaÅŸÄ±ldÄ±</span>
                </div>
                <button type="button" class="secondary-btn" id="checkedEditBtn">DÃ¼zenle</button>
              </div>
              <p class="control-meta" id="checkedSummaryMeta"></p>
              <p class="control-meta" id="checkedSummaryPlatforms"></p>
              <p class="control-meta" id="checkedSummaryOwner"></p>
              <div class="control-note-display" id="checkedNoteText" style="display:none;"></div>
              <p class="control-checked-at" id="checkedInfoText"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: GÃ¶rev OluÅŸtur/DÃ¼zenle -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header-block">
        <div class="modal-header">
          <div class="modal-title" id="taskModalTitle">Yeni GÃ¶rev OluÅŸtur</div>
          <button class="modal-close" id="taskModalCloseBtn" aria-label="Kapat">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-form-section">
          
          <div class="form-row">
            <label for="taskNameInput">GÃ¶rev Ä°smi <span style="color:#ef4444;">*</span></label>
            <input 
              type="text" 
              id="taskNameInput" 
              placeholder="GÃ¶rev baÅŸlÄ±ÄŸÄ±nÄ± girin"
              required
            />
          </div>

          <div class="form-row">
            <label for="taskDescriptionInput">GÃ¶rev AÃ§Ä±klamasÄ±</label>
            <textarea
              id="taskDescriptionInput"
              placeholder="GÃ¶revin detaylarÄ±nÄ± aÃ§Ä±klayÄ±n"
              rows="2"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="taskNoteInput">Not (isteÄŸe baÄŸlÄ±)</label>
            <textarea
              id="taskNoteInput"
              placeholder="GÃ¶revle ilgili ek notlar"
              rows="1"
            ></textarea>
          </div>

          <!-- Teslim Tarihi ve Sorumlu KiÅŸi yan yana (2 sÃ¼tun) -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-row" style="margin-bottom:0;">
              <label for="taskDueDateInput">Teslim Tarihi <span style="color:#ef4444;">*</span></label>
              <div style="display:flex;gap:6px;">
                <input 
                  type="date" 
                  id="taskDueDateInput" 
                  style="flex:1;"
                  required
                />
                <input 
                  type="time" 
                  id="taskDueTimeInput" 
                  style="flex:1;"
                  value="17:00"
                />
              </div>
            </div>

            <div class="form-row" style="margin-bottom:0;">
              <label for="taskOwnerSelect">Sorumlu KiÅŸi</label>
              <select id="taskOwnerSelect" style="font-size:12px;padding:6px;border-radius:6px;width:100%;">
                <option value="">SeÃ§ilmedi</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="margin-bottom:8px;margin-top:8px;">
            <label>Ã–ncelik <span style="color:#ef4444;">*</span></label>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                <input type="radio" name="taskPriority" value="low" checked />
                <span style="padding:3px 8px;background:#dbeafe;color:#1e40af;border-radius:6px;font-size:11px;font-weight:600;">DÃ¼ÅŸÃ¼k</span>
              </label>
              <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                <input type="radio" name="taskPriority" value="medium" />
                <span style="padding:3px 8px;background:#fef3c7;color:#92400e;border-radius:6px;font-size:11px;font-weight:600;">Orta</span>
              </label>
              <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                <input type="radio" name="taskPriority" value="high" />
                <span style="padding:3px 8px;background:#fee2e2;color:#991b1b;border-radius:6px;font-size:11px;font-weight:600;">YÃ¼ksek</span>
              </label>
            </div>
          </div>

          <div class="form-buttons" style="margin-top:12px;">
            <div class="form-button-actions">
              <button type="button" id="taskDeleteBtn" style="background:#dc2626;padding:8px 16px;border:none;border-radius:8px;color:white;cursor:pointer;font-size:13px;font-weight:600;display:none;">Sil</button>
              <button type="button" id="taskClearBtn" style="background:#6b7280;padding:8px 16px;border:none;border-radius:8px;color:white;cursor:pointer;font-size:13px;font-weight:600;">Temizle</button>
              <button type="button" id="taskSaveBtn" style="background:#3b82f6;padding:8px 20px;border:none;border-radius:8px;color:white;cursor:pointer;font-size:13px;font-weight:600;">Kaydet</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div id="copyPopoverBackdrop" class="copy-popover-backdrop">
    <div class="copy-popover" id="copyPopover">
      <div class="copy-popover-header">
        <span>Bu paylaÅŸÄ±mÄ± kopyala</span>
        <button type="button" class="color-help-close" id="copyPopoverCloseBtn" aria-label="Kapat">Ã—</button>
      </div>
      <div class="form-row" style="margin-bottom:0;">
        <label for="copyDateInput">Hedef tarih</label>
        <input type="date" id="copyDateInput" />
      </div>
      <div class="copy-popover-actions">
        <button type="button" class="secondary-btn" id="copyCancelBtn">VazgeÃ§</button>
        <button type="button" class="primary-btn" id="copyConfirmBtn">Kopyala</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    // ========================================
    // GLOBAL HATA YÃ–NETÄ°MÄ° SÄ°STEMÄ°
    // ========================================
    
    /**
     * Hata mesajÄ±nÄ± tarayÄ±cÄ±da toast olarak gÃ¶sterir (kÄ±rmÄ±zÄ± arka plan, 5 saniye sonra kaybolur)
     * @param {string} message - GÃ¶sterilecek hata mesajÄ±
     */
    function showErrorToast(message) {
      try {
        const container = document.getElementById('errorToastContainer');
        if (!container) {
          console.error('[Toast] Container bulunamadÄ±:', message);
          return;
        }
        
        // Toast elementi oluÅŸtur
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.textContent = message || 'Bir hata oluÅŸtu';
        
        // Container'a ekle
        container.appendChild(toast);
        
        // 5 saniye sonra kaldÄ±r
        setTimeout(() => {
          toast.classList.add('hiding');
          // Animasyon bitince DOM'dan kaldÄ±r (300ms animasyon sÃ¼resi)
          setTimeout(() => {
            if (toast.parentNode === container) {
              container.removeChild(toast);
            }
          }, 300);
        }, 5000);
      } catch (err) {
        // Toast gÃ¶sterirken bile hata olursa, en azÄ±ndan console'a yazdÄ±r
        console.error('[Toast HatasÄ±]', err, '| Mesaj:', message);
      }
    }
    
    /**
     * BaÅŸarÄ± mesajÄ±nÄ± tarayÄ±cÄ±da toast olarak gÃ¶sterir (yeÅŸil arka plan, 3 saniye sonra kaybolur)
     * @param {string} message - GÃ¶sterilecek baÅŸarÄ± mesajÄ±
     */
    function showSuccessToast(message) {
      try {
        const container = document.getElementById('errorToastContainer');
        if (!container) {
          console.error('[Toast] Container bulunamadÄ±:', message);
          return;
        }
        
        // Toast elementi oluÅŸtur
        const toast = document.createElement('div');
        toast.className = 'error-toast'; // AynÄ± class'Ä± kullanÄ±yoruz ama yeÅŸil yapacaÄŸÄ±z
        toast.style.background = '#10b981'; // YeÅŸil arka plan
        toast.textContent = message || 'Ä°ÅŸlem baÅŸarÄ±lÄ±';
        
        // Container'a ekle
        container.appendChild(toast);
        
        // 3 saniye sonra kaldÄ±r (baÅŸarÄ± mesajlarÄ± daha kÄ±sa)
        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => {
            if (toast.parentNode === container) {
              container.removeChild(toast);
            }
          }, 300);
        }, 3000);
      } catch (err) {
        console.error('[Toast HatasÄ±]', err, '| Mesaj:', message);
      }
    }
    
    /**
     * Global hata yakalayÄ±cÄ± - YakalanmamÄ±ÅŸ JavaScript hatalarÄ± iÃ§in
     */
    window.onerror = function(message, source, lineno, colno, error) {
      const errorMsg = error?.message || message || 'Bilinmeyen bir hata oluÅŸtu';
      const errorDetails = `SatÄ±r: ${lineno || '?'}, SÃ¼tun: ${colno || '?'}`;
      
      console.error('[Global Error]', {
        message: errorMsg,
        source,
        line: lineno,
        column: colno,
        error
      });
      
      // KullanÄ±cÄ±ya toast gÃ¶ster
      showErrorToast(`Hata: ${errorMsg}`);
      
      // Hata propagasyonunu engelle (sayfa Ã§Ã¶kmesini Ã¶nle)
      return true;
    };
    
    /**
     * Global promise rejection yakalayÄ±cÄ± - YakalanmamÄ±ÅŸ async/await hatalarÄ± iÃ§in
     */
    window.addEventListener('unhandledrejection', function(event) {
      const errorMsg = event.reason?.message || event.reason || 'Asenkron iÅŸlem hatasÄ±';
      
      console.error('[Unhandled Promise Rejection]', {
        reason: event.reason,
        promise: event.promise
      });
      
      // KullanÄ±cÄ±ya toast gÃ¶ster
      showErrorToast(`Beklenmeyen hata: ${errorMsg}`);
      
      // VarsayÄ±lan hata davranÄ±ÅŸÄ±nÄ± engelle
      event.preventDefault();
    });
    
    /**
     * GÃ¼venli localStorage.getItem - Try-catch ile korumalÄ±
     * @param {string} key - localStorage anahtarÄ±
     * @param {string} defaultValue - Hata durumunda dÃ¶ndÃ¼rÃ¼lecek varsayÄ±lan deÄŸer
     * @returns {string} localStorage'dan alÄ±nan deÄŸer veya varsayÄ±lan deÄŸer
     */
    function safeLocalStorageGet(key, defaultValue = '') {
      try {
        return localStorage.getItem(key) || defaultValue;
      } catch (err) {
        console.error(`[localStorage.getItem] Hata (${key}):`, err);
        showErrorToast('Yerel depolama okuma hatasÄ±');
        return defaultValue;
      }
    }
    
    /**
     * GÃ¼venli localStorage.setItem - Try-catch ile korumalÄ±
     * @param {string} key - localStorage anahtarÄ±
     * @param {string} value - Kaydedilecek deÄŸer
     * @returns {boolean} BaÅŸarÄ±lÄ± ise true, hata varsa false
     */
    function safeLocalStorageSet(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (err) {
        console.error(`[localStorage.setItem] Hata (${key}):`, err);
        showErrorToast('Yerel depolama yazma hatasÄ±');
        return false;
      }
    }
    
    /**
     * GÃ¼venli localStorage.removeItem - Try-catch ile korumalÄ±
     * @param {string} key - localStorage anahtarÄ±
     * @returns {boolean} BaÅŸarÄ±lÄ± ise true, hata varsa false
     */
    function safeLocalStorageRemove(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (err) {
        console.error(`[localStorage.removeItem] Hata (${key}):`, err);
        showErrorToast('Yerel depolama silme hatasÄ±');
        return false;
      }
    }
    
    // ========================================
    // ANA UYGULAMA KODU BAÅžLANGIÃ‡
    // ========================================
    
    const API_BASE = "https://paylasimtakvimi.onrender.com";
    let authToken = safeLocalStorageGet("contentCalendar_token", "");
    let entriesById = new Map();
    let entriesByDate = new Map();

    const loginOverlay = document.getElementById("loginOverlay");
    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginSubmitBtn = document.getElementById("loginSubmitBtn");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");
    const switchAuthModeBtn = document.getElementById("switchAuthModeBtn");
    const adminPanelBtn = document.getElementById("adminPanelBtn");
    const excelUploadContainer = document.querySelector(".excel-upload-container");
    const excelUploadBtn = document.getElementById("excelUploadBtn");
    const resetEntriesBtn = document.getElementById("resetEntriesBtn");
    const resetOptions = document.getElementById("resetOptions");
    const resetOptionButtons = resetOptions
      ? Array.from(resetOptions.querySelectorAll("button[data-scope]"))
      : [];
    const resetCancelBtn = document.getElementById("resetCancelBtn");
    const excelFileInput = document.getElementById("excelInput");
const adminOverlay = document.getElementById("adminOverlay");
const adminCloseBtn = document.getElementById("adminCloseBtn");
const adminUserList = document.getElementById("adminUserList");
const adminViewSelfBtn = document.getElementById("adminViewSelfBtn");
const adminViewInfo = document.getElementById("adminViewInfo");
const pendingCountBadge = document.getElementById("pendingCountBadge");
const colorDescriptionsSection = document.getElementById("colorDescriptionsSection");
const colorDescriptionsForm = document.getElementById("colorDescriptionsForm");
const colorDescriptionSaveBtn = document.getElementById("colorDescriptionSaveBtn");
const colorDescriptionSaveStatus = document.getElementById("colorDescriptionSaveStatus");
const adminTabButtons = Array.from(document.querySelectorAll(".admin-tab-btn"));
const adminUsersSection = document.getElementById("adminUsersSection");
const colorTabBtn = document.getElementById("colorTabBtn");

    const monthLabel = document.getElementById("monthLabel");
    const daysContainer = document.getElementById("daysContainer");
    const prevBtn = document.getElementById("prevMonthBtn");
    const nextBtn = document.getElementById("nextMonthBtn");

    const filesInput = document.getElementById("filesInput");
    const textInput = document.getElementById("textInput");
    const timeInput = document.getElementById("timeInput");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    deleteBtn.disabled = true;
    const platformInputs = document.querySelectorAll(
      ".platforms input[type='checkbox']"
    );
    const platformPresetButtons = document.querySelectorAll(".preset-btn[data-platforms]");
    const platformInputMap = new Map();
    platformInputs.forEach((cb) => {
      platformInputMap.set(cb.value, cb);
    });
    const scheduleList = document.getElementById("scheduleList");
const scheduleViewToggle = document.getElementById("scheduleViewToggle");
const scheduleViewButtons = scheduleViewToggle
  ? Array.from(scheduleViewToggle.querySelectorAll("button[data-view]"))
  : [];
const saveSuccessMessage = document.getElementById("saveSuccessMessage");
const scheduleSearchInput = document.getElementById("scheduleSearchInput");
const entryColorInput = document.getElementById("entryColorInput");
const highlightColorInput = document.getElementById("highlightColorInput");
const noteInput = document.getElementById("noteInput");
const ownerSelect = document.getElementById("ownerSelect");
const entryColorPicker = document.getElementById("entryColorPicker");
const highlightColorPicker = document.getElementById("highlightColorPicker");
const entryColorToggle = document.getElementById("entryColorToggle");
const highlightColorToggle = document.getElementById("highlightColorToggle");
const entryColorWrapper = document.getElementById("entryColorWrapper");
const highlightColorWrapper = document.getElementById("highlightColorWrapper");
const channelFilter = document.getElementById("channelFilter");
const channelFilterButtons = channelFilter
  ? Array.from(channelFilter.querySelectorAll("button[data-channel]"))
  : [];

// GÃ¶rev Panosu elementleri
const taskBoardContainer = document.getElementById("taskBoardContainer");
const taskBoardAddBtn = document.getElementById("taskBoardAddBtn");
const assigneeFilterButtons = Array.from(
  document.querySelectorAll(".assignee-filter-btn")
);
const copyPopoverBackdrop = document.getElementById("copyPopoverBackdrop");
const copyPopover = document.getElementById("copyPopover");
const copyDateInput = document.getElementById("copyDateInput");
const copyConfirmBtn = document.getElementById("copyConfirmBtn");
const copyCancelBtn = document.getElementById("copyCancelBtn");
const copyPopoverCloseBtn = document.getElementById("copyPopoverCloseBtn");
const colorHelpBtn = document.getElementById("colorHelpBtn");
const colorHelpPanel = document.getElementById("colorHelpPanel");
const colorHelpList = document.getElementById("colorHelpList");
const colorHelpCloseBtn = document.getElementById("colorHelpCloseBtn");
const reportFilterLabel = document.getElementById("reportFilterLabel");
const toastContainer = document.getElementById("toastContainer");
const notificationWrapper = document.getElementById("notificationWrapper");
const notificationToggleBtn = document.getElementById("notificationToggleBtn");
const notificationBadge = document.getElementById("notificationBadge");
const notificationPanel = document.getElementById("notificationPanel");
const notificationListEl = document.getElementById("notificationList");
const notificationEmptyState = document.getElementById("notificationEmptyState");
function showToast(message, variant = "success") {
  if (!toastContainer) return;
  const toast = document.createElement("div");
  toast.className = "toast-message";
  toast.textContent = message;
  if (variant === "error") {
    toast.style.background = "#fee2e2";
    toast.style.color = "#991b1b";
    toast.style.borderColor = "#fecaca";
    toast.style.boxShadow = "0 12px 30px rgba(248, 113, 113, 0.2)";
  }
  toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 1800);
}

    const dayModal = document.getElementById("dayModal");
    const modalDateTitle = document.getElementById("modalDateTitle");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalFormSection = document.getElementById("modalFormSection");
    const modalControlSection = document.getElementById("modalControlSection");
    const modalCheckedSection = document.getElementById("modalCheckedSection");
const controlSummaryTitle = document.getElementById("controlSummaryTitle");
const controlSummaryMeta = document.getElementById("controlSummaryMeta");
const controlSummaryPlatforms = document.getElementById("controlSummaryPlatforms");
const controlSummaryOwner = document.getElementById("controlSummaryOwner");
const controlNoteInput = document.getElementById("controlNoteInput");
    const markDoneBtn = document.getElementById("markDoneBtn");
    const markMissedBtn = document.getElementById("markMissedBtn");
    const controlEditBtn = document.getElementById("controlEditBtn");
    const checkedEditBtn = document.getElementById("checkedEditBtn");
    const checkedStatusBadge = document.getElementById("checkedStatusBadge");
    const checkedSummaryMeta = document.getElementById("checkedSummaryMeta");
const checkedSummaryPlatforms = document.getElementById("checkedSummaryPlatforms");
const checkedSummaryOwner = document.getElementById("checkedSummaryOwner");
    const checkedNoteText = document.getElementById("checkedNoteText");
    const checkedInfoText = document.getElementById("checkedInfoText");
    const planReturnBanner = document.getElementById("planReturnBanner");
    const returnToControlBtn = document.getElementById("returnToControlBtn");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const modalSummary = document.getElementById("modalSummary");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    const tabCalendar = document.getElementById("tabCalendar");
    const tabReports = document.getElementById("tabReports");
    const viewCalendar = document.getElementById("viewCalendar");
    const viewReports = document.getElementById("viewReports");

    const reportMonthLabel = document.getElementById("reportMonthLabel");
    const reportTotal = document.getElementById("reportTotal");
    const reportPlatforms = document.getElementById("reportPlatforms");
    const reportTimes = document.getElementById("reportTimes");
    const reportDays = document.getElementById("reportDays");
    const reportModeRadios = document.querySelectorAll("input[name='reportMode']");
    const reportRangeInputs = document.getElementById("reportRangeInputs");
    const reportRangeStartInput = document.getElementById("reportRangeStart");
    const reportRangeEndInput = document.getElementById("reportRangeEnd");
    const quickRangeButtons = document.getElementById("quickRangeButtons");
    const platformChartWrapper = document.getElementById("platformChartWrapper");
    const platformChartCanvas = document.getElementById("platformChart");
    const timeChartWrapper = document.getElementById("timeChartWrapper");
    const timeChartCanvas = document.getElementById("timeChart");
    const reportContentToggle = document.getElementById("reportContentToggle");
    const reportViewButtons = reportContentToggle
      ? Array.from(reportContentToggle.querySelectorAll("button[data-report-view]"))
      : [];
    const reportsSummaryContainer = document.getElementById("reportsSummaryContainer");
    const reportsExecutedSection = document.getElementById("reportsExecutedSection");
    const executedSummaryLine = document.getElementById("executedSummaryLine");
    const executedTableBody = document.getElementById("executedTableBody");
    const executedEmptyMessage = document.getElementById("executedEmptyMessage");
    const executedShowMissedToggle = document.getElementById("executedShowMissedToggle");

    const monthNames = [
      "Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran",
      "Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"
    ];

    const todayReferenceDate = normalizeToMidnight(new Date());
    const todayDateKey = formatDateKey(todayReferenceDate);

    let currentYear;
    let currentMonth;
    let summaryDateKey = todayDateKey;
    let selectedDateKey = todayDateKey;
let currentDayItems = []; // {id, files, text, time, platforms}[]
let activeItemId = null;
let isRegisterMode = false;
let currentUser = null;
let adminSelectedUserId = null;
let modalForcePlanMode = false;
let copySourceEntry = null;
const excelUploadDefaultText = excelUploadBtn ? excelUploadBtn.textContent : "Excel yÃ¼kle";
let scheduleSearchQuery = "";
let scheduleViewMode = "daily";
let scheduleDailyDateKey = summaryDateKey;
let highlightedDates = new Map();
let saveSuccessTimeout = null;
let activeScheduleSummaryKey = summaryDateKey;
const NOTIFICATION_STORAGE_PREFIX = "goartNotifications_";
const CALENDAR_STORAGE_KEY = "goart_calendar_v2";
const ASSIGNEE_FILTER_STORAGE_KEY = "calendar_assignee_filter";
let notifications = [];
let notificationPanelOpen = false;
const DEFAULT_ENTRY_COLOR = "white";
const DEFAULT_HIGHLIGHT_COLOR = "white";
const COLOR_TOKENS_IN_ORDER = [
  "blue",
  "red",
  "green",
  "yellow",
  "purple",
  "orange",
  "white"
];
const COLOR_HEX_BY_TOKEN = {
  blue: "#2563eb",
  red: "#ef4444",
  green: "#22c55e",
  yellow: "#facc15",
  purple: "#7c3aed",
  orange: "#f97316",
  white: "#ffffff"
};
const COLOR_TOKEN_BY_HEX = Object.fromEntries(
  Object.entries(COLOR_HEX_BY_TOKEN).map(([token, hex]) => [
    hex.toLowerCase(),
    token
  ])
);
const COLOR_DESCRIPTION_DEFAULTS = {
  blue: { label: "Mavi", description: "Topluluk canlÄ± yayÄ±nlarÄ±" },
  red: { label: "KÄ±rmÄ±zÄ±", description: "Acil kampanyalar / duyurular" },
  green: { label: "YeÅŸil", description: "Topluluk baÅŸarÄ±larÄ± / bÃ¼lten" },
  yellow: { label: "SarÄ±", description: "Etkinlik ve hatÄ±rlatmalar" },
  purple: { label: "Mor", description: "Ä°ÅŸ birlikleri / Ã¶zel projeler" },
  orange: { label: "Turuncu", description: "ÃœrÃ¼n gÃ¼ncellemeleri / videolar" },
  white: { label: "Beyaz", description: "VarsayÄ±lan gÃ¼n" }
};
function cloneColorDescriptionDefaults() {
  return JSON.parse(JSON.stringify(COLOR_DESCRIPTION_DEFAULTS));
}
let colorDescriptions = cloneColorDescriptionDefaults();
let colorDescriptionsLoaded = false;
let colorHelpPanelOpen = false;
let activeAdminPanelTab = "users";
const CHANNEL_FILTER_DEFINITIONS = {
  all: {
    label: "TÃ¼mÃ¼",
    matcher: () => true
  },
  instagram: {
    label: "Instagram",
    matcher: (value) => value.toLowerCase().includes("instagram")
  },
  x: {
    label: "X",
    matcher: (value) =>
      value.trim().toLowerCase() === "x" ||
      value.toLowerCase().includes("twitter")
  },
  telegram: {
    label: "Telegram",
    matcher: (value) => value.toLowerCase().includes("telegram")
  },
  facebook: {
    label: "Facebook",
    matcher: (value) => value.toLowerCase().includes("facebook")
  },
  linkedin: {
    label: "LinkedIn",
    matcher: (value) => value.toLowerCase().includes("linkedin")
  },
  youtube: {
    label: "YouTube",
    matcher: (value) => value.toLowerCase().includes("youtube")
  },
  tiktok: {
    label: "TikTok",
    matcher: (value) => value.toLowerCase().includes("tiktok")
  },
  discord: {
    label: "Discord",
    matcher: (value) => value.toLowerCase().includes("discord")
  },
  reddit: {
    label: "Reddit",
    matcher: (value) => value.toLowerCase().includes("reddit")
  },
  website: {
    label: "Website",
    matcher: (value) =>
      value.trim().toLowerCase() === "website" ||
      value.toLowerCase().includes("website") ||
      value.toLowerCase().includes("landing") ||
      value.toLowerCase().includes("web")
  },
  medium: {
    label: "Medium",
    matcher: (value) => value.toLowerCase().includes("medium")
  }
};
const CHANNEL_FILTER_STORAGE_KEY = "calendar_channel_filter";
let activeChannelFilter =
  safeLocalStorageGet(CHANNEL_FILTER_STORAGE_KEY, "all");
if (!CHANNEL_FILTER_DEFINITIONS[activeChannelFilter]) {
  activeChannelFilter = "all";
}
let assigneeFilter =
  safeLocalStorageGet(ASSIGNEE_FILTER_STORAGE_KEY, "all");
if (assigneeFilter !== "all" && assigneeFilter !== "mine") {
  assigneeFilter = "all";
}
let responsibleUsers = [];
const responsibleUserMap = new Map();

function hexToRgb(hex) {
  const value = hex.replace("#", "");
  const bigint = parseInt(value, 16);
  if (value.length === 3) {
    const r = (bigint >> 8) & 0xf;
    const g = (bigint >> 4) & 0xf;
    const b = bigint & 0xf;
    return { r: r * 17, g: g * 17, b: b * 17 };
  }
  return {
    r: (bigint >> 16) & 255,
    g: (bigint >> 8) & 255,
    b: bigint & 255
  };
}

function hexToRgba(hex, alpha = 1) {
  const { r, g, b } = hexToRgb(hex);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function getContrastingTextColor(hex) {
  const { r, g, b } = hexToRgb(hex);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111827" : "#f9fafb";
}

function normalizeHexColor(value) {
  if (!value) return null;
  let hex = value.toString().trim().toLowerCase();
  if (!hex.startsWith("#")) return null;
  if (hex.length === 4) {
    hex =
      "#" +
      hex[1] +
      hex[1] +
      hex[2] +
      hex[2] +
      hex[3] +
      hex[3];
  }
  if (hex.length === 7) return hex;
  return null;
}

function getColorTokenFromHex(value) {
  const normalized = normalizeHexColor(value);
  if (!normalized) return null;
  return COLOR_TOKEN_BY_HEX[normalized] || null;
}

function normalizeColorToken(value, fallback = null) {
  if (!value) return fallback;
  const raw = value.toString().trim().toLowerCase();
  if (COLOR_HEX_BY_TOKEN[raw]) return raw;
  const fromHex = getColorTokenFromHex(value);
  if (fromHex) return fromHex;
  return fallback;
}

function getHexFromColorToken(value, fallbackToken = DEFAULT_ENTRY_COLOR) {
  const token = normalizeColorToken(value, fallbackToken) || fallbackToken;
  return COLOR_HEX_BY_TOKEN[token] || COLOR_HEX_BY_TOKEN[DEFAULT_ENTRY_COLOR];
}

// Ortak modal helper fonksiyonlarÄ±
let scrollPosition = 0;

function preventBodyScroll(e) {
  // Modal iÃ§indeki scroll edilebilir alanlarÄ± kontrol et
  let target = e.target;
  while (target && target !== document.body) {
    const style = window.getComputedStyle(target);
    const overflowY = style.overflowY;
    
    // EÄŸer element scroll edilebilirse ve scroll alanÄ± varsa, event'i geÃ§ir
    if ((overflowY === 'auto' || overflowY === 'scroll') && target.scrollHeight > target.clientHeight) {
      // Element scroll edilebilir, event'i engelleme
      return;
    }
    target = target.parentElement;
  }
  
  // Scroll edilebilir alan yoksa, engelle
  e.preventDefault();
  e.stopPropagation();
  return false;
}

function openModalHelper(modalElement) {
  if (!modalElement) return;
  
  // Mevcut scroll pozisyonunu kaydet
  scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
  
  // Body'yi sabitle
  document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollPosition}px`;
  document.body.style.width = '100%';
  document.body.classList.add('modal-open');
  
  // Wheel ve touch event'lerini kontrol et
  document.addEventListener('wheel', preventBodyScroll, { passive: false });
  document.addEventListener('touchmove', preventBodyScroll, { passive: false });
  
  modalElement.style.display = "flex";
}

function closeModalHelper(modalElement) {
  if (!modalElement) return;
  modalElement.style.display = "none";
  
  // BaÅŸka aÃ§Ä±k modal var mÄ± kontrol et
  const anyModalOpen = document.querySelector('.modal[style*="display: flex"], .login-overlay.active, .admin-overlay.active');
  if (!anyModalOpen) {
    // Event listener'larÄ± kaldÄ±r
    document.removeEventListener('wheel', preventBodyScroll, { passive: false });
    document.removeEventListener('touchmove', preventBodyScroll, { passive: false });
    
    // Body'yi eski haline getir
    document.body.classList.remove('modal-open');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    
    // Scroll pozisyonunu geri yÃ¼kle
    window.scrollTo(0, scrollPosition);
  }
}

function getEntryDateTime(entry) {
  if (!entry || !entry.date) return null;
  const timeValue =
    entry.time && /^\d{2}:\d{2}$/.test(entry.time) ? entry.time : "23:59";
  const timestamp = new Date(`${entry.date}T${timeValue}:00`);
  return Number.isNaN(timestamp.getTime()) ? null : timestamp;
}

function readSharedCalendarEntries() {
  try {
    const raw = safeLocalStorageGet(CALENDAR_STORAGE_KEY, null);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error('[readSharedCalendarEntries] JSON parse hatasÄ±:', err);
    showErrorToast('Takvim verileri okunamadÄ±');
    return [];
  }
}

let isBootstrappingFromStorage = false;

function writeSharedCalendarEntries(entries) {
  try {
    const success = safeLocalStorageSet(CALENDAR_STORAGE_KEY, JSON.stringify(entries));
    if (!success) {
      console.error('[writeSharedCalendarEntries] KayÄ±t baÅŸarÄ±sÄ±z');
    }
  } catch (err) {
    console.error('[writeSharedCalendarEntries] JSON stringify hatasÄ±:', err);
    showErrorToast('Takvim verileri kaydedilemedi');
  }
}

function persistEntriesToSharedStorage() {
  if (isBootstrappingFromStorage) return;
  const payload = Array.from(entriesById.values());
  writeSharedCalendarEntries(payload);
}

function bootstrapEntriesFromSharedStorage() {
  const stored = readSharedCalendarEntries();
  if (stored && stored.length) {
    isBootstrappingFromStorage = true;
    rebuildEntriesCache(stored);
    isBootstrappingFromStorage = false;
  }
}

bootstrapEntriesFromSharedStorage();

function isEntryPast(entry) {
  const dt = getEntryDateTime(entry);
  if (!dt) return false;
  return dt.getTime() < Date.now();
}

function formatStatusLabel(status) {
  if (status === "done") return "PaylaÅŸÄ±ldÄ±";
  if (status === "missed") return "PaylaÅŸÄ±lmadÄ±";
  return "PlanlandÄ±";
}

function filterPlatformsByChannel(platforms = [], filterId = "all") {
  if (!Array.isArray(platforms) || !platforms.length) return [];
  if (!filterId || filterId === "all") return platforms.slice();
  const definition = CHANNEL_FILTER_DEFINITIONS[filterId];
  if (!definition) return platforms.slice();
  return platforms.filter((platform) =>
    definition.matcher(String(platform || ""))
  );
}

function formatPlatformsLabel(platforms = [], options = {}) {
  const filterId = options.filterId || "all";
  const scoped =
    filterPlatformsByChannel(platforms, filterId) || [];
  if (!scoped.length) {
    return filterId !== "all"
      ? getChannelFilterLabel(filterId)
      : "Platform seÃ§ilmedi";
  }
  return scoped.join(", ");
}

function formatEntryPreviewText(entry, limit = 120) {
  if (!entry) return "Metin yok";
  const raw = (entry.text || entry.files || "").trim();
  if (!raw) return "Metin yok";
  if (raw.length <= limit) return raw;
  return raw.slice(0, Math.max(0, limit - 3)) + "...";
}

function getColorDescriptionForKey(key) {
  return (
    colorDescriptions[key] ||
    COLOR_DESCRIPTION_DEFAULTS[key] || {
      label: key,
      description: ""
    }
  );
}

function renderColorHelpList() {
  if (!colorHelpList) return;
  colorHelpList.innerHTML = "";
  COLOR_TOKENS_IN_ORDER.forEach((token) => {
    if (!COLOR_HEX_BY_TOKEN[token]) return;
    const info = getColorDescriptionForKey(token);
    const row = document.createElement("div");
    row.className = "color-help-row";
    const dot = document.createElement("span");
    dot.className = "color-help-dot";
    dot.style.backgroundColor = COLOR_HEX_BY_TOKEN[token];
    row.appendChild(dot);
    const text = document.createElement("span");
    text.textContent = `${info.label} â€“ ${info.description || "AÃ§Ä±klama eklenmemiÅŸ"}`;
    row.appendChild(text);
    colorHelpList.appendChild(row);
  });
}

renderColorHelpList();

function getResponsibleEmailById(ownerId) {
  if (ownerId === null || typeof ownerId === "undefined") return "";
  return responsibleUserMap.get(Number(ownerId)) || "";
}

function getCurrentUserEmail() {
  return currentUser && currentUser.email ? currentUser.email : "";
}

function getCurrentUserDisplayName() {
  if (!currentUser) return "Takvim";
  return (
    currentUser.fullName ||
    currentUser.name ||
    currentUser.email ||
    "Takvim"
  );
}

function getNotificationStorageKey(email) {
  if (!email) return null;
  return `${NOTIFICATION_STORAGE_PREFIX}${email.toLowerCase()}`;
}

function readNotificationsForEmail(email) {
  const key = getNotificationStorageKey(email);
  if (!key) return [];
  try {
    const raw = safeLocalStorageGet(key, null);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error('[readNotificationsForEmail] JSON parse hatasÄ±:', err);
    showErrorToast('Bildirimler okunamadÄ±');
    return [];
  }
}

function writeNotificationsForEmail(email, list) {
  const key = getNotificationStorageKey(email);
  if (!key) return;
  try {
    const success = safeLocalStorageSet(key, JSON.stringify(list));
    if (!success) {
      console.error('[writeNotificationsForEmail] KayÄ±t baÅŸarÄ±sÄ±z');
    }
  } catch (err) {
    console.error('[writeNotificationsForEmail] JSON stringify hatasÄ±:', err);
    showErrorToast('Bildirimler kaydedilemedi');
  }
}

function normalizeNotificationRecord(item) {
  if (!item || typeof item !== "object") return null;
  const createdAt =
    typeof item.createdAt === "number"
      ? item.createdAt
      : Date.parse(item.createdAt || "") || Date.now();
  return {
    id: item.id || `ntf_${createdAt}_${Math.random().toString(36).slice(2, 8)}`,
    createdAt,
    shareId: item.shareId || item.cardId || null,
    dayKey: item.dayKey || item.dateKey || null,
    title: item.title || "Yeni iÃ§erik",
    from: item.fromEmail || item.from || item.userEmail || "Takvim",
    to: item.to || item.userEmail || "",
    message:
      item.message ||
      `${item.fromEmail || item.from || "Takvim"} seni "${item.title || "bu kart"}" iÃ§in sorumlu yaptÄ±.`,
    isRead: Boolean(item.isRead)
  };
}

function sortNotificationsDesc(list) {
  return list
    .slice()
    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
}

// Backend API'den bildirimleri Ã§ek
async function loadNotificationsForCurrentUser() {
  const email = getCurrentUserEmail();
  if (!email) {
    notifications = [];
    updateNotificationBadge();
    renderNotificationList();
    return;
  }
  
  try {
    // Backend'den bildirimleri al
    const response = await apiFetch("/notifications");
    if (response.ok) {
      const data = await response.json();
      notifications = sortNotificationsDesc(data);
      updateNotificationBadge();
      renderNotificationList();
    } else {
      console.error('[loadNotificationsForCurrentUser] API hatasÄ±:', response.status);
      // Fallback: localStorage'dan yÃ¼kle (eski sistem iÃ§in backward compatibility)
      const stored = readNotificationsForEmail(email)
        .map((item) => normalizeNotificationRecord(item))
        .filter(Boolean);
      notifications = sortNotificationsDesc(stored);
      updateNotificationBadge();
      renderNotificationList();
    }
  } catch (err) {
    console.error('[loadNotificationsForCurrentUser] Hata:', err);
    // Fallback: localStorage'dan yÃ¼kle
    const stored = readNotificationsForEmail(email)
      .map((item) => normalizeNotificationRecord(item))
      .filter(Boolean);
    notifications = sortNotificationsDesc(stored);
    updateNotificationBadge();
    renderNotificationList();
  }
}

function updateNotificationBadge() {
  if (!notificationBadge) return;
  const unreadCount = notifications.filter((n) => !n.isRead).length;
  if (unreadCount > 0) {
    notificationBadge.textContent =
      unreadCount > 99 ? "99+" : String(unreadCount);
    notificationBadge.style.display = "inline-flex";
  } else {
    notificationBadge.textContent = "";
    notificationBadge.style.display = "none";
  }
}

function renderNotificationList() {
  if (!notificationListEl || !notificationEmptyState) return;
  const markAllReadBtn = document.getElementById("markAllReadBtn");
  const clearAllBtn = document.getElementById("clearAllNotificationsBtn");
  notificationListEl.innerHTML = "";
  
  if (!notifications.length) {
    notificationEmptyState.style.display = "block";
    if (markAllReadBtn) markAllReadBtn.style.display = "none";
    if (clearAllBtn) clearAllBtn.style.display = "none";
    return;
  }
  
  notificationEmptyState.style.display = "none";
  const hasUnread = notifications.some(n => !n.isRead);
  if (markAllReadBtn) {
    markAllReadBtn.style.display = hasUnread ? "block" : "none";
  }
  // "TÃ¼mÃ¼nÃ¼ sil" butonu her zaman gÃ¶rÃ¼nÃ¼r (bildirim varsa)
  if (clearAllBtn) {
    clearAllBtn.style.display = "block";
  }
  
  notifications.forEach((notification) => {
    const item = document.createElement("button");
    item.type = "button";
    item.className = "notification-item";
    if (!notification.isRead) {
      item.classList.add("unread");
    }
    item.dataset.notificationId = notification.id;

    // Sol nokta (sadece okunmamÄ±ÅŸ)
    if (!notification.isRead) {
      const dot = document.createElement("span");
      dot.className = "notification-dot";
      dot.setAttribute("aria-hidden", "true");
      item.appendChild(dot);
    }

    // Ä°Ã§erik container
    const content = document.createElement("div");
    content.className = "notification-content";

    // Header: BaÅŸlÄ±k + Tarih
    const header = document.createElement("div");
    header.className = "notification-header";
    
    const titleText = document.createElement("div");
    titleText.className = "notification-item-title";
    titleText.textContent = notification.title || "Yeni iÃ§erik";
    header.appendChild(titleText);
    
    const timestamp = document.createElement("div");
    timestamp.className = "notification-timestamp";
    timestamp.textContent = formatNotificationTimestamp(notification.createdAt);
    header.appendChild(timestamp);
    
    content.appendChild(header);

    // Body: Mesaj (kart adÄ± olmadan)
    const bodyRow = document.createElement("div");
    bodyRow.className = "notification-item-body";
    const cleanMessage = (notification.message || "")
      .replace(/seni ÅŸu karta sorumlu yaptÄ±:.*$/i, "seni bu karta sorumlu yaptÄ±.")
      .replace(/seni ".*?" iÃ§in sorumlu yaptÄ±/i, "seni bu karta sorumlu yaptÄ±");
    bodyRow.textContent = cleanMessage || `${notification.fromEmail || notification.from || "Takvim"} seni bu karta sorumlu yaptÄ±.`;
    content.appendChild(bodyRow);

    item.appendChild(content);

    item.addEventListener("click", (event) => {
      event.stopPropagation();
      handleNotificationItemClick(notification.id);
    });
    notificationListEl.appendChild(item);
  });
}

function formatNotificationTimestamp(value) {
  if (!value) return "";
  const date = typeof value === "number" ? new Date(value) : new Date(value || 0);
  if (Number.isNaN(date.getTime())) return "";
  
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const targetDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const diffMs = today.getTime() - targetDay.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  const timeStr = date.toLocaleTimeString("tr-TR", {
    hour: "2-digit",
    minute: "2-digit"
  });
  
  if (diffDays === 0) {
    return `BugÃ¼n Â· ${timeStr}`;
  } else if (diffDays === 1) {
    return `DÃ¼n Â· ${timeStr}`;
  } else {
    const dateStr = date.toLocaleDateString("tr-TR", {
      day: "numeric",
      month: "long",
      year: "numeric"
    });
    return `${dateStr} Â· ${timeStr}`;
  }
}

function toggleNotificationPanel(forceOpen = null) {
  if (!notificationPanel || !notificationToggleBtn) return;
  const shouldOpen =
    forceOpen === null ? !notificationPanelOpen : Boolean(forceOpen);
  if (shouldOpen) {
    notificationPanel.classList.add("open");
    notificationPanelOpen = true;
    notificationToggleBtn.setAttribute("aria-expanded", "true");
    // Body scroll'u kilitle
    document.body.style.overflow = 'hidden';
  } else {
    closeNotificationPanel();
  }
}

function closeNotificationPanel() {
  if (!notificationPanel || !notificationToggleBtn) return;
  notificationPanel.classList.remove("open");
  notificationPanelOpen = false;
  notificationToggleBtn.setAttribute("aria-expanded", "false");
  // Body scroll kilidini aÃ§
  document.body.style.overflow = '';
}

function handleNotificationItemClick(notificationId) {
  const target = notifications.find((n) => n.id === notificationId);
  if (!target) return;
  markNotificationAsRead(notificationId);
  closeNotificationPanel();
  focusNotificationTarget(target);
}

function focusNotificationTarget(notification) {
  if (!notification) return;
  const targetId = notification.shareId || notification.cardId || null;
  
  // GÃ¶rev bildirimi mi kontrol et (cardId "task_" ile baÅŸlÄ±yorsa)
  if (targetId && typeof targetId === 'string' && targetId.startsWith('task_')) {
    // GÃ¶rev ID'sini Ã§Ä±kar (Ã¶rn: "task_123" -> "123")
    const taskId = parseInt(targetId.replace('task_', ''), 10);
    if (!isNaN(taskId) && typeof openTaskModal === 'function') {
      openTaskModal(taskId); // GÃ¶rev modalÄ±nÄ± aÃ§
      return; // Takvim mantÄ±ÄŸÄ±na dÃ¼ÅŸme
    }
  }
  
  // Takvim paylaÅŸÄ±mÄ± bildirimi ise (eski mantÄ±k devam eder)
  const entry =
    targetId && entriesById.get(targetId)
      ? entriesById.get(targetId)
      : null;
  const dateKey = entry ? entry.date : notification.dayKey || notification.dateKey || null;
  if (dateKey) {
    focusDayFromSchedule(dateKey, targetId);
  }
}

// Bildirimi okundu olarak iÅŸaretle (Backend API kullan)
async function markNotificationAsRead(notificationId) {
  if (!notificationId) return;
  
  // Ã–nce local state'i gÃ¼ncelle (UI hÄ±zlÄ± tepki versin)
  let changed = false;
  notifications = notifications.map((item) => {
    if (item.id === notificationId && !item.isRead) {
      changed = true;
      return { ...item, isRead: true };
    }
    return item;
  });
  
  if (changed) {
    updateNotificationBadge();
    renderNotificationList();
    
    // Sonra backend'e kaydet
    try {
      await apiFetch(`/notifications/${notificationId}/read`, {
        method: "PATCH"
      });
    } catch (err) {
      console.error('[markNotificationAsRead] API hatasÄ±:', err);
      // Fallback: localStorage'a kaydet (eski sistem iÃ§in)
      const email = getCurrentUserEmail();
      if (email) {
        const stored = readNotificationsForEmail(email).map((item) =>
          item.id === notificationId ? { ...item, isRead: true } : item
        );
        writeNotificationsForEmail(email, stored);
      }
    }
  }
}

// Backend'e bildirim gÃ¶nder (API kullan)
async function addNotificationForAssignee({
  userEmail,
  shareId,
  cardId,
  title,
  message,
  dayKey,
  dateKey
}) {
  const targetId = shareId || cardId;
  // Bildirim oluÅŸturulamÄ±yorsa debug logla
  if (!userEmail || !targetId) {
    console.warn('[addNotificationForAssignee] Bildirim oluÅŸturulamadÄ±:', { userEmail, targetId, shareId, cardId });
    return;
  }
  
  // Backend API'ye bildirim gÃ¶nder
  try {
    const response = await apiFetch("/notifications", {
      method: "POST",
      body: JSON.stringify({
        targetUserEmail: userEmail,
        title: title || "Yeni iÃ§erik",
        message: message || `${getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim"} seni ÅŸu karta sorumlu yaptÄ±: ${title || "Bu kart"}`,
        shareId: shareId || null,
        cardId: cardId || null,
        dayKey: dayKey || dateKey || null
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('[addNotificationForAssignee] Bildirim baÅŸarÄ±yla gÃ¶nderildi:', data);
      
      // EÄŸer bildirim kendi kullanÄ±cÄ±mÄ±za gÃ¶nderildiyse, local state'i gÃ¼ncelle
      if (userEmail === getCurrentUserEmail()) {
        notifications = sortNotificationsDesc([data, ...notifications]);
        updateNotificationBadge();
        renderNotificationList();
      }
    } else {
      console.error('[addNotificationForAssignee] API hatasÄ±:', response.status);
      // Fallback: localStorage'a kaydet (eski sistem iÃ§in)
      fallbackAddNotificationLocally({ userEmail, shareId, cardId, title, message, dayKey, dateKey });
    }
  } catch (err) {
    console.error('[addNotificationForAssignee] Hata:', err);
    // Fallback: localStorage'a kaydet
    fallbackAddNotificationLocally({ userEmail, shareId, cardId, title, message, dayKey, dateKey });
  }
}

// Fallback: Eski localStorage sistemi (backward compatibility)
function fallbackAddNotificationLocally({ userEmail, shareId, cardId, title, message, dayKey, dateKey }) {
  const targetId = shareId || cardId;
  const notification = {
    id: `ntf_${targetId}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
    createdAt: Date.now(),
    shareId: targetId,
    dayKey: dayKey || dateKey || null,
    title: title || "Yeni iÃ§erik",
    from: getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim",
    to: userEmail,
    message: message || `${getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim"} seni ÅŸu karta sorumlu yaptÄ±: ${title || "Bu kart"}`,
    isRead: false
  };
  const stored = readNotificationsForEmail(userEmail);
  stored.push(notification);
  writeNotificationsForEmail(userEmail, stored);
  if (userEmail === getCurrentUserEmail()) {
    notifications = sortNotificationsDesc(stored);
    updateNotificationBadge();
    renderNotificationList();
  }
}

// TÃ¼m bildirimleri okundu olarak iÅŸaretle (Backend API kullan)
async function markAllNotificationsAsRead() {
  if (!notifications.length) return;
  
  // Ã–nce local state'i gÃ¼ncelle (UI hÄ±zlÄ± tepki versin)
  let changed = false;
  notifications = notifications.map((item) => {
    if (!item.isRead) {
      changed = true;
      return { ...item, isRead: true };
    }
    return item;
  });
  
  if (changed) {
    updateNotificationBadge();
    renderNotificationList();
    
    // Sonra backend'e kaydet
    try {
      await apiFetch("/notifications/mark-all-read", {
        method: "POST"
      });
    } catch (err) {
      console.error('[markAllNotificationsAsRead] API hatasÄ±:', err);
      // Fallback: localStorage'a kaydet
      const email = getCurrentUserEmail();
      if (email) {
        writeNotificationsForEmail(email, notifications);
      }
    }
  }
}

// TÃ¼m bildirimleri sil (localStorage + backend)
async function clearAllNotifications() {
  if (!notifications.length) return;
  
  // KullanÄ±cÄ±ya onay sor (yanlÄ±ÅŸlÄ±kla silmeyi Ã¶nle)
  if (!confirm("TÃ¼m bildirimler silinecek. Emin misiniz?")) {
    return;
  }
  
  // Local state'i temizle
  notifications = [];
  
  // UI'yi gÃ¼ncelle
  updateNotificationBadge();
  renderNotificationList();
  
  // localStorage'dan temizle
  const email = getCurrentUserEmail();
  if (email) {
    try {
      localStorage.removeItem(`notifications_${email}`);
    } catch (err) {
      console.error('[clearAllNotifications] localStorage temizleme hatasÄ±:', err);
    }
  }
  
  // Backend'den temizle
  try {
    const response = await apiFetch("/notifications/clear-all", {
      method: "DELETE"
    });
    
    // BaÅŸarÄ±lÄ± silme sonrasÄ± UI gÃ¼ncelle
    notifications = []; // Global state temizle
    updateNotificationBadge(); // Badge'i gÃ¼ncelle (sayÄ± 0 olacak)
    renderNotificationList(); // Liste boÅŸaltÄ±lacak
    
    showToast("TÃ¼m bildirimler temizlendi", "success");
    
  } catch (err) {
    console.error('[clearAllNotifications] API hatasÄ±:', err);
    
    // API baÅŸarÄ±sÄ±z olsa da local temizlik yapÄ±ldÄ±
    // KullanÄ±cÄ± hÃ¢lÃ¢ bildirimleri gÃ¶rmÃ¼yor ama backend'de duruyor
    notifications = []; // Local state temizle
    updateNotificationBadge();
    renderNotificationList();
    
    showToast("Bildirimler ekranÄ±nÄ±zdan kaldÄ±rÄ±ldÄ± (senkronizasyon hatasÄ±)", "warning");
  }
}

function updateNotificationVisibility(isLoggedIn) {
  if (!notificationWrapper) return;
  notificationWrapper.style.display = isLoggedIn ? "inline-flex" : "none";
  if (!isLoggedIn) {
    closeNotificationPanel();
    notifications = [];
    updateNotificationBadge();
    renderNotificationList();
  }
}

function applyPlatformPreset(values = []) {
  platformInputs.forEach((cb) => {
    cb.checked = false;
  });
  values.forEach((value) => {
    const trimmed = value.trim();
    if (!trimmed) return;
    const input = platformInputMap.get(trimmed);
    if (input) input.checked = true;
  });
}

function openCopyPopover(entry) {
  if (!copyPopover || !copyDateInput || !copyPopoverBackdrop) return;
  copySourceEntry = entry;
  copyDateInput.value = entry.date || "";
  copyPopoverBackdrop.classList.add("active");
  copyPopover.classList.add("active");
  requestAnimationFrame(() => copyDateInput.focus());
}

function closeCopyPopover() {
  if (!copyPopover || !copyPopoverBackdrop) return;
  copySourceEntry = null;
  copyPopoverBackdrop.classList.remove("active");
  copyPopover.classList.remove("active");
}

async function handleCopyConfirm() {
  if (!copySourceEntry) return;
  if (!authToken) {
    showLoginOverlay();
    return;
  }
  if (!isViewingOwnData()) {
    alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
    return;
  }
  if (!copyDateInput || !copyDateInput.value) {
    alert("LÃ¼tfen hedef tarihi seÃ§.");
    return;
  }
  const targetDate = copyDateInput.value;
  if (!/^\d{4}-\d{2}-\d{2}$/.test(targetDate)) {
    alert("Tarih formatÄ± geÃ§ersiz.");
    return;
  }

  const source = copySourceEntry;
  const payload = {
    date: targetDate,
    time: source.time || "",
    text: source.text || "",
    files: source.files || "",
    communication: source.communication || "",
    communicationType:
      source.communication_type || source.communicationType || "",
    status: "planned",
    platforms: Array.isArray(source.platforms) ? [...source.platforms] : [],
    color: normalizeColorToken(source.color, null) || "",
    note: source.note || "",
    checkedAt: null,
    ownerId: source.owner_id || null
  };

  if (copyConfirmBtn) copyConfirmBtn.disabled = true;
  try {
    await createEntry(payload);
    renderCalendar();
    updateScheduleList();
    if (selectedDateKey) {
      currentDayItems = loadDayData(selectedDateKey).items;
      renderModalSummaryList();
    }
    closeCopyPopover();
    showToast("PaylaÅŸÄ±m kopyalandÄ±.");
  } catch (err) {
    console.error('[copyEntry] Hata:', err);
    showErrorToast(err.message || "PaylaÅŸÄ±m kopyalanamadÄ±");
  } finally {
    if (copyConfirmBtn) copyConfirmBtn.disabled = false;
  }
}

function toggleColorHelpPanel(forceOpen = null) {
  if (!colorHelpPanel) return;
  const shouldOpen =
    forceOpen !== null ? forceOpen : !colorHelpPanel.classList.contains("active");
  if (shouldOpen) {
    colorHelpPanel.classList.add("active");
    colorHelpPanelOpen = true;
  } else {
    colorHelpPanel.classList.remove("active");
    colorHelpPanelOpen = false;
  }
}

function entryMatchesChannelFilter(entry, filterId = "all") {
  if (!entry || !entry.platforms) return filterId === "all";
  const definition = CHANNEL_FILTER_DEFINITIONS[filterId];
  if (!definition) return true;
  return entry.platforms.some((platform) =>
    definition.matcher(String(platform || ""))
  );
}

function dayMatchesChannelFilter(items, filterId = "all") {
  if (filterId === "all") return true;
  return items.some((item) => entryMatchesChannelFilter(item, filterId));
}

function filterEntriesByChannel(items, filterId = "all") {
  if (filterId === "all") return items.slice();
  return items.filter((item) => entryMatchesChannelFilter(item, filterId));
}

function getEntryOwnerEmail(entry) {
  if (!entry) return "";
  return getOwnerLabel(entry.owner_id) || "";
}

function entryAssignedToCurrentUser(entry) {
  const currentEmail = getCurrentUserEmail();
  if (!currentEmail) return false;
  const ownerEmail = getEntryOwnerEmail(entry);
  if (!ownerEmail) return false;
  return ownerEmail.toLowerCase() === currentEmail.toLowerCase();
}

function entryMatchesAssigneeFilter(entry) {
  if (assigneeFilter !== "mine") return true;
  return entryAssignedToCurrentUser(entry);
}

function filterEntriesByAssignee(items = []) {
  if (assigneeFilter !== "mine") return items.slice();
  return items.filter((item) => entryMatchesAssigneeFilter(item));
}

function getChannelFilterLabel(filterId) {
  return CHANNEL_FILTER_DEFINITIONS[filterId]
    ? CHANNEL_FILTER_DEFINITIONS[filterId].label
    : CHANNEL_FILTER_DEFINITIONS.all.label;
}

function setActiveChannelFilter(nextFilter) {
  if (!CHANNEL_FILTER_DEFINITIONS[nextFilter]) {
    nextFilter = "all";
  }
  activeChannelFilter = nextFilter;
  safeLocalStorageSet(CHANNEL_FILTER_STORAGE_KEY, activeChannelFilter);
  channelFilterButtons.forEach((btn) => {
    const target = btn.dataset.channel || "all";
    btn.classList.toggle("active", target === activeChannelFilter);
  });
  renderCalendar();
  updateScheduleList();
  if (viewReports.style.display !== "none") renderReports();
  updateReportFilterLabel();
}

function updateAssigneeFilterUI() {
  if (!assigneeFilterButtons.length) return;
  assigneeFilterButtons.forEach((btn) => {
    const target = btn.dataset.assignee || "all";
    btn.classList.toggle("active", target === assigneeFilter);
  });
}

function setAssigneeFilter(nextFilter) {
  const allowedViews = ["all", "mine"];
  const normalized = allowedViews.includes(nextFilter) ? nextFilter : "all";
  if (assigneeFilter === normalized) return;
  assigneeFilter = normalized;
  safeLocalStorageSet(ASSIGNEE_FILTER_STORAGE_KEY, assigneeFilter);
  updateAssigneeFilterUI();
  renderCalendar();
  updateScheduleList();
  if (viewReports.style.display !== "none") renderReports();
}

function setScheduleViewMode(nextMode) {
  const allowedViews = ["daily", "weekly", "monthly"];
  const normalized = allowedViews.includes(nextMode) ? nextMode : "daily";
  if (scheduleViewMode === normalized) return;
  scheduleViewMode = normalized;
  if (scheduleViewMode === "daily") {
    scheduleDailyDateKey = summaryDateKey;
    activeScheduleSummaryKey = summaryDateKey;
  }
  scheduleViewButtons.forEach((btn) => {
    const target = btn.dataset.view || "daily";
    btn.classList.toggle("active", target === scheduleViewMode);
  });
  updateScheduleList();
}

function updateReportFilterLabel() {
  if (!reportFilterLabel) return;
  reportFilterLabel.textContent = `Kanal filtresi: ${getChannelFilterLabel(
    activeChannelFilter
  )}`;
}

async function ensureColorDescriptionsLoaded(force = false) {
  if (colorDescriptionsLoaded && !force) return;
  await loadColorDescriptions();
}

const COLOR_SETTINGS_STORAGE_KEY = "goartCalendarColorSettings";

function readColorSettingsFromStorage() {
  try {
    const raw = safeLocalStorageGet(COLOR_SETTINGS_STORAGE_KEY, null);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : null;
  } catch (err) {
    console.error('[readColorSettingsFromStorage] JSON parse hatasÄ±:', err);
    showErrorToast('Renk ayarlarÄ± okunamadÄ±');
    return null;
  }
}

function writeColorSettingsToStorage(settings) {
  try {
    const success = safeLocalStorageSet(
      COLOR_SETTINGS_STORAGE_KEY,
      JSON.stringify(settings)
    );
    if (!success) {
      console.error('[writeColorSettingsToStorage] KayÄ±t baÅŸarÄ±sÄ±z');
    }
  } catch (err) {
    console.error('[writeColorSettingsToStorage] JSON stringify hatasÄ±:', err);
    showErrorToast('Renk ayarlarÄ± kaydedilemedi');
  }
}

async function loadColorDescriptions(force = false) {
  if (colorDescriptionsLoaded && !force) return;
  const merged = cloneColorDescriptionDefaults();
  const stored = readColorSettingsFromStorage();
  if (stored && typeof stored === "object") {
    Object.entries(stored).forEach(([key, value]) => {
      if (!merged[key]) return;
      merged[key] = {
        label:
          value && typeof value.label === "string" && value.label.trim()
            ? value.label.trim()
            : merged[key].label,
        description:
          value && typeof value.description === "string"
            ? value.description
            : merged[key].description
      };
    });
  }
  colorDescriptions = merged;
  colorDescriptionsLoaded = true;
  renderColorHelpList();
  refreshColorDescriptionSection();
}

async function loadResponsibleUsers() {
  if (!authToken) {
    responsibleUsers = [];
    responsibleUserMap.clear();
    populateOwnerSelectOptions();
    populateTaskOwnerSelect(); // GÃ¶rev modalÄ± iÃ§in de dropdown'Ä± gÃ¼ncelle
    return;
  }
  try {
    const response = await apiFetch("/users/approved");
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const data = await response.json();
    responsibleUsers = Array.isArray(data) ? data : [];
    responsibleUserMap.clear();
    responsibleUsers.forEach((user) => {
      if (user && typeof user.id !== "undefined") {
        responsibleUserMap.set(Number(user.id), user.email || "");
      }
    });
    console.log("Sorumlu kullanÄ±cÄ±lar yÃ¼klendi:", responsibleUsers.length, "kullanÄ±cÄ±");
    populateOwnerSelectOptions(); // PaylaÅŸÄ±m formu iÃ§in dropdown'Ä± gÃ¼ncelle
    populateTaskOwnerSelect(); // GÃ¶rev modalÄ± iÃ§in de dropdown'Ä± gÃ¼ncelle
  } catch (err) {
    console.error("Sorumlu kiÅŸi listesi yÃ¼klenemedi:", err);
    responsibleUsers = [];
    responsibleUserMap.clear();
    populateOwnerSelectOptions();
    populateTaskOwnerSelect(); // GÃ¶rev modalÄ± iÃ§in de dropdown'Ä± gÃ¼ncelle
  }
  if (
    selectedDateKey &&
    dayModal &&
    dayModal.style.display === "flex" &&
    currentDayItems.length
  ) {
    currentDayItems = loadDayData(selectedDateKey).items;
    renderModalSummaryList();
  }
}

function populateOwnerSelectOptions() {
  if (!ownerSelect) return;
  const previousValue = ownerSelect.value;
  ownerSelect.innerHTML = '<option value=\"\">SeÃ§ilmedi</option>';
  responsibleUsers.forEach((user) => {
    if (!user || typeof user.id === "undefined") return;
    const opt = document.createElement("option");
    opt.value = String(user.id);
    opt.textContent = user.email || `#${user.id}`;
    ownerSelect.appendChild(opt);
  });
  if (previousValue && responsibleUserMap.has(Number(previousValue))) {
    ownerSelect.value = previousValue;
  } else {
    ownerSelect.value = "";
  }
}

// GÃ¶rev modalÄ±ndaki sorumlu kiÅŸi dropdown'Ä±nÄ± doldur
function populateTaskOwnerSelect() {
  // taskOwnerSelect elementi henÃ¼z yÃ¼klenmemiÅŸ olabilir (sayfa ilk aÃ§Ä±lÄ±ÅŸta)
  const taskOwnerSelect = document.getElementById("taskOwnerSelect");
  if (!taskOwnerSelect) return;
  
  const previousValue = taskOwnerSelect.value;
  taskOwnerSelect.innerHTML = '<option value="">SeÃ§ilmedi</option>';
  
  responsibleUsers.forEach((user) => {
    if (!user || typeof user.id === "undefined") return;
    const opt = document.createElement("option");
    opt.value = String(user.id);
    opt.textContent = user.email || `#${user.id}`;
    taskOwnerSelect.appendChild(opt);
  });
  
  // Ã–nceki deÄŸeri koru
  if (previousValue && responsibleUserMap.has(Number(previousValue))) {
    taskOwnerSelect.value = previousValue;
  }
}

function getOwnerLabel(ownerId) {
  if (!ownerId) return "";
  return responsibleUserMap.get(Number(ownerId)) || "";
}

function setHighlightInputValue(value) {
  const finalValue = normalizeColorToken(value, DEFAULT_HIGHLIGHT_COLOR);
  if (highlightColorInput) {
    highlightColorInput.value = finalValue;
  }
  if (highlightColorPicker && highlightColorInput) {
    setColorPickerValue(highlightColorPicker, highlightColorInput, finalValue);
  }
  updateColorToggle(highlightColorToggle, finalValue);
}

function updateDayHighlightLocally(dateKey, colorValue) {
  if (!dateKey) return;
  if (colorValue) {
    const normalized = normalizeColorToken(colorValue, null);
    if (normalized) {
      highlightedDates.set(dateKey, normalized);
    } else {
      highlightedDates.delete(dateKey);
    }
  } else {
    highlightedDates.delete(dateKey);
  }
  if (selectedDateKey === dateKey) {
    updateHighlightStateUI();
  }
  renderCalendar();
  updateScheduleList();
}

function setActiveAdminPanelTab(panelId = "users") {
  let target = panelId || "users";
  const isColorPanel = target === "colors";
  const canEditColors = Boolean(currentUser && currentUser.role === "admin");
  if (isColorPanel && !canEditColors) {
    target = "users";
  }
  activeAdminPanelTab = target;
  adminTabButtons.forEach((btn) => {
    const btnPanel = btn.dataset.panel || "users";
    btn.classList.toggle("active", btnPanel === activeAdminPanelTab);
  });
  if (adminUsersSection) {
    const showUsers = activeAdminPanelTab === "users";
    adminUsersSection.classList.toggle("active", showUsers);
    adminUsersSection.style.display = showUsers ? "" : "none";
  }
  if (isColorPanel && canEditColors) {
    ensureColorDescriptionsLoaded();
  }
  refreshColorDescriptionSection();
}

function refreshColorDescriptionSection() {
  if (!colorDescriptionsSection) return;
  const canEdit = Boolean(currentUser && currentUser.role === "admin");
  if (colorTabBtn) {
    colorTabBtn.style.display = canEdit ? "" : "none";
  }
  if (!canEdit && activeAdminPanelTab === "colors") {
    setActiveAdminPanelTab("users");
    return;
  }
  const shouldShow = canEdit && activeAdminPanelTab === "colors";
  colorDescriptionsSection.classList.toggle("active", shouldShow);
  colorDescriptionsSection.style.display = shouldShow ? "" : "none";
  if (shouldShow) {
    if (colorDescriptionsLoaded) {
      renderColorDescriptionsForm();
    } else {
      ensureColorDescriptionsLoaded().then(() => {
        if (activeAdminPanelTab === "colors") {
          renderColorDescriptionsForm();
        }
      });
    }
  }
}

function renderColorDescriptionsForm() {
  if (!colorDescriptionsForm) return;
  colorDescriptionsForm.innerHTML = "";
  COLOR_TOKENS_IN_ORDER.forEach((token) => {
    if (!COLOR_HEX_BY_TOKEN[token]) return;
    const info = getColorDescriptionForKey(token);
    const row = document.createElement("div");
    row.className = "color-description-row";

    const dot = document.createElement("span");
    dot.className = "color-description-dot";
    dot.style.backgroundColor = COLOR_HEX_BY_TOKEN[token];
    row.appendChild(dot);

    const fields = document.createElement("div");
    fields.className = "color-description-fields";

    const labelInput = document.createElement("input");
    labelInput.type = "text";
    labelInput.value = info.label || "";
    labelInput.placeholder = "Etiket";
    labelInput.dataset.colorKey = token;
    labelInput.dataset.field = "label";
    fields.appendChild(labelInput);

    const descriptionInput = document.createElement("textarea");
    descriptionInput.value = info.description || "";
    descriptionInput.placeholder = "AÃ§Ä±klama";
    descriptionInput.dataset.colorKey = token;
    descriptionInput.dataset.field = "description";
    fields.appendChild(descriptionInput);

    row.appendChild(fields);
    colorDescriptionsForm.appendChild(row);
  });
}

async function saveColorDescriptions() {
  if (!colorDescriptionSaveBtn) return;
  const descriptionsPayload = {};
  if (colorDescriptionsForm) {
    const inputs = colorDescriptionsForm.querySelectorAll(
      "[data-color-key][data-field]"
    );
    inputs.forEach((input) => {
      const key = input.dataset.colorKey;
      const field = input.dataset.field;
      if (!descriptionsPayload[key]) {
        descriptionsPayload[key] = { label: "", description: "" };
      }
      descriptionsPayload[key][field] = input.value;
    });
  }

  colorDescriptionSaveBtn.disabled = true;
  if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "Kaydediliyor...";
  try {
    const merged = { ...colorDescriptions };
    Object.entries(descriptionsPayload).forEach(([key, value]) => {
      if (!merged[key]) return;
      merged[key] = {
        label:
          value && typeof value.label === "string" && value.label.trim()
            ? value.label.trim()
            : merged[key].label,
        description:
          value && typeof value.description === "string"
            ? value.description
            : merged[key].description
      };
    });
    colorDescriptions = merged;
    writeColorSettingsToStorage(colorDescriptions);
    renderColorHelpList();
    refreshColorDescriptionSection();
    if (colorDescriptionSaveStatus) {
      colorDescriptionSaveStatus.textContent = "Kaydedildi.";
      setTimeout(() => {
        if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "";
      }, 2500);
    }
  } catch (err) {
    if (colorDescriptionSaveStatus) {
      colorDescriptionSaveStatus.textContent = err.message || "Kaydedilemedi.";
    }
  } finally {
    colorDescriptionSaveBtn.disabled = false;
  }
}

function formatDateTimeHuman(value) {
  if (!value) return "";
  const dt = new Date(value);
  if (Number.isNaN(dt.getTime())) return "";
  return dt.toLocaleString("tr-TR", {
    dateStyle: "medium",
    timeStyle: "short"
  });
}

function renderColorPicker(container, input, paletteTokens, onChange) {
  if (!container || !input || !Array.isArray(paletteTokens)) return;
  container.innerHTML = "";
  const currentToken = normalizeColorToken(input.value, DEFAULT_ENTRY_COLOR);
  paletteTokens.forEach((token) => {
    if (!COLOR_HEX_BY_TOKEN[token]) return;
    const hex = COLOR_HEX_BY_TOKEN[token];
    const swatchLabel = getColorDescriptionForKey(token).label || token;
    const button = document.createElement("button");
    button.type = "button";
    button.className = "color-swatch";
    button.setAttribute("aria-label", swatchLabel);
    button.title = swatchLabel;
    const span = document.createElement("span");
    span.style.backgroundColor = hex;
    button.appendChild(span);
    button.dataset.token = token;
    if (currentToken === token) {
      button.classList.add("active");
    }
    button.addEventListener("click", () => {
      input.value = token;
      container
        .querySelectorAll(".color-swatch.active")
        .forEach((el) => el.classList.remove("active"));
      button.classList.add("active");
      if (onChange) onChange(token);
      closeColorPicker(container);
    });
    container.appendChild(button);
  });
  closeColorPicker(container);
}

function setColorPickerValue(container, input, value) {
  if (!container || !input) return;
  const normalizedToken = normalizeColorToken(value, DEFAULT_ENTRY_COLOR);
  input.value = normalizedToken || "";
  container
    .querySelectorAll(".color-swatch")
    .forEach((btn) => {
      const token = btn.dataset.token;
      if (!token) return;
      if (token === normalizedToken) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });
}

function updateColorToggle(toggle, color) {
  if (!toggle) return;
  const swatch = toggle.querySelector(".toggle-swatch");
  if (swatch) {
    swatch.style.backgroundColor = getHexFromColorToken(color);
  }
}

function setColorPickerEnabled(wrapper, toggle, enabled) {
  if (!wrapper || !toggle) return;
  const picker = wrapper.querySelector(".color-picker");
  if (enabled) {
    wrapper.classList.remove("disabled");
    toggle.disabled = false;
    if (picker) picker.classList.remove("disabled");
  } else {
    wrapper.classList.add("disabled");
    toggle.disabled = true;
    if (picker) {
      picker.classList.add("disabled");
      closeColorPicker(picker);
    }
  }
}

function handleHighlightSelection(colorToken) {
  if (!selectedDateKey || !isViewingOwnData()) return;
  const normalizedToken = normalizeColorToken(colorToken, null);
  if (!normalizedToken) return;
  const current = highlightedDates.get(selectedDateKey);
  const willRemove = current && current === normalizedToken;
  const nextColor = willRemove ? null : normalizedToken;
  const previousColor = current || null;

  updateDayHighlightLocally(selectedDateKey, nextColor);

  const action = nextColor
    ? () => setDateHighlight(selectedDateKey, nextColor)
    : () => removeDateHighlight(selectedDateKey);

  action()
    .then(() => {
      if (viewReports.style.display !== "none") renderReports();
    })
    .catch((err) => {
      console.error('[updateDayHighlight] Hata:', err);
      showErrorToast(err.message || "GÃ¼n iÅŸaretlenemedi");
      updateDayHighlightLocally(selectedDateKey, previousColor);
    });
}

function showSaveSuccessMessage() {
  if (!saveSuccessMessage) return;
  saveSuccessMessage.style.display = "block";
  if (saveSuccessTimeout) clearTimeout(saveSuccessTimeout);
  saveSuccessTimeout = setTimeout(() => {
    hideSaveSuccessMessage();
  }, 4000);
}

function hideSaveSuccessMessage() {
  if (!saveSuccessMessage) return;
  saveSuccessMessage.style.display = "none";
  if (saveSuccessTimeout) {
    clearTimeout(saveSuccessTimeout);
    saveSuccessTimeout = null;
  }
}
    const resetScopeLabels = {
      excel: "Excel giriÅŸlerini sÄ±fÄ±rla",
      manual: "Manuel giriÅŸleri sÄ±fÄ±rla",
      highlights: "GÃ¼n renklerini sÄ±fÄ±rla",
      all: "TÃ¼m kayÄ±tlarÄ± sÄ±fÄ±rla"
    };
    const resetConfirmMessages = {
      excel: "Excel'den gelen kayÄ±tlarÄ±n tamamÄ± silinecek. Emin misin?",
      manual: "Manuel eklediÄŸin kayÄ±tlarÄ±n tamamÄ± silinecek. Emin misin?",
      highlights: "TÃ¼m gÃ¼n renkleri kaldÄ±rÄ±lacak. Emin misin?",
      all: "TÃ¼m iÃ§erikler ve gÃ¼n renkleri silinecek. Emin misin?"
    };
    const resetSuccessMessages = {
      excel: "Excel giriÅŸleri baÅŸarÄ±yla silindi.",
      manual: "Manuel giriÅŸler baÅŸarÄ±yla silindi.",
      highlights: "GÃ¼n renkleri baÅŸarÄ±yla temizlendi.",
      all: "TÃ¼m kayÄ±tlar ve gÃ¼n renkleri baÅŸarÄ±yla silindi."
    };

    let reportMode = "month"; // "month" | "range"
    let reportsContentView = "summary"; // "summary" | "executed"
    let platformChartInstance = null;
    let timeChartInstance = null;
const quickRangeButtonsList = quickRangeButtons
  ? Array.from(quickRangeButtons.querySelectorAll("button[data-range]"))
  : [];
if (entryColorInput) entryColorInput.value = DEFAULT_ENTRY_COLOR;
if (highlightColorInput) highlightColorInput.value = DEFAULT_HIGHLIGHT_COLOR;
const COLOR_PICKER_CONTAINERS = [];
const COLOR_PICKER_TOGGLE_MAP = new Map();

function closeColorPicker(container) {
  if (!container) return;
  container.classList.remove("open");
  const toggle = COLOR_PICKER_TOGGLE_MAP.get(container);
  if (toggle) toggle.setAttribute("aria-expanded", "false");
}

function openColorPicker(container, toggle) {
  if (!container) return;
  container.classList.add("open");
  if (toggle) toggle.setAttribute("aria-expanded", "true");
}

function closeAllColorPickers(except = null) {
  COLOR_PICKER_CONTAINERS.forEach((container) => {
    if (!container) return;
    if (except && container === except) return;
    closeColorPicker(container);
  });
}

function setupColorPicker(container, input, toggle, palette, onChange) {
  if (!container || !input) return;
  renderColorPicker(container, input, palette, (color) => {
    updateColorToggle(toggle, color);
    if (typeof onChange === "function") onChange(color);
  });
  setColorPickerValue(container, input, input.value);
  updateColorToggle(toggle, input.value);
  COLOR_PICKER_CONTAINERS.push(container);
  if (toggle) {
    COLOR_PICKER_TOGGLE_MAP.set(container, toggle);
    toggle.setAttribute("aria-expanded", "false");
  }
  container.addEventListener("click", (event) => event.stopPropagation());
  if (toggle) {
    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      if (toggle.disabled) return;
      const isOpen = container.classList.contains("open");
      if (isOpen) {
        closeColorPicker(container);
      } else {
        closeAllColorPickers();
        openColorPicker(container, toggle);
      }
    });
  }
}

if (entryColorPicker && entryColorInput) {
  setupColorPicker(
    entryColorPicker,
    entryColorInput,
    entryColorToggle,
    COLOR_TOKENS_IN_ORDER
  );
}

if (highlightColorPicker && highlightColorInput) {
  setupColorPicker(
    highlightColorPicker,
    highlightColorInput,
    highlightColorToggle,
    COLOR_TOKENS_IN_ORDER,
    (token) => handleHighlightSelection(token)
  );
  setColorPickerEnabled(
    highlightColorWrapper,
    highlightColorToggle,
    false
  );
}

if (notificationToggleBtn) {
  notificationToggleBtn.addEventListener("click", (event) => {
    event.stopPropagation();
    toggleNotificationPanel();
  });
}
if (notificationPanel) {
  notificationPanel.addEventListener("click", (event) => event.stopPropagation());
}
const markAllReadBtn = document.getElementById("markAllReadBtn");
if (markAllReadBtn) {
  markAllReadBtn.addEventListener("click", (event) => {
    event.stopPropagation();
    markAllNotificationsAsRead();
  });
}

// "TÃ¼mÃ¼nÃ¼ sil" butonu event listener
const clearAllNotificationsBtn = document.getElementById("clearAllNotificationsBtn");
if (clearAllNotificationsBtn) {
  clearAllNotificationsBtn.addEventListener("click", (event) => {
    event.stopPropagation(); // Panel'in kapanmasÄ±nÄ± Ã¶nle
    clearAllNotifications();
  });
}

document.addEventListener("click", () => {
  closeAllColorPickers();
  closeNotificationPanel();
});

if (scheduleSearchInput) {
  scheduleSearchInput.addEventListener("input", (event) => {
    scheduleSearchQuery = event.target.value.trim().toLowerCase();
    updateScheduleList();
  });
}

if (modalFormSection) {
  modalFormSection.addEventListener("input", () => hideSaveSuccessMessage());
  modalFormSection.addEventListener("change", () => hideSaveSuccessMessage());
}

    function setAuthToken(token) {
      authToken = token || "";
      if (authToken) {
        safeLocalStorageSet("contentCalendar_token", authToken);
      } else {
        safeLocalStorageRemove("contentCalendar_token");
      }
      updateAuthUI();
    }

    function setCurrentUser(user) {
      currentUser = user;
      if (currentUser && currentUser.id) {
        responsibleUserMap.set(
          Number(currentUser.id),
          currentUser.email || responsibleUserMap.get(Number(currentUser.id)) || ""
        );
      }
      updateAuthUI();
      if (!currentUser) {
        responsibleUsers = [];
        responsibleUserMap.clear();
      }
      loadNotificationsForCurrentUser();
    }

    function updateAuthUI() {
      const isLoggedIn = Boolean(authToken && currentUser);
      logoutBtn.style.display = isLoggedIn ? "inline-flex" : "none";
      updateNotificationVisibility(isLoggedIn);
      if (currentUser && currentUser.role === "admin") {
        adminPanelBtn.style.display = "inline-flex";
      } else {
        adminPanelBtn.style.display = "none";
        adminViewInfo.style.display = "none";
        adminSelectedUserId = null;
      }
      if (excelUploadBtn) {
        const canUpload =
          Boolean(isLoggedIn && currentUser && currentUser.role === "admin");
        excelUploadBtn.style.display = canUpload ? "inline-flex" : "none";
        excelUploadBtn.disabled = !canUpload;
        if (resetEntriesBtn) {
          resetEntriesBtn.style.display = canUpload ? "inline-flex" : "none";
          resetEntriesBtn.disabled = !canUpload;
          resetEntriesBtn.textContent = "SÄ±fÄ±rla";
        }
        if (excelUploadContainer) {
          excelUploadContainer.style.display = canUpload ? "flex" : "none";
        }
        if (resetOptions) {
          resetOptions.style.display = "none";
          resetOptionButtons.forEach((btn) => {
            btn.disabled = false;
            const scope = btn.dataset.scope;
            if (scope && resetScopeLabels[scope]) {
              btn.textContent = resetScopeLabels[scope];
            }
          });
        }
      }
      updateEditingPermissions();
      refreshColorDescriptionSection();
    }

    function setAuthMode(registerMode) {
      isRegisterMode = Boolean(registerMode);
      loginSubmitBtn.textContent = isRegisterMode ? "KayÄ±t ol" : "GiriÅŸ yap";
      switchAuthModeBtn.textContent = isRegisterMode
        ? "Zaten hesabÄ±m var"
        : "KayÄ±t olmak istiyorum";
      loginError.classList.remove("success");
    }

    function showLoginOverlay(registerMode = false) {
      loginOverlay.classList.add("active");
      document.body.classList.add('modal-open');
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
      document.body.classList.add("blurred");
      setAuthMode(registerMode);
    }

    function hideLoginOverlay() {
      loginOverlay.classList.remove("active");
      document.body.classList.remove('modal-open');
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      document.body.classList.remove("blurred");
      setAuthMode(false);
    }

    async function apiFetch(path, options = {}) {
      const opts = { ...options };
      opts.headers = { ...(opts.headers || {}) };
      if (opts.body && !opts.headers["Content-Type"]) {
        opts.headers["Content-Type"] = "application/json";
      }
      if (authToken) {
        opts.headers.Authorization = "Bearer " + authToken;
      }
      const response = await fetch(API_BASE + path, opts);
      if (response.status === 401) {
        setCurrentUser(null);
        setAuthToken("");
        if (adminOverlay.classList.contains("active")) {
          closeAdminOverlay();
        }
        showLoginOverlay();
        throw new Error("Oturum sÃ¼resi doldu. LÃ¼tfen tekrar giriÅŸ yap.");
      }
      if (!response.ok) {
        let message = "Beklenmeyen bir hata oluÅŸtu.";
        try {
          const data = await response.json();
          if (data && data.error) message = data.error;
        } catch {
          message = response.statusText || message;
        }
        throw new Error(message);
      }
      return response;
    }

    function normalizeEntry(entry) {
      let platformsRaw = entry.platforms;
      if (typeof platformsRaw === "string") {
        try {
          platformsRaw = JSON.parse(platformsRaw);
        } catch {
          platformsRaw = [];
        }
      }
      if (!Array.isArray(platformsRaw)) platformsRaw = [];

      const normalizedSource = (entry.source || "manual").toLowerCase() === "excel"
        ? "excel"
        : entry.source || "manual";
      const normalizedStatus =
        entry.status === "done" || entry.status === "missed"
          ? entry.status
          : "planned";

      return {
        id: entry.id,
        user_id: entry.user_id,
        date: entry.date,
        time: entry.time || "",
        text: entry.text || "",
        files: entry.files || "",
        communication: entry.communication || "",
        communication_type: entry.communication_type || entry.communicationType || "",
        status: normalizedStatus,
        note: entry.note || "",
        checkedAt: entry.checked_at || entry.checkedAt || null,
        owner_id: entry.owner_id || entry.ownerId || null,
        platforms: platformsRaw,
        source: normalizedSource,
        color: normalizeColorToken(entry.color, null) || ""
      };
    }

    function sortAndStore(dateKey, items) {
      const sorted = sortItemsByTime(items);
      entriesByDate.set(dateKey, sorted);
    }

    function upsertEntry(entry) {
      const normalized = normalizeEntry(entry);
      if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
        return;
      }
      entriesById.set(normalized.id, normalized);
      const list = entriesByDate.get(normalized.date) || [];
      const idx = list.findIndex((it) => it.id === normalized.id);
      if (idx === -1) {
        list.push(normalized);
      } else {
      list[idx] = normalized;
    }
    sortAndStore(normalized.date, list);
    persistEntriesToSharedStorage();
  }

    function rebuildEntriesCache(rows) {
      entriesById = new Map();
      entriesByDate = new Map();
      rows.forEach((row) => {
        const normalized = normalizeEntry(row);
        if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
          return;
        }
        entriesById.set(normalized.id, normalized);
        const list = entriesByDate.get(normalized.date) || [];
        list.push(normalized);
        entriesByDate.set(normalized.date, list);
      });
    entriesByDate.forEach((items, key) => {
      sortAndStore(key, items);
    });
    persistEntriesToSharedStorage();
  }

    function removeEntryFromCache(entryId) {
      const existing = entriesById.get(entryId);
      if (!existing) return;
      entriesById.delete(entryId);
      const arr = entriesByDate.get(existing.date) || [];
      const filtered = arr.filter((it) => it.id !== entryId);
      if (filtered.length) {
        entriesByDate.set(existing.date, filtered);
      } else {
        entriesByDate.delete(existing.date);
      }
      persistEntriesToSharedStorage();
    }

    function isViewingOwnData() {
      if (!currentUser || currentUser.role !== "admin") return true;
      return (
        adminSelectedUserId === null ||
        adminSelectedUserId === currentUser.id
      );
    }

    function updateEditingPermissions() {
      const canEdit = Boolean(authToken) && isViewingOwnData();
      toggleFormBtn.disabled = !canEdit;
      saveBtn.disabled = !canEdit;
      clearBtn.disabled = !canEdit;
      setColorPickerEnabled(entryColorWrapper, entryColorToggle, canEdit);
      if (ownerSelect) ownerSelect.disabled = !canEdit;
      if (!canEdit) {
        deleteBtn.disabled = true;
        modalFormSection.style.display = "none";
        activeItemId = null;
        clearFormOnly();
        modalForcePlanMode = false;
        setModalViewForEntry(null);
        modalFormSection.style.display = "none";
      } else {
        deleteBtn.disabled = !activeItemId;
      }
      setControlActionsEnabled(canEdit);
    }

    async function loadHighlightsFromServer(targetUserId = null) {
      const query = targetUserId ? `?userId=${targetUserId}` : "";
      try {
      const response = await apiFetch(`/calendar/highlights${query}`);
      const data = await response.json();
      highlightedDates = new Map(
        data
          .map((item) => {
            const token = normalizeColorToken(item.color, null);
            if (!token) return null;
            return [item.date, token];
          })
          .filter(Boolean)
      );
      } catch (err) {
        console.warn("Vurgular yÃ¼klenemedi:", err.message);
        highlightedDates = new Map();
      }
    }

    async function loadEntriesFromServer(targetUserId = null, label = "") {
      const query = targetUserId ? `?userId=${targetUserId}` : "";
      let data = [];
      let usedStoredFallback = false;
      try {
        const response = await apiFetch(`/calendar${query}`);
        data = await response.json();
      } catch (err) {
        console.warn("Takvim verileri alÄ±namadÄ±:", err.message);
        if (!targetUserId) {
          const stored = readSharedCalendarEntries();
          if (stored.length) {
            data = stored;
            usedStoredFallback = true;
          } else {
            return;
          }
        } else {
          return;
        }
      }
      const mergedEntries = data;
      if (!usedStoredFallback && !targetUserId) {
        writeSharedCalendarEntries(mergedEntries);
      }
      rebuildEntriesCache(mergedEntries);
      await loadHighlightsFromServer(targetUserId);
      activeItemId = null;
      modalFormSection.style.display = "none";
      clearFormOnly();
      modalForcePlanMode = false;
      setModalViewForEntry(null);
      closeCopyPopover();
      renderCalendar();
      updateScheduleList(); // SaÄŸ paneldeki listeyi gÃ¼ncelle
      if (viewReports.style.display !== "none") renderReports();
      if (selectedDateKey) {
        currentDayItems = loadDayData(selectedDateKey).items;
        renderModalSummaryList();
        updateHighlightStateUI();
      } else {
        updateHighlightStateUI();
      }
      if (currentUser && currentUser.role === "admin") {
        if (targetUserId && targetUserId !== currentUser.id) {
          adminViewInfo.style.display = "";
          adminViewInfo.textContent = label
            ? `Åžu anda ${label} kullanÄ±cÄ±sÄ±nÄ±n takvimi gÃ¶rÃ¼ntÃ¼leniyor.`
            : `Åžu anda #${targetUserId} numaralÄ± kullanÄ±cÄ±nÄ±n takvimi gÃ¶rÃ¼ntÃ¼leniyor.`;
        } else {
          adminViewInfo.style.display = "none";
          adminSelectedUserId = null;
        }
      }
      updateAuthUI();
    }

    async function loadAdminUsers() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminUserList.innerHTML = "<p class=\"small\">YÃ¼kleniyor...</p>";
      try {
        const response = await apiFetch("/users");
        const data = await response.json();
        renderAdminUsers(data);
      } catch (err) {
        adminUserList.innerHTML = `<p class="small" style="color:#dc2626;">${err.message}</p>`;
        updatePendingCountBadge(0);
      }
    }

    function createBadge(text, type = "") {
      const span = document.createElement("span");
      span.className = "badge";
      if (type) span.classList.add(type);
      span.textContent = text;
      return span;
    }

    function renderAdminUsers(users) {
      if (!Array.isArray(users)) {
        updatePendingCountBadge(0);
        adminUserList.innerHTML = `<p class="small">KayÄ±t bulunamadÄ±.</p>`;
        return;
      }
      const pendingCount = users.filter((user) => !user.approved).length;
      updatePendingCountBadge(pendingCount);
      adminUserList.innerHTML = "";
      if (!users.length) {
        const empty = document.createElement("p");
        empty.className = "small";
        empty.textContent = "KayÄ±t bulunamadÄ±.";
        adminUserList.appendChild(empty);
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("div");
        row.className = "admin-user-row";
        const selected = adminSelectedUserId === null
          ? currentUser && user.id === currentUser.id
          : adminSelectedUserId === user.id;
        if (selected) row.classList.add("selected");

        const emailDiv = document.createElement("div");
        emailDiv.textContent = user.email;

        const roleDiv = document.createElement("div");
        const roleSelect = document.createElement("select");
        roleSelect.className = "role-select";
        ["user", "admin"].forEach((roleOption) => {
          const opt = document.createElement("option");
          opt.value = roleOption;
          opt.textContent =
            roleOption === "admin" ? "Admin" : "KullanÄ±cÄ±";
          roleSelect.appendChild(opt);
        });
        roleSelect.value = user.role === "admin" ? "admin" : "user";
        roleSelect.disabled =
          !user.approved ||
          (currentUser && currentUser.id === user.id);
        roleSelect.addEventListener("change", async () => {
          const nextRole = roleSelect.value;
          roleSelect.disabled = true;
          try {
            await updateUserRole(user.id, nextRole);
            await loadAdminUsers();
          } catch (error) {
            console.error('[updateUserRole] Hata:', error);
            showErrorToast(error.message || "Rol gÃ¼ncellenemedi");
          } finally {
            roleSelect.disabled =
              currentUser && currentUser.id === user.id;
          }
        });
        roleDiv.appendChild(roleSelect);

        const statusDiv = document.createElement("div");
        statusDiv.style.display = "flex";
        statusDiv.style.gap = "8px";
        const statusBadge = createBadge(
          user.approved ? "OnaylÄ±" : "Onay bekliyor",
          user.approved ? "success" : "warning"
        );
        const countBadge = createBadge(`${user.entryCount} kayÄ±t`, "info");
        statusDiv.appendChild(statusBadge);
        statusDiv.appendChild(countBadge);

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "admin-user-actions";

        if (user.approved) {
          const viewBtn = document.createElement("button");
          viewBtn.textContent = "Takvimi gÃ¶ster";
          viewBtn.addEventListener("click", async () => {
            const viewingOwn = currentUser && user.id === currentUser.id;
            adminSelectedUserId = viewingOwn ? null : user.id;
            try {
              await loadEntriesFromServer(
                adminSelectedUserId ? adminSelectedUserId : null,
                viewingOwn ? "" : user.email
              );
              closeAdminOverlay();
            } catch (error) {
              console.error('[loadEntriesFromServer] Hata:', error);
              showErrorToast(error.message || "KullanÄ±cÄ± takvimi yÃ¼klenemedi");
            }
          });
          actionsDiv.appendChild(viewBtn);
        } else {
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "Onayla";
          approveBtn.addEventListener("click", async () => {
            approveBtn.disabled = true;
            try {
              await approveUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              approveBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(approveBtn);

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "Reddet";
          rejectBtn.classList.add("secondary-btn");
          rejectBtn.addEventListener("click", async () => {
            const confirmed = confirm(
              `${user.email} hesabÄ±nÄ± reddetmek istediÄŸine emin misin?`
            );
            if (!confirmed) return;
            rejectBtn.disabled = true;
            try {
              await rejectUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              rejectBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(rejectBtn);
        }

        row.appendChild(emailDiv);
        row.appendChild(roleDiv);
        row.appendChild(statusDiv);
        row.appendChild(actionsDiv);
        adminUserList.appendChild(row);
      });
    }

    async function approveUser(userId) {
      await apiFetch(`/users/${userId}/approve`, { method: "POST" });
      await loadAdminUsers();
    }

    async function rejectUser(userId) {
      await apiFetch(`/users/${userId}/reject`, { method: "POST" });
      if (adminSelectedUserId === userId) {
        adminSelectedUserId = null;
        adminViewInfo.style.display = "none";
        await loadEntriesFromServer();
      }
      await loadAdminUsers();
    }

    async function updateUserRole(userId, role) {
      await apiFetch(`/users/${userId}/role`, {
        method: "POST",
        body: JSON.stringify({ role })
      });
    }

    function openAdminOverlay() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminOverlay.classList.add("active");
      document.body.classList.add('modal-open');
      loadAdminUsers();
      ensureColorDescriptionsLoaded().then(() => {
        renderColorDescriptionsForm();
      });
    }

    function closeAdminOverlay() {
      adminOverlay.classList.remove("active");
      document.body.classList.remove('modal-open');
      if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "";
    }

    async function createEntry(payload) {
      const response = await apiFetch("/calendar", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function updateEntry(id, payload) {
      const response = await apiFetch(`/calendar/${id}`, {
        method: "PUT",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function deleteEntry(id) {
      await apiFetch(`/calendar/${id}`, { method: "DELETE" });
      removeEntryFromCache(id);
    }

    /* Tema */
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "AÃ§Ä±k mod";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "Koyu mod";
      }
    }
    function initTheme() {
      const stored = safeLocalStorageGet("contentCalendar_theme", "light");
      applyTheme(stored === "dark" ? "dark" : "light");
    }
    themeToggleBtn.addEventListener("click", () => {
      const next = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(next);
      safeLocalStorageSet("contentCalendar_theme", next);
      if (viewReports.style.display !== "none") renderReports();
    });

    /* YardÄ±mcÄ±lar */
    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function parseDateKeyString(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (
        Number.isNaN(year) ||
        Number.isNaN(month) ||
        Number.isNaN(day)
      ) {
        return null;
      }
      const dt = new Date(year, month - 1, day);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }
    function formatHumanDate(date) {
      const day = String(date.getDate());
      const monthName = monthNames[date.getMonth()];
      const year = date.getFullYear();
      return day + " " + monthName + " " + year;
    }
    function setSelectedDateState(dateKey, dateObj = null) {
      if (!dateKey) return null;
      const parsed = dateObj || parseDateKeyString(dateKey);
      if (!parsed) return null;
      selectedDateKey = dateKey;
      return parsed;
    }

    function setSummaryDateKey(dateKey) {
      if (!dateKey) return;
      summaryDateKey = dateKey;
      scheduleDailyDateKey = dateKey;
      activeScheduleSummaryKey = dateKey;
      updateScheduleList();
      renderCalendar();
    }

    // Takvim ile saÄŸ panel listesinin yÃ¼ksekliÄŸini senkronize et
    function syncDaySummaryHeight() {
      const calendarShell = document.querySelector(".calendar-shell");
      const summaryShell = document.querySelector(".summary-shell");
      const daySummaryScroll = document.querySelector(".day-summary-scroll");
      if (!calendarShell || !summaryShell || !daySummaryScroll) return;

      // Ã–lÃ§Ã¼mleri temiz bir ÅŸekilde alabilmek iÃ§in Ã¶nce yÃ¼kseklikleri sÄ±fÄ±rla
      summaryShell.style.height = "";
      daySummaryScroll.style.height = "";
      daySummaryScroll.style.maxHeight = "";

      const calendarHeight = calendarShell.getBoundingClientRect().height;
      const totalShellHeight = summaryShell.scrollHeight;
      const currentScrollHeight = daySummaryScroll.offsetHeight;
      const otherContentHeight = totalShellHeight - currentScrollHeight;
      const targetScrollHeight = calendarHeight - otherContentHeight - 8; // kÃ¼Ã§Ã¼k tampon

      if (targetScrollHeight > 0) {
        summaryShell.style.height = `${calendarHeight}px`;
        daySummaryScroll.style.height = `${targetScrollHeight}px`;
        daySummaryScroll.style.maxHeight = `${targetScrollHeight}px`;
      } else {
        summaryShell.style.height = `${calendarHeight}px`;
      }
      
      // GÃ¶rev Panosu'nu da aynÄ± hizaya getir
      const taskBoardPanel = document.querySelector(".task-board-panel");
      const taskBoardScrollWrapper = document.querySelector(".task-board-scroll-wrapper");
      
      if (taskBoardPanel && taskBoardScrollWrapper && calendarHeight > 0) {
        taskBoardPanel.style.height = `${calendarHeight}px`;
        
        // GÃ¶rev Panosu'ndaki diÄŸer iÃ§erik yÃ¼ksekliÄŸini hesapla (header + gap)
        const taskBoardHeader = taskBoardPanel.querySelector(".task-board-header");
        const headerHeight = taskBoardHeader ? taskBoardHeader.offsetHeight : 0;
        const gapHeight = 6; // CSS'teki gap deÄŸeri
        const taskBoardTargetHeight = calendarHeight - headerHeight - gapHeight - 8;
        
        if (taskBoardTargetHeight > 0) {
          taskBoardScrollWrapper.style.height = `${taskBoardTargetHeight}px`;
          taskBoardScrollWrapper.style.maxHeight = `${taskBoardTargetHeight}px`;
        }
      }
    }
    window.addEventListener("load", syncDaySummaryHeight);
    window.addEventListener("resize", syncDaySummaryHeight);
    setTimeout(syncDaySummaryHeight, 100);
    function minutesFromTime(t) {
      if (!t) return 24 * 60 + 1; // saat yoksa en sona
      const parts = t.split(":");
      if (parts.length !== 2) return 24 * 60 + 1;
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (Number.isNaN(h) || Number.isNaN(m)) return 24 * 60 + 1;
      return h * 60 + m;
    }
    function sortItemsByTime(items) {
      return items.slice().sort((a, b) => minutesFromTime(a.time) - minutesFromTime(b.time));
    }
    function isDarkMode() {
      return document.body.classList.contains("dark");
    }

    /* Veri okuma / yazma */
function loadDayData(dateKey) {
      const items = entriesByDate.get(dateKey) || [];
    const clones = items.map((item) => ({
      id: item.id,
      date: item.date || dateKey,
      files: item.files || "",
      text: item.text || "",
      time: item.time || "",
      platforms: Array.isArray(item.platforms) ? [...item.platforms] : [],
      communication: item.communication || "",
      communicationType: item.communication_type || item.communicationType || "",
      status: item.status || "planned",
      note: item.note || "",
      checkedAt: item.checkedAt || item.checked_at || null,
      owner_id: item.owner_id || item.ownerId || null,
      source: item.source || "manual",
      color: normalizeColorToken(item.color, null) || ""
    }));
      return { items: sortItemsByTime(clones) };
    }

const SUMMARY_TITLE_LIMIT = 48;
    // Bir iÃ§erik iÃ§in 10 karakterlik metin + platformlar + saat
    function makeItemSummary(item) {
      const textSource = item.text || item.files || "";
      let snippet = textSource ? textSource.slice(0, SUMMARY_TITLE_LIMIT) : "";
      if (textSource.length > SUMMARY_TITLE_LIMIT) snippet = snippet.trim() + "...";
      if (!snippet) snippet = "Ä°Ã§erik";
      const platforms =
        item.platforms && item.platforms.length
          ? item.platforms.join(", ")
          : "Platform seÃ§ilmedi";
      const time = item.time || "";
      return { snippet, platforms, time };
    }

    /* SaÄŸ panel: GÃ¼n DetayÄ± / Takvim Ã–zeti */
function summarizePlatformLabel(platform) {
  const key = (platform || "").toLowerCase();
  if (!key) return "Platform seÃ§ilmedi";
  if (key.includes("instagram")) return "Instagram";
  if (key.includes("facebook")) return "Facebook";
  if (key.includes("telegram")) return "Telegram";
  if (key.includes("linkedin")) return "LinkedIn";
  if (key.includes("youtube")) return "YouTube";
  if (key.includes("tiktok")) return "TikTok";
  if (key.includes("reddit")) return "Reddit";
  if (key.includes("discord")) return "Discord";
  if (key === "website") return "Website";
  if (key === "medium") return "Medium";
  if (key.includes("landing")) return "Website";
  if (key.includes("web")) return "Website";
  if (key.includes("blog")) return "Blog";
  if (key.includes("twitter") || key === "x") return "X";
  return platform || "Platform seÃ§ilmedi";
}

    function buildDaySummary(items, options = {}) {
      const filterId = options.filterId || "all";
      const channelScoped = filterEntriesByChannel(items, filterId);
      const scopedItems = filterEntriesByAssignee(channelScoped);
      const counts = {};
      scopedItems.forEach((item) => {
        let list = filterPlatformsByChannel(item.platforms || [], filterId);
        if (!list.length) {
          list =
            filterId !== "all"
              ? [getChannelFilterLabel(filterId)]
              : ["Platform seÃ§ilmedi"];
        }
        list.forEach((platform) => {
          const label = summarizePlatformLabel(platform);
          if (!counts[label]) {
            counts[label] = { count: 0 };
          }
          counts[label].count += 1;
        });
      });
      const entries = Object.entries(counts)
        .map(([label, info]) => [label, info.count])
        .sort((a, b) => b[1] - a[1]);
      return { total: scopedItems.length, entries };
    }

    function updateScheduleList() {
      if (!scheduleList) return;
      scheduleList.innerHTML = "";
      const normalizedQuery = getNormalizedSearchQuery();
      if (normalizedQuery) {
        renderSearchResults(normalizedQuery);
        syncDaySummaryHeight();
        return;
      }
      if (scheduleViewMode === "daily") {
        renderDailySchedule();
      } else if (scheduleViewMode === "monthly") {
        renderMonthlySchedule();
      } else {
        renderWeeklySchedule();
      }
      syncDaySummaryHeight();
    }

    function renderSearchResults(query) {
      const matches = [];
      entriesByDate.forEach((items, key) => {
        const dayData = loadDayData(key);
        const dayItems = dayData.items || [];
        if (!dayItems.length) return;
        const scopedItems = filterEntriesByAssignee(
          dayItems.filter((item) =>
            entryMatchesChannelFilter(item, activeChannelFilter)
          )
        );
        if (!scopedItems.length) return;
        const hasMatch = scopedItems.some((item) =>
          entryMatchesSearchQuery(item, query)
        );
        if (!hasMatch) return;
        matches.push({ key, items: scopedItems });
      });
      if (!matches.length) {
        renderEmptySchedule("AramanÄ±zla eÅŸleÅŸen gÃ¼n bulunamadÄ±.");
        return;
      }
      matches
        .sort((a, b) => a.key.localeCompare(b.key))
        .forEach(({ key, items }) => {
          const dateObj = parseDateKeyString(key);
          const summary = buildDaySummary(items, {
            filterId: activeChannelFilter
          });
          scheduleList.appendChild(
            createScheduleSummaryRow(
              dateObj,
              key,
              summary,
              formatHumanDate(dateObj)
            )
          );
        });
    }

    function focusDayFromSchedule(dateKey, entryId = null) {
      if (!dateKey) return;
      const dateObj = parseDateKeyString(dateKey);
      if (!dateObj) return;
      setSelectedDateState(dateKey, dateObj);
      currentYear = dateObj.getFullYear();
      currentMonth = dateObj.getMonth();
      renderCalendar();
      openModalForDate(dateObj, dateKey, entryId);
    }

    function isDateBeforeToday(dateObj) {
      if (!dateObj) return false;
      const candidate = normalizeToMidnight(dateObj);
      return candidate.getTime() < todayReferenceDate.getTime();
    }

    function isKeyBeforeToday(key) {
      if (!key) return false;
      const dateObj = parseDateKeyString(key);
      return isDateBeforeToday(dateObj);
    }

function getNormalizedSearchQuery(override = null) {
  if (typeof override === "string") {
    return override.trim().toLowerCase();
  }
  return (scheduleSearchQuery || "").trim().toLowerCase();
}

function entryMatchesSearchQuery(entry, queryOverride = null) {
  const query = getNormalizedSearchQuery(queryOverride);
  if (!query) return true;
  const ownerLabel = entry.owner_id ? getOwnerLabel(entry.owner_id) : "";
  const haystack = (
    (entry.text || "") +
    " " +
    (entry.files || "") +
    " " +
    (entry.note || "") +
    " " +
    (entry.time || "") +
    " " +
    formatPlatformsLabel(entry.platforms || []) +
    " " +
    ownerLabel
  )
    .toLowerCase();
  return haystack.includes(query);
}

    function getDailyFocusDateKey() {
      if (summaryDateKey) {
        return summaryDateKey;
      }
      if (scheduleDailyDateKey) {
        return scheduleDailyDateKey;
      }
      if (todayDateKey) {
        return todayDateKey;
      }
      const futureKeys = Array.from(entriesByDate.keys()).sort();
      return futureKeys.length ? futureKeys[0] : null;
    }

    function getDailyRowStatus(entry) {
      if (!entry) {
        return null;
      }
      // Sadece paylaÅŸÄ±ldÄ±/paylaÅŸÄ±lmadÄ± durumlarÄ± iÃ§in ikon
      if (entry.status === "done") {
        return { key: "done", symbol: "âœ“" };
      }
      const pastEntry = isEntryPast(entry);
      if (entry.status === "missed" || (pastEntry && entry.status !== "done")) {
        return { key: "missed", symbol: "âŒ" };
      }
      // Sadece saat atanmÄ±ÅŸ veya pending durumlarÄ± iÃ§in ikon yok
      return null;
    }

    function renderDailySchedule() {
      const focusKey = getDailyFocusDateKey();
      if (!focusKey) {
        renderEmptySchedule("YaklaÅŸan iÃ§erik bulunamadÄ±.");
        return;
      }
      scheduleDailyDateKey = focusKey;
      const dateObj = parseDateKeyString(focusKey);
      const dayData = loadDayData(focusKey);
      const items = filterEntriesByAssignee(
        (dayData.items || []).filter((item) =>
          entryMatchesChannelFilter(item, activeChannelFilter)
        )
      );
      const filtered = sortItemsByTime(
        items.filter((item) => entryMatchesSearchQuery(item))
      );

      const heading = document.createElement("p");
      heading.className = "daily-entry-heading";
      heading.textContent = `${formatHumanDate(dateObj)} Â· ${
        filtered.length ? `${filtered.length} paylaÅŸÄ±m` : "Ä°Ã§erik bulunamadÄ±"
      }`;
      scheduleList.appendChild(heading);

      if (!filtered.length) {
        renderEmptySchedule(
          scheduleSearchQuery
            ? "AramanÄ±zla eÅŸleÅŸen paylaÅŸÄ±m yok."
            : "Bu gÃ¼n iÃ§in yaklaÅŸan iÃ§erik yok."
        );
        return;
      }

      const list = document.createElement("div");
      list.className = "daily-entry-list";
      filtered.forEach((entry) => {
        const statusState = getDailyRowStatus(entry);
        const row = document.createElement("div");
        row.className = "daily-entry-row";
        row.tabIndex = 0;
        row.dataset.entryId = String(entry.id);
        const colorToken = normalizeColorToken(entry.color, null);
        if (colorToken) {
          row.classList.add(`color-${colorToken}`);
        } else {
          row.classList.add("color-default");
        }
        // GÃ¼n DetayÄ± panelinde active class ekleme - mavi ÅŸerit istemiyoruz
        // if (entry.id === activeItemId) {
        //   row.classList.add("active");
        // }

        const body = document.createElement("div");
        body.className = "daily-entry-body";

        // Header: ikon + baÅŸlÄ±k + saat chip
        const header = document.createElement("div");
        header.className = "daily-entry-header";
        
        // Status ikonu sadece paylaÅŸÄ±ldÄ±/paylaÅŸÄ±lmadÄ± durumlarÄ± iÃ§in
        if (statusState) {
          const statusIcon = document.createElement("span");
          statusIcon.className = `daily-entry-status status-${statusState.key}`;
          statusIcon.textContent = statusState.symbol;
          statusIcon.title = formatStatusLabel(entry.status);
          header.appendChild(statusIcon);
        }

        const title = document.createElement("span");
        title.className = "daily-entry-title";
        title.textContent = formatEntryPreviewText(entry, 90);
        header.appendChild(title);
        
        // Saat chip'i saÄŸda
        const hasTime = Boolean(entry.time);
        if (hasTime) {
          const timeChip = document.createElement("span");
          timeChip.className = "daily-entry-time-chip";
          
          const clockIcon = document.createElement("span");
          clockIcon.className = "daily-entry-time-chip-icon";
          clockIcon.textContent = "â°";
          clockIcon.setAttribute("aria-hidden", "true");
          timeChip.appendChild(clockIcon);
          
          timeChip.appendChild(document.createTextNode(entry.time));
          header.appendChild(timeChip);
        }
        
        body.appendChild(header);

        // Platform satÄ±rÄ±
        const platformLine = document.createElement("div");
        platformLine.className = "daily-entry-meta";
        platformLine.textContent = formatPlatformsLabel(entry.platforms || [], {
          filterId: activeChannelFilter
        });
        body.appendChild(platformLine);
        
        // Sorumlu satÄ±rÄ±
        const ownerLabel = getOwnerLabel(entry.owner_id);
        if (ownerLabel) {
          const ownerLine = document.createElement("div");
          ownerLine.className = "daily-entry-meta daily-entry-owner";
          ownerLine.textContent = `Sorumlu: ${ownerLabel}`;
          body.appendChild(ownerLine);
        }
        
        // Footer'Ä± HER ZAMAN oluÅŸtur (Excel olsun olmasÄ±n)
        const footer = document.createElement("div");
        footer.className = "daily-entry-footer";
        
        // Excel badge'i sadece Excel kartlarÄ±nda gÃ¶rÃ¼nsÃ¼n
        if (entry.source && entry.source.toLowerCase() === "excel") {
          const badge = document.createElement("span");
          badge.className = "summary-item-badge excel";
          badge.textContent = "Excel";
          footer.appendChild(badge);
        }
        
        body.appendChild(footer);
        row.appendChild(body);
        const openEntry = () => {
          if (entry.date) {
            const parsed = parseDateKeyString(entry.date);
            if (parsed) {
              openModalForDate(parsed, entry.date, entry.id);
              return;
            }
          }
          selectEntryById(entry.id);
        };
        row.addEventListener("click", openEntry);
        row.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            openEntry();
          }
        });
        list.appendChild(row);
      });
      scheduleList.appendChild(list);
    }

    function getWeeklyRangeStartDate() {
      const summary =
        summaryDateKey && parseDateKeyString(summaryDateKey);
      if (summary) {
        return normalizeToMidnight(summary);
      }
      if (scheduleDailyDateKey) {
        const fallback = parseDateKeyString(scheduleDailyDateKey);
        if (fallback) {
          return normalizeToMidnight(fallback);
        }
      }
      return todayReferenceDate;
    }

    function getSelectedMonthStartDate() {
      const summary =
        summaryDateKey && parseDateKeyString(summaryDateKey);
      const base = summary || new Date(currentYear, currentMonth, 1);
      return normalizeToMidnight(new Date(base.getFullYear(), base.getMonth(), 1));
    }

    function getSelectedMonthEndDate() {
      const monthStart = getSelectedMonthStartDate();
      return normalizeToMidnight(
        new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0)
      );
    }

    function addDays(date, amount) {
      const cloned = new Date(date);
      cloned.setDate(cloned.getDate() + amount);
      cloned.setHours(0, 0, 0, 0);
      return cloned;
    }

    function renderMonthlySchedule() {
      const monthStart = getSelectedMonthStartDate();
      const monthEnd = getSelectedMonthEndDate();
      if (monthStart.getTime() > monthEnd.getTime()) {
        renderEmptySchedule("Bu ay iÃ§in iÃ§erik bulunamadÄ±.");
        return;
      }
      renderRangeSchedule(monthStart, monthEnd, "Bu ay iÃ§in iÃ§erik bulunamadÄ±.");
    }

    function renderRangeSchedule(rangeStart, rangeEnd, emptyMessage) {
      if (!rangeStart || !rangeEnd || rangeStart.getTime() > rangeEnd.getTime()) {
        renderEmptySchedule(emptyMessage);
        return;
      }
      let any = false;
      const query = scheduleSearchQuery;
      const cursor = new Date(rangeStart);
      cursor.setHours(0, 0, 0, 0);

      while (cursor.getTime() <= rangeEnd.getTime()) {
        const key = formatDateKey(cursor);
        const dayData = loadDayData(key);
        const items = filterEntriesByAssignee(
          (dayData.items || []).filter((item) =>
            entryMatchesChannelFilter(item, activeChannelFilter)
          )
        );
        if (items.length) {
          const summary = buildDaySummary(items, { filterId: activeChannelFilter });
          if (summary.total) {
            const humanDate = formatHumanDate(cursor);
            const haystack = (
              humanDate +
              " " +
              summary.entries.map(([label]) => label).join(" ")
            ).toLowerCase();
            if (!query || haystack.includes(query)) {
              any = true;
              const snapshot = new Date(
                cursor.getFullYear(),
                cursor.getMonth(),
                cursor.getDate()
              );
              scheduleList.appendChild(
                createScheduleSummaryRow(snapshot, key, summary, humanDate)
              );
            }
          }
        }
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }

      if (!any) {
        renderEmptySchedule(emptyMessage);
      }
    }

    function createScheduleSummaryRow(dateObj, key, summary, humanDate) {
      const row = document.createElement("div");
      row.className = "schedule-item summary";
      row.dataset.dateKey = key;
      row.tabIndex = 0;
      const highlightColor = highlightedDates.get(key);
      if (highlightColor) {
        row.classList.add("has-highlight");
        row.dataset.color = highlightColor;
      } else {
        row.classList.remove("has-highlight");
        delete row.dataset.color;
      }
      // GÃ¼n DetayÄ± panelinde active class ekleme - mavi ÅŸerit istemiyoruz
      // if (activeScheduleSummaryKey === key) {
      //   row.classList.add("active");
      // }

      const header = document.createElement("div");
      header.className = "schedule-summary-header";
      const headerSuffix =
        activeChannelFilter === "all"
          ? `${summary.total} paylaÅŸÄ±m`
          : `${getChannelFilterLabel(activeChannelFilter)} ${summary.total} paylaÅŸÄ±m`;
      header.textContent = `${humanDate} Â· ${headerSuffix}`;
      row.appendChild(header);

      const chips = document.createElement("div");
      chips.className = "schedule-summary-chips";
      summary.entries.forEach(([label, count]) => {
        const chip = document.createElement("span");
        chip.className = "summary-chip";
        chip.textContent = `${count} ${label}`;
        chips.appendChild(chip);
      });
      row.appendChild(chips);

      const activateSummaryRow = () => {
        focusDayFromSchedule(key);
      };
      row.addEventListener("click", activateSummaryRow);
      row.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          activateSummaryRow();
        }
      });

      return row;
    }

    function renderEmptySchedule(message) {
      const container = document.createElement("div");
      container.style.cssText = "display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 24px 16px;";
      
      const empty = document.createElement("p");
      empty.className = "small";
      empty.style.cssText = "margin: 0; text-align: center; color: #64748b;";
      empty.textContent = scheduleSearchQuery
        ? "AramanÄ±zla eÅŸleÅŸen gÃ¼n bulunamadÄ±."
        : message;
      container.appendChild(empty);
      
      // Arama yoksa ve seÃ§ili bir tarih varsa "PaylaÅŸÄ±m oluÅŸtur" butonu ekle
      if (!scheduleSearchQuery && selectedDateKey) {
        const createBtn = document.createElement("button");
        createBtn.className = "secondary-btn modal-create-btn";
        createBtn.style.cssText = "padding: 7px 13px; font-size: 9px; font-weight: 600;";
        createBtn.textContent = "+ PaylaÅŸÄ±m oluÅŸtur";
        createBtn.onclick = () => {
          // GiriÅŸ kontrolÃ¼
          if (!authToken) {
            alert("PaylaÅŸÄ±m oluÅŸturmak iÃ§in Ã¶nce giriÅŸ yap.");
            showLoginOverlay();
            return;
          }
          if (!isViewingOwnData()) {
            alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
            return;
          }
          
          // MODALIN AÃ‡IK OLMADIÄžI DURUMDA, MODALI AÃ‡
          if (dayModal.style.display === "none" || !selectedDateKey) {
            // EÄŸer selectedDateKey varsa o tarihi aÃ§, yoksa bugÃ¼nÃ¼ aÃ§
            const targetKey = selectedDateKey || todayDateKey;
            if (targetKey) {
              const dateObj = parseDateKeyString(targetKey);
              if (dateObj) {
                openModalForDate(dateObj, targetKey, null);
                return; // Modal aÃ§Ä±ldÄ±, fonksiyondan Ã§Ä±k
              }
            }
          }
          
          // Modal zaten aÃ§Ä±ksa, sadece formu temizle ve gÃ¶ster
          activeItemId = null;
          modalForcePlanMode = false;
          clearFormOnly();
          setModalViewForEntry(null); // Bu fonksiyon form bÃ¶lÃ¼mÃ¼nÃ¼ "flex" olarak gÃ¶sterir
          deleteBtn.disabled = true;
          renderModalSummaryList();
        };
        container.appendChild(createBtn);
      }
      
      scheduleList.appendChild(container);
    }

    function renderWeeklySchedule() {
      const start = getWeeklyRangeStartDate();
      const monthEnd = getSelectedMonthEndDate();
      if (start.getTime() > monthEnd.getTime()) {
        renderEmptySchedule("YaklaÅŸan iÃ§erik bulunamadÄ±.");
        return;
      }
      let end = addDays(start, 6);
      if (end.getTime() > monthEnd.getTime()) {
        end = monthEnd;
      }
      renderRangeSchedule(start, end, "Bu hafta iÃ§in iÃ§erik bulunamadÄ±.");
    }

    /* Takvim */
    function renderCalendar() {
      try {
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const firstWeekday = (firstDay.getDay() + 6) % 7;
        const daysInMonth = lastDay.getDate();

        monthLabel.textContent = monthNames[currentMonth] + " " + currentYear;

        daysContainer.innerHTML = "";

      for (let i = 0; i < firstWeekday; i++) {
        const empty = document.createElement("div");
        daysContainer.appendChild(empty);
      }

      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth();
      const todayDay = today.getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.className = "day";

        // BugÃ¼nkÃ¼ tarihi iÅŸaretle
        if (day === todayDay && currentMonth === todayMonth && currentYear === todayYear) {
          cell.classList.add("today");
        }

        const numSpan = document.createElement("div");
        numSpan.className = "day-number";
        const numInner = document.createElement("span");
        numInner.className = "day-number-inner";
        numInner.textContent = day;
        numSpan.appendChild(numInner);
        cell.appendChild(numSpan);

      const body = document.createElement("div");
      body.className = "day-body";
      cell.appendChild(body);

      const dateObj = new Date(currentYear, currentMonth, day);
      const key = formatDateKey(dateObj);
      const dayData = loadDayData(key);
      const items = dayData.items || [];
      const channelScopedItems = filterEntriesByChannel(items, activeChannelFilter);
      const visibleItems = filterEntriesByAssignee(channelScopedItems);
        const highlightColor = highlightedDates.get(key);
        if (highlightColor) {
          cell.classList.add("day-highlighted");
          cell.dataset.color = highlightColor;
        } else {
          cell.classList.remove("day-highlighted");
          delete cell.dataset.color;
        }

        const matchesChannel = dayMatchesChannelFilter(items, activeChannelFilter);
        const hasVisibleAssigneeItems = visibleItems.length > 0;
        if (
          (activeChannelFilter !== "all" && !matchesChannel) ||
          (assigneeFilter === "mine" && !hasVisibleAssigneeItems)
        ) {
          cell.classList.add("filtered-out");
        } else {
          cell.classList.remove("filtered-out");
        }

        if (visibleItems.length) {
          cell.classList.add("has-data");
          const summary = buildDaySummary(visibleItems, { filterId: activeChannelFilter });
          if (summary.total > 0) {
            const counter = document.createElement("div");
            counter.className = "day-counter";
            const entriesToShow = summary.entries.slice(0, 3);
            const visibleTotal = entriesToShow.reduce(
              (sum, [, count]) => sum + count,
              0
            );
            if (activeChannelFilter === "all") {
              counter.textContent =
                visibleTotal === 1
                  ? "1 iÃ§erik"
                  : `${visibleTotal} iÃ§erik`;
            } else {
              counter.textContent = `${getChannelFilterLabel(
                activeChannelFilter
              )} ${visibleTotal} iÃ§erik`;
            }
            body.appendChild(counter);
            entriesToShow.forEach(([label, count]) => {
              const chip = document.createElement("div");
              chip.className = "day-summary-chip";
              chip.textContent = `${count} ${label}`;
              body.appendChild(chip);
            });
          }
        }

        cell.addEventListener("click", () => {
          openModalForDate(dateObj, key);
        });

       daysContainer.appendChild(cell);
      }

      updateScheduleList();
      syncDaySummaryHeight();
      } catch (err) {
        console.error('[renderCalendar] DOM manipÃ¼lasyon hatasÄ±:', err);
        showErrorToast('Takvim gÃ¶rÃ¼ntÃ¼lenemedi');
      }
    }

    /* Modal iÃ§i liste */
    function renderModalSummaryList() {
      try {
        modalSummary.innerHTML = "";

        if (!currentDayItems.length) {
        deleteBtn.disabled = true;
        const empty = document.createElement("div");
        empty.className = "summary-empty";
        empty.textContent = "Bu gÃ¼n iÃ§in kayÄ±tlÄ± iÃ§erik yok.";
        modalSummary.appendChild(empty);
        
        // BoÅŸ listede "PaylaÅŸÄ±m oluÅŸtur" butonu ekle
        const createBtn = document.createElement("button");
        createBtn.className = "secondary-btn modal-create-btn";
        createBtn.style.cssText = "padding: 7px 13px; font-size: 9px; font-weight: 600; margin-top: 12px;";
        createBtn.textContent = "+ PaylaÅŸÄ±m oluÅŸtur";
        createBtn.onclick = () => {
          // GiriÅŸ kontrolÃ¼
          if (!authToken) {
            alert("PaylaÅŸÄ±m oluÅŸturmak iÃ§in Ã¶nce giriÅŸ yap.");
            showLoginOverlay();
            return;
          }
          if (!isViewingOwnData()) {
            alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
            return;
          }
          // Form aÃ§ma iÅŸlemleri (toggleFormBtn ile aynÄ±)
          activeItemId = null;
          modalForcePlanMode = false;
          clearFormOnly();
          setModalViewForEntry(null); // Bu fonksiyon form bÃ¶lÃ¼mÃ¼nÃ¼ "flex" olarak gÃ¶sterir
          deleteBtn.disabled = true;
          renderModalSummaryList();
        };
        modalSummary.appendChild(createBtn);
        
        return;
      }

      currentDayItems = sortItemsByTime(currentDayItems);
      deleteBtn.disabled = !activeItemId || !isViewingOwnData();

      currentDayItems.forEach((item, index) => {
        const wrap = document.createElement("div");
        wrap.className = "summary-item";
        wrap.setAttribute("role", "button");
        wrap.setAttribute("tabindex", "0");
        if (item.id === activeItemId) wrap.classList.add("active");
        const cardColor = normalizeColorToken(item.color, null);
        if (cardColor) {
          wrap.classList.add(`color-${cardColor}`);
        } else {
          wrap.classList.add("color-default");
        }
        wrap.dataset.entryId = String(item.id);
        if (item.source === "excel") wrap.classList.add("excel");
        const statusKey =
          item.status === "done" || item.status === "missed"
            ? item.status
            : "planned";
        wrap.dataset.status = statusKey;
        const { snippet, platforms, time } = makeItemSummary(item);
        const header = document.createElement("div");
        header.className = "summary-item-head";

        const headerLeft = document.createElement("div");
        headerLeft.className = "summary-item-header-left";

        // Status ikonu (GÃ¼n DetayÄ± panelindeki gibi)
        const statusState = getDailyRowStatus(item);
        if (statusState) {
          const statusIcon = document.createElement("span");
          statusIcon.className = `daily-entry-status status-${statusState.key}`;
          statusIcon.textContent = statusState.symbol;
          statusIcon.title = formatStatusLabel(item.status);
          headerLeft.appendChild(statusIcon);
        }

        const title = document.createElement("div");
        title.className = "summary-item-title";
        title.textContent = snippet || `Ä°Ã§erik ${index + 1}`;
        headerLeft.appendChild(title);
        header.appendChild(headerLeft);

        const statusWrap = document.createElement("div");
        statusWrap.className = "summary-item-header-right";
        
        // Saat chip'i
        if (time) {
          const timeChip = document.createElement("span");
          timeChip.className = "summary-item-time-chip";
          const timeIcon = document.createElement("span");
          timeIcon.className = "icon-clock";
          timeIcon.textContent = "â°";
          timeChip.appendChild(timeIcon);
          timeChip.appendChild(document.createTextNode(time));
          statusWrap.appendChild(timeChip);
        }
        
        // Excel badge
        if (item.source === "excel") {
          const excelBadge = document.createElement("span");
          excelBadge.className = "summary-item-badge excel";
          excelBadge.textContent = "Excel";
          statusWrap.appendChild(excelBadge);
        }
        
        header.appendChild(statusWrap);

        wrap.appendChild(header);

        const platformsDiv = document.createElement("div");
        platformsDiv.className = "summary-item-platforms";
        platformsDiv.textContent = platforms;
        wrap.appendChild(platformsDiv);

        const ownerLabel = getOwnerLabel(item.owner_id);
        const ownerDiv = document.createElement("div");
        ownerDiv.className = "summary-item-owner";
        ownerDiv.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
        wrap.appendChild(ownerDiv);

        const footer = document.createElement("div");
        footer.className = "summary-item-footer";
        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "summary-item-copy-icon";
        copyBtn.setAttribute("aria-label", "PaylaÅŸÄ±mÄ± kopyala");
        copyBtn.textContent = "â§‰";
        copyBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          openCopyPopover(item);
        });
        footer.appendChild(copyBtn);
        wrap.appendChild(footer);

        wrap.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            selectEntryById(item.id);
          }
        });

        modalSummary.appendChild(wrap);
      });
      updateEditingPermissions();
      } catch (err) {
        console.error('[renderModalSummaryList] DOM manipÃ¼lasyon hatasÄ±:', err);
        showErrorToast('Liste gÃ¶rÃ¼ntÃ¼lenemedi');
      }
    }

    function selectEntryById(entryId, forcePlan = false) {
      let entry = entriesById.get(entryId);
      if (!entry && Array.isArray(currentDayItems)) {
        entry = currentDayItems.find((it) => it.id === entryId) || null;
        if (entry) {
          entriesById.set(entry.id, entry);
        }
      }
      if (!entry) return;
      activeItemId = entryId;
      modalForcePlanMode = Boolean(forcePlan);
      populateFormWithEntry(entry);
      deleteBtn.disabled = !activeItemId || !isViewingOwnData();
      renderModalSummaryList();
      setModalViewForEntry(entry);
      setControlActionsEnabled(Boolean(authToken) && isViewingOwnData());
    }

    function populateFormWithEntry(entry) {
      hideSaveSuccessMessage();
      filesInput.value = entry.files || "";
      textInput.value = entry.text || "";
      timeInput.value = entry.time || "";
      platformInputs.forEach((cb) => {
        cb.checked = entry.platforms
          ? entry.platforms.includes(cb.value)
          : false;
      });
  if (entryColorInput) {
    const entryColor = normalizeColorToken(entry.color, null) || "";
    entryColorInput.value = entryColor || DEFAULT_ENTRY_COLOR;
    updateColorToggle(entryColorToggle, entryColor || DEFAULT_ENTRY_COLOR);
    if (entryColorPicker) {
      setColorPickerValue(entryColorPicker, entryColorInput, entryColor);
    }
  }
  if (noteInput) {
    noteInput.value = entry.note || "";
  }
  if (controlNoteInput) {
    controlNoteInput.value = entry.note || "";
  }
  // Sorumlu kiÅŸi seÃ§imini formu yÃ¼klerken de gÃ¼ncelle
  if (ownerSelect) {
    const ownerValue = entry.owner_id ? String(entry.owner_id) : "";
    if (ownerValue && responsibleUserMap.has(Number(ownerValue))) {
      ownerSelect.value = ownerValue;
    } else if (currentUser && responsibleUserMap.has(currentUser.id)) {
      ownerSelect.value = String(currentUser.id);
    } else {
      ownerSelect.value = "";
    }
  }
}
    function updatePendingCountBadge(count) {
      if (!pendingCountBadge) return;
      pendingCountBadge.textContent = `(${count} bekleyen kayÄ±t)`;
      pendingCountBadge.classList.toggle("has-pending", count > 0);
    }

    function setPlanReturnBannerVisible(visible) {
      if (!planReturnBanner) return;
      planReturnBanner.style.display = visible ? "flex" : "none";
      setControlActionsEnabled(Boolean(authToken) && isViewingOwnData());
    }

    function showPlanningView(entry, options = {}) {
      if (modalFormSection) modalFormSection.style.display = "flex";
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      setPlanReturnBannerVisible(Boolean(options.showReturnBanner));
    }

    function fillControlSummary(entry) {
      if (!entry) return;
      const dateObj = parseDateKeyString(entry.date);
      const dateLabel = dateObj ? formatHumanDate(dateObj) : entry.date;
      if (controlSummaryTitle) {
        controlSummaryTitle.textContent =
          entry.text || entry.files || "Ä°Ã§erik detayÄ±";
      }
      if (controlSummaryMeta) {
        controlSummaryMeta.textContent = `${dateLabel} Â· ${
          entry.time || "Saat seÃ§ilmedi"
        }`;
      }
      if (controlSummaryPlatforms) {
        controlSummaryPlatforms.textContent = formatPlatformsLabel(
          entry.platforms
        );
      }
      if (controlSummaryOwner) {
        const ownerLabel = getOwnerLabel(entry.owner_id);
        controlSummaryOwner.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
      }
      if (controlNoteInput) {
        controlNoteInput.value = entry.note || "";
      }
      if (ownerSelect) {
        const ownerValue = entry.owner_id
          ? String(entry.owner_id)
          : "";
        if (ownerValue && responsibleUserMap.has(Number(ownerValue))) {
          ownerSelect.value = ownerValue;
        } else if (currentUser && responsibleUserMap.has(currentUser.id)) {
          ownerSelect.value = String(currentUser.id);
        } else {
          ownerSelect.value = "";
        }
      }
    }

    function fillCheckedSummary(entry) {
      if (!entry) return;
      const dateObj = parseDateKeyString(entry.date);
      const dateLabel = dateObj ? formatHumanDate(dateObj) : entry.date;
      if (checkedSummaryMeta) {
        checkedSummaryMeta.textContent = `${dateLabel} Â· ${
          entry.time || "Saat seÃ§ilmedi"
        }`;
      }
      if (checkedSummaryPlatforms) {
        checkedSummaryPlatforms.textContent = formatPlatformsLabel(
          entry.platforms
        );
      }
      if (checkedSummaryOwner) {
        const ownerLabel = getOwnerLabel(entry.owner_id);
        checkedSummaryOwner.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
      }
      if (checkedStatusBadge) {
        checkedStatusBadge.textContent = formatStatusLabel(entry.status);
        checkedStatusBadge.classList.toggle(
          "missed",
          entry.status === "missed"
        );
      }
      if (checkedNoteText) {
        if (entry.note) {
          checkedNoteText.style.display = "";
          checkedNoteText.textContent = entry.note;
        } else {
          checkedNoteText.style.display = "none";
          checkedNoteText.textContent = "";
        }
      }
      if (checkedInfoText) {
        checkedInfoText.textContent = entry.checkedAt
          ? `Kontrol tarihi: ${formatDateTimeHuman(entry.checkedAt)}`
          : "";
      }
    }

    function showControlView(entry) {
      if (!entry) {
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      modalForcePlanMode = false;
      if (modalFormSection) modalFormSection.style.display = "none";
      if (modalControlSection) modalControlSection.style.display = "block";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      setPlanReturnBannerVisible(false);
      fillControlSummary(entry);
    }

    function showCheckedView(entry) {
      if (!entry) {
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      modalForcePlanMode = false;
      if (modalFormSection) modalFormSection.style.display = "none";
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "block";
      setPlanReturnBannerVisible(false);
      fillCheckedSummary(entry);
    }

    function setControlActionsEnabled(enabled) {
      [markDoneBtn, markMissedBtn, controlEditBtn, checkedEditBtn].forEach(
        (btn) => {
          if (btn) btn.disabled = !enabled;
        }
      );
      if (controlNoteInput) {
        controlNoteInput.readOnly = !enabled;
      }
      if (returnToControlBtn) {
        const bannerVisible =
          planReturnBanner && planReturnBanner.style.display !== "none";
        returnToControlBtn.disabled = !enabled || !bannerVisible;
      }
    }

    function setModalViewForEntry(entry) {
      if (!entry) {
        modalForcePlanMode = false;
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      const past = isEntryPast(entry);
      const status = entry.status || "planned";
      if (!modalForcePlanMode && past && status === "planned") {
        showControlView(entry);
        return;
      }
      if (!modalForcePlanMode && (status === "done" || status === "missed")) {
        showCheckedView(entry);
        return;
      }
      showPlanningView(entry, {
        showReturnBanner: modalForcePlanMode && (past || status !== "planned")
      });
    }

    function clearFormOnly(options = {}) {
      filesInput.value = "";
      textInput.value = "";
      timeInput.value = "";
  platformInputs.forEach((cb) => (cb.checked = false));
  if (entryColorInput) entryColorInput.value = DEFAULT_ENTRY_COLOR;
    if (entryColorPicker && entryColorInput) {
      setColorPickerValue(
        entryColorPicker,
          entryColorInput,
          DEFAULT_ENTRY_COLOR
        );
      }
      updateColorToggle(entryColorToggle, DEFAULT_ENTRY_COLOR);
      if (noteInput) noteInput.value = "";
      if (controlNoteInput) controlNoteInput.value = "";
      if (ownerSelect) {
        if (currentUser && responsibleUserMap.has(currentUser.id)) {
          ownerSelect.value = String(currentUser.id);
        } else {
          ownerSelect.value = "";
        }
      }
      setPlanReturnBannerVisible(false);
      if (!options.preserveSuccessMessage) {
        hideSaveSuccessMessage();
      }
    }

    function updateHighlightStateUI() {
      if (!highlightColorInput) return;
      if (!selectedDateKey) {
        highlightColorInput.disabled = true;
        setHighlightInputValue(DEFAULT_HIGHLIGHT_COLOR);
        setColorPickerEnabled(
          highlightColorWrapper,
          highlightColorToggle,
          false
        );
        return;
      }
      const hasHighlight = highlightedDates.has(selectedDateKey);
      const colorValue = hasHighlight
        ? highlightedDates.get(selectedDateKey)
        : DEFAULT_HIGHLIGHT_COLOR;
      highlightColorInput.disabled = !isViewingOwnData();
      setHighlightInputValue(colorValue);
      setColorPickerEnabled(
        highlightColorWrapper,
        highlightColorToggle,
        isViewingOwnData()
      );
    }

    async function setDateHighlight(dateKey, colorValue = DEFAULT_HIGHLIGHT_COLOR) {
      const colorToken = normalizeColorToken(colorValue, DEFAULT_HIGHLIGHT_COLOR);
      const payload = { date: dateKey, color: colorToken };
      const response = await apiFetch("/calendar/highlights", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      const normalized = normalizeColorToken(
        data.color || colorToken,
        DEFAULT_HIGHLIGHT_COLOR
      );
      if (normalized) {
        highlightedDates.set(data.date || dateKey, normalized);
      }
    }

    async function removeDateHighlight(dateKey) {
      await apiFetch(`/calendar/highlights/${dateKey}`, { method: "DELETE" });
      highlightedDates.delete(dateKey);
    }


    function openModalForDate(dateObj, key, initialItemId = null) {
      closeCopyPopover();
      setSelectedDateState(key, dateObj);
      const dayData = loadDayData(key);
      currentDayItems = dayData.items || [];
      activeItemId = initialItemId;
      modalForcePlanMode = false;

      modalDateTitle.textContent = formatHumanDate(dateObj);
      updateHighlightStateUI();

      clearFormOnly();
      deleteBtn.disabled = !activeItemId;

      let selectedEntry = null;
      if (activeItemId) {
        selectedEntry =
          entriesById.get(activeItemId) ||
          currentDayItems.find((it) => it.id === activeItemId) ||
          null;
        if (selectedEntry) {
          entriesById.set(selectedEntry.id, selectedEntry);
          populateFormWithEntry(selectedEntry);
        } else {
          activeItemId = null;
        }
      }

      if (!selectedEntry && activeItemId === null) {
        clearFormOnly();
        if (modalFormSection) modalFormSection.style.display = "none";
        if (modalControlSection) modalControlSection.style.display = "none";
        if (modalCheckedSection) modalCheckedSection.style.display = "none";
        setPlanReturnBannerVisible(false);
      } else {
        setModalViewForEntry(selectedEntry);
      }
      renderModalSummaryList();
      openModalHelper(dayModal);
      updateScheduleList();
    }

    function closeModal() {
      closeModalHelper(dayModal);
      modalForcePlanMode = false;
      setPlanReturnBannerVisible(false);
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      if (modalFormSection) modalFormSection.style.display = "none";
      activeItemId = null;
      toggleColorHelpPanel(false);
      closeCopyPopover();
      hideSaveSuccessMessage();
      selectedDateKey = summaryDateKey;
      renderCalendar();
    }

    function normalizeToMidnight(date) {
      if (!date) return null;
      const normalized = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      normalized.setHours(0, 0, 0, 0);
      return normalized;
    }
    function formatDateInputValue(date) {
      if (!date) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function parseDateInput(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (
        Number.isNaN(year) ||
        Number.isNaN(month) ||
        Number.isNaN(day)
      ) {
        return null;
      }
      const parsed = new Date(year, month - 1, day);
      if (
        parsed.getFullYear() !== year ||
        parsed.getMonth() !== month - 1 ||
        parsed.getDate() !== day
      ) {
        return null;
      }
      return normalizeToMidnight(parsed);
    }

    function clearReportOutputs() {
      reportTotal.textContent = "-";
      reportPlatforms.innerHTML = "";
      reportTimes.innerHTML = "";
      reportDays.textContent = "-";
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "";
      if (reportFilterLabel) reportFilterLabel.textContent = "";
      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }
      if (platformChartWrapper) platformChartWrapper.style.display = "none";
      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }
      if (timeChartWrapper) timeChartWrapper.style.display = "none";
      clearExecutedOutputs();
    }

    function clearExecutedOutputs() {
      if (reportsExecutedSection) {
        reportsExecutedSection.style.display = "none";
      }
      if (executedTableBody) executedTableBody.innerHTML = "";
      if (executedEmptyMessage) executedEmptyMessage.style.display = "none";
      if (executedSummaryLine) executedSummaryLine.textContent = "";
    }

    /* Ä°statistik hesaplama: seÃ§ilen tarih aralÄ±ÄŸÄ± iÃ§in */
    function buildStatsForRange(rangeStartDate, rangeEndDate, filterId = "all") {
      const startDate = normalizeToMidnight(rangeStartDate);
      const endDate = normalizeToMidnight(rangeEndDate);
    const platformsList = [
      "Instagram Post","Instagram Story","Instagram Reels","Instagram",
      "Facebook","X","Reddit","Discord",
      "YouTube","LinkedIn","TikTok","Telegram","Medium"
    ];

      let total = 0;
      const platformCounts = {};
      let early = 0, mid = 0, late = 0, noTime = 0;
      let daysWithContent = 0;

      platformsList.forEach((p) => (platformCounts[p] = 0));

      if (!startDate || !endDate || startDate > endDate) {
        return {
          total,
          platformCounts,
          early,
          mid,
          late,
          noTime,
          daysWithContent,
          startDate,
          endDate
        };
      }

      const cursor = new Date(startDate);

      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const items = loadDayData(key).items;
        if (!items.length) {
          cursor.setDate(cursor.getDate() + 1);
          cursor.setHours(0, 0, 0, 0);
          continue;
        }

        let dayHasContent = false;

        items.forEach((item) => {
          const hasContent =
            item.text || item.files || item.time || (item.platforms && item.platforms.length);
          if (!hasContent) return;
          if (!entryMatchesChannelFilter(item, filterId)) return;
          if (!entryMatchesAssigneeFilter(item)) return;

          dayHasContent = true;
          total++;

          (item.platforms || []).forEach((p) => {
            if (!platformCounts[p]) platformCounts[p] = 0;
            platformCounts[p]++;
          });

          if (!item.time) {
            noTime++;
          } else {
            const mins = minutesFromTime(item.time);
            if (mins < 12 * 60) early++;
            else if (mins < 18 * 60) mid++;
            else late++;
          }
        });

        if (dayHasContent) daysWithContent++;
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }

      return {
        total,
        platformCounts,
        early,
        mid,
        late,
        noTime,
        daysWithContent,
        startDate,
        endDate
      };
    }

    function setRangeInputs(startDate, endDate) {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      reportRangeStartInput.value = formatDateInputValue(startDate);
      reportRangeEndInput.value = formatDateInputValue(endDate);
    }

    function ensureRangeInputsInitialized() {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      const currentStart = parseDateInput(reportRangeStartInput.value);
      const currentEnd = parseDateInput(reportRangeEndInput.value);
      if (currentStart && currentEnd) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - 6);
      setRangeInputs(start, end);
    }

    function applyQuickRange(days) {
      if (!Number.isFinite(days) || days < 1) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - (days - 1));
      setRangeInputs(start, end);
      if (reportMode === "range") renderReports();
    }

    function getReportRangeInfo() {
      if (reportMode === "range") {
        const parsedStart = parseDateInput(
          reportRangeStartInput ? reportRangeStartInput.value : ""
        );
        const parsedEnd = parseDateInput(
          reportRangeEndInput ? reportRangeEndInput.value : ""
        );
        if (!parsedStart || !parsedEnd) return null;
        let rangeStart = parsedStart;
        let rangeEnd = parsedEnd;
        if (rangeStart > rangeEnd) {
          rangeStart = parsedEnd;
          rangeEnd = parsedStart;
          if (reportRangeStartInput && reportRangeEndInput) {
            reportRangeStartInput.value = formatDateInputValue(rangeStart);
            reportRangeEndInput.value = formatDateInputValue(rangeEnd);
          }
        }
        return {
          start: rangeStart,
          end: rangeEnd,
          label: `${formatHumanDate(rangeStart)} - ${formatHumanDate(rangeEnd)} arasÄ± Ã¶zet`
        };
      }
      const rangeStart = normalizeToMidnight(new Date(currentYear, currentMonth, 1));
      const rangeEnd = normalizeToMidnight(new Date(currentYear, currentMonth + 1, 0));
      return {
        start: rangeStart,
        end: rangeEnd,
        label: `${monthNames[currentMonth]} ${currentYear} iÃ§in aylÄ±k Ã¶zet`
      };
    }

    function collectEntriesInRange(rangeStartDate, rangeEndDate, filterId = "all") {
      const startDate = normalizeToMidnight(rangeStartDate);
      const endDate = normalizeToMidnight(rangeEndDate);
      if (!startDate || !endDate || startDate > endDate) return [];
      const results = [];
      const cursor = new Date(startDate);
      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const items = filterEntriesByAssignee(
          filterEntriesByChannel(loadDayData(key).items || [], filterId)
        );
        items.forEach((item) => results.push(item));
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }
      return results;
    }

    function renderReportsSummary(rangeInfo) {
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "";
      if (reportsExecutedSection) reportsExecutedSection.style.display = "none";
      const stats = buildStatsForRange(
        rangeInfo.start,
        rangeInfo.end,
        activeChannelFilter
      );
      reportTotal.textContent = stats.total + " planlanmÄ±ÅŸ iÃ§erik";

      reportPlatforms.innerHTML = "";
      const entries = Object.entries(stats.platformCounts)
        .filter(([, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        const li = document.createElement("li");
        li.textContent = "Bu aralÄ±k iÃ§in platform seÃ§ilmiÅŸ iÃ§erik yok.";
        reportPlatforms.appendChild(li);
      } else {
        entries.forEach(([platform, count]) => {
          const li = document.createElement("li");
          li.textContent = platform + ": " + count;
          reportPlatforms.appendChild(li);
        });
      }
      renderPlatformChart(entries);

      reportTimes.innerHTML = "";
      const slots = [
        ["Sabah (06:00â€“11:59)", stats.early],
        ["Ã–ÄŸlen / Ã–ÄŸleden sonra (12:00â€“17:59)", stats.mid],
        ["AkÅŸam (18:00â€“23:59)", stats.late],
        ["Saat belirtilmemiÅŸ", stats.noTime]
      ];
      slots.forEach(([label, count]) => {
        const li = document.createElement("li");
        li.textContent = label + ": " + count;
        reportTimes.appendChild(li);
      });
      renderTimeChart(stats);

      reportDays.textContent =
        stats.daysWithContent + " gÃ¼nde en az bir iÃ§erik planlanmÄ±ÅŸ.";
      clearExecutedOutputs();
    }

    function renderReportsExecuted(rangeInfo, entries) {
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "none";
      if (reportsExecutedSection) reportsExecutedSection.style.display = "block";
      if (!executedSummaryLine || !executedTableBody) return;

      const doneCount = entries.filter((entry) => entry.status === "done").length;
      const missedCount = entries.filter((entry) => entry.status === "missed").length;
      const plannedCount = entries.length - doneCount - missedCount;
      executedSummaryLine.textContent = `SeÃ§ilen aralÄ±kta ${doneCount} paylaÅŸÄ±lan, ${missedCount} kaÃ§an, ${plannedCount} planlÄ± iÃ§erik var.`;

      const showMissed = Boolean(executedShowMissedToggle && executedShowMissedToggle.checked);
      const rows = entries
        .filter(
          (entry) =>
            entry.status === "done" || (showMissed && entry.status === "missed")
        )
        .sort((a, b) => {
          const aDate = getEntryDateTime(a);
          const bDate = getEntryDateTime(b);
          return (bDate ? bDate.getTime() : 0) - (aDate ? aDate.getTime() : 0);
        });

      executedTableBody.innerHTML = "";
      if (!rows.length) {
        if (executedEmptyMessage) executedEmptyMessage.style.display = "block";
        return;
      }
      if (executedEmptyMessage) executedEmptyMessage.style.display = "none";

      rows.forEach((entry) => {
        const tr = document.createElement("tr");

        const dateCell = document.createElement("td");
        dateCell.dataset.label = "Tarih";
        const entryDate = parseDateInput(entry.date);
        dateCell.textContent = entryDate ? formatHumanDate(entryDate) : entry.date;
        tr.appendChild(dateCell);

        const timeCell = document.createElement("td");
        timeCell.dataset.label = "Saat";
        timeCell.textContent = entry.time || "-";
        tr.appendChild(timeCell);

        const textCell = document.createElement("td");
        textCell.dataset.label = "Metin";
        const preview = formatEntryPreviewText(entry, 120);
        textCell.textContent = preview;
        const fullText = (entry.text || entry.files || "").trim();
        if (fullText) textCell.title = fullText;
        tr.appendChild(textCell);

        const platformCell = document.createElement("td");
        platformCell.dataset.label = "Platformlar";
        platformCell.textContent = formatPlatformsLabel(entry.platforms);
        tr.appendChild(platformCell);

        const statusCell = document.createElement("td");
        statusCell.dataset.label = "Durum";
        const statusBadge = document.createElement("span");
        statusBadge.classList.add(
          "report-status-badge",
          entry.status === "done"
            ? "report-status-done"
            : entry.status === "missed"
            ? "report-status-missed"
            : "report-status-planned"
        );
        statusBadge.textContent = formatStatusLabel(entry.status);
        statusCell.appendChild(statusBadge);
        tr.appendChild(statusCell);

        const ownerCell = document.createElement("td");
        ownerCell.dataset.label = "Sorumlu";
        const ownerLabel = getOwnerLabel(entry.owner_id);
        ownerCell.textContent = ownerLabel || "-";
        tr.appendChild(ownerCell);

        const noteCell = document.createElement("td");
        noteCell.dataset.label = "Not";
        if (entry.note) {
          noteCell.textContent = entry.note;
          noteCell.title = entry.note;
        } else {
          noteCell.textContent = "-";
        }
        tr.appendChild(noteCell);

        executedTableBody.appendChild(tr);
      });
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Dosya okunurken hata oluÅŸtu."));
        reader.readAsDataURL(file);
      });
    }

    function updateRangeControlsVisibility() {
      if (!reportRangeInputs || !quickRangeButtons) return;
      if (reportMode === "range") {
        reportRangeInputs.style.display = "flex";
        quickRangeButtons.style.display = "flex";
      } else {
        reportRangeInputs.style.display = "none";
        quickRangeButtons.style.display = "none";
      }
    }

    function renderReports() {
      try {
        const rangeInfo = getReportRangeInfo();
        if (!rangeInfo) {
        reportMonthLabel.textContent = "LÃ¼tfen geÃ§erli bir tarih aralÄ±ÄŸÄ± seÃ§.";
        clearReportOutputs();
        if (reportMode === "range" && reportPlatforms) {
          const li = document.createElement("li");
          li.textContent = "GeÃ§erli bir tarih aralÄ±ÄŸÄ± seÃ§.";
          reportPlatforms.appendChild(li);
        }
        return;
      }

      reportMonthLabel.textContent = rangeInfo.label;
      updateReportFilterLabel();

      if (reportsContentView === "executed") {
        const entriesInRange = collectEntriesInRange(
          rangeInfo.start,
          rangeInfo.end,
          activeChannelFilter
        );
        renderReportsExecuted(rangeInfo, entriesInRange);
      } else {
        renderReportsSummary(rangeInfo);
      }
      } catch (err) {
        console.error('[renderReports] Rapor oluÅŸturma hatasÄ±:', err);
        showErrorToast('Raporlar gÃ¶rÃ¼ntÃ¼lenemedi');
      }
    }
    function renderPlatformChart(entries) {
      if (!platformChartWrapper || !platformChartCanvas || typeof Chart === "undefined") return;

      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }

      const labels = entries.map(([label]) => label);
      const data = entries.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        platformChartWrapper.style.display = "none";
        return;
      }

      const axisColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const gridColor = isDarkMode() ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.35)";
      const barColor = isDarkMode() ? "#60a5fa" : "#2563eb";

      platformChartWrapper.style.display = "block";
      platformChartInstance = new Chart(platformChartCanvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Ä°Ã§erik sayÄ±sÄ±",
            data,
            backgroundColor: data.map(() => barColor),
            borderRadius: 6,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: {
                color: axisColor,
                font: { size: 11 }
              },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: axisColor
              },
              grid: {
                color: gridColor
              }
            }
          }
        }
      });
    }
    function renderTimeChart(stats) {
      if (!timeChartWrapper || !timeChartCanvas || typeof Chart === "undefined") return;

      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }

      const labels = [
        "Sabah (06:00â€“11:59)",
        "Ã–ÄŸlen / Ã–ÄŸleden sonra (12:00â€“17:59)",
        "AkÅŸam (18:00â€“23:59)",
        "Saat belirtilmemiÅŸ"
      ];
      const data = [stats.early, stats.mid, stats.late, stats.noTime];
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        timeChartWrapper.style.display = "none";
        return;
      }

      const legendColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const colors = isDarkMode()
        ? ["#38bdf8", "#facc15", "#f472b6", "#94a3b8"]
        : ["#0ea5e9", "#f59e0b", "#ec4899", "#9ca3af"];

      timeChartWrapper.style.display = "block";
      timeChartInstance = new Chart(timeChartCanvas, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "45%",
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: legendColor,
                boxWidth: 12,
                padding: 12,
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    /* Sekmeler */
    tabCalendar.addEventListener("click", () => {
      tabCalendar.classList.add("active");
      tabReports.classList.remove("active");
      viewCalendar.style.display = "";
      viewReports.style.display = "none";
    });

    tabReports.addEventListener("click", () => {
      tabReports.classList.add("active");
      tabCalendar.classList.remove("active");
      viewCalendar.style.display = "none";
      viewReports.style.display = "";
      renderReports();
    });

    /* Rapor gÃ¶rÃ¼nÃ¼m modlarÄ± */
    reportModeRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        if (!radio.checked) return;
        reportMode = radio.value;
        updateRangeControlsVisibility();
        if (reportMode === "range") {
          ensureRangeInputsInitialized();
        }
        renderReports();
      });
    });

    if (reportRangeStartInput) {
      reportRangeStartInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    if (reportRangeEndInput) {
      reportRangeEndInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    quickRangeButtonsList.forEach((btn) => {
      btn.addEventListener("click", () => {
        const days = Number(btn.dataset.range);
        applyQuickRange(days);
      });
    });

    reportViewButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.reportView;
        if (!view || reportsContentView === view) return;
        reportsContentView = view;
        reportViewButtons.forEach((button) => {
          button.classList.toggle("active", button.dataset.reportView === view);
        });
        renderReports();
      });
    });

    if (executedShowMissedToggle) {
      executedShowMissedToggle.addEventListener("change", () => {
        if (reportsContentView === "executed") renderReports();
      });
    }

    if (colorHelpBtn) {
      colorHelpBtn.addEventListener("click", async (event) => {
        event.stopPropagation();
        await ensureColorDescriptionsLoaded();
        renderColorHelpList();
        toggleColorHelpPanel();
      });
    }
    if (colorHelpCloseBtn) {
      colorHelpCloseBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleColorHelpPanel(false);
      });
    }
    if (colorHelpPanel) {
      colorHelpPanel.addEventListener("click", (event) => {
        event.stopPropagation();
      });
    }
    document.addEventListener("click", (event) => {
      if (!colorHelpPanelOpen) return;
      if (
        colorHelpPanel &&
        !colorHelpPanel.contains(event.target) &&
        event.target !== colorHelpBtn
      ) {
        toggleColorHelpPanel(false);
      }
    });

    updateRangeControlsVisibility();

    loginForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;
      if (!email || !password) {
        loginError.textContent = "E-posta ve ÅŸifre gerekli.";
        return;
      }
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginSubmitBtn.disabled = true;
      try {
        const endpoint = isRegisterMode ? "/auth/register" : "/auth/login";
        const response = await fetch(API_BASE + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
          let message = isRegisterMode ? "KayÄ±t yapÄ±lamadÄ±." : "GiriÅŸ yapÄ±lamadÄ±.";
          try {
            const data = await response.json();
            if (data && data.error) message = data.error;
          } catch { /* ignore */ }
          throw new Error(message);
        }
        if (isRegisterMode) {
          const data = await response.json();
          setAuthMode(false);
          loginError.classList.add("success");
          loginError.textContent = data.approved
            ? "Admin hesabÄ± oluÅŸturuldu. Åžimdi giriÅŸ yapabilirsiniz."
            : "KayÄ±t baÅŸarÄ±lÄ±, admin onayÄ±ndan sonra giriÅŸ yapabilirsiniz.";
          loginSubmitBtn.disabled = false;
          return;
        }
        const data = await response.json();
        setAuthToken(data.token);
        setCurrentUser(data.user);
        adminSelectedUserId = null;
        setAssigneeFilter("all"); // TÃ¼m kartlarÄ± gÃ¶ster
        await loadEntriesFromServer();
        await loadResponsibleUsers();
        await ensureColorDescriptionsLoaded();
        startAutoSync(); // GiriÅŸ yapÄ±ldÄ±ÄŸÄ±nda otomatik senkronizasyonu baÅŸlat
        hideLoginOverlay();
      } catch (err) {
        loginError.classList.remove("success");
        loginError.textContent = err.message || (isRegisterMode ? "KayÄ±t yapÄ±lamadÄ±." : "GiriÅŸ yapÄ±lamadÄ±.");
      } finally {
        loginSubmitBtn.disabled = false;
      }
    });

    switchAuthModeBtn.addEventListener("click", () => {
      setAuthMode(!isRegisterMode);
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
    });

    if (adminPanelBtn) {
      adminPanelBtn.addEventListener("click", () => {
        openAdminOverlay();
      });
    }
    if (adminCloseBtn) {
      adminCloseBtn.addEventListener("click", () => {
        closeAdminOverlay();
      });
    }
    adminOverlay.addEventListener("click", (event) => {
      if (event.target === adminOverlay) {
        closeAdminOverlay();
      }
    });
    if (adminViewSelfBtn) {
      adminViewSelfBtn.addEventListener("click", async () => {
        if (!currentUser) {
          closeAdminOverlay();
          return;
        }
        adminSelectedUserId = null;
        try {
          await loadEntriesFromServer();
        } catch (error) {
          alert(error.message);
        }
        closeAdminOverlay();
      });
    }
    if (adminTabButtons.length) {
      adminTabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetPanel = btn.dataset.panel || "users";
          if (targetPanel === activeAdminPanelTab) return;
          setActiveAdminPanelTab(targetPanel);
        });
      });
    }

    if (colorDescriptionSaveBtn) {
      colorDescriptionSaveBtn.addEventListener("click", () => {
        if (!currentUser || currentUser.role !== "admin") return;
        saveColorDescriptions();
      });
    }

    platformPresetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const data = btn.dataset.platforms || "";
        const values = data
          .split("|")
          .map((item) => item.trim())
          .filter(Boolean);
        applyPlatformPreset(values);
      });
    });

    channelFilterButtons.forEach((btn) => {
      const channelId = btn.dataset.channel || "all";
      btn.classList.toggle("active", channelId === activeChannelFilter);
      btn.addEventListener("click", () => {
        setActiveChannelFilter(channelId);
      });
    });
    if (assigneeFilterButtons.length) {
      updateAssigneeFilterUI();
      assigneeFilterButtons.forEach((btn) => {
        const targetAssignee = btn.dataset.assignee || "all";
        btn.addEventListener("click", () => {
          setAssigneeFilter(targetAssignee);
        });
      });
    }
    if (scheduleViewButtons.length) {
      scheduleViewButtons.forEach((btn) => {
        const view = btn.dataset.view || "daily";
        btn.classList.toggle("active", view === scheduleViewMode);
        btn.addEventListener("click", () => {
          setScheduleViewMode(view);
        });
      });
    }
    updateReportFilterLabel();
    setActiveAdminPanelTab("users");
    if (modalSummary) {
      modalSummary.addEventListener("click", (event) => {
        if (event.target.closest(".summary-item-copy-btn")) return;
        const card = event.target.closest(".summary-item");
        if (!card || !card.dataset.entryId) return;
        const entryId = Number(card.dataset.entryId);
        if (!Number.isFinite(entryId)) return;
        selectEntryById(entryId);
      });
    }

    if (copyCancelBtn) {
      copyCancelBtn.addEventListener("click", () => closeCopyPopover());
    }
    if (copyPopoverCloseBtn) {
      copyPopoverCloseBtn.addEventListener("click", () => closeCopyPopover());
    }
    if (copyConfirmBtn) {
      copyConfirmBtn.addEventListener("click", () => handleCopyConfirm());
    }
    if (copyPopoverBackdrop) {
      copyPopoverBackdrop.addEventListener("click", (event) => {
        if (event.target === copyPopoverBackdrop) {
          closeCopyPopover();
        }
      });
    }
    if (copyPopover) {
      copyPopover.addEventListener("click", (event) => event.stopPropagation());
    }
    document.addEventListener("keydown", (event) => {
      if (
        event.key === "Escape" &&
        copyPopoverBackdrop &&
        copyPopoverBackdrop.classList.contains("active")
      ) {
        closeCopyPopover();
      }
    });

    if (excelUploadBtn && excelFileInput) {
      const handleExcelUpload = () => {
        if (!authToken) {
          showLoginOverlay();
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yÃ¼klemek iÃ§in admin yetkisi gerekir.");
          return;
        }
        if (!isViewingOwnData()) {
          alert("BaÅŸka bir kullanÄ±cÄ±nÄ±n takvimini incelerken dosya yÃ¼kleyemezsin.");
          return;
        }
        excelFileInput.value = "";
        excelFileInput.click();
      };
      excelUploadBtn.addEventListener("click", handleExcelUpload);

      excelFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        if (!/\.(xlsx|xls|csv)$/i.test(file.name)) {
          alert("LÃ¼tfen .xlsx, .xls veya .csv uzantÄ±lÄ± bir dosya seÃ§.");
          excelFileInput.value = "";
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yÃ¼klemek iÃ§in admin yetkisi gerekir.");
          excelFileInput.value = "";
          return;
        }

        const previousText = excelUploadBtn.textContent;
        excelUploadBtn.disabled = true;
        excelUploadBtn.textContent = "YÃ¼kleniyor...";

        try {
          const dataUrl = await readFileAsDataURL(file);
          const base64Data = String(dataUrl).split(",")[1];
          if (!base64Data) {
            throw new Error("Dosya okunamadÄ±.");
          }
          const response = await apiFetch("/import/upload", {
            method: "POST",
            body: JSON.stringify({ filename: file.name, data: base64Data })
          });
          const result = await response.json();
          await loadEntriesFromServer();
          let message = `${result.imported} kayÄ±t eklendi.`;
          if (result.skippedUnmapped) {
            message += ` ${result.skippedUnmapped} satÄ±r eÅŸleÅŸmeyen mecra nedeniyle atlandÄ±.`;
          }
          if (result.unmappedMecra && result.unmappedMecra.length) {
            message += ` EÅŸleÅŸmeyen mecralar: ${result.unmappedMecra.join(", ")}.`;
          }
          alert(`Ä°Ã§e aktarma tamamlandÄ±. ${message}`);
        } catch (err) {
          console.error('[excelUpload] Hata:', err);
          showErrorToast(err.message || "Dosya yÃ¼klenemedi");
        } finally {
          excelUploadBtn.disabled = false;
          excelUploadBtn.textContent = previousText || excelUploadDefaultText;
          excelFileInput.value = "";
        }
      });
    }

    function ensureResetPermissions() {
      if (!authToken) {
        showLoginOverlay();
        return false;
      }
      if (!currentUser || currentUser.role !== "admin") {
        alert("Takvimi sÄ±fÄ±rlamak iÃ§in admin yetkisi gerekir.");
        return false;
      }
      if (!isViewingOwnData()) {
        alert("BaÅŸka bir kullanÄ±cÄ±nÄ±n takvimini incelerken sÄ±fÄ±rlama yapamazsÄ±n.");
        return false;
      }
      return true;
    }

    function hideResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "none";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
        const scope = btn.dataset.scope;
        if (scope && resetScopeLabels[scope]) {
          btn.textContent = resetScopeLabels[scope];
        }
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
    }

    function showResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "flex";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
      if (resetOptionButtons.length) {
        setTimeout(() => resetOptionButtons[0].focus(), 0);
      }
    }

    async function handleScopedReset(scope, triggerButton) {
      if (!scope || !resetConfirmMessages[scope]) return;
      if (!ensureResetPermissions()) {
        hideResetOptions();
        return;
      }
      const confirmed = confirm(resetConfirmMessages[scope]);
      if (!confirmed) return;

      const previousResetText = resetEntriesBtn ? resetEntriesBtn.textContent : "";
      const previousTriggerText = triggerButton ? triggerButton.textContent : "";

      if (resetEntriesBtn) {
        resetEntriesBtn.disabled = true;
        resetEntriesBtn.textContent = "SÄ±fÄ±rlanÄ±yor...";
      }
      resetOptionButtons.forEach((btn) => {
        btn.disabled = true;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = true;
      }
      if (triggerButton) {
        triggerButton.textContent = "SÄ±fÄ±rlanÄ±yor...";
      }

      try {
        const response = await apiFetch("/calendar/reset", {
          method: "DELETE",
          body: JSON.stringify({ scope })
        });
        await response.json();
        // Backend'den gÃ¼ncel veriyi yÃ¼kle
        await loadEntriesFromServer();
        // Ekrandaki kartlarÄ± (schedule list) da yeniden Ã§iz
        updateScheduleList();
        alert(resetSuccessMessages[scope] || "KayÄ±tlar baÅŸarÄ±yla silindi.");
      } catch (err) {
        console.error('[resetEntries] Hata:', err);
        showErrorToast(err.message || "Takvim sÄ±fÄ±rlanamadÄ±");
      } finally {
        if (resetEntriesBtn) {
          resetEntriesBtn.disabled = false;
          resetEntriesBtn.textContent = previousResetText || "SÄ±fÄ±rla";
        }
        if (triggerButton && previousTriggerText) {
          triggerButton.textContent = previousTriggerText;
        }
        hideResetOptions();
      }
    }

    if (resetEntriesBtn) {
      const handleResetClick = () => {
        if (!ensureResetPermissions()) return;
        if (!resetOptions) return;
        const isHidden = getComputedStyle(resetOptions).display === "none";
        if (isHidden) {
          showResetOptions();
        } else {
          hideResetOptions();
        }
      };
      resetEntriesBtn.addEventListener("click", handleResetClick);
    }

    resetOptionButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        handleScopedReset(btn.dataset.scope, btn);
      });
    });

    if (resetCancelBtn) {
      resetCancelBtn.addEventListener("click", () => {
        hideResetOptions();
      });
    }

    logoutBtn.addEventListener("click", () => {
      if (adminOverlay.classList.contains("active")) {
        closeAdminOverlay();
      }
      setCurrentUser(null);
      setAuthToken("");
      stopAutoSync(); // Otomatik senkronizasyonu durdur
      adminSelectedUserId = null;
      adminViewInfo.style.display = "none";
      entriesById = new Map();
      entriesByDate = new Map();
      selectedDateKey = todayDateKey;
      currentDayItems = [];
      activeItemId = null;
      scheduleViewMode = "daily";
      scheduleDailyDateKey = todayDateKey;
      activeScheduleSummaryKey = todayDateKey;
      if (scheduleViewButtons.length) {
        scheduleViewButtons.forEach((btn) => {
          const view = btn.dataset.view || "daily";
          btn.classList.toggle("active", view === scheduleViewMode);
        });
      }
      clearFormOnly();
      closeModal();
      modalFormSection.style.display = "none";
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
      showLoginOverlay(false);
    });

    /* ==================== GÃ–REV PANOSU ==================== */
    // TODO: Backend entegrasyonu yapÄ±lacak - Firestore veya SQL DB modeli
    // Åžimdilik dummy verilerle Ã§alÄ±ÅŸÄ±yoruz
    
    /* 
     * GÃ–REV YÃ–NETÄ°MÄ° SÄ°STEMÄ°
     * TODO: Backend entegrasyonu iÃ§in /tasks endpoint'leri eklenecek
     * - GET /tasks - tÃ¼m gÃ¶revleri getir
     * - POST /tasks - yeni gÃ¶rev oluÅŸtur
     * - PUT /tasks/:id - gÃ¶revi gÃ¼ncelle (status deÄŸiÅŸimi vs.)
     * - DELETE /tasks/:id - gÃ¶revi sil
     * Åžimdilik localStorage kullanÄ±yoruz.
     */
    
    // Server'dan gÃ¶revleri yÃ¼kle (ArtÄ±k localStorage deÄŸil, backend API kullanÄ±lÄ±yor)
    async function loadTasksFromServer() {
      try {
        // KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸsa boÅŸ dizi dÃ¶ndÃ¼r
        if (!authToken) {
          console.warn('[loadTasksFromServer] Token yok, gÃ¶revler yÃ¼klenemiyor');
          return [];
        }

        console.log('[loadTasksFromServer] Backend\'den gÃ¶revler isteniyor: GET /tasks'); // Debug log
        const response = await apiFetch("/tasks");
        const data = await response.json();
        console.log('[loadTasksFromServer] Backend\'den alÄ±nan gÃ¶rev sayÄ±sÄ±:', data.length); // Debug log
        
        // Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ kontrolÃ¼:
        // 1) GeÃ§ersiz ID'lere sahip gÃ¶revleri filtrele (eski localStorage verilerinden korunma)
        // 2) Status alanÄ± eksik olan gÃ¶revleri dÃ¼zelt
        return data
          .filter(task => {
            // ID geÃ§erli bir integer olmalÄ± (backend INTEGER PRIMARY KEY kullanÄ±yor)
            const isValidId = typeof task.id === 'number' && Number.isInteger(task.id) && task.id > 0;
            if (!isValidId) {
              console.warn('[loadTasksFromServer] GeÃ§ersiz ID\'ye sahip gÃ¶rev filtrelendi:', task);
            }
            return isValidId;
          })
          .map(task => ({
            ...task,
            status: task.status || "todo"
          }));
      } catch (err) {
        console.error('[loadTasksFromServer] GÃ¶revler yÃ¼klenemedi:', err.message);
        return [];
      }
    }
    
    // Yeni gÃ¶rev oluÅŸtur (Backend'e kaydet)
    async function createTask(taskData) {
      try {
        console.log('[createTask] Backend\'e gÃ¶nderilecek veri:', taskData); // Debug log
        const response = await apiFetch("/tasks", {
          method: "POST",
          body: JSON.stringify(taskData)
        });
        const result = await response.json();
        console.log('[createTask] Backend\'den dÃ¶nen sonuÃ§:', result); // Debug log
        return result;
      } catch (err) {
        console.error('[createTask] Hata:', err);
        showErrorToast(err.message || 'GÃ¶rev oluÅŸturulamadÄ±');
        throw err;
      }
    }
    
    // GÃ¶revi gÃ¼ncelle (Backend'e kaydet)
    async function updateTask(taskId, updates) {
      try {
        // ID validation: Backend integer bekliyor
        const numericId = Number(taskId);
        if (!Number.isInteger(numericId) || numericId <= 0) {
          throw new Error(`GeÃ§ersiz gÃ¶rev ID'si: ${taskId}`);
        }
        
        const response = await apiFetch(`/tasks/${numericId}`, {
          method: "PUT",
          body: JSON.stringify(updates)
        });
        return await response.json();
      } catch (err) {
        console.error('[updateTask] Hata:', err);
        showErrorToast(err.message || 'GÃ¶rev gÃ¼ncellenemedi');
        throw err;
      }
    }
    
    // GÃ¶revi sil (Backend'den sil)
    async function deleteTask(taskId) {
      try {
        // ID validation: Backend integer bekliyor
        const numericId = Number(taskId);
        if (!Number.isInteger(numericId) || numericId <= 0) {
          throw new Error(`GeÃ§ersiz gÃ¶rev ID'si: ${taskId}`);
        }
        
        await apiFetch(`/tasks/${numericId}`, {
          method: "DELETE"
        });
      } catch (err) {
        console.error('[deleteTask] Hata:', err);
        showErrorToast(err.message || 'GÃ¶rev silinemedi');
        throw err;
      }
    }
    
    let taskBoardData = [];

    const taskBoardColumns = [
      { id: "todo", title: "Bekliyor", status: "todo" },
      { id: "in-progress", title: "YapÄ±lÄ±yor", status: "in-progress" },
      { id: "done", title: "TamamlandÄ±", status: "done" }
    ];

    function renderTaskBoard() {
      if (!taskBoardContainer) return;
      
      taskBoardContainer.innerHTML = "";
      
      taskBoardColumns.forEach(column => {
        // Status alanÄ± eksik olan gÃ¶revleri "todo" olarak kabul et (veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in)
        const tasks = taskBoardData.filter(task => (task.status || "todo") === column.status);
        
        // GÃ¶revleri Ã¶ncelik ve teslim tarihine gÃ¶re sÄ±rala
        tasks.sort((a, b) => {
          // Ã–ncelik sÄ±ralamasÄ±: high=1, medium=2, low=3 (kÃ¼Ã§Ã¼k sayÄ± Ã¼stte)
          const priorityOrder = { high: 1, medium: 2, low: 3 };
          const aPriority = priorityOrder[a.priority] || 2; // varsayÄ±lan: orta
          const bPriority = priorityOrder[b.priority] || 2;
          
          // Ã–ncelikler farklÄ±ysa, yÃ¼ksek Ã¶ncelik Ã¼stte olsun
          if (aPriority !== bPriority) {
            return aPriority - bPriority;
          }
          
          // AynÄ± Ã¶nceliÄŸe sahipse, teslim tarihine gÃ¶re sÄ±rala (yakÄ±n olan Ã¼stte)
          const dateA = new Date(a.dueDate).getTime();
          const dateB = new Date(b.dueDate).getTime();
          return dateA - dateB;
        });
        
        const columnEl = document.createElement("div");
        columnEl.className = "task-board-column";
        columnEl.setAttribute("data-status", column.status);
        
        // Kolon baÅŸlÄ±ÄŸÄ±
        const headerEl = document.createElement("div");
        headerEl.className = "task-board-column-header";
        
        const titleEl = document.createElement("div");
        titleEl.className = "task-board-column-title";
        // BaÅŸlÄ±k ve sayÄ±yÄ± parantez iÃ§inde birleÅŸtir (Ã¶rn: "Bekliyor (2)")
        titleEl.textContent = `${column.title} (${tasks.length})`;
        
        headerEl.appendChild(titleEl);
        columnEl.appendChild(headerEl);
        
        // Kartlar container
        const cardsEl = document.createElement("div");
        cardsEl.className = "task-board-cards";
        
        if (tasks.length === 0) {
          const emptyEl = document.createElement("div");
          emptyEl.className = "task-board-empty-state";
          emptyEl.textContent = "GÃ¶rev yok";
          cardsEl.appendChild(emptyEl);
        } else {
          tasks.forEach(task => {
            const cardEl = createTaskCard(task);
            cardsEl.appendChild(cardEl);
          });
        }
        
        columnEl.appendChild(cardsEl);
        taskBoardContainer.appendChild(columnEl);
      });
    }

    function createTaskCard(task) {
      const cardEl = document.createElement("div");
      cardEl.className = "task-board-card";
      cardEl.setAttribute("data-task-id", task.id);
      
      // BaÅŸlÄ±k
      const titleEl = document.createElement("div");
      titleEl.className = "task-board-card-title";
      titleEl.textContent = task.title;
      cardEl.appendChild(titleEl);
      
      // AÃ§Ä±klama
      if (task.description) {
        const descEl = document.createElement("div");
        descEl.className = "task-board-card-description";
        descEl.textContent = task.description;
        cardEl.appendChild(descEl);
      }
      
      // Teslim tarihi (varsa)
      if (task.dueDate) {
        const dueDateEl = document.createElement("div");
        dueDateEl.style.cssText = "font-size: 10px; color: #6b7280; margin-bottom: 6px; display: flex; align-items: center; gap: 3px;";
        const dueDate = new Date(task.dueDate);
        const dateStr = dueDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const timeStr = dueDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        dueDateEl.innerHTML = `ðŸ“… ${dateStr} - ${timeStr}`;
        cardEl.appendChild(dueDateEl);
      }
      
      // Meta bilgiler
      const metaEl = document.createElement("div");
      metaEl.className = "task-board-card-meta";
      
      // Sorumlu
      const assigneeEl = document.createElement("div");
      assigneeEl.className = "task-board-card-assignee";
      assigneeEl.textContent = task.assignee || "Belirlenmedi";
      metaEl.appendChild(assigneeEl);
      
      // Ã–ncelik
      if (task.priority) {
        const priorityEl = document.createElement("div");
        priorityEl.className = `task-board-card-priority ${task.priority}`;
        priorityEl.textContent = task.priority === "high" ? "YÃ¼ksek" : 
                                  task.priority === "medium" ? "Orta" : "DÃ¼ÅŸÃ¼k";
        metaEl.appendChild(priorityEl);
      }
      
      cardEl.appendChild(metaEl);
      
      // Aksiyon butonlarÄ± (sadece status deÄŸiÅŸtir - sil butonu kaldÄ±rÄ±ldÄ±)
      const actionsEl = document.createElement("div");
      actionsEl.style.cssText = "display: flex; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;";
      
      // Status deÄŸiÅŸtir dropdown
      const statusSelect = document.createElement("select");
      statusSelect.style.cssText = "flex: 1; padding: 4px 6px; font-size: 11px; border-radius: 4px; border: 1px solid #cbd5e1;";
      statusSelect.innerHTML = `
        <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>Bekliyor</option>
        <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>YapÄ±lÄ±yor</option>
        <option value="done" ${task.status === 'done' ? 'selected' : ''}>TamamlandÄ±</option>
      `;
      statusSelect.addEventListener("change", async (e) => {
        e.stopPropagation();
        try {
          await updateTask(task.id, { status: e.target.value });
          await refreshTaskBoard();
        } catch (err) {
          // Hata zaten updateTask iÃ§inde gÃ¶sterildi
        }
      });
      actionsEl.appendChild(statusSelect);
      
      cardEl.appendChild(actionsEl);
      
      // Karta tÄ±klayÄ±nca dÃ¼zenleme modalÄ±nÄ± aÃ§
      cardEl.addEventListener("click", (e) => {
        // EÄŸer status dropdown'a tÄ±klandÄ±ysa, modalÄ± aÃ§ma
        if (e.target === statusSelect) {
          return;
        }
        openTaskModal(task.id);
      });
      
      return cardEl;
    }

    // GÃ¶revleri yeniden yÃ¼kle ve ekranÄ± gÃ¼ncelle
    async function refreshTaskBoard() {
      console.log('[refreshTaskBoard] GÃ¶revler backend\'den yÃ¼kleniyor...'); // Debug log
      taskBoardData = await loadTasksFromServer();
      console.log('[refreshTaskBoard] YÃ¼klenen gÃ¶rev sayÄ±sÄ±:', taskBoardData.length); // Debug log
      renderTaskBoard();
    }
    
    /* ==================== GÃ–REV MODAL FONKSÄ°YONLARI ==================== */
    
    // GÃ¶rev Modal elementleri
    const taskModal = document.getElementById("taskModal");
    const taskModalTitle = document.getElementById("taskModalTitle");
    const taskModalCloseBtn = document.getElementById("taskModalCloseBtn");
    const taskNameInput = document.getElementById("taskNameInput");
    const taskDescriptionInput = document.getElementById("taskDescriptionInput");
    const taskNoteInput = document.getElementById("taskNoteInput");
    const taskDueDateInput = document.getElementById("taskDueDateInput");
    const taskDueTimeInput = document.getElementById("taskDueTimeInput");
    const taskOwnerSelect = document.getElementById("taskOwnerSelect");
    const taskSaveBtn = document.getElementById("taskSaveBtn");
    const taskClearBtn = document.getElementById("taskClearBtn");
    const taskDeleteBtn = document.getElementById("taskDeleteBtn");
    const taskCancelBtn = document.getElementById("taskCancelBtn");
    
    let currentEditingTaskId = null; // DÃ¼zenlenen gÃ¶rev ID'si (null ise yeni gÃ¶rev)
    
    // GÃ¶rev modalÄ±nÄ± aÃ§
    function openTaskModal(taskId = null) {
      if (!taskModal) return;
      
      // DÃ¼zenleme modunda mÄ± yoksa yeni gÃ¶rev mi?
      currentEditingTaskId = taskId;
      
      if (taskId) {
        // DÃ¼zenleme modu - mevcut gÃ¶revi yÃ¼kle
        const task = taskBoardData.find(t => t.id === taskId);
        if (!task) return;
        
        taskModalTitle.textContent = "GÃ¶revi DÃ¼zenle";
        taskNameInput.value = task.title || "";
        taskDescriptionInput.value = task.description || "";
        taskNoteInput.value = task.note || "";
        
        // Teslim tarihi ve saati ayarla
        if (task.dueDate) {
          const dueDate = new Date(task.dueDate);
          taskDueDateInput.value = dueDate.toISOString().split('T')[0];
          taskDueTimeInput.value = dueDate.toTimeString().slice(0, 5);
        }
        
        // Sorumlu kiÅŸi seÃ§
        if (task.owner_id) {
          taskOwnerSelect.value = String(task.owner_id);
        } else {
          taskOwnerSelect.value = "";
        }
        
        // Ã–ncelik seÃ§
        const priorityRadio = document.querySelector(`input[name="taskPriority"][value="${task.priority || 'low'}"]`);
        if (priorityRadio) priorityRadio.checked = true;
        
      } else {
        // Yeni gÃ¶rev modu - formu temizle
        taskModalTitle.textContent = "Yeni GÃ¶rev OluÅŸtur";
        taskNameInput.value = "";
        taskDescriptionInput.value = "";
        taskNoteInput.value = "";
        
        // BugÃ¼nÃ¼n tarihi default olarak
        const today = new Date();
        taskDueDateInput.value = today.toISOString().split('T')[0];
        taskDueTimeInput.value = "17:00";
        
        // Sorumlu kiÅŸi: Mevcut kullanÄ±cÄ± default olarak
        if (currentUser && responsibleUserMap.has(currentUser.id)) {
          taskOwnerSelect.value = String(currentUser.id);
        } else {
          taskOwnerSelect.value = "";
        }
        
        // Ã–ncelik: DÃ¼ÅŸÃ¼k default
        const lowPriorityRadio = document.querySelector('input[name="taskPriority"][value="low"]');
        if (lowPriorityRadio) lowPriorityRadio.checked = true;
      }
      
      // Sorumlu kiÅŸi listesini doldur
      populateTaskOwnerSelect();
      
      // Sil butonunu sadece dÃ¼zenleme modunda gÃ¶ster
      if (taskDeleteBtn) {
        taskDeleteBtn.style.display = taskId ? "block" : "none";
      }
      
      // ModalÄ± gÃ¶ster (openModalHelper ile ana sayfa scroll'unu kilitle)
      openModalHelper(taskModal);
      
      // Ä°lk input'a focus
      if (taskNameInput) taskNameInput.focus();
    }
    
    // GÃ¶rev modalÄ±nÄ± kapat
    function closeTaskModal() {
      if (!taskModal) return;
      
      // closeModalHelper ile scroll pozisyonunu geri yÃ¼kle
      closeModalHelper(taskModal);
      currentEditingTaskId = null;
    }
    
    // NOT: populateTaskOwnerSelect() fonksiyonu artÄ±k loadResponsibleUsers() yanÄ±nda tanÄ±mlÄ± (satÄ±r ~5300 civarÄ±)
    
    // GÃ¶rev kaydetme fonksiyonu
    async function saveTaskFromModal() {
      // Zorunlu alanlarÄ± kontrol et
      const taskName = taskNameInput.value.trim();
      const dueDate = taskDueDateInput.value;
      
      if (!taskName) {
        showErrorToast("GÃ¶rev ismi zorunludur!");
        taskNameInput.focus();
        return;
      }
      
      if (!dueDate) {
        showErrorToast("Teslim tarihi zorunludur!");
        taskDueDateInput.focus();
        return;
      }
      
      // SeÃ§ili Ã¶nceliÄŸi al
      const priorityRadio = document.querySelector('input[name="taskPriority"]:checked');
      const priority = priorityRadio ? priorityRadio.value : "low";
      
      // Teslim tarihi + saati birleÅŸtir
      const dueTime = taskDueTimeInput.value || "17:00";
      const dueDateTimeString = `${dueDate}T${dueTime}:00`;
      const dueDateObj = new Date(dueDateTimeString);
      
      // Sorumlu kiÅŸi bilgisi
      const selectedOwnerId = taskOwnerSelect.value ? Number(taskOwnerSelect.value) : null;
      const ownerEmail = selectedOwnerId ? getOwnerLabel(selectedOwnerId) : "";
      
      // GÃ¶rev objesini oluÅŸtur
      const taskData = {
        title: taskName,
        description: taskDescriptionInput.value.trim(),
        note: taskNoteInput.value.trim(),
        dueDate: dueDateObj.toISOString(),
        owner_id: selectedOwnerId,
        assignee: ownerEmail || "Belirlenmedi",
        priority: priority
      };
      
      // Yeni gÃ¶rev oluÅŸturuluyorsa, status alanÄ±nÄ± ekle (dÃ¼zenleme modunda status korunur)
      if (!currentEditingTaskId) {
        taskData.status = "todo";
      }
      
      // DEBUG: GÃ¼ncellenecek veriyi konsola yazdÄ±r
      console.log("[saveTaskFromModal] Kaydedilecek veri:", taskData);
      console.log("[saveTaskFromModal] DÃ¼zenleme modu:", !!currentEditingTaskId);
      
      try {
        if (currentEditingTaskId) {
          // Mevcut gÃ¶revi bul ve mevcut status'Ã¼ kontrol et
          const existingTask = taskBoardData.find(t => t.id === currentEditingTaskId);
          console.log("[saveTaskFromModal] Mevcut gÃ¶rev:", existingTask);
          
          // Sorumlu kiÅŸi deÄŸiÅŸti mi kontrol et
          const previousOwnerId = existingTask ? existingTask.owner_id : null;
          const ownerChanged = selectedOwnerId !== null && selectedOwnerId !== previousOwnerId;
          
          // Mevcut gÃ¶revi gÃ¼ncelle
          const updatedTask = await updateTask(currentEditingTaskId, taskData);
          await refreshTaskBoard();
          console.log("[saveTaskFromModal] GÃ¼ncellenen gÃ¶rev:", updatedTask);
          
          // Sorumlu kiÅŸi deÄŸiÅŸtiyse bildirim gÃ¶nder
          if (ownerChanged && ownerEmail) {
            addNotificationForAssignee({
              userEmail: ownerEmail,
              cardId: `task_${currentEditingTaskId}`,
              title: `GÃ¶rev: ${taskName}`,
              message: `${getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim"} seni ÅŸu gÃ¶reve sorumlu yaptÄ±: ${taskName}`,
              dayKey: null
            });
          }
          
          showSuccessToast("GÃ¶rev baÅŸarÄ±yla gÃ¼ncellendi!");
        } else {
          // Yeni gÃ¶rev ekle
          const newTask = await createTask(taskData);
          await refreshTaskBoard();
          
          // Sorumlu kiÅŸi varsa bildirim gÃ¶nder
          if (selectedOwnerId !== null && ownerEmail && newTask) {
            addNotificationForAssignee({
              userEmail: ownerEmail,
              cardId: `task_${newTask.id}`,
              title: `GÃ¶rev: ${taskName}`,
              message: `${getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim"} seni yeni bir gÃ¶reve sorumlu yaptÄ±: ${taskName}`,
              dayKey: null
            });
          }
          
          showSuccessToast("GÃ¶rev baÅŸarÄ±yla eklendi!");
        }
        
        closeTaskModal();
        
      } catch (err) {
        console.error("[saveTaskFromModal] Hata:", err);
        showErrorToast("GÃ¶rev kaydedilemedi!");
      }
    }
    
    // Yeni gÃ¶rev butonu click eventi
    if (taskBoardAddBtn) {
      taskBoardAddBtn.addEventListener("click", () => {
        openTaskModal(); // Yeni gÃ¶rev modalÄ±nÄ± aÃ§
      });
    }
    
    // Modal kapatma butonlarÄ±
    if (taskModalCloseBtn) {
      taskModalCloseBtn.addEventListener("click", closeTaskModal);
    }
    
    if (taskCancelBtn) {
      taskCancelBtn.addEventListener("click", closeTaskModal);
    }
    
    // Temizle butonu - formu sÄ±fÄ±rla
    if (taskClearBtn) {
      taskClearBtn.addEventListener("click", () => {
        // TÃ¼m alanlarÄ± temizle
        if (taskNameInput) taskNameInput.value = "";
        if (taskDescriptionInput) taskDescriptionInput.value = "";
        if (taskNoteInput) taskNoteInput.value = "";
        
        // BugÃ¼nÃ¼n tarihi
        const today = new Date();
        if (taskDueDateInput) taskDueDateInput.value = today.toISOString().split('T')[0];
        if (taskDueTimeInput) taskDueTimeInput.value = "17:00";
        
        // Sorumlu kiÅŸi: Mevcut kullanÄ±cÄ±
        if (taskOwnerSelect) {
          if (currentUser && responsibleUserMap.has(currentUser.id)) {
            taskOwnerSelect.value = String(currentUser.id);
          } else {
            taskOwnerSelect.value = "";
          }
        }
        
        // Ã–ncelik: DÃ¼ÅŸÃ¼k
        const lowPriorityRadio = document.querySelector('input[name="taskPriority"][value="low"]');
        if (lowPriorityRadio) lowPriorityRadio.checked = true;
        
        // Ä°lk input'a focus
        if (taskNameInput) taskNameInput.focus();
      });
    }
    
    // Sil butonu - gÃ¶revi sil ve modalÄ± kapat
    if (taskDeleteBtn) {
      taskDeleteBtn.addEventListener("click", async () => {
        if (!currentEditingTaskId) return;
        
        // Silme onayÄ± iste
        const task = taskBoardData.find(t => t.id === currentEditingTaskId);
        if (!task) return;
        
        if (confirm(`"${task.title}" gÃ¶revini silmek istediÄŸinize emin misiniz?`)) {
          try {
            await deleteTask(currentEditingTaskId);
            await refreshTaskBoard();
            showSuccessToast("GÃ¶rev baÅŸarÄ±yla silindi!");
            closeTaskModal();
          } catch (err) {
            // Hata zaten deleteTask iÃ§inde gÃ¶sterildi
          }
        }
      });
    }
    
    // Kaydet butonu
    if (taskSaveBtn) {
      taskSaveBtn.addEventListener("click", saveTaskFromModal);
    }
    
    // Modal backdrop'a tÄ±klayÄ±nca kapat
    if (taskModal) {
      taskModal.addEventListener("click", (e) => {
        if (e.target === taskModal) {
          closeTaskModal();
        }
      });
    }
    
    // Enter tuÅŸu ile kaydet (textarea hariÃ§)
    if (taskModal) {
      taskModal.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
          e.preventDefault();
          saveTaskFromModal();
        }
      });
    }

    /* Olaylar ve init */
    async function init() {
      // Sayfa yÃ¼klendiÄŸinde modal-open class'Ä±nÄ± temizle
      document.body.classList.remove('modal-open');
      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth();
      ensureRangeInputsInitialized();
      renderCalendar();
      renderTaskBoard(); // GÃ¶rev panosunu render et
      if (authToken) {
        try {
          const meResponse = await apiFetch("/auth/me");
          const meData = await meResponse.json();
          setCurrentUser(meData);
          adminSelectedUserId = null;
          setAssigneeFilter("all"); // TÃ¼m kartlarÄ± gÃ¶ster
          await loadEntriesFromServer();
          await loadResponsibleUsers();
          await ensureColorDescriptionsLoaded();
          await refreshTaskBoard(); // GÃ¶revleri backend'den yÃ¼kle
          hideLoginOverlay();
        } catch (err) {
          console.error(err);
          setAuthToken("");
          setCurrentUser(null);
          entriesById = new Map();
          entriesByDate = new Map();
          showLoginOverlay();
        }
      } else {
        setCurrentUser(null);
        updateAuthUI();
        showLoginOverlay();
        await ensureColorDescriptionsLoaded();
      }
      
      // --- AUTO REFRESH (POLLING) ---
      // Not: startAutoSync() fonksiyonu zaten otomatik senkronizasyon yapÄ±yor
      // Bu yÃ¼zden burada tekrar polling yapmaya gerek yok (performans iÃ§in kaldÄ±rÄ±ldÄ±)
    }

    /* ðŸ”„ Otomatik Senkronizasyon MekanizmasÄ± (Polling) */
    let pollingInterval = null;

    // Polling fonksiyonu: Her 30 saniyede bir verileri kontrol et
    async function startAutoSync() {
      // Polling zaten Ã§alÄ±ÅŸÄ±yorsa tekrar baÅŸlatma
      if (pollingInterval) return;

      pollingInterval = setInterval(async () => {
        try {
          // Modal aÃ§Ä±ksa veya admin paneli aÃ§Ä±ksa polling yapma (kullanÄ±cÄ± iÅŸlem yapÄ±yor olabilir)
          // DÃœZELTÄ°LDÄ°: dayModal style.display ile kontrol ediliyor (classList.contains deÄŸil!)
          const isModalOpen = dayModal && dayModal.style.display === "flex";
          const isAdminPanelOpen = adminOverlay && adminOverlay.classList.contains("active");
          const isLoginOverlayOpen = loginOverlay && loginOverlay.classList.contains("active");

          // KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸsa veya sekme arka plandaysa polling yapma (Performans optimizasyonu)
          if (!authToken || isModalOpen || isAdminPanelOpen || isLoginOverlayOpen || document.visibilityState !== 'visible') {
            return; // Bu dÃ¶ngÃ¼yÃ¼ atla, bir sonrakini bekle
          }

          // Arka planda sessizce verileri yenile (Admin baÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼lÃ¼yorsa onun verilerini yÃ¼kle)
          const targetUserId = adminSelectedUserId || null;
          await loadEntriesFromServer(targetUserId);

          // GÃ¶revleri de yenile (GÃ¶rev Panosu senkronizasyonu)
          await refreshTaskBoard();

        } catch (err) {
          // Hata olursa sessizce logla, kullanÄ±cÄ±yÄ± rahatsÄ±z etme
          console.warn("[AutoSync] Otomatik senkronizasyon hatasÄ±:", err.message);
        }
      }, 120000); // 2 dakika (10 saniyeden 120 saniyeye Ã§Ä±karÄ±ldÄ± - performans iÃ§in)
    }

    // Polling'i durdur (Ã¶rn: kullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ yaptÄ±ÄŸÄ±nda)
    function stopAutoSync() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Init fonksiyonundan sonra polling'i baÅŸlat
    startAutoSync();

    prevBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    nextBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    // Yeni iÃ§erik
  toggleFormBtn.addEventListener("click", () => {
      if (!selectedDateKey) return;
      if (!authToken) {
        alert("PaylaÅŸÄ±m oluÅŸturmak iÃ§in Ã¶nce giriÅŸ yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
        return;
      }
      activeItemId = null;
      modalForcePlanMode = false;
      clearFormOnly();
      setModalViewForEntry(null);
      deleteBtn.disabled = true;
      renderModalSummaryList();
    });

    if (markDoneBtn) {
      markDoneBtn.addEventListener("click", () => handleStatusDecision("done"));
    }
    if (markMissedBtn) {
      markMissedBtn.addEventListener("click", () =>
        handleStatusDecision("missed")
      );
    }
    if (controlEditBtn) {
      controlEditBtn.addEventListener("click", () => {
        if (!activeItemId) return;
        selectEntryById(activeItemId, true);
      });
    }
    if (checkedEditBtn) {
      checkedEditBtn.addEventListener("click", () => {
        if (!activeItemId) return;
        selectEntryById(activeItemId, true);
      });
    }
    if (returnToControlBtn) {
      returnToControlBtn.addEventListener("click", () => {
        modalForcePlanMode = false;
        const entry = activeItemId ? entriesById.get(activeItemId) : null;
        setModalViewForEntry(entry);
      });
    }

    async function handleSave() {
      if (!authToken) {
        alert("LÃ¼tfen Ã¶nce giriÅŸ yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
        return;
      }
      if (!selectedDateKey) {
        alert("Ã–nce takvimden bir gÃ¼n seÃ§.");
        return;
      }

      const selectedPlatforms = [];
      platformInputs.forEach((cb) => {
        if (cb.checked) selectedPlatforms.push(cb.value);
      });

      const filesVal = filesInput.value.trim();
      const textVal = textInput.value.trim();
      const timeVal = timeInput.value;
      const noteVal = noteInput ? noteInput.value.trim() : null;
      const anyContent = filesVal || textVal || timeVal || selectedPlatforms.length;

      if (!anyContent) {
        alert("Kaydedilecek bir iÃ§erik yok.");
        return;
      }

      const existing = activeItemId ? entriesById.get(activeItemId) : null;
      const normalizeOwnerId = (value) =>
        value === null || typeof value === "undefined" || value === ""
          ? null
          : Number(value);
      const selectedOwnerId =
        ownerSelect && ownerSelect.value
          ? Number(ownerSelect.value)
          : null;
      const ownerIdValue =
        selectedOwnerId !== null
          ? selectedOwnerId
          : existing
          ? normalizeOwnerId(existing.owner_id)
          : null;
      const payload = {
        date: selectedDateKey,
        time: timeVal,
        text: textVal,
        files: filesVal,
        platforms: selectedPlatforms,
        color: entryColorInput
          ? normalizeColorToken(entryColorInput.value, null) || ""
          : "",
        communication: existing ? existing.communication || "" : "",
        communicationType: existing
          ? existing.communication_type || existing.communicationType || ""
          : "",
        status: existing ? existing.status || "planned" : "planned",
        note: noteVal !== null ? noteVal : existing ? existing.note || "" : "",
        checkedAt: existing ? existing.checkedAt || null : null,
        ownerId: ownerIdValue
      };

      const previousOwnerId = existing
        ? normalizeOwnerId(existing.owner_id)
        : null;
      const ownerEmailForNotification =
        ownerIdValue !== null ? getResponsibleEmailById(ownerIdValue) : "";
      const shouldNotifyAssignee =
        Boolean(ownerEmailForNotification) &&
        ownerIdValue !== null &&
        ownerIdValue !== previousOwnerId;
      const assignerEmailForNotification =
        getCurrentUserEmail() || getCurrentUserDisplayName() || "Takvim";
      const notificationTitle = textVal || filesVal || "Yeni iÃ§erik";
      const notificationDraft = shouldNotifyAssignee
        ? {
            userEmail: ownerEmailForNotification,
            title: notificationTitle,
            message: `${assignerEmailForNotification} seni ÅŸu karta sorumlu yaptÄ±: ${notificationTitle}`
          }
        : null;

      let resolvedEntryId = null;
      saveBtn.disabled = true;
      try {
        if (activeItemId && entriesById.has(activeItemId)) {
          await updateEntry(activeItemId, payload);
          resolvedEntryId = activeItemId;
        } else {
          const created = await createEntry(payload);
          activeItemId = created.id;
          resolvedEntryId = created.id;
        }
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        const targetEntryId = resolvedEntryId;
        activeItemId = null;
        modalForcePlanMode = false;
        clearFormOnly({ preserveSuccessMessage: true });
        setModalViewForEntry(null);
        renderModalSummaryList();
        showSaveSuccessMessage();
        deleteBtn.disabled = true;
        if (notificationDraft && targetEntryId) {
          addNotificationForAssignee({
            userEmail: notificationDraft.userEmail,
            shareId: targetEntryId,
            title: notificationDraft.title,
            message: notificationDraft.message,
            dayKey: selectedDateKey
          });
        }
      } catch (err) {
        console.error('[handleSave] Hata:', err);
        showErrorToast(err.message || "Kaydedilirken bir hata oluÅŸtu");
      } finally {
        saveBtn.disabled = false;
      }
    }

    function handleClear() {
      clearFormOnly();
    }

    async function handleStatusDecision(nextStatus) {
      if (!authToken) {
        alert("LÃ¼tfen Ã¶nce giriÅŸ yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
        return;
      }
      if (!selectedDateKey || !activeItemId) return;
      const entry = entriesById.get(activeItemId);
      if (!entry) return;

      const noteValue = controlNoteInput
        ? controlNoteInput.value.trim()
        : entry.note || "";

      const payload = {
        date: entry.date,
        time: entry.time || "",
        text: entry.text || "",
        files: entry.files || "",
        communication: entry.communication || "",
        communicationType:
          entry.communication_type || entry.communicationType || "",
        status: nextStatus,
        platforms: Array.isArray(entry.platforms) ? entry.platforms : [],
        color: normalizeColorToken(entry.color, null) || "",
        note: noteValue,
        checkedAt: new Date().toISOString(),
        ownerId: entry.owner_id || null
      };

      const actionButtons = [markDoneBtn, markMissedBtn];
      actionButtons.forEach((btn) => btn && (btn.disabled = true));
      try {
        await updateEntry(activeItemId, payload);
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        renderModalSummaryList();
        const updatedEntry = entriesById.get(activeItemId);
        modalForcePlanMode = false;
        setModalViewForEntry(updatedEntry);
        updateScheduleList();
      } catch (err) {
        console.error('[handleStatusDecision] Hata:', err);
        showErrorToast(err.message || "Durum gÃ¼ncellenemedi");
      } finally {
        actionButtons.forEach((btn) => btn && (btn.disabled = false));
      }
    }

    async function handleDelete() {
      if (!authToken) {
        alert("LÃ¼tfen Ã¶nce giriÅŸ yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("DiÄŸer kullanÄ±cÄ±larÄ±n takviminde deÄŸiÅŸiklik yapamazsÄ±n.");
        return;
      }
      if (!selectedDateKey || !activeItemId) return;

      const confirmed = confirm("Bu paylaÅŸÄ±mÄ± silmek istediÄŸine emin misin?");
      if (!confirmed) return;

      deleteBtn.disabled = true;
      try {
        await deleteEntry(activeItemId);
        activeItemId = null;
        clearFormOnly();
        modalForcePlanMode = false;
        setModalViewForEntry(null);
        modalFormSection.style.display = "none";
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        updateScheduleList(); // SaÄŸ paneldeki listeyi gÃ¼ncelle
        if (viewReports.style.display !== "none") renderReports();
        renderModalSummaryList();
      } catch (err) {
        console.error('[handleDelete] Hata:', err);
        deleteBtn.disabled = false;
        showErrorToast(err.message || "KayÄ±t silinirken bir hata oluÅŸtu");
      }
    }

    saveBtn.addEventListener("click", () => {
      handleSave();
    });
    clearBtn.addEventListener("click", handleClear);
    deleteBtn.addEventListener("click", () => {
      handleDelete();
    });

    modalCloseBtn.addEventListener("click", closeModal);
    dayModal.addEventListener("click", (e) => {
      if (e.target === dayModal) closeModal();
    });
    
    // Escape tuÅŸu ile modal'Ä± kapat
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && dayModal && dayModal.style.display === "flex") {
        closeModal();
      }
    });

    initTheme();
    init();
  </script>
</div>
</body>
</html>
<!-- Test -->
<!-- Auto commit test -->
<!-- GitDoc working! -->
<!-- New delay test: 10s commit -->






<!-- Test -->


  <!-- Final test: auto commit working -->
