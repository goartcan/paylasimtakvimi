<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Paylaşım Takvimi</title>
  <style>
    * { box-sizing: border-box; }
    :root {
      --calendar-shell-height: auto;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      color: #111827;
      font-size: 14px;
    }
    h1, h2, h3, label { font-weight: 700; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 48px;
      padding: 2px 0;
      margin-bottom: 2px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .header-right button {
      padding: 5px 10px;
      font-size: 12px;
    }
    .logo { height: 32px; }
    .login-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(17, 24, 39, 0.65);
      z-index: 1500;
      padding: 16px;
    }
    .login-overlay.active { display: flex; }
    .login-card {
      width: min(340px, 96vw);
      background: #ffffff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .login-card h2 {
      margin: 0;
      font-size: 18px;
      text-align: center;
    }
    .login-card form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .login-card .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
    }
    .login-card input {
      padding: 7px 9px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
    }
    .login-card button {
      width: 100%;
      justify-content: center;
      padding: 6px 10px;
      font-size: 13px;
    }
    .login-card .secondary-btn {
      background: #e2e8f0;
      color: #111827;
    }
    .login-card .secondary-btn:hover {
      background: #d1d5db;
    }
    .login-card-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: center;
    }
    #loginError {
      min-height: 16px;
      color: #dc2626;
      font-size: 12px;
    }
    #loginError.success {
      color: #16a34a;
    }
    body.dark .login-card {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .login-card input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .login-card .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .login-card .secondary-btn:hover {
      background: #2c3a52;
    }
    #appRoot {
      width: 100%;
      max-width: 1180px;
      margin: 0 auto;
      padding: 8px 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 100vh;
    }
#viewCalendar {
  width: 100%;
  display: block;
}
    #viewReports {
      display: block;
    }
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1400;
    }
    .admin-overlay.active { display: flex; }
    .admin-panel {
      width: min(680px, 96vw);
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.26);
    }
    .admin-panel-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 8px;
      margin-bottom: -4px;
      flex-wrap: wrap;
    }
    .admin-tab-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 9999px;
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .admin-tab-btn.active {
      background: #0f172a;
      color: #ffffff;
    }
    .admin-tab-view {
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .admin-tab-view.active {
      display: flex;
    }
    .color-description-scroll {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 6px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
    }
    .admin-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .admin-panel-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }
    .admin-panel-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .admin-close-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 8px;
    }
    .admin-user-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
    }
    .admin-user-row {
      display: grid;
      grid-template-columns: 1.6fr 0.9fr 0.9fr auto;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .admin-user-row .role-select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }
    .admin-section {
      border-top: 1px solid #e2e8f0;
      padding-top: 16px;
      margin-top: 8px;
    }
    .admin-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .color-description-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
      align-items: center;
    }
    .color-description-row:last-child {
      border-bottom: none;
    }
    .pending-count-badge {
      font-weight: 600;
      color: #9a3412;
      margin-left: 4px;
    }
    .pending-count-badge.has-pending {
      color: #b91c1c;
    }
    .color-description-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.15);
    }
    .color-description-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .color-description-fields input,
    .color-description-fields textarea {
      font-size: 12px;
      padding: 6px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
    }
    .color-description-fields textarea {
      resize: vertical;
      min-height: 48px;
    }
    .color-description-actions {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-user-row > div:first-child {
      word-break: break-all;
    }
    .admin-user-row.selected {
      border-color: #3b82f6;
      background: #e0f2fe;
    }
    .admin-user-row.actions {
      justify-content: flex-end;
    }
    .admin-user-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e2e8f0;
      color: #1f2937;
    }
    .badge.success {
      background: #dcfce7;
      color: #166534;
    }
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    .badge.info {
      background: #dbeafe;
      color: #1d4ed8;
    }
    body.dark .admin-panel {
      background: #0f172a;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .admin-user-row {
      background: #111827;
      border-color: #1f2937;
    }
    body.dark .admin-user-row.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.2);
    }
    body.dark .admin-close-btn {
      color: #f9fafb;
    }
    body.dark .badge {
      background: #1e293b;
      color: #f9fafb;
    }
    body.dark .badge.success {
      background: rgba(22, 101, 52, 0.2);
      color: #bbf7d0;
    }
    body.dark .badge.warning {
      background: rgba(146, 64, 14, 0.2);
      color: #fde68a;
    }
    body.dark .badge.info {
      background: rgba(37, 99, 235, 0.2);
      color: #bfdbfe;
    }

    body.blurred {
      backdrop-filter: blur(6px);
    }
    body.blurred #appRoot {
      filter: blur(6px);
      pointer-events: none;
      user-select: none;
    }
    .toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1600;
      pointer-events: none;
    }
    .toast-message {
      min-width: 220px;
      max-width: 320px;
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.2);
      opacity: 0;
      transform: translateY(12px);
      animation: toast-in 0.2s ease forwards, toast-out 0.3s ease forwards 1.3s;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
      to { opacity: 0; transform: translateY(12px); }
    }

    /* Sekmeler */
.tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
    #adminViewInfo {
      margin: -8px 0 16px 0;
      color: #1d4ed8;
      font-weight: 600;
    }
    body.dark #adminViewInfo {
      color: #93c5fd;
    }
.tab-button {
  cursor: pointer;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  padding: 5px 12px;
  background: #f3f4f6;
  font-size: 12px;
}
    .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }

.container {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 10px;
  align-items: stretch;
  width: 100%;
}
.calendar-shell {
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-self: stretch;
}
.calendar {
  border: 1px solid #dde2ff;
  border-radius: 12px;
  padding: 8px;
  background: #f9faff;
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
  min-height: 0;
}
.calendar-grid-wrapper {
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
  width: 100%;
}
.channel-filter {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
  font-size: 12px;
  color: #475569;
}
.channel-filter-btn {
  font-size: 11px;
  padding: 3px 9px;
  border-radius: 999px;
  border: 1px solid #d5dbf5;
  background: #ffffff;
  color: #1f2937;
}
.channel-filter-btn.active {
  background: #1d4ed8;
  border-color: #1e40af;
  color: #ffffff;
  box-shadow: 0 6px 16px rgba(30, 64, 175, 0.25);
}
    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 4px 0;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #c4d0ff;
      padding: 4px 10px;
      background: #f2f5ff;
      font-size: 12px;
      font-weight: 600;
      color: #152052;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease,
        box-shadow 0.12s ease;
    }
    button:hover { background: #e4ebff; }
    .secondary-btn {
      background: #e2e8f0;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .secondary-btn:hover {
      background: #d1d5db;
    }
    .primary-btn {
      background: #2563eb;
      border-color: #1d4ed8;
      color: #ffffff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }
    .primary-btn:hover {
      background: #1d4ed8;
    }
    .month-nav-btn {
      min-width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      border-radius: 8px;
      background: #ffffff;
      border-color: #c4d0ff;
      color: #1a275a;
      padding: 0;
    }
    .month-nav-btn:hover {
      background: #dde5ff;
    }
    .month-nav-btn {
      min-width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border-radius: 10px;
      background: #ffffff;
      border-color: #c4d0ff;
      color: #1a275a;
    }
    .month-nav-btn:hover {
      background: #dde5ff;
    }
    .danger-btn {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .danger-btn:hover {
      background: #fecaca;
    }
    #themeToggleBtn {
      font-size: 11px;
      padding-inline: 10px;
    }
    .month-label {
      font-weight: 700;
      font-size: 17px;
      color: #152052;
    }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
.calendar-grid-wrapper .days {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-auto-rows: 90px;
  gap: 2px;
  width: 100%;
}
    .weekday {
      text-align: center;
      font-weight: 700;
      font-size: 10px;
      padding: 2px 0;
      background: #f0f3ff;
      border-radius: 6px;
      color: #1a275a;
    }
    .day {
      --day-surface: #ffffff;
      --day-text: #0f172a;
      --day-border: #e1e5ff;
      --day-chip-bg: rgba(15, 23, 42, 0.06);
      --day-chip-color: #0f172a;
      --day-chip-border: transparent;
      --day-highlight-shadow: rgba(15, 23, 42, 0.08);
      border-radius: 6px;
      border: 1px solid var(--day-border);
      padding: 2px;
      height: 100%;
      font-size: 11px;
      cursor: pointer;
      background: var(--day-surface);
      color: var(--day-text);
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .day:hover {
      border-color: #3b5bdb;
      box-shadow: 0 0 0 1px rgba(59, 91, 219, 0.12);
      background: #f4f6ff;
    }
    .day.filtered-out {
      opacity: 0.35;
    }
    .day-number {
      font-weight: 700;
      font-size: 11px;
      margin-bottom: 1px;
      color: var(--day-text);
    }
.day-counter {
      font-size: 8px;
      font-weight: 600;
      color: #6b21a8;
      margin-bottom: 1px;
    }
    .day.day-highlighted {
      background: var(--day-surface, #ffffff);
      border-color: var(--day-border, #e1e5ff);
      box-shadow: 0 12px 28px var(--day-highlight-shadow, rgba(15, 23, 42, 0.12));
    }
    .day-summary {
      font-size: 9px;
      color: #33415c;
    }
    .day-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1px;
      padding-right: 1px;
      overflow: hidden;
    }
    .day-summary + .day-summary { margin-top: 2px; }
    .day-summary.excel {
      color: #0369a1;
    }
    .day-summary-chip {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 1px 6px;
      margin-top: 1px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 8px;
      color: #0f172a;
      font-weight: 600;
    }
    .day[data-color] .day-summary {
      color: var(--day-text);
    }
    .day[data-color="yellow"],
    .day[data-color="white"],
    .day[data-color="amber"],
    .day[data-color="orange"],
    .day[data-color="green"],
    .day[data-color="emerald"],
    .day[data-color="cyan"],
    .day[data-color="sky"],
    .day[data-color="default"] {
      --day-text: #1f2937;
      --day-chip-bg: rgba(255, 255, 255, 0.78);
      --day-chip-color: #1f2937;
      --day-chip-border: rgba(31, 41, 55, 0.18);
    }
    .day[data-color="blue"],
    .day[data-color="purple"],
    .day[data-color="violet"],
    .day[data-color="pink"],
    .day[data-color="red"],
    .day[data-color="rose"],
    .day[data-color="gray"],
    .day[data-color="black"] {
      --day-text: #ffffff;
      --day-chip-bg: rgba(255, 255, 255, 0.22);
      --day-chip-color: #ffffff;
      --day-chip-border: rgba(255, 255, 255, 0.45);
    }
.schedule-item.summary[data-color] .schedule-summary-header {
  color: var(--summary-text);
}
    .schedule-item.summary[data-color="yellow"],
    .schedule-item.summary[data-color="white"],
    .schedule-item.summary[data-color="amber"],
    .schedule-item.summary[data-color="orange"],
    .schedule-item.summary[data-color="green"],
    .schedule-item.summary[data-color="emerald"],
    .schedule-item.summary[data-color="cyan"],
    .schedule-item.summary[data-color="sky"],
    .schedule-item.summary[data-color="default"] {
      --summary-text: #1f2937;
      --summary-chip-bg: rgba(255, 255, 255, 0.78);
      --summary-chip-color: #1f2937;
      --summary-chip-border: rgba(31, 41, 55, 0.18);
    }
    .schedule-item.summary[data-color="blue"],
    .schedule-item.summary[data-color="purple"],
    .schedule-item.summary[data-color="violet"],
    .schedule-item.summary[data-color="pink"],
    .schedule-item.summary[data-color="red"],
    .schedule-item.summary[data-color="rose"],
    .schedule-item.summary[data-color="gray"],
    .schedule-item.summary[data-color="black"] {
      --summary-text: #ffffff;
      --summary-chip-bg: rgba(255, 255, 255, 0.22);
      --summary-chip-color: #ffffff;
      --summary-chip-border: rgba(255, 255, 255, 0.45);
    }

.side {
  display: flex;
  flex-direction: column;
  gap: 10px;
  height: 100%;
}
.summary-shell {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 0 0 320px;
      max-width: 320px;
      align-self: stretch;
      min-height: var(--calendar-shell-height, auto);
      height: var(--calendar-shell-height, auto);
      max-height: var(--calendar-shell-height, none);
      overflow: hidden;
    }
.form {
  border: 1px solid #dde2ff;
  border-radius: 9px;
  padding: 8px;
  background: #ffffff;
  display: flex;
  flex-direction: column;
  gap: 6px;
  height: 100%;
}
.summary-shell .form {
  flex: 1;
}
.summary-scroll-area {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
  overflow-y: auto;
  padding-right: 2px;
}
.summary-scroll-area::-webkit-scrollbar {
  width: 6px;
}
.summary-scroll-area::-webkit-scrollbar-thumb {
  background: #cbd5f5;
  border-radius: 999px;
}
.excel-upload-container {
  margin-top: auto;
  padding-top: 10px;
  border-top: 1px dashed #e5e7eb;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
    .excel-upload-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .reset-options {
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .reset-options .danger-btn {
      justify-content: center;
    }
    .reset-options .secondary-btn {
      justify-content: center;
    }
    .excel-note {
      font-size: 11px;
      color: #4b5563;
    }
    .excel-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #2563eb;
      color: #f8fafc;
      border: 1px solid #1d4ed8;
    }
    .small {
      font-size: 11px;
      color: #4b5563;
    }
.schedule-list {
  margin-top: 6px;
  border-top: 1px solid #eef0ff;
  padding-top: 6px;
}
#scheduleList {
  flex: 1;
  min-height: 0;
}
.schedule-search {
  margin-top: 6px;
  display: flex;
  align-items: center;
}
.schedule-search input {
  width: 100%;
  padding: 6px 9px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  font-size: 12px;
  outline: none;
}
    .schedule-view-toggle {
      margin: 6px 0 4px;
      display: inline-flex;
      gap: 6px;
      background: #f1f5f9;
      border-radius: 999px;
      padding: 3px;
    }
    .schedule-view-btn {
      border: none;
      background: transparent;
      padding: 4px 11px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 999px;
      color: #475569;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .schedule-view-btn.active {
      background: #0f172a;
      color: #ffffff;
    }
.schedule-item.summary {
  --summary-surface: #ffffff;
  --summary-text: #0f172a;
  --summary-border: transparent;
  --summary-chip-bg: rgba(15, 23, 42, 0.06);
  --summary-chip-color: #0f172a;
  --summary-chip-border: rgba(15, 23, 42, 0.16);
  --summary-shadow: rgba(15, 23, 42, 0.08);
  padding: 7px;
  margin-bottom: 5px;
  border-radius: 7px;
  border: 1px solid rgba(226, 232, 240, 0.8);
  border-left: 4px solid var(--summary-border, rgba(226, 232, 240, 0.9));
  background: var(--summary-surface);
  color: var(--summary-text);
  transition: border-color 0.12s ease, border-left-color 0.12s ease,
    background 0.12s ease, box-shadow 0.12s ease;
}
    .schedule-item.summary:hover {
      box-shadow: 0 6px 16px var(--summary-shadow, rgba(15, 23, 42, 0.12));
      border-color: #cbd5f5;
      border-left-color: #2563eb;
    }
    .schedule-item.summary.active {
      border-color: rgba(37, 99, 235, 0.45);
      border-left-color: #2563eb;
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18);
    }
    .daily-entry-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .daily-entry-heading {
      font-weight: 600;
      color: #0f172a;
      font-size: 12px;
      margin: 4px 0;
    }
.daily-entry-row {
  --daily-card-color: rgba(15, 23, 42, 0.12);
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-left: 4px solid rgba(226, 232, 240, 0.9);
  border-radius: 9px;
  padding: 8px 9px;
  background: #ffffff;
  display: flex;
  gap: 10px;
      align-items: flex-start;
      cursor: pointer;
      transition: box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .daily-entry-row:hover {
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border-color: #dbe3ff;
      border-left-color: #2563eb;
    }
    .daily-entry-row.active {
      border-color: rgba(59, 91, 219, 0.3);
      border-left-color: var(--daily-card-color, rgba(59, 91, 219, 0.3));
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.15);
    }
    .daily-entry-row:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    .daily-entry-status {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 2px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .daily-entry-status.status-done {
      background: #16a34a;
      color: #ffffff;
    }
    .daily-entry-status.status-missed {
      background: #dc2626;
      color: #ffffff;
    }
    .daily-entry-status.status-scheduled {
      background: #2563eb;
      color: #ffffff;
    }
    .daily-entry-status.status-pending {
      background: #e2e8f0;
      color: #1e293b;
    }
    .daily-entry-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .daily-entry-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      margin: 0;
    }
    .daily-entry-meta {
      font-size: 12px;
      color: #475569;
      margin: 0;
    }
    .daily-entry-meta.daily-entry-time {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .daily-entry-time-icon {
      font-size: 12px;
      color: #2563eb;
      line-height: 1;
    }
    .daily-entry-badges {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .schedule-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--summary-text);
    }
    .schedule-summary-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .summary-chip {
      padding: 1px 6px;
      border-radius: 999px;
      background: var(--summary-chip-bg);
      border: 1px solid var(--summary-chip-border);
      color: var(--summary-chip-color);
      font-size: 10px;
      font-weight: 600;
    }
    .schedule-item {
      padding: 5px 0;
      border-bottom: 1px solid #f1f3ff;
      cursor: pointer;
    }
    .schedule-item.from-excel {
      background: rgba(14, 165, 233, 0.08);
      border-color: #bae6fd;
      border-radius: 8px;
      padding: 6px;
    }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-date {
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 2px;
      color: #111827;
    }
    .schedule-text {
      font-size: 11px;
      margin-bottom: 2px;
      color: #374151;
    }

    /* Raporlar görünümü */
    #viewReports {
      border: 1px solid #dde2ff;
      border-radius: 12px;
      padding: 16px;
      background: #ffffff;
    }
    .report-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0 10px 0;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .report-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .report-section { margin-bottom: 16px; }
    .report-section h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    .report-list {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
    }
    .report-range-inputs {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .report-range-inputs input[type="date"] {
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #ffffff;
      color: #111827;
    }
    .report-range-inputs .range-separator {
      font-size: 12px;
      color: #6b7280;
    }
    .quick-range-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin: 0 0 14px 0;
      flex-wrap: wrap;
    }
    .quick-range-buttons span {
      color: #6b7280;
      font-weight: 600;
    }
    .quick-range-buttons button {
      font-size: 11px;
      padding: 4px 10px;
    }
    .report-content-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0 0 14px 0;
    }
    .report-view-btn {
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #0f172a;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
    }
    .report-view-btn.active {
      background: #2563eb;
      border-color: #1d4ed8;
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    }
    .report-view-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .report-summary-line {
      font-size: 13px;
      color: #0f172a;
    }
    .report-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #475569;
      cursor: pointer;
    }
    .report-table-wrapper {
      width: 100%;
      overflow-x: auto;
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 640px;
    }
    .report-table thead {
      background: #f8fafc;
    }
    .report-table th,
    .report-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    .report-table th {
      font-weight: 600;
      color: #0f172a;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .report-table td {
      color: #0f172a;
    }
    .report-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .report-status-done {
      background: rgba(34, 197, 94, 0.18);
      color: #166534;
    }
    .report-status-missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .report-status-planned {
      background: rgba(15, 23, 42, 0.05);
      color: #0f172a;
    }
    @media (max-width: 768px) {
      .report-table {
        min-width: 100%;
      }
      .report-table thead {
        display: none;
      }
      .report-table tr {
        display: block;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 12px;
        padding: 10px 12px;
      }
      .report-table td {
        border: none;
        padding: 6px 0;
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .report-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #475569;
        margin-right: 8px;
      }
    }
    body.dark .report-range-inputs input[type="date"] {
      background: #111827;
      border-color: #374151;
      color: #f3f4f6;
    }
    body.dark .quick-range-buttons span {
      color: #9ca3af;
    }
    body.dark .report-view-btn {
      background: #111827;
      color: #f3f4f6;
      border-color: #374151;
    }
    body.dark .report-view-btn.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #1d4ed8;
    }
    body.dark .report-table thead {
      background: #111827;
    }
    body.dark .report-table th,
    body.dark .report-table td {
      color: #f1f5f9;
      border-bottom-color: #1f2937;
    }
    body.dark .report-status-planned {
      background: rgba(248, 250, 252, 0.08);
      color: #f1f5f9;
    }
    .report-chart-wrapper {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .report-chart-wrapper canvas {
      width: 100%;
      height: 260px;
    }
    body.dark .report-chart-wrapper {
      background: #1f2937;
      border-color: #374151;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 0;
      max-width: 960px;
      width: min(96vw, 960px);
      max-height: 92vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
    }
    .modal-header-block {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f9fbff;
      padding: 20px 24px 12px;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 16px 16px 0 0;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-toolbar {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      position: relative;
      margin-top: 12px;
    }
    .highlight-picker {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    .highlight-help-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .highlight-help-btn:hover {
      background: #f3f4f6;
    }
    .color-help-panel {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 280px;
      border-radius: 14px;
      border: 1px solid #e4e7f5;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      padding: 12px;
      display: none;
      z-index: 40;
    }
    .color-help-panel.active {
      display: block;
    }
    .color-help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .color-help-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }
    .color-help-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      color: #0f172a;
    }
    .color-help-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
    }
    .color-help-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #0f172a;
    }
    .color-help-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(15, 23, 42, 0.12);
      flex-shrink: 0;
    }
    .copy-popover-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1600;
      padding: 16px;
    }
    .copy-popover-backdrop.active {
      display: flex;
    }
    .copy-popover {
      width: min(360px, 100%);
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 18px;
      padding: 18px;
      background: #ffffff;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.3);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .copy-popover-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 13px;
      color: #0f172a;
    }
    .copy-popover-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .color-picker-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }
    .highlight-label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
    }
    .color-picker-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      font-size: 12px;
    }
    .color-picker-toggle .toggle-swatch {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
      display: inline-block;
    }
    .color-picker {
      display: none;
      opacity: 0;
      pointer-events: none;
      transform: translateY(4px) scale(0.98);
      transition: opacity 120ms ease, transform 120ms ease;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 14px;
      background: #fff;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 168px;
      z-index: 30;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.2);
      grid-template-columns: repeat(4, 32px);
      gap: 8px;
    }
    .color-picker.open {
      display: grid;
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }
    .color-picker-wrapper.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .color-picker.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      outline: none;
      background: transparent;
    }
    .color-swatch span {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }
    .color-swatch.active {
      border-color: #111;
    }
    .modal-columns {
      display: grid;
      grid-template-columns: minmax(230px, 320px) minmax(420px, 1fr);
      gap: 18px;
      align-items: flex-start;
    }
    .modal-summary {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      background: #f9fafb;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-form-section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #ffffff;
    }
    .form-row {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      padding: 6px;
      font-family: inherit;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    select {
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      font-family: inherit;
      background: #ffffff;
      color: #0f172a;
    }
    .form-success-message {
      font-size: 12px;
      color: #16a34a;
      margin-top: 6px;
      display: none;
    }
    input[type="text"],
    input[type="time"] {
      padding: 6px;
      font-size: 12px;
      font-family: inherit;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    #filesInput {
      min-height: 48px;
    }
    .platforms {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 8px;
      font-size: 12px;
    }
    .platforms label {
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .platform-presets {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #475569;
    }
    .platform-presets .preset-btn {
      font-size: 11px;
      padding: 4px 10px;
    }
    .form-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .inline-color-control {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #111827;
    }
    .inline-color-control .color-picker-toggle {
      margin-left: 2px;
    }
    .form-button-actions {
      display: inline-flex;
      gap: 6px;
      margin-left: auto;
    }
    #toggleFormBtn {
      border-radius: 999px;
      padding-inline: 14px;
      padding-block: 6px;
    }

    /* Gün içi içerik listesi */
    #modalSummary {
      margin-top: 8px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .summary-item {
      --summary-card-color: rgba(15, 23, 42, 0.25);
      position: relative;
      padding: 5px 8px 6px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: none;
      cursor: pointer;
      color: #0f172a;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }
    .summary-item:focus-visible {
      outline: 2px solid rgba(59, 91, 219, 0.4);
      outline-offset: 2px;
    }
    .summary-item + .summary-item {
      margin-top: 1px;
    }
    .summary-item.excel {
      background: #ffffff;
    }
    .summary-item.active {
      border: 2px solid #3b82f6;
      background: #eef3ff;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18);
    }
    .summary-item.active::before {
      content: "";
      position: absolute;
      left: -1px;
      top: 10px;
      bottom: 10px;
      width: 4px;
      border-radius: 999px;
      background: #3b82f6;
    }
    .summary-item:hover {
      border-color: #cbd5f5;
    }
    .summary-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--summary-card-color, #94a3b8);
      border: 1px solid rgba(255, 255, 255, 0.9);
      flex-shrink: 0;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.08);
    }
    .summary-item-header-left {
      display: flex;
      align-items: center;
      gap: 5px;
      min-width: 0;
      flex: 1;
    }
    .summary-item-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .summary-item-title {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 2px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: normal;
      max-width: 240px;
    }
    .summary-item-time-chip {
      font-size: 10.5px;
      color: #475569;
      border: 1px solid #dbeafe;
      background: #eef2ff;
      border-radius: 999px;
      padding: 2px 6px 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .summary-item-time-chip .time-value {
      font-weight: 600;
    }
    .icon-clock {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #c7d2fe;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #1d4ed8;
      background: #eef2ff;
    }
    .summary-item-platforms {
      font-size: 10.8px;
      color: #475569;
      line-height: 1.3;
    }
    .summary-item-owner {
      font-size: 10.8px;
      color: #1f2937;
      margin-top: 2px;
    }
    .summary-item-badge {
      font-size: 9.5px;
      color: #0f172a;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 999px;
      padding: 1px 7px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .summary-item-badge.excel {
      background: #e0e7ff;
      color: #1d4ed8;
      border-color: #c7d2fe;
      font-size: 9.5px;
      padding: 2px 7px;
    }
    .summary-item-footer {
      margin-top: 2px;
      display: flex;
      justify-content: flex-end;
    }
    .summary-item-copy-icon {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      border: 1px dashed #c7d2fe;
      background: #eef2ff;
      color: #4338ca;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .summary-item-copy-icon:hover {
      background: #e0e7ff;
    }
    .summary-item-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 3px;
    }
    .summary-item-status-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .summary-item-status {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      white-space: nowrap;
    }
    .summary-item-status.status-done {
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }
    .summary-item-status.status-missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .summary-item-status.status-planned {
      background: rgba(248, 250, 252, 1);
      color: #0f172a;
    }
    .modal-control-section {
      display: none;
    }
    .control-card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 18px;
      padding: 16px;
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .control-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      margin-bottom: 2px;
    }
    .control-title {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      margin: 0;
    }
    .control-meta {
      font-size: 14px;
      color: #475569;
      line-height: 1.4;
      margin: 0;
    }
    .control-note label {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: block;
      margin-bottom: 4px;
    }
    .control-note textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
    }
    .control-note textarea:read-only {
      background: #f8fafc;
      cursor: not-allowed;
    }
    .control-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .success-btn,
    .link-btn {
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
    }
    .success-btn {
      background: #dcfce7;
      border: 1px solid #86efac;
      color: #166534;
    }
    .success-btn:hover {
      background: #bbf7d0;
    }
    .control-actions .danger-btn {
      flex: none;
    }
    .link-btn {
      background: transparent;
      border: none;
      color: #2563eb;
      padding: 0;
      font-weight: 600;
      cursor: pointer;
    }
    .link-btn:disabled {
      color: #94a3b8;
      cursor: not-allowed;
    }
    .control-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(34, 197, 94, 0.15);
      color: #166534;
    }
    .control-status-badge.missed {
      background: rgba(248, 113, 113, 0.2);
      color: #991b1b;
    }
    .control-note-display {
      font-size: 14px;
      color: #334155;
      background: #f8fafc;
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
    }
    .control-checked-at {
      font-size: 12px;
      color: #94a3b8;
    }
    .plan-return-banner {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      font-size: 12px;
      color: #9a3412;
      margin-bottom: 10px;
    }
    .plan-return-banner span {
      flex: 1;
    }
    .summary-empty {
      padding: 20px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      color: #6b7280;
      width: 100%;
      text-align: center;
    }

    /* DARK MODE: yüksek kontrast */
    body.dark {
      background: #0b1120;
      color: #e5e7eb;
    }
    body.dark .calendar,
    body.dark .form,
    body.dark #viewReports {
      background: #0b1120;
      border-color: #1f2937;
    }
    body.dark .calendar-header {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .weekday {
      background: #0f172a;
      color: #e5e7eb;
    }
    body.dark .day {
      --day-surface: #0b1120;
      --day-text: #e5e7eb;
      --day-border: #1f2937;
      --day-chip-bg: rgba(226, 232, 240, 0.08);
      --day-chip-color: #e5e7eb;
      --day-chip-border: rgba(226, 232, 240, 0.18);
      --day-highlight-shadow: rgba(0, 0, 0, 0.45);
      background: var(--day-surface);
      border-color: var(--day-border);
    }
    body.dark .day.day-highlighted {
      box-shadow: 0 14px 30px var(--day-highlight-shadow, rgba(15, 23, 42, 0.45));
    }
    body.dark .day-number { color: var(--day-text); }
    body.dark .day-summary { color: #cbd5f5; }
    body.dark .day-counter {
      color: #c4b5fd;
    }

    /* Koyu mod modal daha aydınlık ve kontrastlı */
    body.dark .modal {
      background: rgba(15, 23, 42, 0.85);
    }
    body.dark .modal-content {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
    }
    body.dark .modal-header-block {
      background: #1e293b;
      border-color: #1f2937;
    }
    body.dark .modal-title { color: #f9fafb; }
    body.dark textarea,
    body.dark input[type="text"],
    body.dark input[type="time"] {
      background: #020617;
      color: #f9fafb;
      border-color: #475569;
    }
    body.dark .color-help-panel {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
    }
    body.dark .color-help-title {
      color: #f9fafb;
    }
    body.dark .color-help-row {
      color: #f9fafb;
    }

    body.dark .summary-item {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      color: #f8fafc;
    }
    body.dark .summary-item.excel {
      background: #111827;
    }
    body.dark .summary-item.active {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 45px rgba(59, 130, 246, 0.25);
    }
    body.dark .summary-empty {
      background: #020617;
      border-color: #475569;
      color: #9ca3af;
    }
    body.dark .summary-item-title,
    body.dark .summary-item-platforms,
    body.dark .summary-item-owner {
      color: #f8fafc;
    }
    body.dark .summary-item-time-chip {
      border-color: #475569;
      background: #1e293b;
      color: #e2e8f0;
    }
    body.dark .summary-item-time-chip .time-value {
      color: #e2e8f0;
    }
    body.dark .icon-clock {
      border-color: #475569;
      background: #111827;
      color: #93c5fd;
    }
    body.dark .summary-item-badge,
    body.dark .excel-chip {
      background: #1d4ed8;
      border-color: transparent;
      color: #f8fafc;
    }
    body.dark .summary-item-copy-icon {
      border-color: #4c1d95;
      background: #1e1b4b;
      color: #c4b5fd;
    }
    body.dark .form-success-message {
      color: #4ade80;
    }
    body.dark .copy-popover-backdrop {
      background: rgba(0, 0, 0, 0.6);
    }
    body.dark .copy-popover {
      background: #111827;
      border-color: #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
      color: #f9fafb;
    }
    body.dark .control-card {
      background: #ffffff;
      color: #0f172a;
    }
    body.dark .control-note textarea {
      background: #f8fafc;
      color: #0f172a;
      border-color: rgba(15, 23, 42, 0.15);
    }
    body.dark .excel-upload-container {
      border-top-color: #374151;
    }
    body.dark .schedule-search input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .day-summary.excel {
      color: #bae6fd;
    }
    body.dark .schedule-item {
      border-color: #1f2937;
    }
    body.dark .schedule-text,
    body.dark .schedule-date {
      color: #e5e7eb;
    }
    body.dark .schedule-item.summary {
      --summary-surface: #111827;
      --summary-text: #f5f6fb;
      --summary-border: rgba(59, 130, 246, 0.6);
      --summary-chip-bg: rgba(226, 232, 240, 0.12);
      --summary-chip-color: #f5f6fb;
      --summary-chip-border: rgba(226, 232, 240, 0.25);
      border-color: #1f2937;
      box-shadow: none;
    }
    body.dark .day-summary-chip {
      background: var(--day-chip-bg, #1e3a8a);
      color: var(--day-chip-color, #c7d2fe);
      border-color: var(--day-chip-border, transparent);
    }
    body.dark .summary-chip {
      background: #1e3a8a;
      color: #c7d2fe;
    }
    body.dark .schedule-view-toggle {
      background: #1f2937;
    }
    body.dark .schedule-view-btn {
      color: #cbd5f5;
    }
    body.dark .schedule-view-btn.active {
      background: #f8fafc;
      color: #0f172a;
    }
    body.dark .daily-entry-row {
      background: #111827;
      border-color: #1f2937;
      border-left-color: rgba(30, 41, 59, 0.9);
    }
    body.dark .daily-entry-row:hover {
      border-color: #3b82f6;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.6);
    }
    body.dark .daily-entry-row.active {
      border-color: rgba(59, 130, 246, 0.5);
      border-left-color: var(--daily-card-color, rgba(59, 130, 246, 0.5));
    }
    body.dark .daily-entry-title {
      color: #f8fafc;
    }
    body.dark .daily-entry-meta {
      color: #cbd5f5;
    }
    body.dark .daily-entry-status.status-pending {
      background: #334155;
      color: #f1f5f9;
    }
    body.dark .daily-entry-status.status-scheduled {
      background: #38bdf8;
      color: #0f172a;
    }
    body.dark .daily-entry-time-icon {
      color: #facc15;
    }

    body.dark button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark button:hover {
      background: #1e293b;
    }
    body.dark .primary-btn {
      background: #2563eb;
      border-color: #3b82f6;
      color: #ffffff;
    }
    body.dark .primary-btn:hover {
      background: #1d4ed8;
    }
    body.dark .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .secondary-btn:hover {
      background: #2c3a52;
    }
    body.dark .admin-user-row .role-select {
      background: #0f172a;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .admin-section {
      border-top-color: #1f2937;
    }
    body.dark .color-description-row {
      border-bottom-color: #1f2937;
    }
    body.dark .color-description-fields input,
    body.dark .color-description-fields textarea {
      background: #0f172a;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .color-swatch.active {
      border-color: #f9fafb;
    }
    body.dark .danger-btn {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }
    body.dark .danger-btn:hover {
      background: #991b1b;
    }
    body.dark .tab-button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }
    body.dark .report-controls { color: #e5e7eb; }
    body.dark .modal-summary {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .modal-form-section {
      background: #0b1120;
      border-color: #1f2937;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 780px) {
      .modal-columns {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <h2>Paylaşım Takvimi</h2>
      <form id="loginForm">
        <div class="form-row">
          <label for="loginEmail">E-posta</label>
          <input type="email" id="loginEmail" autocomplete="email" placeholder="ornek@site.com" required />
        </div>
        <div class="form-row">
          <label for="loginPassword">Şifre</label>
          <input type="password" id="loginPassword" autocomplete="current-password" placeholder="••••••••" required />
        </div>
        <div class="login-card-footer">
          <button type="submit" id="loginSubmitBtn" class="primary-btn">Giriş yap</button>
          <button type="button" id="switchAuthModeBtn" class="secondary-btn">Kayıt olmak istiyorum</button>
          <span id="loginError"></span>
        </div>
      </form>
    </div>
  </div>
  <div id="adminOverlay" class="admin-overlay">
    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2>Admin Paneli</h2>
        <button id="adminCloseBtn" class="admin-close-btn" aria-label="Kapat">×</button>
      </div>
      <div class="admin-panel-tabs" id="adminPanelTabs">
        <button type="button" class="admin-tab-btn active" data-panel="users">Kullanıcı yönetimi</button>
        <button
          type="button"
          class="admin-tab-btn"
          data-panel="colors"
          id="colorTabBtn"
          style="display:none;"
        >
          Renk açıklamalarını düzenle
        </button>
      </div>
      <div class="admin-tab-view active" id="adminUsersSection" data-panel="users">
        <p class="small">
          Bekleyen kullanıcı kayıtlarını onaylayabilir, herhangi bir kullanıcının takvimini görüntüleyebilirsin.
          <span id="pendingCountBadge" class="pending-count-badge">(0 bekleyen kayıt)</span>
        </p>
        <div class="admin-panel-actions">
          <button type="button" id="adminViewSelfBtn" class="primary-btn">Kendi takvimimi göster</button>
        </div>
        <div class="admin-user-list" id="adminUserList"></div>
      </div>
      <div
        class="admin-tab-view admin-section"
        id="colorDescriptionsSection"
        data-panel="colors"
        style="display:none;"
      >
        <h3>Renk açıklamalarını düzenle</h3>
        <p class="small">
          Gün rengi panelinde görünen metinleri burada düzenleyebilirsin. Bu ayarlar tüm kullanıcılar için geçerlidir.
        </p>
        <div class="color-description-scroll">
          <div id="colorDescriptionsForm"></div>
        </div>
        <div class="color-description-actions">
          <button type="button" id="colorDescriptionSaveBtn" class="secondary-btn">Kaydet</button>
          <span class="small" id="colorDescriptionSaveStatus"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container" id="toastContainer" aria-live="polite"></div>
  <div id="appRoot">
  <div class="header">
    <div class="header-left">
      <img src="goart-logo.png" alt="GoArt Worlds" class="logo" />
      <h1>Paylaşım Takvimi</h1>
    </div>
    <div class="header-right">
      <button id="adminPanelBtn" style="display:none;">Admin paneli</button>
      <button id="logoutBtn" style="display:none;">Çıkış yap</button>
      <button id="themeToggleBtn">Koyu mod</button>
    </div>
  </div>

  <div class="tabs" style="margin-bottom:8px;">
    <button class="tab-button active" id="tabCalendar">Takvim</button>
    <button class="tab-button" id="tabReports">Raporlar</button>
  </div>
  <p class="small" id="adminViewInfo" style="display:none;"></p>

  <!-- TAKVİM GÖRÜNÜMÜ -->
  <div id="viewCalendar">
    <div class="container calendar-layout" id="calendarLayout">
      <div class="calendar-shell">
        <div class="calendar">
        <div class="channel-filter" id="channelFilter">
          <span>Kanallar:</span>
          <button type="button" class="channel-filter-btn" data-channel="all">Tümü</button>
          <button type="button" class="channel-filter-btn" data-channel="instagram">Instagram</button>
          <button type="button" class="channel-filter-btn" data-channel="x">X</button>
          <button type="button" class="channel-filter-btn" data-channel="telegram">Telegram</button>
          <button type="button" class="channel-filter-btn" data-channel="facebook">Facebook</button>
          <button type="button" class="channel-filter-btn" data-channel="linkedin">LinkedIn</button>
          <button type="button" class="channel-filter-btn" data-channel="youtube">YouTube</button>
          <button type="button" class="channel-filter-btn" data-channel="tiktok">TikTok</button>
          <button type="button" class="channel-filter-btn" data-channel="discord">Discord</button>
          <button type="button" class="channel-filter-btn" data-channel="reddit">Reddit</button>
          <button type="button" class="channel-filter-btn" data-channel="website">Website</button>
          <button type="button" class="channel-filter-btn" data-channel="medium">Medium</button>
        </div>
        <div class="calendar-header">
          <button id="prevMonthBtn" class="month-nav-btn" aria-label="Önceki ay">&larr;</button>
          <div class="month-label" id="monthLabel"></div>
          <button id="nextMonthBtn" class="month-nav-btn" aria-label="Sonraki ay">&rarr;</button>
        </div>
        <div class="weekdays">
          <div class="weekday">Pzt</div>
          <div class="weekday">Sal</div>
          <div class="weekday">Çar</div>
          <div class="weekday">Per</div>
          <div class="weekday">Cum</div>
          <div class="weekday">Cmt</div>
          <div class="weekday">Paz</div>
        </div>
        <div class="calendar-grid-wrapper">
          <div class="days" id="daysContainer"></div>
        </div>
      </div>
      </div>

      <div class="side summary-shell">
        <div class="form">
          <h2>Gün Detayı / Takvim Özeti</h2>
          <div class="summary-scroll-area">
            <div class="schedule-search">
              <input
                type="text"
                id="scheduleSearchInput"
                placeholder="Tarih veya platform ara"
                aria-label="Takvim araması"
              />
            </div>
            <div class="schedule-view-toggle" id="scheduleViewToggle">
              <button type="button" class="schedule-view-btn active" data-view="daily">Günlük</button>
              <button type="button" class="schedule-view-btn" data-view="weekly">Haftalık</button>
              <button type="button" class="schedule-view-btn" data-view="monthly">Aylık</button>
            </div>
            <div id="scheduleList" class="schedule-list small"></div>
          </div>
          <div class="excel-upload-container">
            <p class="excel-note">
              Excel yüklediğinde önceki Excel kayıtları silinir, manuel eklediğin içeriklere dokunulmaz.
            </p>
            <div class="excel-upload-actions">
              <button id="excelUploadBtn" class="secondary-btn" style="display:none;">Excel yükle</button>
              <button id="resetEntriesBtn" class="danger-btn" style="display:none;">Sıfırla</button>
            </div>
            <div id="resetOptions" class="reset-options">
              <button type="button" class="danger-btn" data-scope="excel">Excel girişlerini sıfırla</button>
              <button type="button" class="danger-btn" data-scope="manual">Manuel girişleri sıfırla</button>
              <button type="button" class="danger-btn" data-scope="highlights">Gün renklerini sıfırla</button>
              <button type="button" class="danger-btn" data-scope="all">Tüm kayıtları sıfırla</button>
              <button type="button" class="secondary-btn" id="resetCancelBtn">Vazgeç</button>
            </div>
            <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none;" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RAPORLAR -->
  <div id="viewReports" style="display:none;">
    <h2>Raporlar</h2>
    <p class="small" id="reportMonthLabel"></p>
    <p class="small" id="reportFilterLabel"></p>

    <div class="report-controls">
      <span>Görünüm:</span>
      <label>
        <input type="radio" name="reportMode" value="month" checked />
        Aylık
      </label>
      <label>
        <input type="radio" name="reportMode" value="range" />
        Tarih aralığı
      </label>
      <div class="report-range-inputs" id="reportRangeInputs" style="display:none;">
        <input type="date" id="reportRangeStart" />
        <span class="range-separator">→</span>
        <input type="date" id="reportRangeEnd" />
      </div>
    </div>
    <div class="quick-range-buttons" id="quickRangeButtons" style="display:none;">
      <span>Kısayol:</span>
      <button type="button" data-range="7">Son 7 gün</button>
      <button type="button" data-range="14">Son 14 gün</button>
      <button type="button" data-range="30">Son 30 gün</button>
      <button type="button" data-range="90">Son 90 gün</button>
    </div>

    <div class="report-content-toggle" id="reportContentToggle">
      <span>İçerik görünümü:</span>
      <button type="button" class="report-view-btn active" data-report-view="summary">Özet</button>
      <button type="button" class="report-view-btn" data-report-view="executed">Paylaşılan içerikler</button>
    </div>

    <div id="reportsSummaryContainer">
      <div class="report-section">
        <h3>Toplam içerik</h3>
        <p class="small" id="reportTotal"></p>
      </div>

      <div class="report-section">
        <h3>Platforma göre içerik sayısı</h3>
        <div class="report-chart-wrapper" id="platformChartWrapper" style="display:none;">
          <canvas id="platformChart"></canvas>
        </div>
        <ul class="report-list" id="reportPlatforms"></ul>
      </div>

      <div class="report-section">
        <h3>Saat aralığına göre dağılım</h3>
        <div class="report-chart-wrapper" id="timeChartWrapper" style="display:none;">
          <canvas id="timeChart"></canvas>
        </div>
        <ul class="report-list" id="reportTimes"></ul>
      </div>

      <div class="report-section">
        <h3>İçerik olan gün sayısı</h3>
        <p class="small" id="reportDays"></p>
      </div>
    </div>

    <div class="report-section" id="reportsExecutedSection" style="display:none;">
      <div class="report-executed-header">
        <p class="report-summary-line" id="executedSummaryLine"></p>
        <label class="report-checkbox">
          <input type="checkbox" id="executedShowMissedToggle" />
          Kaçanları da göster
        </label>
      </div>
      <div class="report-table-wrapper">
        <table class="report-table">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Saat</th>
              <th>Metin</th>
              <th>Platformlar</th>
              <th>Durum</th>
              <th>Sorumlu</th>
              <th>Not</th>
            </tr>
          </thead>
          <tbody id="executedTableBody"></tbody>
        </table>
        <p class="small" id="executedEmptyMessage" style="display:none;">Bu aralıkta paylaşılan içerik bulunamadı.</p>
      </div>
    </div>
  </div>

  <!-- Modal: Seçili Gün -->
  <div class="modal" id="dayModal">
    <div class="modal-content">
      <div class="modal-header-block">
        <div class="modal-header">
          <div class="modal-title" id="modalDateTitle"></div>
          <button class="modal-close" id="modalCloseBtn" aria-label="Kapat">&times;</button>
        </div>
        <div class="modal-toolbar">
        <button id="toggleFormBtn">Paylaşım oluştur +</button>
        <div class="highlight-picker color-picker-wrapper" id="highlightColorWrapper">
          <span class="highlight-label">Gün rengi</span>
          <button type="button" class="color-picker-toggle" id="highlightColorToggle" aria-label="Gün rengini seç">
            <span class="toggle-swatch"></span>
            <span>Seç</span>
          </button>
          <button type="button" class="highlight-help-btn" id="colorHelpBtn" aria-label="Gün rengi açıklamalarını göster">?</button>
          <div class="color-picker" id="highlightColorPicker"></div>
          <input type="hidden" id="highlightColorInput" value="#fee2e2" />
          <div class="color-help-panel" id="colorHelpPanel">
            <div class="color-help-header">
              <span class="color-help-title">Gün rengi açıklamaları</span>
              <button type="button" class="color-help-close" id="colorHelpCloseBtn" aria-label="Kapat">×</button>
            </div>
            <div class="color-help-list" id="colorHelpList"></div>
          </div>
        </div>
      </div>
      </div>
      <div class="modal-body">
        <div class="modal-columns">
          <div id="modalSummary" class="modal-summary small"></div>

          <div id="modalFormSection" class="modal-form-section" style="display: none;">
            <div class="plan-return-banner" id="planReturnBanner">
              <span>Bu paylaşım geçmiş. Şu anda planlama formunu düzenliyorsun.</span>
              <button type="button" class="link-btn" id="returnToControlBtn">Kontrol moduna dön</button>
            </div>
            <div class="form-row">
              <label for="filesInput">Paylaşılacak dosyalar / linkler</label>
              <textarea
                id="filesInput"
                placeholder="Örn: Drive linki, dosya adları"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="textInput">Paylaşım metni</label>
            <textarea
              id="textInput"
              placeholder="Post metnini buraya yaz"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="timeInput">Paylaşım saati</label>
            <input type="time" id="timeInput" />
          </div>

          <div class="form-row">
            <label for="noteInput">Not (isteğe bağlı)</label>
            <textarea
              id="noteInput"
              placeholder="Örn: görsel güncellenmeli, farklı link kullanılacak"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="ownerSelect">Sorumlu kişi</label>
            <select id="ownerSelect" style="font-size:12px;padding:6px;border-radius:6px;">
              <option value="">Seçilmedi</option>
            </select>
          </div>

          <div class="form-row">
            <label>Hangi sosyal medya?</label>
            <div class="platform-presets">
              <span>Hızlı seçim:</span>
              <button type="button" class="preset-btn secondary-btn" data-platforms="Instagram Post|Instagram Story|Instagram Reels">Instagram paketi</button>
              <button type="button" class="preset-btn secondary-btn" data-platforms="Instagram Post|Instagram Story|Instagram Reels|Facebook|X|Telegram|Website">Çoklu sosyal</button>
              <button type="button" class="preset-btn secondary-btn" data-platforms="">Temizle</button>
            </div>
            <div class="platforms">
              <label><input type="checkbox" value="Instagram Post" />Instagram Post</label>
              <label><input type="checkbox" value="Instagram Story" />Instagram Story</label>
              <label><input type="checkbox" value="Instagram Reels" />Instagram Reels</label>
              <label><input type="checkbox" value="Facebook" />Facebook</label>
              <label><input type="checkbox" value="X" />X</label>
              <label><input type="checkbox" value="Reddit" />Reddit</label>
              <label><input type="checkbox" value="Discord" />Discord</label>
              <label><input type="checkbox" value="YouTube" />YouTube</label>
              <label><input type="checkbox" value="LinkedIn" />LinkedIn</label>
              <label><input type="checkbox" value="TikTok" />TikTok</label>
              <label><input type="checkbox" value="Telegram" />Telegram</label>
              <label><input type="checkbox" value="Website" />Website</label>
              <label><input type="checkbox" value="Medium" />Medium</label>
            </div>
          </div>

          <div class="form-buttons">
            <div class="inline-color-control color-picker-wrapper" id="entryColorWrapper">
              <span>Kart rengi</span>
              <button type="button" class="color-picker-toggle" id="entryColorToggle" aria-label="Paylaşım rengini seç">
                <span class="toggle-swatch"></span>
                <span>Seç</span>
              </button>
              <div class="color-picker" id="entryColorPicker"></div>
              <input type="hidden" id="entryColorInput" value="#2563eb" />
            </div>
            <div class="form-button-actions">
              <button id="deleteBtn">Sil</button>
              <button id="clearBtn">Temizle</button>
              <button id="saveBtn">Kaydet</button>
            </div>
          </div>
          <p class="form-success-message" id="saveSuccessMessage">Değişiklikler kaydedildi.</p>

          <p class="small">
            Not: Veriler hesabınıza bağlı olarak sunucuda saklanır.
          </p>
        </div>
          <div id="modalControlSection" class="modal-control-section" style="display:none;">
            <div class="control-card">
              <div class="control-header">
                <div>
                  <p class="control-label">Planlanan paylaşım</p>
                  <p class="control-title" id="controlSummaryTitle"></p>
                </div>
                <button type="button" class="link-btn" id="controlEditBtn">Düzenle</button>
              </div>
              <p class="control-meta" id="controlSummaryMeta"></p>
              <p class="control-meta" id="controlSummaryPlatforms"></p>
              <p class="control-meta" id="controlSummaryOwner"></p>
              <div class="control-note">
                <label for="controlNoteInput">Not ekle (isteğe bağlı)</label>
                <textarea id="controlNoteInput" placeholder="Örn: Link güncellendi, farklı dosya paylaşıldı..."></textarea>
              </div>
              <div class="control-actions">
                <button type="button" class="success-btn" id="markDoneBtn">✅ Paylaşıldı</button>
                <button type="button" class="danger-btn" id="markMissedBtn">❌ Paylaşılmadı</button>
              </div>
            </div>
          </div>

          <div id="modalCheckedSection" class="modal-control-section" style="display:none;">
            <div class="control-card">
              <div class="control-header">
                <div>
                  <p class="control-label">Durum</p>
                  <span class="control-status-badge" id="checkedStatusBadge">Paylaşıldı</span>
                </div>
                <button type="button" class="secondary-btn" id="checkedEditBtn">Düzenle</button>
              </div>
              <p class="control-meta" id="checkedSummaryMeta"></p>
              <p class="control-meta" id="checkedSummaryPlatforms"></p>
              <p class="control-meta" id="checkedSummaryOwner"></p>
              <div class="control-note-display" id="checkedNoteText" style="display:none;"></div>
              <p class="control-checked-at" id="checkedInfoText"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="copyPopoverBackdrop" class="copy-popover-backdrop">
    <div class="copy-popover" id="copyPopover">
      <div class="copy-popover-header">
        <span>Bu paylaşımı kopyala</span>
        <button type="button" class="color-help-close" id="copyPopoverCloseBtn" aria-label="Kapat">×</button>
      </div>
      <div class="form-row" style="margin-bottom:0;">
        <label for="copyDateInput">Hedef tarih</label>
        <input type="date" id="copyDateInput" />
      </div>
      <div class="copy-popover-actions">
        <button type="button" class="secondary-btn" id="copyCancelBtn">Vazgeç</button>
        <button type="button" class="primary-btn" id="copyConfirmBtn">Kopyala</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    const API_BASE = "https://paylasimtakvimi.onrender.com";
    let authToken = localStorage.getItem("contentCalendar_token") || "";
    let entriesById = new Map();
    let entriesByDate = new Map();

    const loginOverlay = document.getElementById("loginOverlay");
    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginSubmitBtn = document.getElementById("loginSubmitBtn");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");
    const switchAuthModeBtn = document.getElementById("switchAuthModeBtn");
    const adminPanelBtn = document.getElementById("adminPanelBtn");
    const excelUploadContainer = document.querySelector(".excel-upload-container");
    const excelUploadBtn = document.getElementById("excelUploadBtn");
    const resetEntriesBtn = document.getElementById("resetEntriesBtn");
    const resetOptions = document.getElementById("resetOptions");
    const resetOptionButtons = resetOptions
      ? Array.from(resetOptions.querySelectorAll("button[data-scope]"))
      : [];
    const resetCancelBtn = document.getElementById("resetCancelBtn");
    const excelFileInput = document.getElementById("excelInput");
const adminOverlay = document.getElementById("adminOverlay");
const adminCloseBtn = document.getElementById("adminCloseBtn");
const adminUserList = document.getElementById("adminUserList");
const adminViewSelfBtn = document.getElementById("adminViewSelfBtn");
const adminViewInfo = document.getElementById("adminViewInfo");
const pendingCountBadge = document.getElementById("pendingCountBadge");
const colorDescriptionsSection = document.getElementById("colorDescriptionsSection");
const colorDescriptionsForm = document.getElementById("colorDescriptionsForm");
const colorDescriptionSaveBtn = document.getElementById("colorDescriptionSaveBtn");
const colorDescriptionSaveStatus = document.getElementById("colorDescriptionSaveStatus");
const adminTabButtons = Array.from(document.querySelectorAll(".admin-tab-btn"));
const adminUsersSection = document.getElementById("adminUsersSection");
const colorTabBtn = document.getElementById("colorTabBtn");

    const monthLabel = document.getElementById("monthLabel");
    const daysContainer = document.getElementById("daysContainer");
    const prevBtn = document.getElementById("prevMonthBtn");
    const nextBtn = document.getElementById("nextMonthBtn");

    const filesInput = document.getElementById("filesInput");
    const textInput = document.getElementById("textInput");
    const timeInput = document.getElementById("timeInput");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    deleteBtn.disabled = true;
    const platformInputs = document.querySelectorAll(
      ".platforms input[type='checkbox']"
    );
    const platformPresetButtons = document.querySelectorAll(".preset-btn[data-platforms]");
    const platformInputMap = new Map();
    platformInputs.forEach((cb) => {
      platformInputMap.set(cb.value, cb);
    });
    const scheduleList = document.getElementById("scheduleList");
const scheduleViewToggle = document.getElementById("scheduleViewToggle");
const scheduleViewButtons = scheduleViewToggle
  ? Array.from(scheduleViewToggle.querySelectorAll("button[data-view]"))
  : [];
const saveSuccessMessage = document.getElementById("saveSuccessMessage");
const scheduleSearchInput = document.getElementById("scheduleSearchInput");
const entryColorInput = document.getElementById("entryColorInput");
const highlightColorInput = document.getElementById("highlightColorInput");
const noteInput = document.getElementById("noteInput");
const ownerSelect = document.getElementById("ownerSelect");
const entryColorPicker = document.getElementById("entryColorPicker");
const highlightColorPicker = document.getElementById("highlightColorPicker");
const entryColorToggle = document.getElementById("entryColorToggle");
const highlightColorToggle = document.getElementById("highlightColorToggle");
const entryColorWrapper = document.getElementById("entryColorWrapper");
const highlightColorWrapper = document.getElementById("highlightColorWrapper");
const channelFilter = document.getElementById("channelFilter");
const channelFilterButtons = channelFilter
  ? Array.from(channelFilter.querySelectorAll("button[data-channel]"))
  : [];
const copyPopoverBackdrop = document.getElementById("copyPopoverBackdrop");
const copyPopover = document.getElementById("copyPopover");
const copyDateInput = document.getElementById("copyDateInput");
const copyConfirmBtn = document.getElementById("copyConfirmBtn");
const copyCancelBtn = document.getElementById("copyCancelBtn");
const copyPopoverCloseBtn = document.getElementById("copyPopoverCloseBtn");
const colorHelpBtn = document.getElementById("colorHelpBtn");
const colorHelpPanel = document.getElementById("colorHelpPanel");
const colorHelpList = document.getElementById("colorHelpList");
const colorHelpCloseBtn = document.getElementById("colorHelpCloseBtn");
const reportFilterLabel = document.getElementById("reportFilterLabel");
const toastContainer = document.getElementById("toastContainer");

    const dayModal = document.getElementById("dayModal");
    const modalDateTitle = document.getElementById("modalDateTitle");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalFormSection = document.getElementById("modalFormSection");
    const modalControlSection = document.getElementById("modalControlSection");
    const modalCheckedSection = document.getElementById("modalCheckedSection");
const controlSummaryTitle = document.getElementById("controlSummaryTitle");
const controlSummaryMeta = document.getElementById("controlSummaryMeta");
const controlSummaryPlatforms = document.getElementById("controlSummaryPlatforms");
const controlSummaryOwner = document.getElementById("controlSummaryOwner");
const controlNoteInput = document.getElementById("controlNoteInput");
    const markDoneBtn = document.getElementById("markDoneBtn");
    const markMissedBtn = document.getElementById("markMissedBtn");
    const controlEditBtn = document.getElementById("controlEditBtn");
    const checkedEditBtn = document.getElementById("checkedEditBtn");
    const checkedStatusBadge = document.getElementById("checkedStatusBadge");
    const checkedSummaryMeta = document.getElementById("checkedSummaryMeta");
const checkedSummaryPlatforms = document.getElementById("checkedSummaryPlatforms");
const checkedSummaryOwner = document.getElementById("checkedSummaryOwner");
    const checkedNoteText = document.getElementById("checkedNoteText");
    const checkedInfoText = document.getElementById("checkedInfoText");
    const planReturnBanner = document.getElementById("planReturnBanner");
    const returnToControlBtn = document.getElementById("returnToControlBtn");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const modalSummary = document.getElementById("modalSummary");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    const tabCalendar = document.getElementById("tabCalendar");
    const tabReports = document.getElementById("tabReports");
    const viewCalendar = document.getElementById("viewCalendar");
    const viewReports = document.getElementById("viewReports");

    const reportMonthLabel = document.getElementById("reportMonthLabel");
    const reportTotal = document.getElementById("reportTotal");
    const reportPlatforms = document.getElementById("reportPlatforms");
    const reportTimes = document.getElementById("reportTimes");
    const reportDays = document.getElementById("reportDays");
    const reportModeRadios = document.querySelectorAll("input[name='reportMode']");
    const reportRangeInputs = document.getElementById("reportRangeInputs");
    const reportRangeStartInput = document.getElementById("reportRangeStart");
    const reportRangeEndInput = document.getElementById("reportRangeEnd");
    const quickRangeButtons = document.getElementById("quickRangeButtons");
    const platformChartWrapper = document.getElementById("platformChartWrapper");
    const platformChartCanvas = document.getElementById("platformChart");
    const timeChartWrapper = document.getElementById("timeChartWrapper");
    const timeChartCanvas = document.getElementById("timeChart");
    const reportContentToggle = document.getElementById("reportContentToggle");
    const reportViewButtons = reportContentToggle
      ? Array.from(reportContentToggle.querySelectorAll("button[data-report-view]"))
      : [];
    const reportsSummaryContainer = document.getElementById("reportsSummaryContainer");
    const reportsExecutedSection = document.getElementById("reportsExecutedSection");
    const executedSummaryLine = document.getElementById("executedSummaryLine");
    const executedTableBody = document.getElementById("executedTableBody");
    const executedEmptyMessage = document.getElementById("executedEmptyMessage");
    const executedShowMissedToggle = document.getElementById("executedShowMissedToggle");

    const monthNames = [
      "Ocak","Şubat","Mart","Nisan","Mayıs","Haziran",
      "Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"
    ];

    const todayReferenceDate = normalizeToMidnight(new Date());
    const todayDateKey = formatDateKey(todayReferenceDate);

    let currentYear;
    let currentMonth;
    let summaryDateKey = todayDateKey;
    let selectedDateKey = todayDateKey;
let currentDayItems = []; // {id, files, text, time, platforms}[]
let activeItemId = null;
let isRegisterMode = false;
let currentUser = null;
let adminSelectedUserId = null;
let modalForcePlanMode = false;
let copySourceEntry = null;
const excelUploadDefaultText = excelUploadBtn ? excelUploadBtn.textContent : "Excel yükle";
let scheduleSearchQuery = "";
let scheduleViewMode = "daily";
let scheduleDailyDateKey = summaryDateKey;
let highlightedDates = new Map();
let saveSuccessTimeout = null;
let activeScheduleSummaryKey = summaryDateKey;
const DEFAULT_ENTRY_COLOR = "#2563eb";
const DEFAULT_HIGHLIGHT_COLOR = "#fee2e2";
const COLOR_PALETTE = [
  DEFAULT_HIGHLIGHT_COLOR,
  "#ffffff",
  "#000000",
  "#dc2626",
  "#f97316",
  "#facc15",
  "#22c55e",
  "#0ea5e9",
  "#2563eb",
  "#7c3aed",
  "#ec4899",
  "#6b7280",
  "#fbbf24",
  "#34d399",
  "#38bdf8",
  "#a855f7",
  "#ef4444"
];
const COLOR_TOKEN_MAP = {
  "#fee2e2": "default",
  "#ffffff": "white",
  "#000000": "black",
  "#dc2626": "red",
  "#f97316": "orange",
  "#facc15": "yellow",
  "#22c55e": "green",
  "#0ea5e9": "sky",
  "#2563eb": "blue",
  "#7c3aed": "purple",
  "#ec4899": "pink",
  "#6b7280": "gray",
  "#fbbf24": "amber",
  "#34d399": "emerald",
  "#38bdf8": "cyan",
  "#a855f7": "violet",
  "#ef4444": "rose"
};
const COLOR_TOKENS_IN_ORDER = [
  "default",
  "white",
  "black",
  "red",
  "orange",
  "yellow",
  "amber",
  "green",
  "emerald",
  "cyan",
  "sky",
  "blue",
  "purple",
  "violet",
  "pink",
  "rose",
  "gray"
];
const COLOR_DESCRIPTION_DEFAULTS = {
  default: { label: "Açık pembe", description: "Varsayılan gün rengi" },
  white: { label: "Beyaz", description: "Genel içerikler" },
  black: { label: "Siyah", description: "Sistem duyuruları" },
  red: { label: "Kırmızı", description: "Airdrop günleri" },
  orange: { label: "Turuncu", description: "Video içerikleri" },
  yellow: { label: "Sarı", description: "Hediye saatleri" },
  amber: { label: "Kehribar", description: "Yayın hatırlatmaları" },
  green: { label: "Yeşil", description: "Önemli duyurular" },
  emerald: { label: "Zümrüt", description: "B2B etkinlikleri" },
  cyan: { label: "Turkuaz", description: "Eğitim içerikleri" },
  sky: { label: "Açık mavi", description: "USDT etkinlikleri" },
  blue: { label: "Mavi", description: "Topluluk canlı yayınları" },
  purple: { label: "Mor", description: "Influencer iş birlikleri" },
  violet: { label: "Menekşe", description: "Özel seri" },
  pink: { label: "Pembe", description: "Kadın topluluğu içerikleri" },
  rose: { label: "Pudra", description: "PR paylaşımları" },
  gray: { label: "Gri", description: "Hazırlık aşamasında" }
};
const COLOR_HEX_BY_TOKEN = Object.fromEntries(
  Object.entries(COLOR_TOKEN_MAP).map(([hex, token]) => [token, hex])
);
function cloneColorDescriptionDefaults() {
  return JSON.parse(JSON.stringify(COLOR_DESCRIPTION_DEFAULTS));
}
let colorDescriptions = cloneColorDescriptionDefaults();
let colorDescriptionsLoaded = false;
let colorHelpPanelOpen = false;
let activeAdminPanelTab = "users";
const CHANNEL_FILTER_DEFINITIONS = {
  all: {
    label: "Tümü",
    matcher: () => true
  },
  instagram: {
    label: "Instagram",
    matcher: (value) => value.toLowerCase().includes("instagram")
  },
  x: {
    label: "X",
    matcher: (value) =>
      value.trim().toLowerCase() === "x" ||
      value.toLowerCase().includes("twitter")
  },
  telegram: {
    label: "Telegram",
    matcher: (value) => value.toLowerCase().includes("telegram")
  },
  facebook: {
    label: "Facebook",
    matcher: (value) => value.toLowerCase().includes("facebook")
  },
  linkedin: {
    label: "LinkedIn",
    matcher: (value) => value.toLowerCase().includes("linkedin")
  },
  youtube: {
    label: "YouTube",
    matcher: (value) => value.toLowerCase().includes("youtube")
  },
  tiktok: {
    label: "TikTok",
    matcher: (value) => value.toLowerCase().includes("tiktok")
  },
  discord: {
    label: "Discord",
    matcher: (value) => value.toLowerCase().includes("discord")
  },
  reddit: {
    label: "Reddit",
    matcher: (value) => value.toLowerCase().includes("reddit")
  },
  website: {
    label: "Website",
    matcher: (value) =>
      value.trim().toLowerCase() === "website" ||
      value.toLowerCase().includes("website") ||
      value.toLowerCase().includes("landing") ||
      value.toLowerCase().includes("web")
  },
  medium: {
    label: "Medium",
    matcher: (value) => value.toLowerCase().includes("medium")
  }
};
const CHANNEL_FILTER_STORAGE_KEY = "calendar_channel_filter";
let activeChannelFilter =
  localStorage.getItem(CHANNEL_FILTER_STORAGE_KEY) || "all";
if (!CHANNEL_FILTER_DEFINITIONS[activeChannelFilter]) {
  activeChannelFilter = "all";
}
let responsibleUsers = [];
const responsibleUserMap = new Map();

function hexToRgb(hex) {
  const value = hex.replace("#", "");
  const bigint = parseInt(value, 16);
  if (value.length === 3) {
    const r = (bigint >> 8) & 0xf;
    const g = (bigint >> 4) & 0xf;
    const b = bigint & 0xf;
    return { r: r * 17, g: g * 17, b: b * 17 };
  }
  return {
    r: (bigint >> 16) & 255,
    g: (bigint >> 8) & 255,
    b: bigint & 255
  };
}

function hexToRgba(hex, alpha = 1) {
  const { r, g, b } = hexToRgb(hex);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function getContrastingTextColor(hex) {
  const { r, g, b } = hexToRgb(hex);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111827" : "#f9fafb";
}

function normalizeHexColor(value) {
  if (!value) return null;
  let hex = value.toString().trim().toLowerCase();
  if (!hex.startsWith("#")) return null;
  if (hex.length === 4) {
    hex =
      "#" +
      hex[1] +
      hex[1] +
      hex[2] +
      hex[2] +
      hex[3] +
      hex[3];
  }
  if (hex.length === 7) return hex;
  return null;
}

function getColorTokenFromHex(value) {
  const normalized = normalizeHexColor(value);
  if (!normalized) return null;
  return COLOR_TOKEN_MAP[normalized] || null;
}

function getEntryDateTime(entry) {
  if (!entry || !entry.date) return null;
  const timeValue =
    entry.time && /^\d{2}:\d{2}$/.test(entry.time) ? entry.time : "23:59";
  const timestamp = new Date(`${entry.date}T${timeValue}:00`);
  return Number.isNaN(timestamp.getTime()) ? null : timestamp;
}

function isEntryPast(entry) {
  const dt = getEntryDateTime(entry);
  if (!dt) return false;
  return dt.getTime() < Date.now();
}

function formatStatusLabel(status) {
  if (status === "done") return "Paylaşıldı";
  if (status === "missed") return "Paylaşılmadı";
  return "Planlandı";
}

function filterPlatformsByChannel(platforms = [], filterId = "all") {
  if (!Array.isArray(platforms) || !platforms.length) return [];
  if (!filterId || filterId === "all") return platforms.slice();
  const definition = CHANNEL_FILTER_DEFINITIONS[filterId];
  if (!definition) return platforms.slice();
  return platforms.filter((platform) =>
    definition.matcher(String(platform || ""))
  );
}

function formatPlatformsLabel(platforms = [], options = {}) {
  const filterId = options.filterId || "all";
  const scoped =
    filterPlatformsByChannel(platforms, filterId) || [];
  if (!scoped.length) {
    return filterId !== "all"
      ? getChannelFilterLabel(filterId)
      : "Platform seçilmedi";
  }
  return scoped.join(", ");
}

function formatEntryPreviewText(entry, limit = 120) {
  if (!entry) return "Metin yok";
  const raw = (entry.text || entry.files || "").trim();
  if (!raw) return "Metin yok";
  if (raw.length <= limit) return raw;
  return raw.slice(0, Math.max(0, limit - 3)) + "...";
}

function getColorDescriptionForKey(key) {
  return (
    colorDescriptions[key] ||
    COLOR_DESCRIPTION_DEFAULTS[key] || {
      label: key,
      description: ""
    }
  );
}

function renderColorHelpList() {
  if (!colorHelpList) return;
  colorHelpList.innerHTML = "";
  COLOR_TOKENS_IN_ORDER.forEach((token) => {
    if (!COLOR_HEX_BY_TOKEN[token]) return;
    const info = getColorDescriptionForKey(token);
    const row = document.createElement("div");
    row.className = "color-help-row";
    const dot = document.createElement("span");
    dot.className = "color-help-dot";
    dot.style.backgroundColor = COLOR_HEX_BY_TOKEN[token];
    row.appendChild(dot);
    const text = document.createElement("span");
    text.textContent = `${info.label} – ${info.description || "Açıklama eklenmemiş"}`;
    row.appendChild(text);
    colorHelpList.appendChild(row);
  });
}

renderColorHelpList();

function applyPlatformPreset(values = []) {
  platformInputs.forEach((cb) => {
    cb.checked = false;
  });
  values.forEach((value) => {
    const trimmed = value.trim();
    if (!trimmed) return;
    const input = platformInputMap.get(trimmed);
    if (input) input.checked = true;
  });
}

function openCopyPopover(entry) {
  if (!copyPopover || !copyDateInput || !copyPopoverBackdrop) return;
  copySourceEntry = entry;
  copyDateInput.value = entry.date || "";
  copyPopoverBackdrop.classList.add("active");
  copyPopover.classList.add("active");
  requestAnimationFrame(() => copyDateInput.focus());
}

function closeCopyPopover() {
  if (!copyPopover || !copyPopoverBackdrop) return;
  copySourceEntry = null;
  copyPopoverBackdrop.classList.remove("active");
  copyPopover.classList.remove("active");
}

async function handleCopyConfirm() {
  if (!copySourceEntry) return;
  if (!authToken) {
    showLoginOverlay();
    return;
  }
  if (!isViewingOwnData()) {
    alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
    return;
  }
  if (!copyDateInput || !copyDateInput.value) {
    alert("Lütfen hedef tarihi seç.");
    return;
  }
  const targetDate = copyDateInput.value;
  if (!/^\d{4}-\d{2}-\d{2}$/.test(targetDate)) {
    alert("Tarih formatı geçersiz.");
    return;
  }

  const source = copySourceEntry;
  const payload = {
    date: targetDate,
    time: source.time || "",
    text: source.text || "",
    files: source.files || "",
    communication: source.communication || "",
    communicationType:
      source.communication_type || source.communicationType || "",
    status: "planned",
    platforms: Array.isArray(source.platforms) ? [...source.platforms] : [],
    color: source.color || DEFAULT_ENTRY_COLOR,
    note: source.note || "",
    checkedAt: null,
    ownerId: source.owner_id || null
  };

  if (copyConfirmBtn) copyConfirmBtn.disabled = true;
  try {
    await createEntry(payload);
    renderCalendar();
    updateScheduleList();
    if (selectedDateKey) {
      currentDayItems = loadDayData(selectedDateKey).items;
      renderModalSummaryList();
    }
    closeCopyPopover();
    showToast("Paylaşım kopyalandı.");
  } catch (err) {
    alert(err.message || "Paylaşım kopyalanamadı.");
  } finally {
    if (copyConfirmBtn) copyConfirmBtn.disabled = false;
  }
}

function toggleColorHelpPanel(forceOpen = null) {
  if (!colorHelpPanel) return;
  const shouldOpen =
    forceOpen !== null ? forceOpen : !colorHelpPanel.classList.contains("active");
  if (shouldOpen) {
    colorHelpPanel.classList.add("active");
    colorHelpPanelOpen = true;
  } else {
    colorHelpPanel.classList.remove("active");
    colorHelpPanelOpen = false;
  }
}

function entryMatchesChannelFilter(entry, filterId = "all") {
  if (!entry || !entry.platforms) return filterId === "all";
  const definition = CHANNEL_FILTER_DEFINITIONS[filterId];
  if (!definition) return true;
  return entry.platforms.some((platform) =>
    definition.matcher(String(platform || ""))
  );
}

function dayMatchesChannelFilter(items, filterId = "all") {
  if (filterId === "all") return true;
  return items.some((item) => entryMatchesChannelFilter(item, filterId));
}

function filterEntriesByChannel(items, filterId = "all") {
  if (filterId === "all") return items.slice();
  return items.filter((item) => entryMatchesChannelFilter(item, filterId));
}

function getChannelFilterLabel(filterId) {
  return CHANNEL_FILTER_DEFINITIONS[filterId]
    ? CHANNEL_FILTER_DEFINITIONS[filterId].label
    : CHANNEL_FILTER_DEFINITIONS.all.label;
}

function setActiveChannelFilter(nextFilter) {
  if (!CHANNEL_FILTER_DEFINITIONS[nextFilter]) {
    nextFilter = "all";
  }
  activeChannelFilter = nextFilter;
  try {
    localStorage.setItem(CHANNEL_FILTER_STORAGE_KEY, activeChannelFilter);
  } catch {}
  channelFilterButtons.forEach((btn) => {
    const target = btn.dataset.channel || "all";
    btn.classList.toggle("active", target === activeChannelFilter);
  });
  renderCalendar();
  updateScheduleList();
  if (viewReports.style.display !== "none") renderReports();
  updateReportFilterLabel();
}

function setScheduleViewMode(nextMode) {
  const allowedViews = ["daily", "weekly", "monthly"];
  const normalized = allowedViews.includes(nextMode) ? nextMode : "daily";
  if (scheduleViewMode === normalized) return;
  scheduleViewMode = normalized;
  if (scheduleViewMode === "daily") {
    scheduleDailyDateKey = summaryDateKey;
    activeScheduleSummaryKey = summaryDateKey;
  }
  scheduleViewButtons.forEach((btn) => {
    const target = btn.dataset.view || "daily";
    btn.classList.toggle("active", target === scheduleViewMode);
  });
  updateScheduleList();
}

function updateReportFilterLabel() {
  if (!reportFilterLabel) return;
  reportFilterLabel.textContent = `Kanal filtresi: ${getChannelFilterLabel(
    activeChannelFilter
  )}`;
}

async function ensureColorDescriptionsLoaded(force = false) {
  if (colorDescriptionsLoaded && !force) return;
  await loadColorDescriptions();
}

async function loadColorDescriptions() {
  try {
    const response = await apiFetch("/calendar/color-descriptions");
    const data = await response.json();
    const merged = cloneColorDescriptionDefaults();
    if (data && typeof data === "object") {
      Object.entries(data).forEach(([key, value]) => {
        if (!merged[key]) return;
        merged[key] = {
          label:
            value && typeof value.label === "string" && value.label.trim()
              ? value.label.trim()
              : merged[key].label,
          description:
            value && typeof value.description === "string"
              ? value.description
              : merged[key].description
        };
      });
    }
    colorDescriptions = merged;
    colorDescriptionsDraft = cloneColorDescriptionDefaults();
    colorDescriptionsLoaded = true;
  } catch (err) {
    console.warn("Renk açıklamaları yüklenemedi:", err.message);
    colorDescriptions = cloneColorDescriptionDefaults();
  }
  renderColorHelpList();
  refreshColorDescriptionSection();
}

async function loadResponsibleUsers() {
  if (!authToken) {
    responsibleUsers = [];
    responsibleUserMap.clear();
    populateOwnerSelectOptions();
    return;
  }
  try {
    const response = await apiFetch("/users/approved");
    const data = await response.json();
    responsibleUsers = Array.isArray(data) ? data : [];
    responsibleUserMap.clear();
    responsibleUsers.forEach((user) => {
      if (user && typeof user.id !== "undefined") {
        responsibleUserMap.set(Number(user.id), user.email || "");
      }
    });
    populateOwnerSelectOptions();
  } catch (err) {
    console.warn("Sorumlu kişi listesi yüklenemedi:", err.message);
  }
  if (
    selectedDateKey &&
    dayModal &&
    dayModal.style.display === "flex" &&
    currentDayItems.length
  ) {
    currentDayItems = loadDayData(selectedDateKey).items;
    renderModalSummaryList();
  }
}

function populateOwnerSelectOptions() {
  if (!ownerSelect) return;
  const previousValue = ownerSelect.value;
  ownerSelect.innerHTML = '<option value=\"\">Seçilmedi</option>';
  responsibleUsers.forEach((user) => {
    if (!user || typeof user.id === "undefined") return;
    const opt = document.createElement("option");
    opt.value = String(user.id);
    opt.textContent = user.email || `#${user.id}`;
    ownerSelect.appendChild(opt);
  });
  if (previousValue && responsibleUserMap.has(Number(previousValue))) {
    ownerSelect.value = previousValue;
  } else if (currentUser && responsibleUserMap.has(currentUser.id)) {
    ownerSelect.value = String(currentUser.id);
  } else {
    ownerSelect.value = "";
  }
}

function getOwnerLabel(ownerId) {
  if (!ownerId) return "";
  return responsibleUserMap.get(Number(ownerId)) || "";
}

function setHighlightInputValue(value) {
  const finalValue = value || DEFAULT_HIGHLIGHT_COLOR;
  if (highlightColorInput) {
    highlightColorInput.value = finalValue;
  }
  if (highlightColorPicker && highlightColorInput) {
    setColorPickerValue(highlightColorPicker, highlightColorInput, finalValue);
  }
  updateColorToggle(highlightColorToggle, finalValue);
}

function updateDayHighlightLocally(dateKey, colorValue) {
  if (!dateKey) return;
  if (colorValue) {
    const normalized = normalizeHexColor(colorValue);
    if (normalized) {
      highlightedDates.set(dateKey, normalized);
    } else {
      highlightedDates.delete(dateKey);
    }
  } else {
    highlightedDates.delete(dateKey);
  }
  if (selectedDateKey === dateKey) {
    updateHighlightStateUI();
  }
  renderCalendar();
  updateScheduleList();
}

function setActiveAdminPanelTab(panelId = "users") {
  let target = panelId || "users";
  const isColorPanel = target === "colors";
  const canEditColors = Boolean(currentUser && currentUser.role === "admin");
  if (isColorPanel && !canEditColors) {
    target = "users";
  }
  activeAdminPanelTab = target;
  adminTabButtons.forEach((btn) => {
    const btnPanel = btn.dataset.panel || "users";
    btn.classList.toggle("active", btnPanel === activeAdminPanelTab);
  });
  if (adminUsersSection) {
    const showUsers = activeAdminPanelTab === "users";
    adminUsersSection.classList.toggle("active", showUsers);
    adminUsersSection.style.display = showUsers ? "" : "none";
  }
  if (isColorPanel && canEditColors) {
    ensureColorDescriptionsLoaded();
  }
  refreshColorDescriptionSection();
}

function refreshColorDescriptionSection() {
  if (!colorDescriptionsSection) return;
  const canEdit = Boolean(currentUser && currentUser.role === "admin");
  if (colorTabBtn) {
    colorTabBtn.style.display = canEdit ? "" : "none";
  }
  if (!canEdit && activeAdminPanelTab === "colors") {
    setActiveAdminPanelTab("users");
    return;
  }
  const shouldShow = canEdit && activeAdminPanelTab === "colors";
  colorDescriptionsSection.classList.toggle("active", shouldShow);
  colorDescriptionsSection.style.display = shouldShow ? "" : "none";
  if (shouldShow) {
    if (colorDescriptionsLoaded) {
      renderColorDescriptionsForm();
    } else {
      ensureColorDescriptionsLoaded().then(() => {
        if (activeAdminPanelTab === "colors") {
          renderColorDescriptionsForm();
        }
      });
    }
  }
}

function renderColorDescriptionsForm() {
  if (!colorDescriptionsForm) return;
  colorDescriptionsForm.innerHTML = "";
  COLOR_TOKENS_IN_ORDER.forEach((token) => {
    if (!COLOR_HEX_BY_TOKEN[token]) return;
    const info = getColorDescriptionForKey(token);
    const row = document.createElement("div");
    row.className = "color-description-row";

    const dot = document.createElement("span");
    dot.className = "color-description-dot";
    dot.style.backgroundColor = COLOR_HEX_BY_TOKEN[token];
    row.appendChild(dot);

    const fields = document.createElement("div");
    fields.className = "color-description-fields";

    const labelInput = document.createElement("input");
    labelInput.type = "text";
    labelInput.value = info.label || "";
    labelInput.placeholder = "Etiket";
    labelInput.dataset.colorKey = token;
    labelInput.dataset.field = "label";
    fields.appendChild(labelInput);

    const descriptionInput = document.createElement("textarea");
    descriptionInput.value = info.description || "";
    descriptionInput.placeholder = "Açıklama";
    descriptionInput.dataset.colorKey = token;
    descriptionInput.dataset.field = "description";
    fields.appendChild(descriptionInput);

    row.appendChild(fields);
    colorDescriptionsForm.appendChild(row);
  });
}

async function saveColorDescriptions() {
  if (!colorDescriptionSaveBtn) return;
  const descriptionsPayload = {};
  if (colorDescriptionsForm) {
    const inputs = colorDescriptionsForm.querySelectorAll(
      "[data-color-key][data-field]"
    );
    inputs.forEach((input) => {
      const key = input.dataset.colorKey;
      const field = input.dataset.field;
      if (!descriptionsPayload[key]) {
        descriptionsPayload[key] = { label: "", description: "" };
      }
      descriptionsPayload[key][field] = input.value;
    });
  }

  colorDescriptionSaveBtn.disabled = true;
  if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "Kaydediliyor...";
  try {
    await apiFetch("/calendar/color-descriptions", {
      method: "PUT",
      body: JSON.stringify({ descriptions: descriptionsPayload })
    });
    await loadColorDescriptions(true);
    if (colorDescriptionSaveStatus) {
      colorDescriptionSaveStatus.textContent = "Kaydedildi.";
      setTimeout(() => {
        if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "";
      }, 3000);
    }
  } catch (err) {
    if (colorDescriptionSaveStatus) {
      colorDescriptionSaveStatus.textContent = err.message || "Kaydedilemedi.";
    }
  } finally {
    colorDescriptionSaveBtn.disabled = false;
  }
}

function formatDateTimeHuman(value) {
  if (!value) return "";
  const dt = new Date(value);
  if (Number.isNaN(dt.getTime())) return "";
  return dt.toLocaleString("tr-TR", {
    dateStyle: "medium",
    timeStyle: "short"
  });
}

function renderColorPicker(container, input, palette, onChange) {
  if (!container || !input || !Array.isArray(palette)) return;
  container.innerHTML = "";
  palette.forEach((color) => {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "color-swatch";
    button.setAttribute("aria-label", color);
    const span = document.createElement("span");
    span.style.backgroundColor = color;
    button.appendChild(span);
    button.dataset.color = color.toLowerCase();
    if (input.value && input.value.toLowerCase() === button.dataset.color) {
      button.classList.add("active");
    }
    button.addEventListener("click", () => {
      input.value = color;
      container
        .querySelectorAll(".color-swatch.active")
        .forEach((el) => el.classList.remove("active"));
      button.classList.add("active");
      if (onChange) onChange(color);
      closeColorPicker(container);
    });
    container.appendChild(button);
  });
  closeColorPicker(container);
}

function setColorPickerValue(container, input, value) {
  if (!container || !input) return;
  const normalizedValue = (value || "").toLowerCase();
  input.value = value;
  container
    .querySelectorAll(".color-swatch")
    .forEach((btn) => {
      btn.classList.remove("active");
      const swatchColor = btn.dataset.color;
      if (swatchColor && swatchColor === normalizedValue) {
        btn.classList.add("active");
      }
    });
}

function updateColorToggle(toggle, color) {
  if (!toggle) return;
  const swatch = toggle.querySelector(".toggle-swatch");
  if (swatch) {
    swatch.style.backgroundColor = color;
  }
}

function setColorPickerEnabled(wrapper, toggle, enabled) {
  if (!wrapper || !toggle) return;
  const picker = wrapper.querySelector(".color-picker");
  if (enabled) {
    wrapper.classList.remove("disabled");
    toggle.disabled = false;
    if (picker) picker.classList.remove("disabled");
  } else {
    wrapper.classList.add("disabled");
    toggle.disabled = true;
    if (picker) {
      picker.classList.add("disabled");
      closeColorPicker(picker);
    }
  }
}

function handleHighlightSelection(color) {
  if (!selectedDateKey || !isViewingOwnData()) return;
  const normalizedColor = normalizeHexColor(color);
  if (!normalizedColor) return;
  const current = highlightedDates.get(selectedDateKey);
  const normalizedCurrent = current ? normalizeHexColor(current) : null;
  const willRemove =
    normalizedCurrent && normalizedColor === normalizedCurrent;
  const nextColor = willRemove ? null : normalizedColor;
  const previousColor = current || null;

  updateDayHighlightLocally(selectedDateKey, nextColor);

  const action = nextColor
    ? () => setDateHighlight(selectedDateKey, nextColor)
    : () => removeDateHighlight(selectedDateKey);

  action()
    .then(() => {
      if (viewReports.style.display !== "none") renderReports();
    })
    .catch((err) => {
      alert(err.message || "Gün işaretlenemedi.");
      updateDayHighlightLocally(selectedDateKey, previousColor);
    });
}

function showSaveSuccessMessage() {
  if (!saveSuccessMessage) return;
  saveSuccessMessage.style.display = "block";
  if (saveSuccessTimeout) clearTimeout(saveSuccessTimeout);
  saveSuccessTimeout = setTimeout(() => {
    hideSaveSuccessMessage();
  }, 4000);
}

function hideSaveSuccessMessage() {
  if (!saveSuccessMessage) return;
  saveSuccessMessage.style.display = "none";
  if (saveSuccessTimeout) {
    clearTimeout(saveSuccessTimeout);
    saveSuccessTimeout = null;
  }
}
    const resetScopeLabels = {
      excel: "Excel girişlerini sıfırla",
      manual: "Manuel girişleri sıfırla",
      highlights: "Gün renklerini sıfırla",
      all: "Tüm kayıtları sıfırla"
    };
    const resetConfirmMessages = {
      excel: "Excel'den gelen kayıtların tamamı silinecek. Emin misin?",
      manual: "Manuel eklediğin kayıtların tamamı silinecek. Emin misin?",
      highlights: "Tüm gün renkleri kaldırılacak. Emin misin?",
      all: "Tüm içerikler ve gün renkleri silinecek. Emin misin?"
    };
    const resetSuccessMessages = {
      excel: "Excel girişleri başarıyla silindi.",
      manual: "Manuel girişler başarıyla silindi.",
      highlights: "Gün renkleri başarıyla temizlendi.",
      all: "Tüm kayıtlar ve gün renkleri başarıyla silindi."
    };

    let reportMode = "month"; // "month" | "range"
    let reportsContentView = "summary"; // "summary" | "executed"
    let platformChartInstance = null;
    let timeChartInstance = null;
const quickRangeButtonsList = quickRangeButtons
  ? Array.from(quickRangeButtons.querySelectorAll("button[data-range]"))
  : [];
if (entryColorInput) entryColorInput.value = DEFAULT_ENTRY_COLOR;
if (highlightColorInput) highlightColorInput.value = DEFAULT_HIGHLIGHT_COLOR;
const COLOR_PICKER_CONTAINERS = [];
const COLOR_PICKER_TOGGLE_MAP = new Map();

function closeColorPicker(container) {
  if (!container) return;
  container.classList.remove("open");
  const toggle = COLOR_PICKER_TOGGLE_MAP.get(container);
  if (toggle) toggle.setAttribute("aria-expanded", "false");
}

function openColorPicker(container, toggle) {
  if (!container) return;
  container.classList.add("open");
  if (toggle) toggle.setAttribute("aria-expanded", "true");
}

function closeAllColorPickers(except = null) {
  COLOR_PICKER_CONTAINERS.forEach((container) => {
    if (!container) return;
    if (except && container === except) return;
    closeColorPicker(container);
  });
}

function setupColorPicker(container, input, toggle, palette, onChange) {
  if (!container || !input) return;
  renderColorPicker(container, input, palette, (color) => {
    updateColorToggle(toggle, color);
    if (typeof onChange === "function") onChange(color);
  });
  setColorPickerValue(container, input, input.value);
  updateColorToggle(toggle, input.value);
  COLOR_PICKER_CONTAINERS.push(container);
  if (toggle) {
    COLOR_PICKER_TOGGLE_MAP.set(container, toggle);
    toggle.setAttribute("aria-expanded", "false");
  }
  container.addEventListener("click", (event) => event.stopPropagation());
  if (toggle) {
    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      if (toggle.disabled) return;
      const isOpen = container.classList.contains("open");
      if (isOpen) {
        closeColorPicker(container);
      } else {
        closeAllColorPickers();
        openColorPicker(container, toggle);
      }
    });
  }
}

if (entryColorPicker && entryColorInput) {
  setupColorPicker(
    entryColorPicker,
    entryColorInput,
    entryColorToggle,
    COLOR_PALETTE
  );
}

if (highlightColorPicker && highlightColorInput) {
  setupColorPicker(
    highlightColorPicker,
    highlightColorInput,
    highlightColorToggle,
    COLOR_PALETTE,
    (color) => handleHighlightSelection(color)
  );
  setColorPickerEnabled(
    highlightColorWrapper,
    highlightColorToggle,
    false
  );
}

document.addEventListener("click", () => {
  closeAllColorPickers();
});

if (scheduleSearchInput) {
  scheduleSearchInput.addEventListener("input", (event) => {
    scheduleSearchQuery = event.target.value.trim().toLowerCase();
    updateScheduleList();
  });
}

if (modalFormSection) {
  modalFormSection.addEventListener("input", () => hideSaveSuccessMessage());
  modalFormSection.addEventListener("change", () => hideSaveSuccessMessage());
}

    function setAuthToken(token) {
      authToken = token || "";
      if (authToken) {
        localStorage.setItem("contentCalendar_token", authToken);
      } else {
        localStorage.removeItem("contentCalendar_token");
      }
      updateAuthUI();
    }

    function setCurrentUser(user) {
      currentUser = user;
      if (currentUser && currentUser.id) {
        responsibleUserMap.set(
          Number(currentUser.id),
          currentUser.email || responsibleUserMap.get(Number(currentUser.id)) || ""
        );
      }
      updateAuthUI();
      if (!currentUser) {
        responsibleUsers = [];
        responsibleUserMap.clear();
        populateOwnerSelectOptions();
      }
    }

    function updateAuthUI() {
      const isLoggedIn = Boolean(authToken && currentUser);
      logoutBtn.style.display = isLoggedIn ? "inline-flex" : "none";
      if (currentUser && currentUser.role === "admin") {
        adminPanelBtn.style.display = "inline-flex";
      } else {
        adminPanelBtn.style.display = "none";
        adminViewInfo.style.display = "none";
        adminSelectedUserId = null;
      }
      if (excelUploadBtn) {
        const canUpload =
          Boolean(isLoggedIn && currentUser && currentUser.role === "admin" && isViewingOwnData());
        excelUploadBtn.style.display = canUpload ? "inline-flex" : "none";
        excelUploadBtn.disabled = !canUpload;
        if (resetEntriesBtn) {
          resetEntriesBtn.style.display = canUpload ? "inline-flex" : "none";
          resetEntriesBtn.disabled = !canUpload;
          resetEntriesBtn.textContent = "Sıfırla";
        }
        if (excelUploadContainer) {
          excelUploadContainer.style.display = canUpload ? "flex" : "none";
        }
        if (resetOptions) {
          resetOptions.style.display = "none";
          resetOptionButtons.forEach((btn) => {
            btn.disabled = false;
            const scope = btn.dataset.scope;
            if (scope && resetScopeLabels[scope]) {
              btn.textContent = resetScopeLabels[scope];
            }
          });
        }
      }
      updateEditingPermissions();
      refreshColorDescriptionSection();
      populateOwnerSelectOptions();
    }

    function setAuthMode(registerMode) {
      isRegisterMode = Boolean(registerMode);
      loginSubmitBtn.textContent = isRegisterMode ? "Kayıt ol" : "Giriş yap";
      switchAuthModeBtn.textContent = isRegisterMode
        ? "Zaten hesabım var"
        : "Kayıt olmak istiyorum";
      loginError.classList.remove("success");
    }

    function showLoginOverlay(registerMode = false) {
      loginOverlay.classList.add("active");
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
      document.body.classList.add("blurred");
      setAuthMode(registerMode);
    }

    function hideLoginOverlay() {
      loginOverlay.classList.remove("active");
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      document.body.classList.remove("blurred");
      setAuthMode(false);
    }

    async function apiFetch(path, options = {}) {
      const opts = { ...options };
      opts.headers = { ...(opts.headers || {}) };
      if (opts.body && !opts.headers["Content-Type"]) {
        opts.headers["Content-Type"] = "application/json";
      }
      if (authToken) {
        opts.headers.Authorization = "Bearer " + authToken;
      }
      const response = await fetch(API_BASE + path, opts);
      if (response.status === 401) {
        setCurrentUser(null);
        setAuthToken("");
        if (adminOverlay.classList.contains("active")) {
          closeAdminOverlay();
        }
        showLoginOverlay();
        throw new Error("Oturum süresi doldu. Lütfen tekrar giriş yap.");
      }
      if (!response.ok) {
        let message = "Beklenmeyen bir hata oluştu.";
        try {
          const data = await response.json();
          if (data && data.error) message = data.error;
        } catch {
          message = response.statusText || message;
        }
        throw new Error(message);
      }
      return response;
    }

    function normalizeEntry(entry) {
      let platformsRaw = entry.platforms;
      if (typeof platformsRaw === "string") {
        try {
          platformsRaw = JSON.parse(platformsRaw);
        } catch {
          platformsRaw = [];
        }
      }
      if (!Array.isArray(platformsRaw)) platformsRaw = [];

      const normalizedSource = (entry.source || "manual").toLowerCase() === "excel"
        ? "excel"
        : entry.source || "manual";
      const normalizedStatus =
        entry.status === "done" || entry.status === "missed"
          ? entry.status
          : "planned";

      return {
        id: entry.id,
        user_id: entry.user_id,
        date: entry.date,
        time: entry.time || "",
        text: entry.text || "",
        files: entry.files || "",
        communication: entry.communication || "",
        communication_type: entry.communication_type || entry.communicationType || "",
        status: normalizedStatus,
        note: entry.note || "",
        checkedAt: entry.checked_at || entry.checkedAt || null,
        owner_id: entry.owner_id || entry.ownerId || null,
        platforms: platformsRaw,
        source: normalizedSource,
        color: entry.color || ""
      };
    }

    function sortAndStore(dateKey, items) {
      const sorted = sortItemsByTime(items);
      entriesByDate.set(dateKey, sorted);
    }

    function upsertEntry(entry) {
      const normalized = normalizeEntry(entry);
      if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
        return;
      }
      entriesById.set(normalized.id, normalized);
      const list = entriesByDate.get(normalized.date) || [];
      const idx = list.findIndex((it) => it.id === normalized.id);
      if (idx === -1) {
        list.push(normalized);
      } else {
        list[idx] = normalized;
      }
      sortAndStore(normalized.date, list);
    }

    function rebuildEntriesCache(rows) {
      entriesById = new Map();
      entriesByDate = new Map();
      rows.forEach((row) => {
        const normalized = normalizeEntry(row);
        if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
          return;
        }
        entriesById.set(normalized.id, normalized);
        const list = entriesByDate.get(normalized.date) || [];
        list.push(normalized);
        entriesByDate.set(normalized.date, list);
      });
      entriesByDate.forEach((items, key) => {
        sortAndStore(key, items);
      });
    }

    function removeEntryFromCache(entryId) {
      const existing = entriesById.get(entryId);
      if (!existing) return;
      entriesById.delete(entryId);
      const arr = entriesByDate.get(existing.date) || [];
      const filtered = arr.filter((it) => it.id !== entryId);
      if (filtered.length) {
        entriesByDate.set(existing.date, filtered);
      } else {
        entriesByDate.delete(existing.date);
      }
    }

    function isViewingOwnData() {
      if (!currentUser || currentUser.role !== "admin") return true;
      return (
        adminSelectedUserId === null ||
        adminSelectedUserId === currentUser.id
      );
    }

    function updateEditingPermissions() {
      const canEdit = Boolean(authToken) && isViewingOwnData();
      toggleFormBtn.disabled = !canEdit;
      saveBtn.disabled = !canEdit;
      clearBtn.disabled = !canEdit;
      setColorPickerEnabled(entryColorWrapper, entryColorToggle, canEdit);
      if (ownerSelect) ownerSelect.disabled = !canEdit;
      if (!canEdit) {
        deleteBtn.disabled = true;
        modalFormSection.style.display = "none";
        activeItemId = null;
        clearFormOnly();
        modalForcePlanMode = false;
        setModalViewForEntry(null);
        modalFormSection.style.display = "none";
      } else {
        deleteBtn.disabled = !activeItemId;
      }
      setControlActionsEnabled(canEdit);
    }

    async function loadHighlightsFromServer(targetUserId = null) {
      const query = targetUserId ? `?userId=${targetUserId}` : "";
      try {
      const response = await apiFetch(`/calendar/highlights${query}`);
      const data = await response.json();
      highlightedDates = new Map(
        data
          .map((item) => {
            const normalized = normalizeHexColor(item.color);
            if (!normalized) return null;
            return [item.date, normalized];
          })
          .filter(Boolean)
      );
      } catch (err) {
        console.warn("Vurgular yüklenemedi:", err.message);
        highlightedDates = new Map();
      }
    }

    async function loadEntriesFromServer(targetUserId = null, label = "") {
      const query = targetUserId ? `?userId=${targetUserId}` : "";
      const response = await apiFetch(`/calendar${query}`);
      const data = await response.json();
      rebuildEntriesCache(data);
      await loadHighlightsFromServer(targetUserId);
      activeItemId = null;
      modalFormSection.style.display = "none";
      clearFormOnly();
      modalForcePlanMode = false;
      setModalViewForEntry(null);
      closeCopyPopover();
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
      if (selectedDateKey) {
        currentDayItems = loadDayData(selectedDateKey).items;
        renderModalSummaryList();
        updateHighlightStateUI();
      } else {
        updateHighlightStateUI();
      }
      if (currentUser && currentUser.role === "admin") {
        if (targetUserId && targetUserId !== currentUser.id) {
          adminViewInfo.style.display = "";
          adminViewInfo.textContent = label
            ? `Şu anda ${label} kullanıcısının takvimi görüntüleniyor.`
            : `Şu anda #${targetUserId} numaralı kullanıcının takvimi görüntüleniyor.`;
        } else {
          adminViewInfo.style.display = "none";
          adminSelectedUserId = null;
        }
      }
      updateAuthUI();
    }

    async function loadAdminUsers() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminUserList.innerHTML = "<p class=\"small\">Yükleniyor...</p>";
      try {
        const response = await apiFetch("/users");
        const data = await response.json();
        renderAdminUsers(data);
      } catch (err) {
        adminUserList.innerHTML = `<p class="small" style="color:#dc2626;">${err.message}</p>`;
        updatePendingCountBadge(0);
      }
    }

    function createBadge(text, type = "") {
      const span = document.createElement("span");
      span.className = "badge";
      if (type) span.classList.add(type);
      span.textContent = text;
      return span;
    }

    function renderAdminUsers(users) {
      if (!Array.isArray(users)) {
        updatePendingCountBadge(0);
        adminUserList.innerHTML = `<p class="small">Kayıt bulunamadı.</p>`;
        return;
      }
      const pendingCount = users.filter((user) => !user.approved).length;
      updatePendingCountBadge(pendingCount);
      adminUserList.innerHTML = "";
      if (!users.length) {
        const empty = document.createElement("p");
        empty.className = "small";
        empty.textContent = "Kayıt bulunamadı.";
        adminUserList.appendChild(empty);
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("div");
        row.className = "admin-user-row";
        const selected = adminSelectedUserId === null
          ? currentUser && user.id === currentUser.id
          : adminSelectedUserId === user.id;
        if (selected) row.classList.add("selected");

        const emailDiv = document.createElement("div");
        emailDiv.textContent = user.email;

        const roleDiv = document.createElement("div");
        const roleSelect = document.createElement("select");
        roleSelect.className = "role-select";
        ["user", "admin"].forEach((roleOption) => {
          const opt = document.createElement("option");
          opt.value = roleOption;
          opt.textContent =
            roleOption === "admin" ? "Admin" : "Kullanıcı";
          roleSelect.appendChild(opt);
        });
        roleSelect.value = user.role === "admin" ? "admin" : "user";
        roleSelect.disabled =
          !user.approved ||
          (currentUser && currentUser.id === user.id);
        roleSelect.addEventListener("change", async () => {
          const nextRole = roleSelect.value;
          roleSelect.disabled = true;
          try {
            await updateUserRole(user.id, nextRole);
            await loadAdminUsers();
          } catch (error) {
            alert(error.message);
          } finally {
            roleSelect.disabled =
              currentUser && currentUser.id === user.id;
          }
        });
        roleDiv.appendChild(roleSelect);

        const statusDiv = document.createElement("div");
        statusDiv.style.display = "flex";
        statusDiv.style.gap = "8px";
        const statusBadge = createBadge(
          user.approved ? "Onaylı" : "Onay bekliyor",
          user.approved ? "success" : "warning"
        );
        const countBadge = createBadge(`${user.entryCount} kayıt`, "info");
        statusDiv.appendChild(statusBadge);
        statusDiv.appendChild(countBadge);

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "admin-user-actions";

        if (user.approved) {
          const viewBtn = document.createElement("button");
          viewBtn.textContent = "Takvimi göster";
          viewBtn.addEventListener("click", async () => {
            const viewingOwn = currentUser && user.id === currentUser.id;
            adminSelectedUserId = viewingOwn ? null : user.id;
            try {
              await loadEntriesFromServer(
                adminSelectedUserId ? adminSelectedUserId : null,
                viewingOwn ? "" : user.email
              );
              closeAdminOverlay();
            } catch (error) {
              alert(error.message);
            }
          });
          actionsDiv.appendChild(viewBtn);
        } else {
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "Onayla";
          approveBtn.addEventListener("click", async () => {
            approveBtn.disabled = true;
            try {
              await approveUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              approveBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(approveBtn);

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "Reddet";
          rejectBtn.classList.add("secondary-btn");
          rejectBtn.addEventListener("click", async () => {
            const confirmed = confirm(
              `${user.email} hesabını reddetmek istediğine emin misin?`
            );
            if (!confirmed) return;
            rejectBtn.disabled = true;
            try {
              await rejectUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              rejectBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(rejectBtn);
        }

        row.appendChild(emailDiv);
        row.appendChild(roleDiv);
        row.appendChild(statusDiv);
        row.appendChild(actionsDiv);
        adminUserList.appendChild(row);
      });
    }

    async function approveUser(userId) {
      await apiFetch(`/users/${userId}/approve`, { method: "POST" });
      await loadAdminUsers();
    }

    async function rejectUser(userId) {
      await apiFetch(`/users/${userId}/reject`, { method: "POST" });
      if (adminSelectedUserId === userId) {
        adminSelectedUserId = null;
        adminViewInfo.style.display = "none";
        await loadEntriesFromServer();
      }
      await loadAdminUsers();
    }

    async function updateUserRole(userId, role) {
      await apiFetch(`/users/${userId}/role`, {
        method: "POST",
        body: JSON.stringify({ role })
      });
    }

    function openAdminOverlay() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminOverlay.classList.add("active");
      loadAdminUsers();
      ensureColorDescriptionsLoaded().then(() => {
        renderColorDescriptionsForm();
      });
    }

    function closeAdminOverlay() {
      adminOverlay.classList.remove("active");
      if (colorDescriptionSaveStatus) colorDescriptionSaveStatus.textContent = "";
    }

    async function createEntry(payload) {
      const response = await apiFetch("/calendar", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function updateEntry(id, payload) {
      const response = await apiFetch(`/calendar/${id}`, {
        method: "PUT",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function deleteEntry(id) {
      await apiFetch(`/calendar/${id}`, { method: "DELETE" });
      removeEntryFromCache(id);
    }

    /* Tema */
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "Açık mod";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "Koyu mod";
      }
    }
    function initTheme() {
      const stored = localStorage.getItem("contentCalendar_theme");
      applyTheme(stored === "dark" ? "dark" : "light");
    }
    themeToggleBtn.addEventListener("click", () => {
      const next = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(next);
      localStorage.setItem("contentCalendar_theme", next);
      if (viewReports.style.display !== "none") renderReports();
    });

    /* Yardımcılar */
    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function parseDateKeyString(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (
        Number.isNaN(year) ||
        Number.isNaN(month) ||
        Number.isNaN(day)
      ) {
        return null;
      }
      const dt = new Date(year, month - 1, day);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }
    function formatHumanDate(date) {
      const day = String(date.getDate());
      const monthName = monthNames[date.getMonth()];
      const year = date.getFullYear();
      return day + " " + monthName + " " + year;
    }
    function setSelectedDateState(dateKey, dateObj = null) {
      if (!dateKey) return null;
      const parsed = dateObj || parseDateKeyString(dateKey);
      if (!parsed) return null;
      selectedDateKey = dateKey;
      return parsed;
    }

    function setSummaryDateKey(dateKey) {
      if (!dateKey) return;
      summaryDateKey = dateKey;
      scheduleDailyDateKey = dateKey;
      activeScheduleSummaryKey = dateKey;
      updateScheduleList();
      renderCalendar();
    }

    let summaryHeightRaf = null;
    let calendarHeightObserver = null;
    function applyCalendarShellHeight(nextHeight) {
      const numericHeight = Number(nextHeight);
      if (!numericHeight || Number.isNaN(numericHeight) || numericHeight <= 0) {
        return;
      }
      document.documentElement.style.setProperty(
        "--calendar-shell-height",
        `${Math.round(numericHeight)}px`
      );
    }
    function syncSummaryPanelHeight() {
      const calendarShellEl = document.querySelector(".calendar-shell");
      if (!calendarShellEl) return;
      const height = calendarShellEl.getBoundingClientRect().height;
      applyCalendarShellHeight(height);
    }
    function requestSummaryHeightSync() {
      if (summaryHeightRaf) cancelAnimationFrame(summaryHeightRaf);
      summaryHeightRaf = requestAnimationFrame(() => {
        summaryHeightRaf = null;
        syncSummaryPanelHeight();
      });
    }
    function initCalendarHeightObserver() {
      if (!("ResizeObserver" in window)) {
        return;
      }
      const calendarShellEl = document.querySelector(".calendar-shell");
      if (!calendarShellEl) return;
      if (calendarHeightObserver) {
        calendarHeightObserver.disconnect();
      }
      calendarHeightObserver = new ResizeObserver((entries) => {
        entries.forEach((entry) => {
          const borderSize =
            entry.borderBoxSize && entry.borderBoxSize.length
              ? entry.borderBoxSize[0].blockSize
              : null;
          const contentSize =
            entry.contentBoxSize && entry.contentBoxSize.length
              ? entry.contentBoxSize[0].blockSize
              : null;
          const fallbackSize =
            entry.contentRect && entry.contentRect.height
              ? entry.contentRect.height
              : null;
          const resolved =
            borderSize || contentSize || fallbackSize || calendarShellEl.offsetHeight;
          applyCalendarShellHeight(resolved);
        });
      });
      calendarHeightObserver.observe(calendarShellEl);
    }
    window.addEventListener("resize", requestSummaryHeightSync);
    requestSummaryHeightSync();
    initCalendarHeightObserver();
    function minutesFromTime(t) {
      if (!t) return 24 * 60 + 1; // saat yoksa en sona
      const parts = t.split(":");
      if (parts.length !== 2) return 24 * 60 + 1;
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (Number.isNaN(h) || Number.isNaN(m)) return 24 * 60 + 1;
      return h * 60 + m;
    }
    function sortItemsByTime(items) {
      return items.slice().sort((a, b) => minutesFromTime(a.time) - minutesFromTime(b.time));
    }
    function isDarkMode() {
      return document.body.classList.contains("dark");
    }

    /* Veri okuma / yazma */
function loadDayData(dateKey) {
      const items = entriesByDate.get(dateKey) || [];
    const clones = items.map((item) => ({
      id: item.id,
      date: item.date || dateKey,
      files: item.files || "",
      text: item.text || "",
      time: item.time || "",
      platforms: Array.isArray(item.platforms) ? [...item.platforms] : [],
      communication: item.communication || "",
      communicationType: item.communication_type || item.communicationType || "",
      status: item.status || "planned",
      note: item.note || "",
      checkedAt: item.checkedAt || item.checked_at || null,
      owner_id: item.owner_id || item.ownerId || null,
      source: item.source || "manual",
      color: item.color || ""
    }));
      return { items: sortItemsByTime(clones) };
    }

const SUMMARY_TITLE_LIMIT = 48;
    // Bir içerik için 10 karakterlik metin + platformlar + saat
    function makeItemSummary(item) {
      const textSource = item.text || item.files || "";
      let snippet = textSource ? textSource.slice(0, SUMMARY_TITLE_LIMIT) : "";
      if (textSource.length > SUMMARY_TITLE_LIMIT) snippet = snippet.trim() + "...";
      if (!snippet) snippet = "İçerik";
      const platforms =
        item.platforms && item.platforms.length
          ? item.platforms.join(", ")
          : "Platform seçilmedi";
      const time = item.time || "";
      return { snippet, platforms, time };
    }

    /* Sağ panel: Gün Detayı / Takvim Özeti */
function summarizePlatformLabel(platform) {
  const key = (platform || "").toLowerCase();
  if (!key) return "Platform seçilmedi";
  if (key.includes("instagram")) return "Instagram";
  if (key.includes("facebook")) return "Facebook";
  if (key.includes("telegram")) return "Telegram";
  if (key.includes("linkedin")) return "LinkedIn";
  if (key.includes("youtube")) return "YouTube";
  if (key.includes("tiktok")) return "TikTok";
  if (key.includes("reddit")) return "Reddit";
  if (key.includes("discord")) return "Discord";
  if (key === "website") return "Website";
  if (key === "medium") return "Medium";
  if (key.includes("landing")) return "Website";
  if (key.includes("web")) return "Website";
  if (key.includes("blog")) return "Blog";
  if (key.includes("twitter") || key === "x") return "X";
  return platform || "Platform seçilmedi";
}

    function buildDaySummary(items, options = {}) {
      const filterId = options.filterId || "all";
      const scopedItems = filterEntriesByChannel(items, filterId);
      const counts = {};
      scopedItems.forEach((item) => {
        const entryColor = item.color || DEFAULT_ENTRY_COLOR;
        let list = filterPlatformsByChannel(item.platforms || [], filterId);
        if (!list.length) {
          list =
            filterId !== "all"
              ? [getChannelFilterLabel(filterId)]
              : ["Platform seçilmedi"];
        }
        list.forEach((platform) => {
          const label = summarizePlatformLabel(platform);
          if (!counts[label]) {
            counts[label] = { count: 0, color: entryColor };
          }
          counts[label].count += 1;
          counts[label].color = entryColor;
        });
      });
      const entries = Object.entries(counts)
        .map(([label, info]) => [label, info.count, info.color])
        .sort((a, b) => b[1] - a[1]);
      return { total: scopedItems.length, entries };
    }

    function updateScheduleList() {
      if (!scheduleList) return;
      scheduleList.innerHTML = "";
      const normalizedQuery = getNormalizedSearchQuery();
      if (normalizedQuery) {
        renderSearchResults(normalizedQuery);
        return;
      }
      if (scheduleViewMode === "daily") {
        renderDailySchedule();
      } else if (scheduleViewMode === "monthly") {
        renderMonthlySchedule();
      } else {
        renderWeeklySchedule();
      }
    }

    function renderSearchResults(query) {
      const matches = [];
      entriesByDate.forEach((items, key) => {
        const dayData = loadDayData(key);
        const dayItems = dayData.items || [];
        if (!dayItems.length) return;
        const scopedItems = dayItems.filter((item) =>
          entryMatchesChannelFilter(item, activeChannelFilter)
        );
        if (!scopedItems.length) return;
        const hasMatch = scopedItems.some((item) =>
          entryMatchesSearchQuery(item, query)
        );
        if (!hasMatch) return;
        matches.push({ key, items: scopedItems });
      });
      if (!matches.length) {
        renderEmptySchedule("Aramanızla eşleşen gün bulunamadı.");
        return;
      }
      matches
        .sort((a, b) => a.key.localeCompare(b.key))
        .forEach(({ key, items }) => {
          const dateObj = parseDateKeyString(key);
          const summary = buildDaySummary(items, {
            filterId: activeChannelFilter
          });
          scheduleList.appendChild(
            createScheduleSummaryRow(
              dateObj,
              key,
              summary,
              formatHumanDate(dateObj)
            )
          );
        });
    }

    function focusDayFromSchedule(dateKey, entryId = null) {
      if (!dateKey) return;
      const dateObj = parseDateKeyString(dateKey);
      if (!dateObj) return;
      setSelectedDateState(dateKey, dateObj);
      currentYear = dateObj.getFullYear();
      currentMonth = dateObj.getMonth();
      renderCalendar();
      openModalForDate(dateObj, dateKey, entryId);
    }

    function isDateBeforeToday(dateObj) {
      if (!dateObj) return false;
      const candidate = normalizeToMidnight(dateObj);
      return candidate.getTime() < todayReferenceDate.getTime();
    }

    function isKeyBeforeToday(key) {
      if (!key) return false;
      const dateObj = parseDateKeyString(key);
      return isDateBeforeToday(dateObj);
    }

function getNormalizedSearchQuery(override = null) {
  if (typeof override === "string") {
    return override.trim().toLowerCase();
  }
  return (scheduleSearchQuery || "").trim().toLowerCase();
}

function entryMatchesSearchQuery(entry, queryOverride = null) {
  const query = getNormalizedSearchQuery(queryOverride);
  if (!query) return true;
  const ownerLabel = entry.owner_id ? getOwnerLabel(entry.owner_id) : "";
  const haystack = (
    (entry.text || "") +
    " " +
    (entry.files || "") +
    " " +
    (entry.note || "") +
    " " +
    (entry.time || "") +
    " " +
    formatPlatformsLabel(entry.platforms || []) +
    " " +
    ownerLabel
  )
    .toLowerCase();
  return haystack.includes(query);
}

    function getDailyFocusDateKey() {
      if (summaryDateKey) {
        return summaryDateKey;
      }
      if (scheduleDailyDateKey) {
        return scheduleDailyDateKey;
      }
      if (todayDateKey) {
        return todayDateKey;
      }
      const futureKeys = Array.from(entriesByDate.keys()).sort();
      return futureKeys.length ? futureKeys[0] : null;
    }

    function getDailyRowStatus(entry) {
      if (!entry) {
        return { key: "pending", symbol: "•" };
      }
      if (entry.status === "done") {
        return { key: "done", symbol: "✓" };
      }
      const pastEntry = isEntryPast(entry);
      if (entry.status === "missed" || (pastEntry && entry.status !== "done")) {
        return { key: "missed", symbol: "!" };
      }
      if (entry.time) {
        return { key: "scheduled", symbol: "⏰" };
      }
      return { key: "pending", symbol: "•" };
    }

    function renderDailySchedule() {
      const focusKey = getDailyFocusDateKey();
      if (!focusKey) {
        renderEmptySchedule("Yaklaşan içerik bulunamadı.");
        return;
      }
      scheduleDailyDateKey = focusKey;
      const dateObj = parseDateKeyString(focusKey);
      const dayData = loadDayData(focusKey);
      const items = (dayData.items || []).filter((item) =>
        entryMatchesChannelFilter(item, activeChannelFilter)
      );
      const filtered = sortItemsByTime(
        items.filter((item) => entryMatchesSearchQuery(item))
      );

      const heading = document.createElement("p");
      heading.className = "daily-entry-heading";
      heading.textContent = `${formatHumanDate(dateObj)} · ${
        filtered.length ? `${filtered.length} paylaşım` : "İçerik bulunamadı"
      }`;
      scheduleList.appendChild(heading);

      if (!filtered.length) {
        renderEmptySchedule(
          scheduleSearchQuery
            ? "Aramanızla eşleşen paylaşım yok."
            : "Bu gün için yaklaşan içerik yok."
        );
        return;
      }

      const list = document.createElement("div");
      list.className = "daily-entry-list";
      filtered.forEach((entry) => {
        const statusState = getDailyRowStatus(entry);
        const row = document.createElement("div");
        row.className = "daily-entry-row";
        row.tabIndex = 0;
        row.dataset.entryId = String(entry.id);
        const cardColor = normalizeHexColor(entry.color);
        if (cardColor) {
          row.style.setProperty("--daily-card-color", cardColor);
        } else {
          row.style.removeProperty("--daily-card-color");
        }
        if (entry.id === activeItemId) {
          row.classList.add("active");
        }

        const statusIcon = document.createElement("span");
        statusIcon.className = `daily-entry-status status-${statusState.key}`;
        statusIcon.textContent = statusState.symbol;
        statusIcon.title = formatStatusLabel(entry.status);
        row.appendChild(statusIcon);

        const body = document.createElement("div");
        body.className = "daily-entry-body";

        const title = document.createElement("p");
        title.className = "daily-entry-title";
        title.textContent = formatEntryPreviewText(entry, 90);
        body.appendChild(title);

        const timeLine = document.createElement("p");
        const hasTime = Boolean(entry.time);
        timeLine.className = hasTime
          ? "daily-entry-meta daily-entry-time"
          : "daily-entry-meta";
        if (hasTime) {
          const clockIcon = document.createElement("span");
          clockIcon.className = "daily-entry-time-icon";
          clockIcon.textContent = "⏰";
          clockIcon.setAttribute("aria-hidden", "true");
          timeLine.appendChild(clockIcon);
          timeLine.appendChild(document.createTextNode(entry.time));
        } else {
          timeLine.textContent = "Saat seçilmedi";
        }
        body.appendChild(timeLine);

        const metaLine = document.createElement("p");
        metaLine.className = "daily-entry-meta";
        const ownerLabel = getOwnerLabel(entry.owner_id);
        const parts = [
          formatPlatformsLabel(entry.platforms || [], {
            filterId: activeChannelFilter
          }),
          ownerLabel ? `Sorumlu: ${ownerLabel}` : ""
        ].filter(Boolean);
        metaLine.textContent = parts.join(" · ");
        body.appendChild(metaLine);
        if (entry.source && entry.source.toLowerCase() === "excel") {
          const badgeWrap = document.createElement("div");
          badgeWrap.className = "daily-entry-badges";
          const badge = document.createElement("span");
          badge.className = "summary-item-badge";
          badge.textContent = "Excel";
          badgeWrap.appendChild(badge);
          body.appendChild(badgeWrap);
        }

        row.appendChild(body);
        const openEntry = () => {
          if (entry.date) {
            const parsed = parseDateKeyString(entry.date);
            if (parsed) {
              openModalForDate(parsed, entry.date, entry.id);
              return;
            }
          }
          selectEntryById(entry.id);
        };
        row.addEventListener("click", openEntry);
        row.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            openEntry();
          }
        });
        list.appendChild(row);
      });
      scheduleList.appendChild(list);
    }

    function getWeeklyRangeStartDate() {
      const summary =
        summaryDateKey && parseDateKeyString(summaryDateKey);
      if (summary) {
        return normalizeToMidnight(summary);
      }
      if (scheduleDailyDateKey) {
        const fallback = parseDateKeyString(scheduleDailyDateKey);
        if (fallback) {
          return normalizeToMidnight(fallback);
        }
      }
      return todayReferenceDate;
    }

    function getSelectedMonthStartDate() {
      const summary =
        summaryDateKey && parseDateKeyString(summaryDateKey);
      const base = summary || new Date(currentYear, currentMonth, 1);
      return normalizeToMidnight(new Date(base.getFullYear(), base.getMonth(), 1));
    }

    function getSelectedMonthEndDate() {
      const monthStart = getSelectedMonthStartDate();
      return normalizeToMidnight(
        new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0)
      );
    }

    function addDays(date, amount) {
      const cloned = new Date(date);
      cloned.setDate(cloned.getDate() + amount);
      cloned.setHours(0, 0, 0, 0);
      return cloned;
    }

    function renderMonthlySchedule() {
      const monthStart = getSelectedMonthStartDate();
      const monthEnd = getSelectedMonthEndDate();
      if (monthStart.getTime() > monthEnd.getTime()) {
        renderEmptySchedule("Bu ay için içerik bulunamadı.");
        return;
      }
      renderRangeSchedule(monthStart, monthEnd, "Bu ay için içerik bulunamadı.");
    }

    function renderRangeSchedule(rangeStart, rangeEnd, emptyMessage) {
      if (!rangeStart || !rangeEnd || rangeStart.getTime() > rangeEnd.getTime()) {
        renderEmptySchedule(emptyMessage);
        return;
      }
      let any = false;
      const query = scheduleSearchQuery;
      const cursor = new Date(rangeStart);
      cursor.setHours(0, 0, 0, 0);

      while (cursor.getTime() <= rangeEnd.getTime()) {
        const key = formatDateKey(cursor);
        const dayData = loadDayData(key);
        const items = (dayData.items || []).filter((item) =>
          entryMatchesChannelFilter(item, activeChannelFilter)
        );
        if (items.length) {
          const summary = buildDaySummary(items, { filterId: activeChannelFilter });
          if (summary.total) {
            const humanDate = formatHumanDate(cursor);
            const haystack = (
              humanDate +
              " " +
              summary.entries.map(([label]) => label).join(" ")
            ).toLowerCase();
            if (!query || haystack.includes(query)) {
              any = true;
              const snapshot = new Date(
                cursor.getFullYear(),
                cursor.getMonth(),
                cursor.getDate()
              );
              scheduleList.appendChild(
                createScheduleSummaryRow(snapshot, key, summary, humanDate)
              );
            }
          }
        }
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }

      if (!any) {
        renderEmptySchedule(emptyMessage);
      }
    }

    function createScheduleSummaryRow(dateObj, key, summary, humanDate) {
      const row = document.createElement("div");
      row.className = "schedule-item summary";
      row.dataset.dateKey = key;
      row.tabIndex = 0;
      const highlightColor = highlightedDates.get(key);
      if (highlightColor) {
        row.classList.add("has-highlight");
        const normalizedHighlight =
          normalizeHexColor(highlightColor) || highlightColor;
        const token = getColorTokenFromHex(normalizedHighlight);
        const isPureWhite =
          token === "white" || normalizedHighlight === "#ffffff";
        const surfaceTint = isPureWhite
          ? "#ffffff"
          : hexToRgba(normalizedHighlight, 0.12);
        const summaryShadow = isPureWhite
          ? "rgba(15, 23, 42, 0.08)"
          : hexToRgba(normalizedHighlight, 0.2);
        row.style.setProperty("--summary-border", normalizedHighlight);
        row.style.setProperty("--summary-surface", surfaceTint);
        row.style.setProperty("--summary-shadow", summaryShadow);
        if (token) {
          row.dataset.color = token;
          row.style.removeProperty("--summary-text");
          row.style.removeProperty("--summary-chip-bg");
          row.style.removeProperty("--summary-chip-color");
          row.style.removeProperty("--summary-chip-border");
        } else {
          delete row.dataset.color;
          const textColor = getContrastingTextColor(normalizedHighlight);
          row.style.setProperty("--summary-text", textColor);
          if (textColor === "#f9fafb") {
            row.style.setProperty("--summary-chip-bg", "rgba(255, 255, 255, 0.28)");
            row.style.setProperty("--summary-chip-color", "#ffffff");
            row.style.setProperty("--summary-chip-border", "rgba(255, 255, 255, 0.45)");
          } else {
            row.style.setProperty("--summary-chip-bg", "rgba(15, 23, 42, 0.08)");
            row.style.setProperty("--summary-chip-color", "#0f172a");
            row.style.setProperty("--summary-chip-border", "rgba(15, 23, 42, 0.2)");
          }
        }
      } else {
        row.classList.remove("has-highlight");
        row.style.setProperty("--summary-border", "transparent");
        delete row.dataset.color;
        row.style.removeProperty("--summary-surface");
        row.style.removeProperty("--summary-shadow");
        row.style.removeProperty("--summary-text");
        row.style.removeProperty("--summary-chip-bg");
        row.style.removeProperty("--summary-chip-color");
        row.style.removeProperty("--summary-chip-border");
      }
      if (activeScheduleSummaryKey === key) {
        row.classList.add("active");
      }

      const header = document.createElement("div");
      header.className = "schedule-summary-header";
      const headerSuffix =
        activeChannelFilter === "all"
          ? `${summary.total} paylaşım`
          : `${getChannelFilterLabel(activeChannelFilter)} ${summary.total} paylaşım`;
      header.textContent = `${humanDate} · ${headerSuffix}`;
      row.appendChild(header);

      const chips = document.createElement("div");
      chips.className = "schedule-summary-chips";
      summary.entries.forEach(([label, count]) => {
        const chip = document.createElement("span");
        chip.className = "summary-chip";
        chip.textContent = `${count} ${label}`;
        chips.appendChild(chip);
      });
      row.appendChild(chips);

      const activateSummaryRow = () => {
        focusDayFromSchedule(key);
      };
      row.addEventListener("click", activateSummaryRow);
      row.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          activateSummaryRow();
        }
      });

      return row;
    }

    function renderEmptySchedule(message) {
      const empty = document.createElement("p");
      empty.className = "small";
      empty.textContent = scheduleSearchQuery
        ? "Aramanızla eşleşen gün bulunamadı."
        : message;
      scheduleList.appendChild(empty);
    }

    function renderWeeklySchedule() {
      const start = getWeeklyRangeStartDate();
      const monthEnd = getSelectedMonthEndDate();
      if (start.getTime() > monthEnd.getTime()) {
        renderEmptySchedule("Yaklaşan içerik bulunamadı.");
        return;
      }
      let end = addDays(start, 6);
      if (end.getTime() > monthEnd.getTime()) {
        end = monthEnd;
      }
      renderRangeSchedule(start, end, "Bu hafta için içerik bulunamadı.");
    }

    /* Takvim */
    function renderCalendar() {
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const firstWeekday = (firstDay.getDay() + 6) % 7;
      const daysInMonth = lastDay.getDate();

      monthLabel.textContent = monthNames[currentMonth] + " " + currentYear;

      daysContainer.innerHTML = "";

      for (let i = 0; i < firstWeekday; i++) {
        const empty = document.createElement("div");
        daysContainer.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.className = "day";

        const numSpan = document.createElement("div");
        numSpan.className = "day-number";
        numSpan.textContent = day;
        cell.appendChild(numSpan);

      const body = document.createElement("div");
      body.className = "day-body";
      cell.appendChild(body);

      const dateObj = new Date(currentYear, currentMonth, day);
      const key = formatDateKey(dateObj);
      const dayData = loadDayData(key);
      const items = dayData.items || [];
        const highlightColor = highlightedDates.get(key);
        if (highlightColor) {
          const normalizedHighlight =
            normalizeHexColor(highlightColor) || highlightColor;
          cell.classList.add("day-highlighted");
          cell.style.setProperty("--day-surface", normalizedHighlight);
          cell.style.setProperty("--day-border", normalizedHighlight);
          cell.style.setProperty(
            "--day-highlight-shadow",
            hexToRgba(normalizedHighlight, 0.28)
          );
          const colorToken = getColorTokenFromHex(normalizedHighlight);
          if (colorToken) {
            cell.dataset.color = colorToken;
            cell.style.removeProperty("--day-text");
          } else {
            delete cell.dataset.color;
            const textColor = getContrastingTextColor(normalizedHighlight);
            cell.style.setProperty("--day-text", textColor);
          }
        } else {
          cell.classList.remove("day-highlighted");
          delete cell.dataset.color;
          cell.style.removeProperty("--day-surface");
          cell.style.removeProperty("--day-border");
          cell.style.removeProperty("--day-highlight-shadow");
          cell.style.removeProperty("--day-text");
        }

        const matchesFilter = dayMatchesChannelFilter(items, activeChannelFilter);
        if (!matchesFilter && activeChannelFilter !== "all") {
          cell.classList.add("filtered-out");
        } else {
          cell.classList.remove("filtered-out");
        }

        if (items.length) {
          cell.classList.add("has-data");
          const summary = buildDaySummary(items, { filterId: activeChannelFilter });
          if (summary.total > 0) {
            const counter = document.createElement("div");
            counter.className = "day-counter";
            const entriesToShow = summary.entries.slice(0, 3);
            const visibleTotal = entriesToShow.reduce(
              (sum, [, count]) => sum + count,
              0
            );
            if (activeChannelFilter === "all") {
              counter.textContent =
                visibleTotal === 1
                  ? "1 içerik"
                  : `${visibleTotal} içerik`;
            } else {
              counter.textContent = `${getChannelFilterLabel(
                activeChannelFilter
              )} ${visibleTotal} içerik`;
            }
            body.appendChild(counter);
            entriesToShow.forEach(([label, count]) => {
              const chip = document.createElement("div");
              chip.className = "day-summary-chip";
              chip.textContent = `${count} ${label}`;
              body.appendChild(chip);
            });
          }
        }

        cell.addEventListener("click", () => {
          openModalForDate(dateObj, key);
        });

       daysContainer.appendChild(cell);
      }

      updateScheduleList();
      requestSummaryHeightSync();
    }

    /* Modal içi liste */
    function renderModalSummaryList() {
      modalSummary.innerHTML = "";

      if (!currentDayItems.length) {
        deleteBtn.disabled = true;
        const empty = document.createElement("div");
        empty.className = "summary-empty";
        empty.textContent = "Bu gün için kayıtlı içerik yok.";
        modalSummary.appendChild(empty);
        return;
      }

      currentDayItems = sortItemsByTime(currentDayItems);
      deleteBtn.disabled = !activeItemId || !isViewingOwnData();

      currentDayItems.forEach((item, index) => {
        const wrap = document.createElement("div");
        wrap.className = "summary-item";
        wrap.setAttribute("role", "button");
        wrap.setAttribute("tabindex", "0");
        if (item.id === activeItemId) wrap.classList.add("active");
        const cardColor = normalizeHexColor(item.color);
        if (cardColor) {
          wrap.style.setProperty("--summary-card-color", cardColor);
        } else {
          wrap.style.removeProperty("--summary-card-color");
        }
        wrap.dataset.entryId = String(item.id);
        if (item.source === "excel") wrap.classList.add("excel");
        const statusKey =
          item.status === "done" || item.status === "missed"
            ? item.status
            : "planned";
        wrap.dataset.status = statusKey;
        const { snippet, platforms, time } = makeItemSummary(item);
        const header = document.createElement("div");
        header.className = "summary-item-head";

        const headerLeft = document.createElement("div");
        headerLeft.className = "summary-item-header-left";

        const colorDot = document.createElement("span");
        colorDot.className = "summary-color-dot";
        headerLeft.appendChild(colorDot);

        const title = document.createElement("div");
        title.className = "summary-item-title";
        title.textContent = snippet || `İçerik ${index + 1}`;
        headerLeft.appendChild(title);
        header.appendChild(headerLeft);

        const statusWrap = document.createElement("div");
        statusWrap.className = "summary-item-header-right";
        const statusBadge = document.createElement("span");
        statusBadge.className = `summary-item-status status-${statusKey}`;
        statusBadge.textContent = formatStatusLabel(item.status);
        statusWrap.appendChild(statusBadge);
        if (item.source === "excel") {
          const excelBadge = document.createElement("span");
          excelBadge.className = "summary-item-badge excel";
          excelBadge.textContent = "Excel";
          statusWrap.appendChild(excelBadge);
        }
        const timeChip = document.createElement("span");
        timeChip.className = "summary-item-time-chip";
        const timeValue = document.createElement("span");
        timeValue.className = "time-value";
        timeValue.textContent = time ? time : "Saat seçilmedi";
        const timeIcon = document.createElement("span");
        timeIcon.className = "icon-clock";
        timeIcon.textContent = "⏰";
        timeChip.appendChild(timeValue);
        timeChip.appendChild(timeIcon);
        statusWrap.appendChild(timeChip);
        header.appendChild(statusWrap);

        wrap.appendChild(header);

        const platformsDiv = document.createElement("div");
        platformsDiv.className = "summary-item-platforms";
        platformsDiv.textContent = platforms;
        wrap.appendChild(platformsDiv);

        const ownerLabel = getOwnerLabel(item.owner_id);
        const ownerDiv = document.createElement("div");
        ownerDiv.className = "summary-item-owner";
        ownerDiv.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
        wrap.appendChild(ownerDiv);

        const footer = document.createElement("div");
        footer.className = "summary-item-footer";
        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "summary-item-copy-icon";
        copyBtn.setAttribute("aria-label", "Paylaşımı kopyala");
        copyBtn.textContent = "⧉";
        copyBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          openCopyPopover(item);
        });
        footer.appendChild(copyBtn);
        wrap.appendChild(footer);

        wrap.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            selectEntryById(item.id);
          }
        });

        modalSummary.appendChild(wrap);
      });
      updateEditingPermissions();
    }

    function selectEntryById(entryId, forcePlan = false) {
      let entry = entriesById.get(entryId);
      if (!entry && Array.isArray(currentDayItems)) {
        entry = currentDayItems.find((it) => it.id === entryId) || null;
        if (entry) {
          entriesById.set(entry.id, entry);
        }
      }
      if (!entry) return;
      activeItemId = entryId;
      modalForcePlanMode = Boolean(forcePlan);
      populateFormWithEntry(entry);
      deleteBtn.disabled = !activeItemId || !isViewingOwnData();
      renderModalSummaryList();
      setModalViewForEntry(entry);
      setControlActionsEnabled(Boolean(authToken) && isViewingOwnData());
    }

    function populateFormWithEntry(entry) {
      hideSaveSuccessMessage();
      filesInput.value = entry.files || "";
      textInput.value = entry.text || "";
      timeInput.value = entry.time || "";
      platformInputs.forEach((cb) => {
        cb.checked = entry.platforms
          ? entry.platforms.includes(cb.value)
          : false;
      });
  if (entryColorInput) {
    const entryColor = entry.color || DEFAULT_ENTRY_COLOR;
    entryColorInput.value = entryColor;
    updateColorToggle(entryColorToggle, entryColor);
    if (entryColorPicker) {
      setColorPickerValue(entryColorPicker, entryColorInput, entryColor);
    }
  }
  if (noteInput) {
    noteInput.value = entry.note || "";
  }
  if (controlNoteInput) {
    controlNoteInput.value = entry.note || "";
  }
}
    function updatePendingCountBadge(count) {
      if (!pendingCountBadge) return;
      pendingCountBadge.textContent = `(${count} bekleyen kayıt)`;
      pendingCountBadge.classList.toggle("has-pending", count > 0);
    }

    function setPlanReturnBannerVisible(visible) {
      if (!planReturnBanner) return;
      planReturnBanner.style.display = visible ? "flex" : "none";
      setControlActionsEnabled(Boolean(authToken) && isViewingOwnData());
    }

    function showPlanningView(entry, options = {}) {
      if (modalFormSection) modalFormSection.style.display = "flex";
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      setPlanReturnBannerVisible(Boolean(options.showReturnBanner));
    }

    function fillControlSummary(entry) {
      if (!entry) return;
      const dateObj = parseDateKeyString(entry.date);
      const dateLabel = dateObj ? formatHumanDate(dateObj) : entry.date;
      if (controlSummaryTitle) {
        controlSummaryTitle.textContent =
          entry.text || entry.files || "İçerik detayı";
      }
      if (controlSummaryMeta) {
        controlSummaryMeta.textContent = `${dateLabel} · ${
          entry.time || "Saat seçilmedi"
        }`;
      }
      if (controlSummaryPlatforms) {
        controlSummaryPlatforms.textContent = formatPlatformsLabel(
          entry.platforms
        );
      }
      if (controlSummaryOwner) {
        const ownerLabel = getOwnerLabel(entry.owner_id);
        controlSummaryOwner.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
      }
      if (controlNoteInput) {
        controlNoteInput.value = entry.note || "";
      }
      if (ownerSelect) {
        const ownerValue = entry.owner_id
          ? String(entry.owner_id)
          : "";
        if (ownerValue && responsibleUserMap.has(Number(ownerValue))) {
          ownerSelect.value = ownerValue;
        } else if (currentUser && responsibleUserMap.has(currentUser.id)) {
          ownerSelect.value = String(currentUser.id);
        } else {
          ownerSelect.value = "";
        }
      }
    }

    function fillCheckedSummary(entry) {
      if (!entry) return;
      const dateObj = parseDateKeyString(entry.date);
      const dateLabel = dateObj ? formatHumanDate(dateObj) : entry.date;
      if (checkedSummaryMeta) {
        checkedSummaryMeta.textContent = `${dateLabel} · ${
          entry.time || "Saat seçilmedi"
        }`;
      }
      if (checkedSummaryPlatforms) {
        checkedSummaryPlatforms.textContent = formatPlatformsLabel(
          entry.platforms
        );
      }
      if (checkedSummaryOwner) {
        const ownerLabel = getOwnerLabel(entry.owner_id);
        checkedSummaryOwner.textContent = ownerLabel
          ? `Sorumlu: ${ownerLabel}`
          : "Sorumlu: Belirlenmedi";
      }
      if (checkedStatusBadge) {
        checkedStatusBadge.textContent = formatStatusLabel(entry.status);
        checkedStatusBadge.classList.toggle(
          "missed",
          entry.status === "missed"
        );
      }
      if (checkedNoteText) {
        if (entry.note) {
          checkedNoteText.style.display = "";
          checkedNoteText.textContent = entry.note;
        } else {
          checkedNoteText.style.display = "none";
          checkedNoteText.textContent = "";
        }
      }
      if (checkedInfoText) {
        checkedInfoText.textContent = entry.checkedAt
          ? `Kontrol tarihi: ${formatDateTimeHuman(entry.checkedAt)}`
          : "";
      }
    }

    function showControlView(entry) {
      if (!entry) {
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      modalForcePlanMode = false;
      if (modalFormSection) modalFormSection.style.display = "none";
      if (modalControlSection) modalControlSection.style.display = "block";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      setPlanReturnBannerVisible(false);
      fillControlSummary(entry);
    }

    function showCheckedView(entry) {
      if (!entry) {
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      modalForcePlanMode = false;
      if (modalFormSection) modalFormSection.style.display = "none";
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "block";
      setPlanReturnBannerVisible(false);
      fillCheckedSummary(entry);
    }

    function setControlActionsEnabled(enabled) {
      [markDoneBtn, markMissedBtn, controlEditBtn, checkedEditBtn].forEach(
        (btn) => {
          if (btn) btn.disabled = !enabled;
        }
      );
      if (controlNoteInput) {
        controlNoteInput.readOnly = !enabled;
      }
      if (returnToControlBtn) {
        const bannerVisible =
          planReturnBanner && planReturnBanner.style.display !== "none";
        returnToControlBtn.disabled = !enabled || !bannerVisible;
      }
    }

    function setModalViewForEntry(entry) {
      if (!entry) {
        modalForcePlanMode = false;
        showPlanningView(null, { showReturnBanner: false });
        return;
      }
      const past = isEntryPast(entry);
      const status = entry.status || "planned";
      if (!modalForcePlanMode && past && status === "planned") {
        showControlView(entry);
        return;
      }
      if (!modalForcePlanMode && (status === "done" || status === "missed")) {
        showCheckedView(entry);
        return;
      }
      showPlanningView(entry, {
        showReturnBanner: modalForcePlanMode && (past || status !== "planned")
      });
    }

    function clearFormOnly(options = {}) {
      filesInput.value = "";
      textInput.value = "";
      timeInput.value = "";
  platformInputs.forEach((cb) => (cb.checked = false));
  if (entryColorInput) entryColorInput.value = DEFAULT_ENTRY_COLOR;
    if (entryColorPicker && entryColorInput) {
      setColorPickerValue(
        entryColorPicker,
          entryColorInput,
          DEFAULT_ENTRY_COLOR
        );
      }
      updateColorToggle(entryColorToggle, DEFAULT_ENTRY_COLOR);
      if (noteInput) noteInput.value = "";
      if (controlNoteInput) controlNoteInput.value = "";
      if (ownerSelect) {
        if (currentUser && responsibleUserMap.has(currentUser.id)) {
          ownerSelect.value = String(currentUser.id);
        } else {
          ownerSelect.value = "";
        }
      }
      setPlanReturnBannerVisible(false);
      if (!options.preserveSuccessMessage) {
        hideSaveSuccessMessage();
      }
    }

    function updateHighlightStateUI() {
      if (!highlightColorInput) return;
      if (!selectedDateKey) {
        highlightColorInput.disabled = true;
        setHighlightInputValue(DEFAULT_HIGHLIGHT_COLOR);
        setColorPickerEnabled(
          highlightColorWrapper,
          highlightColorToggle,
          false
        );
        return;
      }
      const hasHighlight = highlightedDates.has(selectedDateKey);
      const colorValue = hasHighlight
        ? highlightedDates.get(selectedDateKey)
        : DEFAULT_HIGHLIGHT_COLOR;
      highlightColorInput.disabled = !isViewingOwnData();
      setHighlightInputValue(colorValue);
      setColorPickerEnabled(
        highlightColorWrapper,
        highlightColorToggle,
        isViewingOwnData()
      );
    }

    async function setDateHighlight(dateKey, colorValue = DEFAULT_HIGHLIGHT_COLOR) {
      const payload = { date: dateKey, color: colorValue };
      const response = await apiFetch("/calendar/highlights", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      const normalized = normalizeHexColor(data.color || colorValue);
      if (normalized) {
        highlightedDates.set(data.date, normalized);
      }
    }

    async function removeDateHighlight(dateKey) {
      await apiFetch(`/calendar/highlights/${dateKey}`, { method: "DELETE" });
      highlightedDates.delete(dateKey);
    }


    function openModalForDate(dateObj, key, initialItemId = null) {
      closeCopyPopover();
      setSelectedDateState(key, dateObj);
      const dayData = loadDayData(key);
      currentDayItems = dayData.items || [];
      activeItemId = initialItemId;
      modalForcePlanMode = false;

      modalDateTitle.textContent = formatHumanDate(dateObj);
      updateHighlightStateUI();

      clearFormOnly();
      deleteBtn.disabled = !activeItemId;

      let selectedEntry = null;
      if (activeItemId) {
        selectedEntry =
          entriesById.get(activeItemId) ||
          currentDayItems.find((it) => it.id === activeItemId) ||
          null;
        if (selectedEntry) {
          entriesById.set(selectedEntry.id, selectedEntry);
          populateFormWithEntry(selectedEntry);
        } else {
          activeItemId = null;
        }
      }

      if (!selectedEntry && activeItemId === null) {
        clearFormOnly();
        if (modalFormSection) modalFormSection.style.display = "none";
        if (modalControlSection) modalControlSection.style.display = "none";
        if (modalCheckedSection) modalCheckedSection.style.display = "none";
        setPlanReturnBannerVisible(false);
      } else {
        setModalViewForEntry(selectedEntry);
      }
      renderModalSummaryList();
      dayModal.style.display = "flex";
      updateScheduleList();
    }

    function closeModal() {
      dayModal.style.display = "none";
      modalForcePlanMode = false;
      setPlanReturnBannerVisible(false);
      if (modalControlSection) modalControlSection.style.display = "none";
      if (modalCheckedSection) modalCheckedSection.style.display = "none";
      if (modalFormSection) modalFormSection.style.display = "none";
      activeItemId = null;
      toggleColorHelpPanel(false);
      closeCopyPopover();
      hideSaveSuccessMessage();
      selectedDateKey = summaryDateKey;
      renderCalendar();
    }

    function normalizeToMidnight(date) {
      if (!date) return null;
      const normalized = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      normalized.setHours(0, 0, 0, 0);
      return normalized;
    }
    function formatDateInputValue(date) {
      if (!date) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function parseDateInput(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (
        Number.isNaN(year) ||
        Number.isNaN(month) ||
        Number.isNaN(day)
      ) {
        return null;
      }
      const parsed = new Date(year, month - 1, day);
      if (
        parsed.getFullYear() !== year ||
        parsed.getMonth() !== month - 1 ||
        parsed.getDate() !== day
      ) {
        return null;
      }
      return normalizeToMidnight(parsed);
    }

    function clearReportOutputs() {
      reportTotal.textContent = "-";
      reportPlatforms.innerHTML = "";
      reportTimes.innerHTML = "";
      reportDays.textContent = "-";
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "";
      if (reportFilterLabel) reportFilterLabel.textContent = "";
      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }
      if (platformChartWrapper) platformChartWrapper.style.display = "none";
      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }
      if (timeChartWrapper) timeChartWrapper.style.display = "none";
      clearExecutedOutputs();
    }

    function clearExecutedOutputs() {
      if (reportsExecutedSection) {
        reportsExecutedSection.style.display = "none";
      }
      if (executedTableBody) executedTableBody.innerHTML = "";
      if (executedEmptyMessage) executedEmptyMessage.style.display = "none";
      if (executedSummaryLine) executedSummaryLine.textContent = "";
    }

    /* İstatistik hesaplama: seçilen tarih aralığı için */
    function buildStatsForRange(rangeStartDate, rangeEndDate, filterId = "all") {
      const startDate = normalizeToMidnight(rangeStartDate);
      const endDate = normalizeToMidnight(rangeEndDate);
    const platformsList = [
      "Instagram Post","Instagram Story","Instagram Reels","Instagram",
      "Facebook","X","Reddit","Discord",
      "YouTube","LinkedIn","TikTok","Telegram","Medium"
    ];

      let total = 0;
      const platformCounts = {};
      let early = 0, mid = 0, late = 0, noTime = 0;
      let daysWithContent = 0;

      platformsList.forEach((p) => (platformCounts[p] = 0));

      if (!startDate || !endDate || startDate > endDate) {
        return {
          total,
          platformCounts,
          early,
          mid,
          late,
          noTime,
          daysWithContent,
          startDate,
          endDate
        };
      }

      const cursor = new Date(startDate);

      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const items = loadDayData(key).items;
        if (!items.length) {
          cursor.setDate(cursor.getDate() + 1);
          cursor.setHours(0, 0, 0, 0);
          continue;
        }

        let dayHasContent = false;

        items.forEach((item) => {
          const hasContent =
            item.text || item.files || item.time || (item.platforms && item.platforms.length);
          if (!hasContent) return;
          if (!entryMatchesChannelFilter(item, filterId)) return;

          dayHasContent = true;
          total++;

          (item.platforms || []).forEach((p) => {
            if (!platformCounts[p]) platformCounts[p] = 0;
            platformCounts[p]++;
          });

          if (!item.time) {
            noTime++;
          } else {
            const mins = minutesFromTime(item.time);
            if (mins < 12 * 60) early++;
            else if (mins < 18 * 60) mid++;
            else late++;
          }
        });

        if (dayHasContent) daysWithContent++;
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }

      return {
        total,
        platformCounts,
        early,
        mid,
        late,
        noTime,
        daysWithContent,
        startDate,
        endDate
      };
    }

    function setRangeInputs(startDate, endDate) {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      reportRangeStartInput.value = formatDateInputValue(startDate);
      reportRangeEndInput.value = formatDateInputValue(endDate);
    }

    function ensureRangeInputsInitialized() {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      const currentStart = parseDateInput(reportRangeStartInput.value);
      const currentEnd = parseDateInput(reportRangeEndInput.value);
      if (currentStart && currentEnd) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - 6);
      setRangeInputs(start, end);
    }

    function applyQuickRange(days) {
      if (!Number.isFinite(days) || days < 1) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - (days - 1));
      setRangeInputs(start, end);
      if (reportMode === "range") renderReports();
    }

    function getReportRangeInfo() {
      if (reportMode === "range") {
        const parsedStart = parseDateInput(
          reportRangeStartInput ? reportRangeStartInput.value : ""
        );
        const parsedEnd = parseDateInput(
          reportRangeEndInput ? reportRangeEndInput.value : ""
        );
        if (!parsedStart || !parsedEnd) return null;
        let rangeStart = parsedStart;
        let rangeEnd = parsedEnd;
        if (rangeStart > rangeEnd) {
          rangeStart = parsedEnd;
          rangeEnd = parsedStart;
          if (reportRangeStartInput && reportRangeEndInput) {
            reportRangeStartInput.value = formatDateInputValue(rangeStart);
            reportRangeEndInput.value = formatDateInputValue(rangeEnd);
          }
        }
        return {
          start: rangeStart,
          end: rangeEnd,
          label: `${formatHumanDate(rangeStart)} - ${formatHumanDate(rangeEnd)} arası özet`
        };
      }
      const rangeStart = normalizeToMidnight(new Date(currentYear, currentMonth, 1));
      const rangeEnd = normalizeToMidnight(new Date(currentYear, currentMonth + 1, 0));
      return {
        start: rangeStart,
        end: rangeEnd,
        label: `${monthNames[currentMonth]} ${currentYear} için aylık özet`
      };
    }

    function collectEntriesInRange(rangeStartDate, rangeEndDate, filterId = "all") {
      const startDate = normalizeToMidnight(rangeStartDate);
      const endDate = normalizeToMidnight(rangeEndDate);
      if (!startDate || !endDate || startDate > endDate) return [];
      const results = [];
      const cursor = new Date(startDate);
      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const items = loadDayData(key).items || [];
        items.forEach((item) => {
          if (entryMatchesChannelFilter(item, filterId)) {
            results.push(item);
          }
        });
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }
      return results;
    }

    function renderReportsSummary(rangeInfo) {
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "";
      if (reportsExecutedSection) reportsExecutedSection.style.display = "none";
      const stats = buildStatsForRange(
        rangeInfo.start,
        rangeInfo.end,
        activeChannelFilter
      );
      reportTotal.textContent = stats.total + " planlanmış içerik";

      reportPlatforms.innerHTML = "";
      const entries = Object.entries(stats.platformCounts)
        .filter(([, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        const li = document.createElement("li");
        li.textContent = "Bu aralık için platform seçilmiş içerik yok.";
        reportPlatforms.appendChild(li);
      } else {
        entries.forEach(([platform, count]) => {
          const li = document.createElement("li");
          li.textContent = platform + ": " + count;
          reportPlatforms.appendChild(li);
        });
      }
      renderPlatformChart(entries);

      reportTimes.innerHTML = "";
      const slots = [
        ["Sabah (06:00–11:59)", stats.early],
        ["Öğlen / Öğleden sonra (12:00–17:59)", stats.mid],
        ["Akşam (18:00–23:59)", stats.late],
        ["Saat belirtilmemiş", stats.noTime]
      ];
      slots.forEach(([label, count]) => {
        const li = document.createElement("li");
        li.textContent = label + ": " + count;
        reportTimes.appendChild(li);
      });
      renderTimeChart(stats);

      reportDays.textContent =
        stats.daysWithContent + " günde en az bir içerik planlanmış.";
      clearExecutedOutputs();
    }

    function renderReportsExecuted(rangeInfo, entries) {
      if (reportsSummaryContainer) reportsSummaryContainer.style.display = "none";
      if (reportsExecutedSection) reportsExecutedSection.style.display = "block";
      if (!executedSummaryLine || !executedTableBody) return;

      const doneCount = entries.filter((entry) => entry.status === "done").length;
      const missedCount = entries.filter((entry) => entry.status === "missed").length;
      const plannedCount = entries.length - doneCount - missedCount;
      executedSummaryLine.textContent = `Seçilen aralıkta ${doneCount} paylaşılan, ${missedCount} kaçan, ${plannedCount} planlı içerik var.`;

      const showMissed = Boolean(executedShowMissedToggle && executedShowMissedToggle.checked);
      const rows = entries
        .filter(
          (entry) =>
            entry.status === "done" || (showMissed && entry.status === "missed")
        )
        .sort((a, b) => {
          const aDate = getEntryDateTime(a);
          const bDate = getEntryDateTime(b);
          return (bDate ? bDate.getTime() : 0) - (aDate ? aDate.getTime() : 0);
        });

      executedTableBody.innerHTML = "";
      if (!rows.length) {
        if (executedEmptyMessage) executedEmptyMessage.style.display = "block";
        return;
      }
      if (executedEmptyMessage) executedEmptyMessage.style.display = "none";

      rows.forEach((entry) => {
        const tr = document.createElement("tr");

        const dateCell = document.createElement("td");
        dateCell.dataset.label = "Tarih";
        const entryDate = parseDateInput(entry.date);
        dateCell.textContent = entryDate ? formatHumanDate(entryDate) : entry.date;
        tr.appendChild(dateCell);

        const timeCell = document.createElement("td");
        timeCell.dataset.label = "Saat";
        timeCell.textContent = entry.time || "-";
        tr.appendChild(timeCell);

        const textCell = document.createElement("td");
        textCell.dataset.label = "Metin";
        const preview = formatEntryPreviewText(entry, 120);
        textCell.textContent = preview;
        const fullText = (entry.text || entry.files || "").trim();
        if (fullText) textCell.title = fullText;
        tr.appendChild(textCell);

        const platformCell = document.createElement("td");
        platformCell.dataset.label = "Platformlar";
        platformCell.textContent = formatPlatformsLabel(entry.platforms);
        tr.appendChild(platformCell);

        const statusCell = document.createElement("td");
        statusCell.dataset.label = "Durum";
        const statusBadge = document.createElement("span");
        statusBadge.classList.add(
          "report-status-badge",
          entry.status === "done"
            ? "report-status-done"
            : entry.status === "missed"
            ? "report-status-missed"
            : "report-status-planned"
        );
        statusBadge.textContent = formatStatusLabel(entry.status);
        statusCell.appendChild(statusBadge);
        tr.appendChild(statusCell);

        const ownerCell = document.createElement("td");
        ownerCell.dataset.label = "Sorumlu";
        const ownerLabel = getOwnerLabel(entry.owner_id);
        ownerCell.textContent = ownerLabel || "-";
        tr.appendChild(ownerCell);

        const noteCell = document.createElement("td");
        noteCell.dataset.label = "Not";
        if (entry.note) {
          noteCell.textContent = entry.note;
          noteCell.title = entry.note;
        } else {
          noteCell.textContent = "-";
        }
        tr.appendChild(noteCell);

        executedTableBody.appendChild(tr);
      });
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Dosya okunurken hata oluştu."));
        reader.readAsDataURL(file);
      });
    }

    function updateRangeControlsVisibility() {
      if (!reportRangeInputs || !quickRangeButtons) return;
      if (reportMode === "range") {
        reportRangeInputs.style.display = "flex";
        quickRangeButtons.style.display = "flex";
      } else {
        reportRangeInputs.style.display = "none";
        quickRangeButtons.style.display = "none";
      }
    }

    function renderReports() {
      const rangeInfo = getReportRangeInfo();
      if (!rangeInfo) {
        reportMonthLabel.textContent = "Lütfen geçerli bir tarih aralığı seç.";
        clearReportOutputs();
        if (reportMode === "range" && reportPlatforms) {
          const li = document.createElement("li");
          li.textContent = "Geçerli bir tarih aralığı seç.";
          reportPlatforms.appendChild(li);
        }
        return;
      }

      reportMonthLabel.textContent = rangeInfo.label;
      updateReportFilterLabel();

      if (reportsContentView === "executed") {
        const entriesInRange = collectEntriesInRange(
          rangeInfo.start,
          rangeInfo.end,
          activeChannelFilter
        );
        renderReportsExecuted(rangeInfo, entriesInRange);
      } else {
        renderReportsSummary(rangeInfo);
      }
    }
    function renderPlatformChart(entries) {
      if (!platformChartWrapper || !platformChartCanvas || typeof Chart === "undefined") return;

      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }

      const labels = entries.map(([label]) => label);
      const data = entries.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        platformChartWrapper.style.display = "none";
        return;
      }

      const axisColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const gridColor = isDarkMode() ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.35)";
      const barColor = isDarkMode() ? "#60a5fa" : "#2563eb";

      platformChartWrapper.style.display = "block";
      platformChartInstance = new Chart(platformChartCanvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "İçerik sayısı",
            data,
            backgroundColor: data.map(() => barColor),
            borderRadius: 6,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: {
                color: axisColor,
                font: { size: 11 }
              },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: axisColor
              },
              grid: {
                color: gridColor
              }
            }
          }
        }
      });
    }
    function renderTimeChart(stats) {
      if (!timeChartWrapper || !timeChartCanvas || typeof Chart === "undefined") return;

      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }

      const labels = [
        "Sabah (06:00–11:59)",
        "Öğlen / Öğleden sonra (12:00–17:59)",
        "Akşam (18:00–23:59)",
        "Saat belirtilmemiş"
      ];
      const data = [stats.early, stats.mid, stats.late, stats.noTime];
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        timeChartWrapper.style.display = "none";
        return;
      }

      const legendColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const colors = isDarkMode()
        ? ["#38bdf8", "#facc15", "#f472b6", "#94a3b8"]
        : ["#0ea5e9", "#f59e0b", "#ec4899", "#9ca3af"];

      timeChartWrapper.style.display = "block";
      timeChartInstance = new Chart(timeChartCanvas, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "45%",
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: legendColor,
                boxWidth: 12,
                padding: 12,
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    /* Sekmeler */
    tabCalendar.addEventListener("click", () => {
      tabCalendar.classList.add("active");
      tabReports.classList.remove("active");
      viewCalendar.style.display = "";
      viewReports.style.display = "none";
    });

    tabReports.addEventListener("click", () => {
      tabReports.classList.add("active");
      tabCalendar.classList.remove("active");
      viewCalendar.style.display = "none";
      viewReports.style.display = "";
      renderReports();
    });

    /* Rapor görünüm modları */
    reportModeRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        if (!radio.checked) return;
        reportMode = radio.value;
        updateRangeControlsVisibility();
        if (reportMode === "range") {
          ensureRangeInputsInitialized();
        }
        renderReports();
      });
    });

    if (reportRangeStartInput) {
      reportRangeStartInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    if (reportRangeEndInput) {
      reportRangeEndInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    quickRangeButtonsList.forEach((btn) => {
      btn.addEventListener("click", () => {
        const days = Number(btn.dataset.range);
        applyQuickRange(days);
      });
    });

    reportViewButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.reportView;
        if (!view || reportsContentView === view) return;
        reportsContentView = view;
        reportViewButtons.forEach((button) => {
          button.classList.toggle("active", button.dataset.reportView === view);
        });
        renderReports();
      });
    });

    if (executedShowMissedToggle) {
      executedShowMissedToggle.addEventListener("change", () => {
        if (reportsContentView === "executed") renderReports();
      });
    }

    if (colorHelpBtn) {
      colorHelpBtn.addEventListener("click", async (event) => {
        event.stopPropagation();
        await ensureColorDescriptionsLoaded();
        renderColorHelpList();
        toggleColorHelpPanel();
      });
    }
    if (colorHelpCloseBtn) {
      colorHelpCloseBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        toggleColorHelpPanel(false);
      });
    }
    if (colorHelpPanel) {
      colorHelpPanel.addEventListener("click", (event) => {
        event.stopPropagation();
      });
    }
    document.addEventListener("click", (event) => {
      if (!colorHelpPanelOpen) return;
      if (
        colorHelpPanel &&
        !colorHelpPanel.contains(event.target) &&
        event.target !== colorHelpBtn
      ) {
        toggleColorHelpPanel(false);
      }
    });

    updateRangeControlsVisibility();

    loginForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;
      if (!email || !password) {
        loginError.textContent = "E-posta ve şifre gerekli.";
        return;
      }
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginSubmitBtn.disabled = true;
      try {
        const endpoint = isRegisterMode ? "/auth/register" : "/auth/login";
        const response = await fetch(API_BASE + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
          let message = isRegisterMode ? "Kayıt yapılamadı." : "Giriş yapılamadı.";
          try {
            const data = await response.json();
            if (data && data.error) message = data.error;
          } catch { /* ignore */ }
          throw new Error(message);
        }
        if (isRegisterMode) {
          const data = await response.json();
          setAuthMode(false);
          loginError.classList.add("success");
          loginError.textContent = data.approved
            ? "Admin hesabı oluşturuldu. Şimdi giriş yapabilirsiniz."
            : "Kayıt başarılı, admin onayından sonra giriş yapabilirsiniz.";
          loginSubmitBtn.disabled = false;
          return;
        }
        const data = await response.json();
        setAuthToken(data.token);
        setCurrentUser(data.user);
        adminSelectedUserId = null;
        await loadEntriesFromServer();
        hideLoginOverlay();
      } catch (err) {
        loginError.classList.remove("success");
        loginError.textContent = err.message || (isRegisterMode ? "Kayıt yapılamadı." : "Giriş yapılamadı.");
      } finally {
        loginSubmitBtn.disabled = false;
      }
    });

    switchAuthModeBtn.addEventListener("click", () => {
      setAuthMode(!isRegisterMode);
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
    });

    if (adminPanelBtn) {
      adminPanelBtn.addEventListener("click", () => {
        openAdminOverlay();
      });
    }
    if (adminCloseBtn) {
      adminCloseBtn.addEventListener("click", () => {
        closeAdminOverlay();
      });
    }
    adminOverlay.addEventListener("click", (event) => {
      if (event.target === adminOverlay) {
        closeAdminOverlay();
      }
    });
    if (adminViewSelfBtn) {
      adminViewSelfBtn.addEventListener("click", async () => {
        if (!currentUser) {
          closeAdminOverlay();
          return;
        }
        adminSelectedUserId = null;
        try {
          await loadEntriesFromServer();
        } catch (error) {
          alert(error.message);
        }
        closeAdminOverlay();
      });
    }
    if (adminTabButtons.length) {
      adminTabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetPanel = btn.dataset.panel || "users";
          if (targetPanel === activeAdminPanelTab) return;
          setActiveAdminPanelTab(targetPanel);
        });
      });
    }

    if (colorDescriptionSaveBtn) {
      colorDescriptionSaveBtn.addEventListener("click", () => {
        if (!currentUser || currentUser.role !== "admin") return;
        saveColorDescriptions();
      });
    }

    platformPresetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const data = btn.dataset.platforms || "";
        const values = data
          .split("|")
          .map((item) => item.trim())
          .filter(Boolean);
        applyPlatformPreset(values);
      });
    });

    channelFilterButtons.forEach((btn) => {
      const channelId = btn.dataset.channel || "all";
      btn.classList.toggle("active", channelId === activeChannelFilter);
      btn.addEventListener("click", () => {
        setActiveChannelFilter(channelId);
      });
    });
    if (scheduleViewButtons.length) {
      scheduleViewButtons.forEach((btn) => {
        const view = btn.dataset.view || "daily";
        btn.classList.toggle("active", view === scheduleViewMode);
        btn.addEventListener("click", () => {
          setScheduleViewMode(view);
        });
      });
    }
    updateReportFilterLabel();
    setActiveAdminPanelTab("users");
    if (modalSummary) {
      modalSummary.addEventListener("click", (event) => {
        if (event.target.closest(".summary-item-copy-btn")) return;
        const card = event.target.closest(".summary-item");
        if (!card || !card.dataset.entryId) return;
        const entryId = Number(card.dataset.entryId);
        if (!Number.isFinite(entryId)) return;
        selectEntryById(entryId);
      });
    }

    if (copyCancelBtn) {
      copyCancelBtn.addEventListener("click", () => closeCopyPopover());
    }
    if (copyPopoverCloseBtn) {
      copyPopoverCloseBtn.addEventListener("click", () => closeCopyPopover());
    }
    if (copyConfirmBtn) {
      copyConfirmBtn.addEventListener("click", () => handleCopyConfirm());
    }
    if (copyPopoverBackdrop) {
      copyPopoverBackdrop.addEventListener("click", (event) => {
        if (event.target === copyPopoverBackdrop) {
          closeCopyPopover();
        }
      });
    }
    if (copyPopover) {
      copyPopover.addEventListener("click", (event) => event.stopPropagation());
    }
    document.addEventListener("keydown", (event) => {
      if (
        event.key === "Escape" &&
        copyPopoverBackdrop &&
        copyPopoverBackdrop.classList.contains("active")
      ) {
        closeCopyPopover();
      }
    });

    if (excelUploadBtn && excelFileInput) {
      excelUploadBtn.addEventListener("click", () => {
        if (!authToken) {
          showLoginOverlay();
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yüklemek için admin yetkisi gerekir.");
          return;
        }
        if (!isViewingOwnData()) {
          alert("Başka bir kullanıcının takvimini incelerken dosya yükleyemezsin.");
          return;
        }
        excelFileInput.value = "";
        excelFileInput.click();
      });

      excelFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        if (!/\.(xlsx|xls|csv)$/i.test(file.name)) {
          alert("Lütfen .xlsx, .xls veya .csv uzantılı bir dosya seç.");
          excelFileInput.value = "";
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yüklemek için admin yetkisi gerekir.");
          excelFileInput.value = "";
          return;
        }

        const previousText = excelUploadBtn.textContent;
        excelUploadBtn.disabled = true;
        excelUploadBtn.textContent = "Yükleniyor...";

        try {
          const dataUrl = await readFileAsDataURL(file);
          const base64Data = String(dataUrl).split(",")[1];
          if (!base64Data) {
            throw new Error("Dosya okunamadı.");
          }
          const response = await apiFetch("/import/upload", {
            method: "POST",
            body: JSON.stringify({ filename: file.name, data: base64Data })
          });
          const result = await response.json();
          await loadEntriesFromServer();
          let message = `${result.imported} kayıt eklendi.`;
          if (result.skippedUnmapped) {
            message += ` ${result.skippedUnmapped} satır eşleşmeyen mecra nedeniyle atlandı.`;
          }
          if (result.unmappedMecra && result.unmappedMecra.length) {
            message += ` Eşleşmeyen mecralar: ${result.unmappedMecra.join(", ")}.`;
          }
          alert(`İçe aktarma tamamlandı. ${message}`);
        } catch (err) {
          alert(err.message || "Dosya yüklenemedi.");
        } finally {
          excelUploadBtn.disabled = false;
          excelUploadBtn.textContent = previousText || excelUploadDefaultText;
          excelFileInput.value = "";
        }
      });
    }

    function ensureResetPermissions() {
      if (!authToken) {
        showLoginOverlay();
        return false;
      }
      if (!currentUser || currentUser.role !== "admin") {
        alert("Takvimi sıfırlamak için admin yetkisi gerekir.");
        return false;
      }
      if (!isViewingOwnData()) {
        alert("Başka bir kullanıcının takvimini incelerken sıfırlama yapamazsın.");
        return false;
      }
      return true;
    }

    function hideResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "none";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
        const scope = btn.dataset.scope;
        if (scope && resetScopeLabels[scope]) {
          btn.textContent = resetScopeLabels[scope];
        }
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
    }

    function showResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "flex";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
      if (resetOptionButtons.length) {
        setTimeout(() => resetOptionButtons[0].focus(), 0);
      }
    }

    async function handleScopedReset(scope, triggerButton) {
      if (!scope || !resetConfirmMessages[scope]) return;
      if (!ensureResetPermissions()) {
        hideResetOptions();
        return;
      }
      const confirmed = confirm(resetConfirmMessages[scope]);
      if (!confirmed) return;

      const previousResetText = resetEntriesBtn ? resetEntriesBtn.textContent : "";
      const previousTriggerText = triggerButton ? triggerButton.textContent : "";

      if (resetEntriesBtn) {
        resetEntriesBtn.disabled = true;
        resetEntriesBtn.textContent = "Sıfırlanıyor...";
      }
      resetOptionButtons.forEach((btn) => {
        btn.disabled = true;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = true;
      }
      if (triggerButton) {
        triggerButton.textContent = "Sıfırlanıyor...";
      }

      try {
        const response = await apiFetch("/calendar/reset", {
          method: "DELETE",
          body: JSON.stringify({ scope })
        });
        await response.json();
        await loadEntriesFromServer();
        alert(resetSuccessMessages[scope] || "Kayıtlar başarıyla silindi.");
      } catch (err) {
        alert(err.message || "Takvim sıfırlanamadı.");
      } finally {
        if (resetEntriesBtn) {
          resetEntriesBtn.disabled = false;
          resetEntriesBtn.textContent = previousResetText || "Sıfırla";
        }
        if (triggerButton && previousTriggerText) {
          triggerButton.textContent = previousTriggerText;
        }
        hideResetOptions();
      }
    }

    if (resetEntriesBtn) {
      resetEntriesBtn.addEventListener("click", () => {
        if (!ensureResetPermissions()) return;
        if (!resetOptions) return;
        const isHidden = getComputedStyle(resetOptions).display === "none";
        if (isHidden) {
          showResetOptions();
        } else {
          hideResetOptions();
        }
      });
    }

    resetOptionButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        handleScopedReset(btn.dataset.scope, btn);
      });
    });

    if (resetCancelBtn) {
      resetCancelBtn.addEventListener("click", () => {
        hideResetOptions();
      });
    }

    logoutBtn.addEventListener("click", () => {
      if (adminOverlay.classList.contains("active")) {
        closeAdminOverlay();
      }
      setCurrentUser(null);
      setAuthToken("");
      adminSelectedUserId = null;
      adminViewInfo.style.display = "none";
      entriesById = new Map();
      entriesByDate = new Map();
      selectedDateKey = todayDateKey;
      currentDayItems = [];
      activeItemId = null;
      scheduleViewMode = "daily";
      scheduleDailyDateKey = todayDateKey;
      activeScheduleSummaryKey = todayDateKey;
      if (scheduleViewButtons.length) {
        scheduleViewButtons.forEach((btn) => {
          const view = btn.dataset.view || "daily";
          btn.classList.toggle("active", view === scheduleViewMode);
        });
      }
      clearFormOnly();
      closeModal();
      modalFormSection.style.display = "none";
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
      showLoginOverlay(false);
    });

    /* Olaylar ve init */
    async function init() {
      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth();
      ensureRangeInputsInitialized();
      renderCalendar();
      if (authToken) {
        try {
          const meResponse = await apiFetch("/auth/me");
          const meData = await meResponse.json();
          setCurrentUser(meData);
          adminSelectedUserId = null;
          await loadEntriesFromServer();
          await loadResponsibleUsers();
          await ensureColorDescriptionsLoaded();
          hideLoginOverlay();
        } catch (err) {
          console.error(err);
          setAuthToken("");
          setCurrentUser(null);
          entriesById = new Map();
          entriesByDate = new Map();
          showLoginOverlay();
        }
      } else {
        setCurrentUser(null);
        updateAuthUI();
        showLoginOverlay();
        await ensureColorDescriptionsLoaded();
      }
    }

    prevBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    nextBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    // Yeni içerik
  toggleFormBtn.addEventListener("click", () => {
      if (!selectedDateKey) return;
      if (!authToken) {
        alert("Paylaşım oluşturmak için önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      activeItemId = null;
      modalForcePlanMode = false;
      clearFormOnly();
      setModalViewForEntry(null);
      deleteBtn.disabled = true;
      renderModalSummaryList();
    });

    if (markDoneBtn) {
      markDoneBtn.addEventListener("click", () => handleStatusDecision("done"));
    }
    if (markMissedBtn) {
      markMissedBtn.addEventListener("click", () =>
        handleStatusDecision("missed")
      );
    }
    if (controlEditBtn) {
      controlEditBtn.addEventListener("click", () => {
        if (!activeItemId) return;
        selectEntryById(activeItemId, true);
      });
    }
    if (checkedEditBtn) {
      checkedEditBtn.addEventListener("click", () => {
        if (!activeItemId) return;
        selectEntryById(activeItemId, true);
      });
    }
    if (returnToControlBtn) {
      returnToControlBtn.addEventListener("click", () => {
        modalForcePlanMode = false;
        const entry = activeItemId ? entriesById.get(activeItemId) : null;
        setModalViewForEntry(entry);
      });
    }

    async function handleSave() {
      if (!authToken) {
        alert("Lütfen önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      if (!selectedDateKey) {
        alert("Önce takvimden bir gün seç.");
        return;
      }

      const selectedPlatforms = [];
      platformInputs.forEach((cb) => {
        if (cb.checked) selectedPlatforms.push(cb.value);
      });

      const filesVal = filesInput.value.trim();
      const textVal = textInput.value.trim();
      const timeVal = timeInput.value;
      const noteVal = noteInput ? noteInput.value.trim() : null;
      const anyContent = filesVal || textVal || timeVal || selectedPlatforms.length;

      if (!anyContent) {
        alert("Kaydedilecek bir içerik yok.");
        return;
      }

      const existing = activeItemId ? entriesById.get(activeItemId) : null;
      const ownerIdValue =
        ownerSelect && ownerSelect.value
          ? Number(ownerSelect.value)
          : existing
          ? existing.owner_id || null
          : null;
      const payload = {
        date: selectedDateKey,
        time: timeVal,
        text: textVal,
        files: filesVal,
        platforms: selectedPlatforms,
        color: entryColorInput ? entryColorInput.value || DEFAULT_ENTRY_COLOR : DEFAULT_ENTRY_COLOR,
        communication: existing ? existing.communication || "" : "",
        communicationType: existing
          ? existing.communication_type || existing.communicationType || ""
          : "",
        status: existing ? existing.status || "planned" : "planned",
        note: noteVal !== null ? noteVal : existing ? existing.note || "" : "",
        checkedAt: existing ? existing.checkedAt || null : null,
        ownerId: ownerIdValue
      };

      saveBtn.disabled = true;
      try {
        if (activeItemId && entriesById.has(activeItemId)) {
          await updateEntry(activeItemId, payload);
        } else {
          const created = await createEntry(payload);
          activeItemId = created.id;
        }
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        activeItemId = null;
        modalForcePlanMode = false;
        clearFormOnly({ preserveSuccessMessage: true });
        setModalViewForEntry(null);
        renderModalSummaryList();
        showSaveSuccessMessage();
        deleteBtn.disabled = true;
      } catch (err) {
        console.error(err);
        alert(err.message || "Kaydedilirken bir hata oluştu.");
      } finally {
        saveBtn.disabled = false;
      }
    }

    function handleClear() {
      clearFormOnly();
    }

    async function handleStatusDecision(nextStatus) {
      if (!authToken) {
        alert("Lütfen önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      if (!selectedDateKey || !activeItemId) return;
      const entry = entriesById.get(activeItemId);
      if (!entry) return;

      const noteValue = controlNoteInput
        ? controlNoteInput.value.trim()
        : entry.note || "";

      const payload = {
        date: entry.date,
        time: entry.time || "",
        text: entry.text || "",
        files: entry.files || "",
        communication: entry.communication || "",
        communicationType:
          entry.communication_type || entry.communicationType || "",
        status: nextStatus,
        platforms: Array.isArray(entry.platforms) ? entry.platforms : [],
        color: entry.color || DEFAULT_ENTRY_COLOR,
        note: noteValue,
        checkedAt: new Date().toISOString(),
        ownerId: entry.owner_id || null
      };

      const actionButtons = [markDoneBtn, markMissedBtn];
      actionButtons.forEach((btn) => btn && (btn.disabled = true));
      try {
        await updateEntry(activeItemId, payload);
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        renderModalSummaryList();
        const updatedEntry = entriesById.get(activeItemId);
        modalForcePlanMode = false;
        setModalViewForEntry(updatedEntry);
        updateScheduleList();
      } catch (err) {
        alert(err.message || "Durum güncellenemedi.");
      } finally {
        actionButtons.forEach((btn) => btn && (btn.disabled = false));
      }
    }

    async function handleDelete() {
      if (!authToken) {
        alert("Lütfen önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      if (!selectedDateKey || !activeItemId) return;

      const confirmed = confirm("Bu paylaşımı silmek istediğine emin misin?");
      if (!confirmed) return;

      deleteBtn.disabled = true;
      try {
        await deleteEntry(activeItemId);
        activeItemId = null;
        clearFormOnly();
        modalForcePlanMode = false;
        setModalViewForEntry(null);
        modalFormSection.style.display = "none";
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        renderModalSummaryList();
      } catch (err) {
        console.error(err);
        deleteBtn.disabled = false;
        alert(err.message || "Kayıt silinirken bir hata oluştu.");
      }
    }

    saveBtn.addEventListener("click", () => {
      handleSave();
    });
    clearBtn.addEventListener("click", handleClear);
    deleteBtn.addEventListener("click", () => {
      handleDelete();
    });

    modalCloseBtn.addEventListener("click", closeModal);
    dayModal.addEventListener("click", (e) => {
      if (e.target === dayModal) closeModal();
    });

    initTheme();
    init();
  </script>
</div>
</body>
</html>
    function showToast(message, variant = "success") {
      if (!toastContainer) return;
      const toast = document.createElement("div");
      toast.className = "toast-message";
      toast.textContent = message;
      if (variant === "error") {
        toast.style.background = "#fee2e2";
        toast.style.color = "#991b1b";
        toast.style.borderColor = "#fecaca";
        toast.style.boxShadow = "0 12px 30px rgba(248, 113, 113, 0.2)";
      }
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 1800);
    }
