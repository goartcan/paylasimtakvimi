<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Paylaşım Takvimi</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #ffffff;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
      color: #111827;
    }
    h1, h2, h3, label { font-weight: 700; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo { height: 40px; }
    .login-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(17, 24, 39, 0.65);
      z-index: 1500;
      padding: 16px;
    }
    .login-overlay.active { display: flex; }
    .login-card {
      width: min(360px, 96vw);
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .login-card h2 {
      margin: 0;
      font-size: 20px;
      text-align: center;
    }
    .login-card form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .login-card .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
    }
    .login-card input {
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
    }
    .login-card button {
      width: 100%;
      justify-content: center;
    }
    .login-card .secondary-btn {
      background: #e2e8f0;
      color: #111827;
    }
    .login-card .secondary-btn:hover {
      background: #d1d5db;
    }
    .login-card-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: center;
    }
    #loginError {
      min-height: 16px;
      color: #dc2626;
      font-size: 12px;
    }
    #loginError.success {
      color: #16a34a;
    }
    body.dark .login-card {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .login-card input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    body.dark .login-card .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .login-card .secondary-btn:hover {
      background: #2c3a52;
    }
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1400;
    }
    .admin-overlay.active { display: flex; }
    .admin-panel {
      width: min(720px, 96vw);
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.3);
    }
    .admin-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .admin-panel-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }
    .admin-panel-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .admin-close-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 8px;
    }
    .admin-user-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
    }
    .admin-user-row {
      display: grid;
      grid-template-columns: 1.6fr 0.9fr 0.9fr auto;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .admin-user-row > div:first-child {
      word-break: break-all;
    }
    .admin-user-row.selected {
      border-color: #3b82f6;
      background: #e0f2fe;
    }
    .admin-user-row.actions {
      justify-content: flex-end;
    }
    .admin-user-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e2e8f0;
      color: #1f2937;
    }
    .badge.success {
      background: #dcfce7;
      color: #166534;
    }
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    .badge.info {
      background: #dbeafe;
      color: #1d4ed8;
    }
    body.dark .admin-panel {
      background: #0f172a;
      color: #f9fafb;
      border: 1px solid #1f2937;
    }
    body.dark .admin-user-row {
      background: #111827;
      border-color: #1f2937;
    }
    body.dark .admin-user-row.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.2);
    }
    body.dark .admin-close-btn {
      color: #f9fafb;
    }
    body.dark .badge {
      background: #1e293b;
      color: #f9fafb;
    }
    body.dark .badge.success {
      background: rgba(22, 101, 52, 0.2);
      color: #bbf7d0;
    }
    body.dark .badge.warning {
      background: rgba(146, 64, 14, 0.2);
      color: #fde68a;
    }
    body.dark .badge.info {
      background: rgba(37, 99, 235, 0.2);
      color: #bfdbfe;
    }

    body.blurred {
      backdrop-filter: blur(6px);
    }
    body.blurred #appRoot {
      filter: blur(6px);
      pointer-events: none;
      user-select: none;
    }

    /* Sekmeler */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    #adminViewInfo {
      margin: -8px 0 16px 0;
      color: #1d4ed8;
      font-weight: 600;
    }
    body.dark #adminViewInfo {
      color: #93c5fd;
    }
    .tab-button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 14px;
      background: #f3f4f6;
      font-size: 13px;
    }
    .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }

    .container {
      display: grid;
      grid-template-columns: 3fr 1.2fr;
      gap: 24px;
      align-items: stretch;
    }
    .calendar {
      border: 1px solid #dde2ff;
      border-radius: 12px;
      padding: 20px;
      background: #f9faff;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: -20px -20px 16px -20px;
      padding: 10px 16px;
      background: #eef2ff;
      border-bottom: 1px solid #dde2ff;
      border-radius: 12px 12px 0 0;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #c4d0ff;
      padding: 4px 12px;
      background: #f2f5ff;
      font-size: 12px;
    }
    button:hover { background: #e4ebff; }
    .secondary-btn {
      background: #e2e8f0;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .secondary-btn:hover {
      background: #d1d5db;
    }
    .danger-btn {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }
    .danger-btn:hover {
      background: #fecaca;
    }
    #themeToggleBtn {
      font-size: 11px;
      padding-inline: 10px;
    }
    .month-label {
      font-weight: 700;
      font-size: 20px;
      color: #152052;
    }
    .weekdays,
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .weekday {
      text-align: center;
      font-weight: 700;
      font-size: 12px;
      padding: 4px 0;
      background: #f0f3ff;
      border-radius: 6px;
      color: #1a275a;
    }
    .day {
      border-radius: 8px;
      border: 1px solid #e1e5ff;
      padding: 8px;
      min-height: 120px;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .day:hover {
      border-color: #3b5bdb;
      box-shadow: 0 0 0 1px rgba(59, 91, 219, 0.12);
      background: #f4f6ff;
    }
    .day-number {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
      color: #1a275a;
    }
    .day.has-data {
      border-color: #00b3c6;
      background: #f0fcff;
    }
    .day-summary {
      font-size: 11px;
      color: #33415c;
    }
    .day-summary + .day-summary { margin-top: 2px; }
    .day-summary.excel {
      color: #0369a1;
    }

    .side {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }
    .form {
      border: 1px solid #dde2ff;
      border-radius: 12px;
      padding: 16px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .excel-upload-container {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .excel-upload-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .reset-options {
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .reset-options .danger-btn {
      justify-content: center;
    }
    .reset-options .secondary-btn {
      justify-content: center;
    }
    .excel-note {
      font-size: 11px;
      color: #4b5563;
    }
    .excel-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }
    .small {
      font-size: 11px;
      color: #4b5563;
    }
    .schedule-list {
      margin-top: 12px;
      border-top: 1px solid #eef0ff;
      padding-top: 12px;
      flex: 0 0 340px;
      max-height: 340px;
      overflow-y: auto;
    }
    .schedule-item {
      padding: 6px 0;
      border-bottom: 1px solid #f1f3ff;
      cursor: pointer;
    }
    .schedule-item.from-excel {
      background: rgba(14, 165, 233, 0.08);
      border-color: #bae6fd;
      border-radius: 8px;
      padding: 6px;
    }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-date {
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 2px;
      color: #111827;
    }
    .schedule-text {
      font-size: 11px;
      margin-bottom: 2px;
      color: #374151;
    }

    /* Raporlar görünümü */
    #viewReports {
      border: 1px solid #dde2ff;
      border-radius: 12px;
      padding: 16px;
      background: #ffffff;
    }
    .report-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0 10px 0;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .report-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .report-section { margin-bottom: 16px; }
    .report-section h3 {
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    .report-list {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
    }
    .report-range-inputs {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .report-range-inputs input[type="date"] {
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #ffffff;
      color: #111827;
    }
    .report-range-inputs .range-separator {
      font-size: 12px;
      color: #6b7280;
    }
    .quick-range-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      margin: 0 0 14px 0;
      flex-wrap: wrap;
    }
    .quick-range-buttons span {
      color: #6b7280;
      font-weight: 600;
    }
    .quick-range-buttons button {
      font-size: 11px;
      padding: 4px 10px;
    }
    body.dark .report-range-inputs input[type="date"] {
      background: #111827;
      border-color: #374151;
      color: #f3f4f6;
    }
    body.dark .quick-range-buttons span {
      color: #9ca3af;
    }
    .report-chart-wrapper {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }
    .report-chart-wrapper canvas {
      width: 100%;
      height: 260px;
    }
    body.dark .report-chart-wrapper {
      background: #1f2937;
      border-color: #374151;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      max-width: 780px;
      width: 100%;
      max-height: 92vh;
      overflow-y: auto;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .modal-body {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-toolbar {
      display: flex;
      justify-content: flex-start;
    }
    .modal-columns {
      display: grid;
      grid-template-columns: minmax(230px, 320px) minmax(420px, 1fr);
      gap: 18px;
      align-items: flex-start;
    }
    .modal-summary {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      background: #f9fafb;
    }
    .modal-form-section {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #ffffff;
    }
    .form-row {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      padding: 6px;
      font-family: inherit;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    input[type="text"],
    input[type="time"] {
      padding: 6px;
      font-size: 12px;
      font-family: inherit;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }
    .platforms {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 8px;
      font-size: 12px;
    }
    .platforms label {
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .form-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }
    #toggleFormBtn {
      border-radius: 999px;
      padding-inline: 14px;
      padding-block: 6px;
    }

    /* Gün içi içerik listesi */
    #modalSummary {
      margin-top: 8px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .summary-item {
      padding: 6px 10px;
      border-radius: 8px;
      background: #f3f4ff;
      border: 1px solid #e0e3ff;
      cursor: pointer;
      opacity: 0.85; /* daha okunaklı */
    }
    .summary-item.excel {
      background: #e0f2fe;
      border-color: #bae6fd;
      opacity: 1;
    }
    .summary-item.active {
      opacity: 1;
      background: #e7ebff;
      border-color: #c4d0ff;
    }
    .summary-item-title {
      font-size: 12px;
      color: #111827;
      margin-bottom: 2px;
    }
    .summary-item-time {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 1px;
    }
    .summary-item-platforms {
      font-size: 11px;
      color: #4b5563;
    }
    .summary-item-badge {
      font-size: 10px;
      color: #075985;
      background: #e0f2fe;
      border: 1px solid #bae6fd;
      border-radius: 999px;
      padding: 2px 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .summary-empty {
      padding: 6px 10px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      color: #6b7280;
    }

    /* DARK MODE: yüksek kontrast */
    body.dark {
      background: #0b1120;
      color: #e5e7eb;
    }
    body.dark .calendar,
    body.dark .form,
    body.dark #viewReports {
      background: #0b1120;
      border-color: #1f2937;
    }
    body.dark .calendar-header {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .weekday {
      background: #0f172a;
      color: #e5e7eb;
    }
    body.dark .day {
      background: #0b1120;
      border-color: #1f2937;
    }
    body.dark .day.has-data {
      background: #0f172a;
      border-color: #38bdf8;
    }
    body.dark .day-number { color: #e5e7eb; }
    body.dark .day-summary { color: #cbd5f5; }

    /* Koyu mod modal daha aydınlık ve kontrastlı */
    body.dark .modal {
      background: rgba(15, 23, 42, 0.85);
    }
    body.dark .modal-content {
      background: #111827;
      color: #f9fafb;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
    }
    body.dark .modal-title { color: #f9fafb; }
    body.dark textarea,
    body.dark input[type="text"],
    body.dark input[type="time"] {
      background: #020617;
      color: #f9fafb;
      border-color: #475569;
    }

    body.dark .summary-item {
      background: #020617;
      border-color: #1f2937;
      opacity: 0.9;
    }
    body.dark .summary-item.excel {
      background: rgba(14, 165, 233, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
    }
    body.dark .summary-item.active {
      background: #1d4ed8;
      border-color: #60a5fa;
      opacity: 1;
    }
    body.dark .summary-empty {
      background: #020617;
      border-color: #475569;
      color: #9ca3af;
    }
    body.dark .summary-item-title,
    body.dark .summary-item-time,
    body.dark .summary-item-platforms {
      color: #e5e7eb;
    }
    body.dark .summary-item-badge,
    body.dark .excel-chip {
      background: rgba(14, 165, 233, 0.25);
      border-color: rgba(14, 165, 233, 0.45);
      color: #bae6fd;
    }
    body.dark .excel-upload-container {
      border-top-color: #374151;
    }
    body.dark .day-summary.excel {
      color: #bae6fd;
    }
    body.dark .schedule-item {
      border-color: #1f2937;
    }
    body.dark .schedule-text,
    body.dark .schedule-date {
      color: #e5e7eb;
    }

    body.dark button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark button:hover {
      background: #1e293b;
    }
    body.dark .secondary-btn {
      background: #1e293b;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .secondary-btn:hover {
      background: #2c3a52;
    }
    body.dark .danger-btn {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }
    body.dark .danger-btn:hover {
      background: #991b1b;
    }
    body.dark .tab-button {
      background: #0f172a;
      border-color: #475569;
      color: #e5e7eb;
    }
    body.dark .tab-button.active {
      background: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }
    body.dark .report-controls { color: #e5e7eb; }
    body.dark .modal-summary {
      background: #0f172a;
      border-color: #1f2937;
    }
    body.dark .modal-form-section {
      background: #0b1120;
      border-color: #1f2937;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 780px) {
      .modal-columns {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <h2>Paylaşım Takvimi</h2>
      <form id="loginForm">
        <div class="form-row">
          <label for="loginEmail">E-posta</label>
          <input type="email" id="loginEmail" autocomplete="email" required />
        </div>
        <div class="form-row">
          <label for="loginPassword">Şifre</label>
          <input type="password" id="loginPassword" autocomplete="current-password" required />
        </div>
        <div class="login-card-footer">
          <button type="submit" id="loginSubmitBtn">Giriş yap</button>
          <button type="button" id="switchAuthModeBtn" class="secondary-btn">Kayıt olmak istiyorum</button>
          <span id="loginError"></span>
        </div>
      </form>
    </div>
  </div>
  <div id="adminOverlay" class="admin-overlay">
    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2>Admin Paneli</h2>
        <button id="adminCloseBtn" class="admin-close-btn" aria-label="Kapat">×</button>
      </div>
      <p class="small">
        Bekleyen kullanıcı kayıtlarını onaylayabilir, herhangi bir kullanıcının takvimini görüntüleyebilirsin.
      </p>
      <div class="admin-panel-actions">
        <button type="button" id="adminViewSelfBtn" class="secondary-btn">Kendi takvimimi göster</button>
      </div>
      <div class="admin-user-list" id="adminUserList"></div>
    </div>
  </div>
  <div id="appRoot">
  <div class="header">
    <div class="header-left">
      <img src="goart-logo.png" alt="GoArt Worlds" class="logo" />
      <h1>Paylaşım Takvimi</h1>
    </div>
    <div class="header-right">
      <button id="adminPanelBtn" style="display:none;">Admin paneli</button>
      <button id="logoutBtn" style="display:none;">Çıkış yap</button>
      <button id="themeToggleBtn">Koyu mod</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button active" id="tabCalendar">Takvim</button>
    <button class="tab-button" id="tabReports">Raporlar</button>
  </div>
  <p class="small" id="adminViewInfo" style="display:none;"></p>

  <!-- TAKVİM GÖRÜNÜMÜ -->
  <div id="viewCalendar">
    <div class="container">
      <div class="calendar">
        <div class="calendar-header">
          <button id="prevMonthBtn">&lt;</button>
          <div class="month-label" id="monthLabel"></div>
          <button id="nextMonthBtn">&gt;</button>
        </div>
        <div class="weekdays">
          <div class="weekday">Pzt</div>
          <div class="weekday">Sal</div>
          <div class="weekday">Çar</div>
          <div class="weekday">Per</div>
          <div class="weekday">Cum</div>
          <div class="weekday">Cmt</div>
          <div class="weekday">Paz</div>
        </div>
        <div class="days" id="daysContainer"></div>
      </div>

      <div class="side">
        <div class="form">
          <h2>Gün Detayı / Takvim Özeti</h2>
          <div id="scheduleList" class="schedule-list small"></div>
          <div class="excel-upload-container">
            <p class="excel-note">
              Excel yüklediğinde önceki Excel kayıtları silinir, manuel eklediğin içeriklere dokunulmaz.
            </p>
            <div class="excel-upload-actions">
              <button id="excelUploadBtn" class="secondary-btn" style="display:none;">Excel yükle</button>
              <button id="resetEntriesBtn" class="danger-btn" style="display:none;">Sıfırla</button>
            </div>
            <div id="resetOptions" class="reset-options">
              <button type="button" class="danger-btn" data-scope="excel">Excel girişlerini sıfırla</button>
              <button type="button" class="danger-btn" data-scope="manual">Manuel girişleri sıfırla</button>
              <button type="button" class="danger-btn" data-scope="all">Tüm kayıtları sıfırla</button>
              <button type="button" class="secondary-btn" id="resetCancelBtn">Vazgeç</button>
            </div>
            <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none;" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RAPORLAR -->
  <div id="viewReports" style="display:none;">
    <h2>Raporlar</h2>
    <p class="small" id="reportMonthLabel"></p>

    <div class="report-controls">
      <span>Görünüm:</span>
      <label>
        <input type="radio" name="reportMode" value="month" checked />
        Aylık
      </label>
      <label>
        <input type="radio" name="reportMode" value="range" />
        Tarih aralığı
      </label>
      <div class="report-range-inputs" id="reportRangeInputs" style="display:none;">
        <input type="date" id="reportRangeStart" />
        <span class="range-separator">→</span>
        <input type="date" id="reportRangeEnd" />
      </div>
    </div>
    <div class="quick-range-buttons" id="quickRangeButtons" style="display:none;">
      <span>Kısayol:</span>
      <button type="button" data-range="7">Son 7 gün</button>
      <button type="button" data-range="14">Son 14 gün</button>
      <button type="button" data-range="30">Son 30 gün</button>
      <button type="button" data-range="90">Son 90 gün</button>
    </div>

    <div class="report-section">
      <h3>Toplam içerik</h3>
      <p class="small" id="reportTotal"></p>
    </div>

    <div class="report-section">
      <h3>Platforma göre içerik sayısı</h3>
      <div class="report-chart-wrapper" id="platformChartWrapper" style="display:none;">
        <canvas id="platformChart"></canvas>
      </div>
      <ul class="report-list" id="reportPlatforms"></ul>
    </div>

    <div class="report-section">
      <h3>Saat aralığına göre dağılım</h3>
      <div class="report-chart-wrapper" id="timeChartWrapper" style="display:none;">
        <canvas id="timeChart"></canvas>
      </div>
      <ul class="report-list" id="reportTimes"></ul>
    </div>

    <div class="report-section">
      <h3>İçerik olan gün sayısı</h3>
      <p class="small" id="reportDays"></p>
    </div>
  </div>

  <!-- Modal: Seçili Gün -->
  <div class="modal" id="dayModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalDateTitle"></div>
        <button class="modal-close" id="modalCloseBtn" aria-label="Kapat">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-toolbar">
          <button id="toggleFormBtn">Paylaşım oluştur +</button>
        </div>

        <div class="modal-columns">
          <div id="modalSummary" class="modal-summary small"></div>

          <div id="modalFormSection" class="modal-form-section" style="display: none;">
            <div class="form-row">
              <label for="filesInput">Paylaşılacak dosyalar / linkler</label>
              <textarea
                id="filesInput"
                placeholder="Örn: Drive linki, dosya adları"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="textInput">Paylaşım metni</label>
            <textarea
              id="textInput"
              placeholder="Post metnini buraya yaz"
            ></textarea>
          </div>

          <div class="form-row">
            <label for="timeInput">Paylaşım saati</label>
            <input type="time" id="timeInput" />
          </div>

          <div class="form-row">
            <label>Hangi sosyal medya?</label>
            <div class="platforms">
              <label><input type="checkbox" value="Instagram Post" />Instagram Post</label>
              <label><input type="checkbox" value="Instagram Story" />Instagram Story</label>
              <label><input type="checkbox" value="Instagram Reels" />Instagram Reels</label>
              <label><input type="checkbox" value="Facebook" />Facebook</label>
              <label><input type="checkbox" value="X" />X</label>
              <label><input type="checkbox" value="Reddit" />Reddit</label>
              <label><input type="checkbox" value="Discord" />Discord</label>
              <label><input type="checkbox" value="YouTube" />YouTube</label>
              <label><input type="checkbox" value="LinkedIn" />LinkedIn</label>
              <label><input type="checkbox" value="TikTok" />TikTok</label>
              <label><input type="checkbox" value="Telegram" />Telegram</label>
              <label><input type="checkbox" value="Medium" />Medium</label>
            </div>
          </div>

          <div class="form-buttons">
            <button id="deleteBtn">Sil</button>
            <button id="clearBtn">Temizle</button>
            <button id="saveBtn">Kaydet</button>
          </div>

          <p class="small">
            Not: Veriler hesabınıza bağlı olarak sunucuda saklanır.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    const API_BASE = "http://localhost:4000";
    let authToken = localStorage.getItem("contentCalendar_token") || "";
    let entriesById = new Map();
    let entriesByDate = new Map();

    const loginOverlay = document.getElementById("loginOverlay");
    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginSubmitBtn = document.getElementById("loginSubmitBtn");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");
    const switchAuthModeBtn = document.getElementById("switchAuthModeBtn");
    const adminPanelBtn = document.getElementById("adminPanelBtn");
    const excelUploadContainer = document.querySelector(".excel-upload-container");
    const excelUploadBtn = document.getElementById("excelUploadBtn");
    const resetEntriesBtn = document.getElementById("resetEntriesBtn");
    const resetOptions = document.getElementById("resetOptions");
    const resetOptionButtons = resetOptions
      ? Array.from(resetOptions.querySelectorAll("button[data-scope]"))
      : [];
    const resetCancelBtn = document.getElementById("resetCancelBtn");
    const excelFileInput = document.getElementById("excelInput");
    const adminOverlay = document.getElementById("adminOverlay");
    const adminCloseBtn = document.getElementById("adminCloseBtn");
    const adminUserList = document.getElementById("adminUserList");
    const adminViewSelfBtn = document.getElementById("adminViewSelfBtn");
    const adminViewInfo = document.getElementById("adminViewInfo");

    const monthLabel = document.getElementById("monthLabel");
    const daysContainer = document.getElementById("daysContainer");
    const prevBtn = document.getElementById("prevMonthBtn");
    const nextBtn = document.getElementById("nextMonthBtn");

    const filesInput = document.getElementById("filesInput");
    const textInput = document.getElementById("textInput");
    const timeInput = document.getElementById("timeInput");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    deleteBtn.disabled = true;
    const platformInputs = document.querySelectorAll(
      ".platforms input[type='checkbox']"
    );
    const scheduleList = document.getElementById("scheduleList");

    const dayModal = document.getElementById("dayModal");
    const modalDateTitle = document.getElementById("modalDateTitle");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalFormSection = document.getElementById("modalFormSection");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const modalSummary = document.getElementById("modalSummary");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    const tabCalendar = document.getElementById("tabCalendar");
    const tabReports = document.getElementById("tabReports");
    const viewCalendar = document.getElementById("viewCalendar");
    const viewReports = document.getElementById("viewReports");

    const reportMonthLabel = document.getElementById("reportMonthLabel");
    const reportTotal = document.getElementById("reportTotal");
    const reportPlatforms = document.getElementById("reportPlatforms");
    const reportTimes = document.getElementById("reportTimes");
    const reportDays = document.getElementById("reportDays");
    const reportModeRadios = document.querySelectorAll("input[name='reportMode']");
    const reportRangeInputs = document.getElementById("reportRangeInputs");
    const reportRangeStartInput = document.getElementById("reportRangeStart");
    const reportRangeEndInput = document.getElementById("reportRangeEnd");
    const quickRangeButtons = document.getElementById("quickRangeButtons");
    const platformChartWrapper = document.getElementById("platformChartWrapper");
    const platformChartCanvas = document.getElementById("platformChart");
    const timeChartWrapper = document.getElementById("timeChartWrapper");
    const timeChartCanvas = document.getElementById("timeChart");

    const monthNames = [
      "Ocak","Şubat","Mart","Nisan","Mayıs","Haziran",
      "Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"
    ];

    let currentYear;
    let currentMonth;
    let selectedDateKey = null;
    let currentDayItems = []; // {id, files, text, time, platforms}[]
    let activeItemId = null;
    let isRegisterMode = false;
    let currentUser = null;
    let adminSelectedUserId = null;
    const excelUploadDefaultText = excelUploadBtn ? excelUploadBtn.textContent : "Excel yükle";
    const resetScopeLabels = {
      excel: "Excel girişlerini sıfırla",
      manual: "Manuel girişleri sıfırla",
      all: "Tüm kayıtları sıfırla"
    };
    const resetConfirmMessages = {
      excel: "Excel'den gelen kayıtların tamamı silinecek. Emin misin?",
      manual: "Manuel eklediğin kayıtların tamamı silinecek. Emin misin?",
      all: "Tüm kayıtların tamamı silinecek. Emin misin?"
    };
    const resetSuccessMessages = {
      excel: "Excel girişleri başarıyla silindi.",
      manual: "Manuel girişler başarıyla silindi.",
      all: "Tüm kayıtlar başarıyla silindi."
    };

    let reportMode = "month"; // "month" | "range"
    let platformChartInstance = null;
    let timeChartInstance = null;
    const quickRangeButtonsList = quickRangeButtons
      ? Array.from(quickRangeButtons.querySelectorAll("button[data-range]"))
      : [];

    function setAuthToken(token) {
      authToken = token || "";
      if (authToken) {
        localStorage.setItem("contentCalendar_token", authToken);
      } else {
        localStorage.removeItem("contentCalendar_token");
      }
      updateAuthUI();
    }

    function setCurrentUser(user) {
      currentUser = user;
      updateAuthUI();
    }

    function updateAuthUI() {
      const isLoggedIn = Boolean(authToken && currentUser);
      logoutBtn.style.display = isLoggedIn ? "inline-flex" : "none";
      if (currentUser && currentUser.role === "admin") {
        adminPanelBtn.style.display = "inline-flex";
      } else {
        adminPanelBtn.style.display = "none";
        adminViewInfo.style.display = "none";
        adminSelectedUserId = null;
      }
      if (excelUploadBtn) {
        const canUpload =
          Boolean(isLoggedIn && currentUser && currentUser.role === "admin" && isViewingOwnData());
        excelUploadBtn.style.display = canUpload ? "inline-flex" : "none";
        excelUploadBtn.disabled = !canUpload;
        if (resetEntriesBtn) {
          resetEntriesBtn.style.display = canUpload ? "inline-flex" : "none";
          resetEntriesBtn.disabled = !canUpload;
          resetEntriesBtn.textContent = "Sıfırla";
        }
        if (excelUploadContainer) {
          excelUploadContainer.style.display = canUpload ? "flex" : "none";
        }
        if (resetOptions) {
          resetOptions.style.display = "none";
          resetOptionButtons.forEach((btn) => {
            btn.disabled = false;
            const scope = btn.dataset.scope;
            if (scope && resetScopeLabels[scope]) {
              btn.textContent = resetScopeLabels[scope];
            }
          });
        }
      }
      updateEditingPermissions();
    }

    function setAuthMode(registerMode) {
      isRegisterMode = Boolean(registerMode);
      loginSubmitBtn.textContent = isRegisterMode ? "Kayıt ol" : "Giriş yap";
      switchAuthModeBtn.textContent = isRegisterMode
        ? "Zaten hesabım var"
        : "Kayıt olmak istiyorum";
      loginError.classList.remove("success");
    }

    function showLoginOverlay(registerMode = false) {
      loginOverlay.classList.add("active");
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
      document.body.classList.add("blurred");
      setAuthMode(registerMode);
    }

    function hideLoginOverlay() {
      loginOverlay.classList.remove("active");
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      document.body.classList.remove("blurred");
      setAuthMode(false);
    }

    async function apiFetch(path, options = {}) {
      const opts = { ...options };
      opts.headers = { ...(opts.headers || {}) };
      if (opts.body && !opts.headers["Content-Type"]) {
        opts.headers["Content-Type"] = "application/json";
      }
      if (authToken) {
        opts.headers.Authorization = "Bearer " + authToken;
      }
      const response = await fetch(API_BASE + path, opts);
      if (response.status === 401) {
        setCurrentUser(null);
        setAuthToken("");
        if (adminOverlay.classList.contains("active")) {
          closeAdminOverlay();
        }
        showLoginOverlay();
        throw new Error("Oturum süresi doldu. Lütfen tekrar giriş yap.");
      }
      if (!response.ok) {
        let message = "Beklenmeyen bir hata oluştu.";
        try {
          const data = await response.json();
          if (data && data.error) message = data.error;
        } catch {
          message = response.statusText || message;
        }
        throw new Error(message);
      }
      return response;
    }

    function normalizeEntry(entry) {
      let platformsRaw = entry.platforms;
      if (typeof platformsRaw === "string") {
        try {
          platformsRaw = JSON.parse(platformsRaw);
        } catch {
          platformsRaw = [];
        }
      }
      if (!Array.isArray(platformsRaw)) platformsRaw = [];

      const normalizedSource = (entry.source || "manual").toLowerCase() === "excel"
        ? "excel"
        : entry.source || "manual";

      return {
        id: entry.id,
        user_id: entry.user_id,
        date: entry.date,
        time: entry.time || "",
        text: entry.text || "",
        files: entry.files || "",
        communication: entry.communication || "",
        communication_type: entry.communication_type || entry.communicationType || "",
        status: entry.status || "",
        platforms: platformsRaw,
        source: normalizedSource
      };
    }

    function sortAndStore(dateKey, items) {
      const sorted = sortItemsByTime(items);
      entriesByDate.set(dateKey, sorted);
    }

    function upsertEntry(entry) {
      const normalized = normalizeEntry(entry);
      if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
        return;
      }
      entriesById.set(normalized.id, normalized);
      const list = entriesByDate.get(normalized.date) || [];
      const idx = list.findIndex((it) => it.id === normalized.id);
      if (idx === -1) {
        list.push(normalized);
      } else {
        list[idx] = normalized;
      }
      sortAndStore(normalized.date, list);
    }

    function rebuildEntriesCache(rows) {
      entriesById = new Map();
      entriesByDate = new Map();
      rows.forEach((row) => {
        const normalized = normalizeEntry(row);
        if (normalized.source === "excel" && (!normalized.platforms || !normalized.platforms.length)) {
          return;
        }
        entriesById.set(normalized.id, normalized);
        const list = entriesByDate.get(normalized.date) || [];
        list.push(normalized);
        entriesByDate.set(normalized.date, list);
      });
      entriesByDate.forEach((items, key) => {
        sortAndStore(key, items);
      });
    }

    function removeEntryFromCache(entryId) {
      const existing = entriesById.get(entryId);
      if (!existing) return;
      entriesById.delete(entryId);
      const arr = entriesByDate.get(existing.date) || [];
      const filtered = arr.filter((it) => it.id !== entryId);
      if (filtered.length) {
        entriesByDate.set(existing.date, filtered);
      } else {
        entriesByDate.delete(existing.date);
      }
    }

    function isViewingOwnData() {
      if (!currentUser || currentUser.role !== "admin") return true;
      return (
        adminSelectedUserId === null ||
        adminSelectedUserId === currentUser.id
      );
    }

    function updateEditingPermissions() {
      const canEdit = Boolean(authToken) && isViewingOwnData();
      toggleFormBtn.disabled = !canEdit;
      saveBtn.disabled = !canEdit;
      clearBtn.disabled = !canEdit;
      if (!canEdit) {
        deleteBtn.disabled = true;
        modalFormSection.style.display = "none";
        activeItemId = null;
        clearFormOnly();
      } else {
        deleteBtn.disabled = !activeItemId;
      }
    }

    async function loadEntriesFromServer(targetUserId = null, label = "") {
      const query = targetUserId ? `?userId=${targetUserId}` : "";
      const response = await apiFetch(`/calendar${query}`);
      const data = await response.json();
      rebuildEntriesCache(data);
      activeItemId = null;
      modalFormSection.style.display = "none";
      clearFormOnly();
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
      if (selectedDateKey) {
        currentDayItems = loadDayData(selectedDateKey).items;
        renderModalSummaryList();
      }
      if (currentUser && currentUser.role === "admin") {
        if (targetUserId && targetUserId !== currentUser.id) {
          adminViewInfo.style.display = "";
          adminViewInfo.textContent = label
            ? `Şu anda ${label} kullanıcısının takvimi görüntüleniyor.`
            : `Şu anda #${targetUserId} numaralı kullanıcının takvimi görüntüleniyor.`;
        } else {
          adminViewInfo.style.display = "none";
          adminSelectedUserId = null;
        }
      }
      updateAuthUI();
    }

    async function loadAdminUsers() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminUserList.innerHTML = "<p class=\"small\">Yükleniyor...</p>";
      try {
        const response = await apiFetch("/users");
        const data = await response.json();
        renderAdminUsers(data);
      } catch (err) {
        adminUserList.innerHTML = `<p class="small" style="color:#dc2626;">${err.message}</p>`;
      }
    }

    function createBadge(text, type = "") {
      const span = document.createElement("span");
      span.className = "badge";
      if (type) span.classList.add(type);
      span.textContent = text;
      return span;
    }

    function renderAdminUsers(users) {
      adminUserList.innerHTML = "";
      if (!users.length) {
        const empty = document.createElement("p");
        empty.className = "small";
        empty.textContent = "Kayıt bulunamadı.";
        adminUserList.appendChild(empty);
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("div");
        row.className = "admin-user-row";
        const selected = adminSelectedUserId === null
          ? currentUser && user.id === currentUser.id
          : adminSelectedUserId === user.id;
        if (selected) row.classList.add("selected");

        const emailDiv = document.createElement("div");
        emailDiv.textContent = user.email;

        const roleDiv = document.createElement("div");
        roleDiv.appendChild(
          createBadge(user.role === "admin" ? "Admin" : "Kullanıcı", "info")
        );

        const statusDiv = document.createElement("div");
        statusDiv.style.display = "flex";
        statusDiv.style.gap = "8px";
        const statusBadge = createBadge(
          user.approved ? "Onaylı" : "Onay bekliyor",
          user.approved ? "success" : "warning"
        );
        const countBadge = createBadge(`${user.entryCount} kayıt`, "info");
        statusDiv.appendChild(statusBadge);
        statusDiv.appendChild(countBadge);

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "admin-user-actions";

        if (user.approved) {
          const viewBtn = document.createElement("button");
          viewBtn.textContent = "Takvimi göster";
          viewBtn.addEventListener("click", async () => {
            const viewingOwn = currentUser && user.id === currentUser.id;
            adminSelectedUserId = viewingOwn ? null : user.id;
            try {
              await loadEntriesFromServer(
                adminSelectedUserId ? adminSelectedUserId : null,
                viewingOwn ? "" : user.email
              );
              closeAdminOverlay();
            } catch (error) {
              alert(error.message);
            }
          });
          actionsDiv.appendChild(viewBtn);
        } else {
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "Onayla";
          approveBtn.addEventListener("click", async () => {
            approveBtn.disabled = true;
            try {
              await approveUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              approveBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(approveBtn);

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "Reddet";
          rejectBtn.classList.add("secondary-btn");
          rejectBtn.addEventListener("click", async () => {
            const confirmed = confirm(
              `${user.email} hesabını reddetmek istediğine emin misin?`
            );
            if (!confirmed) return;
            rejectBtn.disabled = true;
            try {
              await rejectUser(user.id);
            } catch (error) {
              alert(error.message);
            } finally {
              rejectBtn.disabled = false;
            }
          });
          actionsDiv.appendChild(rejectBtn);
        }

        row.appendChild(emailDiv);
        row.appendChild(roleDiv);
        row.appendChild(statusDiv);
        row.appendChild(actionsDiv);
        adminUserList.appendChild(row);
      });
    }

    async function approveUser(userId) {
      await apiFetch(`/users/${userId}/approve`, { method: "POST" });
      await loadAdminUsers();
    }

    async function rejectUser(userId) {
      await apiFetch(`/users/${userId}/reject`, { method: "POST" });
      if (adminSelectedUserId === userId) {
        adminSelectedUserId = null;
        adminViewInfo.style.display = "none";
        await loadEntriesFromServer();
      }
      await loadAdminUsers();
    }

    function openAdminOverlay() {
      if (!currentUser || currentUser.role !== "admin") return;
      adminOverlay.classList.add("active");
      loadAdminUsers();
    }

    function closeAdminOverlay() {
      adminOverlay.classList.remove("active");
    }

    async function createEntry(payload) {
      const response = await apiFetch("/calendar", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function updateEntry(id, payload) {
      const response = await apiFetch(`/calendar/${id}`, {
        method: "PUT",
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      upsertEntry(data);
      return data;
    }

    async function deleteEntry(id) {
      await apiFetch(`/calendar/${id}`, { method: "DELETE" });
      removeEntryFromCache(id);
    }

    /* Tema */
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "Açık mod";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "Koyu mod";
      }
    }
    function initTheme() {
      const stored = localStorage.getItem("contentCalendar_theme");
      applyTheme(stored === "dark" ? "dark" : "light");
    }
    themeToggleBtn.addEventListener("click", () => {
      const next = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(next);
      localStorage.setItem("contentCalendar_theme", next);
      if (viewReports.style.display !== "none") renderReports();
    });

    /* Yardımcılar */
    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function formatHumanDate(date) {
      const day = String(date.getDate());
      const monthName = monthNames[date.getMonth()];
      const year = date.getFullYear();
      return day + " " + monthName + " " + year;
    }
    function minutesFromTime(t) {
      if (!t) return 24 * 60 + 1; // saat yoksa en sona
      const parts = t.split(":");
      if (parts.length !== 2) return 24 * 60 + 1;
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (Number.isNaN(h) || Number.isNaN(m)) return 24 * 60 + 1;
      return h * 60 + m;
    }
    function sortItemsByTime(items) {
      return items.slice().sort((a, b) => minutesFromTime(a.time) - minutesFromTime(b.time));
    }
    function isDarkMode() {
      return document.body.classList.contains("dark");
    }

    /* Veri okuma / yazma */
    function loadDayData(dateKey) {
      const items = entriesByDate.get(dateKey) || [];
    const clones = items.map((item) => ({
      id: item.id,
      files: item.files || "",
      text: item.text || "",
      time: item.time || "",
      platforms: Array.isArray(item.platforms) ? [...item.platforms] : [],
      communication: item.communication || "",
      communicationType: item.communication_type || item.communicationType || "",
      status: item.status || "",
      source: item.source || "manual"
    }));
      return { items: sortItemsByTime(clones) };
    }

    // Bir içerik için 10 karakterlik metin + platformlar + saat
    function makeItemSummary(item) {
      const textSource = item.text || item.files || "";
      let snippet = textSource ? textSource.slice(0, 10) : "";
      if (textSource.length > 10) snippet += "...";
      if (!snippet) snippet = "İçerik";
      const platforms =
        item.platforms && item.platforms.length
          ? item.platforms.join(", ")
          : "Platform seçilmedi";
      const time = item.time || "";
      return { snippet, platforms, time };
    }

    /* Sağ panel: Gün Detayı / Takvim Özeti */
    function updateScheduleList() {
      scheduleList.innerHTML = "";
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      let any = false;

      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentYear, currentMonth, day);
        const key = formatDateKey(dateObj);
        const dayData = loadDayData(key);
        const items = dayData.items || [];
        if (!items.length) continue;

        const sortedItems = sortItemsByTime(items);

        sortedItems.forEach((item) => {
          const hasContent =
            item.text || item.files || item.time || (item.platforms && item.platforms.length);
          if (!hasContent) return;
          any = true;

          const { snippet, platforms, time } = makeItemSummary(item);

          const row = document.createElement("div");
          row.className = "schedule-item";
          if (item.source === "excel") {
            row.classList.add("from-excel");
          }

          const dateEl = document.createElement("div");
          dateEl.className = "schedule-date";
          dateEl.textContent = formatHumanDate(dateObj);
          row.appendChild(dateEl);

          const textEl = document.createElement("div");
          textEl.className = "schedule-text";
          const timePart = time ? time + " - " : "";
          textEl.textContent = timePart + snippet + " - " + platforms;
          if (item.source === "excel") {
            const tag = document.createElement("span");
            tag.className = "excel-chip";
            tag.textContent = "Excel";
            textEl.appendChild(document.createTextNode(" "));
            textEl.appendChild(tag);
          }
          row.appendChild(textEl);

          row.addEventListener("click", () => {
            openModalForDate(dateObj, key, item.id);
          });

          scheduleList.appendChild(row);
        });
      }

      if (!any) {
        const empty = document.createElement("p");
        empty.className = "small";
        empty.textContent = "Bu ay için kayıtlı paylaşım yok.";
        scheduleList.appendChild(empty);
      }
    }

    /* Takvim */
    function renderCalendar() {
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const firstWeekday = (firstDay.getDay() + 6) % 7;
      const daysInMonth = lastDay.getDate();

      monthLabel.textContent = monthNames[currentMonth] + " " + currentYear;

      daysContainer.innerHTML = "";

      for (let i = 0; i < firstWeekday; i++) {
        const empty = document.createElement("div");
        daysContainer.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.className = "day";

        const numSpan = document.createElement("div");
        numSpan.className = "day-number";
        numSpan.textContent = day;
        cell.appendChild(numSpan);

        const dateObj = new Date(currentYear, currentMonth, day);
        const key = formatDateKey(dateObj);
        const dayData = loadDayData(key);
        const items = dayData.items || [];

        if (items.length) {
          cell.classList.add("has-data");
          const sortedItems = sortItemsByTime(items);
          sortedItems.slice(0, 3).forEach(item => {
            const { snippet, time } = makeItemSummary(item);
            const line = document.createElement("div");
            line.className = "day-summary";
            if (item.source === "excel") line.classList.add("excel");
            const timePart = time ? time + " " : "";
            line.textContent = timePart + snippet;
            if (item.source === "excel") {
              const tag = document.createElement("span");
              tag.className = "excel-chip";
              tag.textContent = "Excel";
              line.appendChild(document.createTextNode(" "));
              line.appendChild(tag);
            }
            cell.appendChild(line);
          });
        }

        cell.addEventListener("click", () => {
          openModalForDate(dateObj, key);
        });

        daysContainer.appendChild(cell);
      }

      updateScheduleList();
    }

    /* Modal içi liste */
    function renderModalSummaryList() {
      modalSummary.innerHTML = "";

      if (!currentDayItems.length) {
        deleteBtn.disabled = true;
        const empty = document.createElement("div");
        empty.className = "summary-empty";
        empty.textContent = "Bu gün için kayıtlı içerik yok.";
        modalSummary.appendChild(empty);
        return;
      }

      currentDayItems = sortItemsByTime(currentDayItems);
      deleteBtn.disabled = !activeItemId || !isViewingOwnData();

      currentDayItems.forEach((item, index) => {
        const wrap = document.createElement("div");
        wrap.className = "summary-item";
        if (item.id === activeItemId) wrap.classList.add("active");
        if (item.source === "excel") wrap.classList.add("excel");

        const { snippet, platforms, time } = makeItemSummary(item);

        const title = document.createElement("div");
        title.className = "summary-item-title";
        title.textContent = snippet || `İçerik ${index + 1}`;
        wrap.appendChild(title);

        const timeDiv = document.createElement("div");
        timeDiv.className = "summary-item-time";
        timeDiv.textContent = time ? "Saat: " + time : "Saat seçilmedi";
        wrap.appendChild(timeDiv);

        const platformsDiv = document.createElement("div");
        platformsDiv.className = "summary-item-platforms";
        platformsDiv.textContent = platforms;
        if (item.source === "excel") {
          const badge = document.createElement("span");
          badge.className = "summary-item-badge";
          badge.textContent = "Excel";
          platformsDiv.appendChild(document.createTextNode(" "));
          platformsDiv.appendChild(badge);
        }
        wrap.appendChild(platformsDiv);

        wrap.addEventListener("click", () => {
          activeItemId = item.id;
          filesInput.value = item.files || "";
          textInput.value = item.text || "";
          timeInput.value = item.time || "";
          platformInputs.forEach((cb) => {
            cb.checked = item.platforms
              ? item.platforms.includes(cb.value)
              : false;
          });
          modalFormSection.style.display = "";
          deleteBtn.disabled = !activeItemId || !isViewingOwnData();
          renderModalSummaryList();
        });

        modalSummary.appendChild(wrap);
      });
      updateEditingPermissions();
    }

    function clearFormOnly() {
      filesInput.value = "";
      textInput.value = "";
      timeInput.value = "";
      platformInputs.forEach((cb) => (cb.checked = false));
    }

    function openModalForDate(dateObj, key, initialItemId = null) {
      selectedDateKey = key;
      const dayData = loadDayData(key);
      currentDayItems = dayData.items || [];
      activeItemId = initialItemId;

      modalDateTitle.textContent = formatHumanDate(dateObj);

      clearFormOnly();
      modalFormSection.style.display = "none";
      deleteBtn.disabled = !activeItemId;

      if (activeItemId) {
        const item = currentDayItems.find((it) => it.id === activeItemId);
        if (item) {
          filesInput.value = item.files || "";
          textInput.value = item.text || "";
          timeInput.value = item.time || "";
          platformInputs.forEach((cb) => {
            cb.checked = item.platforms
              ? item.platforms.includes(cb.value)
              : false;
          });
          modalFormSection.style.display = "";
        } else {
          activeItemId = null;
        }
      }

      renderModalSummaryList();
      dayModal.style.display = "flex";
    }

    function closeModal() {
      dayModal.style.display = "none";
    }

    function normalizeToMidnight(date) {
      if (!date) return null;
      const normalized = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      normalized.setHours(0, 0, 0, 0);
      return normalized;
    }
    function formatDateInputValue(date) {
      if (!date) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + d;
    }
    function parseDateInput(value) {
      if (!value) return null;
      const parts = value.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (
        Number.isNaN(year) ||
        Number.isNaN(month) ||
        Number.isNaN(day)
      ) {
        return null;
      }
      const parsed = new Date(year, month - 1, day);
      if (
        parsed.getFullYear() !== year ||
        parsed.getMonth() !== month - 1 ||
        parsed.getDate() !== day
      ) {
        return null;
      }
      return normalizeToMidnight(parsed);
    }

    function clearReportOutputs() {
      reportTotal.textContent = "-";
      reportPlatforms.innerHTML = "";
      reportTimes.innerHTML = "";
      reportDays.textContent = "-";
      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }
      if (platformChartWrapper) platformChartWrapper.style.display = "none";
      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }
      if (timeChartWrapper) timeChartWrapper.style.display = "none";
    }

    /* İstatistik hesaplama: seçilen tarih aralığı için */
    function buildStatsForRange(rangeStartDate, rangeEndDate) {
      const startDate = normalizeToMidnight(rangeStartDate);
      const endDate = normalizeToMidnight(rangeEndDate);
    const platformsList = [
      "Instagram Post","Instagram Story","Instagram Reels","Instagram",
      "Facebook","X","Reddit","Discord",
      "YouTube","LinkedIn","TikTok","Telegram","Medium"
    ];

      let total = 0;
      const platformCounts = {};
      let early = 0, mid = 0, late = 0, noTime = 0;
      let daysWithContent = 0;

      platformsList.forEach((p) => (platformCounts[p] = 0));

      if (!startDate || !endDate || startDate > endDate) {
        return {
          total,
          platformCounts,
          early,
          mid,
          late,
          noTime,
          daysWithContent,
          startDate,
          endDate
        };
      }

      const cursor = new Date(startDate);

      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const items = loadDayData(key).items;
        if (!items.length) {
          cursor.setDate(cursor.getDate() + 1);
          cursor.setHours(0, 0, 0, 0);
          continue;
        }

        let dayHasContent = false;

        items.forEach((item) => {
          const hasContent =
            item.text || item.files || item.time || (item.platforms && item.platforms.length);
          if (!hasContent) return;

          dayHasContent = true;
          total++;

          (item.platforms || []).forEach((p) => {
            if (!platformCounts[p]) platformCounts[p] = 0;
            platformCounts[p]++;
          });

          if (!item.time) {
            noTime++;
          } else {
            const mins = minutesFromTime(item.time);
            if (mins < 12 * 60) early++;
            else if (mins < 18 * 60) mid++;
            else late++;
          }
        });

        if (dayHasContent) daysWithContent++;
        cursor.setDate(cursor.getDate() + 1);
        cursor.setHours(0, 0, 0, 0);
      }

      return {
        total,
        platformCounts,
        early,
        mid,
        late,
        noTime,
        daysWithContent,
        startDate,
        endDate
      };
    }

    function setRangeInputs(startDate, endDate) {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      reportRangeStartInput.value = formatDateInputValue(startDate);
      reportRangeEndInput.value = formatDateInputValue(endDate);
    }

    function ensureRangeInputsInitialized() {
      if (!reportRangeStartInput || !reportRangeEndInput) return;
      const currentStart = parseDateInput(reportRangeStartInput.value);
      const currentEnd = parseDateInput(reportRangeEndInput.value);
      if (currentStart && currentEnd) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - 6);
      setRangeInputs(start, end);
    }

    function applyQuickRange(days) {
      if (!Number.isFinite(days) || days < 1) return;
      const end = normalizeToMidnight(new Date());
      const start = new Date(end);
      start.setDate(start.getDate() - (days - 1));
      setRangeInputs(start, end);
      if (reportMode === "range") renderReports();
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Dosya okunurken hata oluştu."));
        reader.readAsDataURL(file);
      });
    }

    function updateRangeControlsVisibility() {
      if (!reportRangeInputs || !quickRangeButtons) return;
      if (reportMode === "range") {
        reportRangeInputs.style.display = "flex";
        quickRangeButtons.style.display = "flex";
      } else {
        reportRangeInputs.style.display = "none";
        quickRangeButtons.style.display = "none";
      }
    }

    function renderReports() {
      let rangeStart;
      let rangeEnd;

      if (reportMode === "range") {
        const parsedStart = parseDateInput(reportRangeStartInput ? reportRangeStartInput.value : "");
        const parsedEnd = parseDateInput(reportRangeEndInput ? reportRangeEndInput.value : "");

        if (!parsedStart || !parsedEnd) {
          reportMonthLabel.textContent = "Lütfen geçerli bir tarih aralığı seç.";
          clearReportOutputs();
          const li = document.createElement("li");
          li.textContent = "Geçerli bir tarih aralığı seç.";
          reportPlatforms.appendChild(li);
          return;
        }

        if (parsedStart > parsedEnd) {
          rangeStart = parsedEnd;
          rangeEnd = parsedStart;
          if (reportRangeStartInput && reportRangeEndInput) {
            reportRangeStartInput.value = formatDateInputValue(rangeStart);
            reportRangeEndInput.value = formatDateInputValue(rangeEnd);
          }
        } else {
          rangeStart = parsedStart;
          rangeEnd = parsedEnd;
        }

        reportMonthLabel.textContent =
          formatHumanDate(rangeStart) + " - " + formatHumanDate(rangeEnd) + " arası özet";
      } else {
        rangeStart = normalizeToMidnight(new Date(currentYear, currentMonth, 1));
        rangeEnd = normalizeToMidnight(new Date(currentYear, currentMonth + 1, 0));
        reportMonthLabel.textContent =
          monthNames[currentMonth] + " " + currentYear + " için aylık özet";
      }

      const stats = buildStatsForRange(rangeStart, rangeEnd);

      reportTotal.textContent = stats.total + " planlanmış içerik";

      reportPlatforms.innerHTML = "";
      const entries = Object.entries(stats.platformCounts)
        .filter(([, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
      if (!entries.length) {
        const li = document.createElement("li");
        li.textContent = "Bu aralık için platform seçilmiş içerik yok.";
        reportPlatforms.appendChild(li);
      } else {
        entries.forEach(([platform, count]) => {
          const li = document.createElement("li");
          li.textContent = platform + ": " + count;
          reportPlatforms.appendChild(li);
        });
      }
      renderPlatformChart(entries);

      reportTimes.innerHTML = "";
      const slots = [
        ["Sabah (06:00–11:59)", stats.early],
        ["Öğlen / Öğleden sonra (12:00–17:59)", stats.mid],
        ["Akşam (18:00–23:59)", stats.late],
        ["Saat belirtilmemiş", stats.noTime]
      ];
      slots.forEach(([label, count]) => {
        const li = document.createElement("li");
        li.textContent = label + ": " + count;
        reportTimes.appendChild(li);
      });
      renderTimeChart(stats);

      reportDays.textContent =
        stats.daysWithContent + " günde en az bir içerik planlanmış.";
    }
    function renderPlatformChart(entries) {
      if (!platformChartWrapper || !platformChartCanvas || typeof Chart === "undefined") return;

      if (platformChartInstance) {
        platformChartInstance.destroy();
        platformChartInstance = null;
      }

      const labels = entries.map(([label]) => label);
      const data = entries.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        platformChartWrapper.style.display = "none";
        return;
      }

      const axisColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const gridColor = isDarkMode() ? "rgba(148, 163, 184, 0.25)" : "rgba(148, 163, 184, 0.35)";
      const barColor = isDarkMode() ? "#60a5fa" : "#2563eb";

      platformChartWrapper.style.display = "block";
      platformChartInstance = new Chart(platformChartCanvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "İçerik sayısı",
            data,
            backgroundColor: data.map(() => barColor),
            borderRadius: 6,
            maxBarThickness: 48
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: {
                color: axisColor,
                font: { size: 11 }
              },
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: axisColor
              },
              grid: {
                color: gridColor
              }
            }
          }
        }
      });
    }
    function renderTimeChart(stats) {
      if (!timeChartWrapper || !timeChartCanvas || typeof Chart === "undefined") return;

      if (timeChartInstance) {
        timeChartInstance.destroy();
        timeChartInstance = null;
      }

      const labels = [
        "Sabah (06:00–11:59)",
        "Öğlen / Öğleden sonra (12:00–17:59)",
        "Akşam (18:00–23:59)",
        "Saat belirtilmemiş"
      ];
      const data = [stats.early, stats.mid, stats.late, stats.noTime];
      const total = data.reduce((sum, val) => sum + val, 0);

      if (!total) {
        timeChartWrapper.style.display = "none";
        return;
      }

      const legendColor = isDarkMode() ? "#e5e7eb" : "#1f2937";
      const colors = isDarkMode()
        ? ["#38bdf8", "#facc15", "#f472b6", "#94a3b8"]
        : ["#0ea5e9", "#f59e0b", "#ec4899", "#9ca3af"];

      timeChartWrapper.style.display = "block";
      timeChartInstance = new Chart(timeChartCanvas, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "45%",
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: legendColor,
                boxWidth: 12,
                padding: 12,
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    /* Sekmeler */
    tabCalendar.addEventListener("click", () => {
      tabCalendar.classList.add("active");
      tabReports.classList.remove("active");
      viewCalendar.style.display = "";
      viewReports.style.display = "none";
    });

    tabReports.addEventListener("click", () => {
      tabReports.classList.add("active");
      tabCalendar.classList.remove("active");
      viewCalendar.style.display = "none";
      viewReports.style.display = "";
      renderReports();
    });

    /* Rapor görünüm modları */
    reportModeRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        if (!radio.checked) return;
        reportMode = radio.value;
        updateRangeControlsVisibility();
        if (reportMode === "range") {
          ensureRangeInputsInitialized();
        }
        renderReports();
      });
    });

    if (reportRangeStartInput) {
      reportRangeStartInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    if (reportRangeEndInput) {
      reportRangeEndInput.addEventListener("change", () => {
        if (reportMode === "range") renderReports();
      });
    }
    quickRangeButtonsList.forEach((btn) => {
      btn.addEventListener("click", () => {
        const days = Number(btn.dataset.range);
        applyQuickRange(days);
      });
    });

    updateRangeControlsVisibility();

    loginForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;
      if (!email || !password) {
        loginError.textContent = "E-posta ve şifre gerekli.";
        return;
      }
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginSubmitBtn.disabled = true;
      try {
        const endpoint = isRegisterMode ? "/auth/register" : "/auth/login";
        const response = await fetch(API_BASE + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
          let message = isRegisterMode ? "Kayıt yapılamadı." : "Giriş yapılamadı.";
          try {
            const data = await response.json();
            if (data && data.error) message = data.error;
          } catch { /* ignore */ }
          throw new Error(message);
        }
        if (isRegisterMode) {
          const data = await response.json();
          setAuthMode(false);
          loginError.classList.add("success");
          loginError.textContent = data.approved
            ? "Admin hesabı oluşturuldu. Şimdi giriş yapabilirsiniz."
            : "Kayıt başarılı, admin onayından sonra giriş yapabilirsiniz.";
          loginSubmitBtn.disabled = false;
          return;
        }
        const data = await response.json();
        setAuthToken(data.token);
        setCurrentUser(data.user);
        adminSelectedUserId = null;
        await loadEntriesFromServer();
        hideLoginOverlay();
      } catch (err) {
        loginError.classList.remove("success");
        loginError.textContent = err.message || (isRegisterMode ? "Kayıt yapılamadı." : "Giriş yapılamadı.");
      } finally {
        loginSubmitBtn.disabled = false;
      }
    });

    switchAuthModeBtn.addEventListener("click", () => {
      setAuthMode(!isRegisterMode);
      loginError.textContent = "";
      loginError.classList.remove("success");
      loginPasswordInput.value = "";
      setTimeout(() => loginEmailInput.focus(), 10);
    });

    if (adminPanelBtn) {
      adminPanelBtn.addEventListener("click", () => {
        openAdminOverlay();
      });
    }
    if (adminCloseBtn) {
      adminCloseBtn.addEventListener("click", () => {
        closeAdminOverlay();
      });
    }
    adminOverlay.addEventListener("click", (event) => {
      if (event.target === adminOverlay) {
        closeAdminOverlay();
      }
    });
    if (adminViewSelfBtn) {
      adminViewSelfBtn.addEventListener("click", async () => {
        if (!currentUser) {
          closeAdminOverlay();
          return;
        }
        adminSelectedUserId = null;
        try {
          await loadEntriesFromServer();
        } catch (error) {
          alert(error.message);
        }
        closeAdminOverlay();
      });
    }

    if (excelUploadBtn && excelFileInput) {
      excelUploadBtn.addEventListener("click", () => {
        if (!authToken) {
          showLoginOverlay();
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yüklemek için admin yetkisi gerekir.");
          return;
        }
        if (!isViewingOwnData()) {
          alert("Başka bir kullanıcının takvimini incelerken dosya yükleyemezsin.");
          return;
        }
        excelFileInput.value = "";
        excelFileInput.click();
      });

      excelFileInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        if (!/\.(xlsx|xls|csv)$/i.test(file.name)) {
          alert("Lütfen .xlsx, .xls veya .csv uzantılı bir dosya seç.");
          excelFileInput.value = "";
          return;
        }
        if (!currentUser || currentUser.role !== "admin") {
          alert("Excel yüklemek için admin yetkisi gerekir.");
          excelFileInput.value = "";
          return;
        }

        const previousText = excelUploadBtn.textContent;
        excelUploadBtn.disabled = true;
        excelUploadBtn.textContent = "Yükleniyor...";

        try {
          const dataUrl = await readFileAsDataURL(file);
          const base64Data = String(dataUrl).split(",")[1];
          if (!base64Data) {
            throw new Error("Dosya okunamadı.");
          }
          const response = await apiFetch("/import/upload", {
            method: "POST",
            body: JSON.stringify({ filename: file.name, data: base64Data })
          });
          const result = await response.json();
          await loadEntriesFromServer();
          let message = `${result.imported} kayıt eklendi.`;
          if (result.skippedUnmapped) {
            message += ` ${result.skippedUnmapped} satır eşleşmeyen mecra nedeniyle atlandı.`;
          }
          if (result.unmappedMecra && result.unmappedMecra.length) {
            message += ` Eşleşmeyen mecralar: ${result.unmappedMecra.join(", ")}.`;
          }
          alert(`İçe aktarma tamamlandı. ${message}`);
        } catch (err) {
          alert(err.message || "Dosya yüklenemedi.");
        } finally {
          excelUploadBtn.disabled = false;
          excelUploadBtn.textContent = previousText || excelUploadDefaultText;
          excelFileInput.value = "";
        }
      });
    }

    function ensureResetPermissions() {
      if (!authToken) {
        showLoginOverlay();
        return false;
      }
      if (!currentUser || currentUser.role !== "admin") {
        alert("Takvimi sıfırlamak için admin yetkisi gerekir.");
        return false;
      }
      if (!isViewingOwnData()) {
        alert("Başka bir kullanıcının takvimini incelerken sıfırlama yapamazsın.");
        return false;
      }
      return true;
    }

    function hideResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "none";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
        const scope = btn.dataset.scope;
        if (scope && resetScopeLabels[scope]) {
          btn.textContent = resetScopeLabels[scope];
        }
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
    }

    function showResetOptions() {
      if (!resetOptions) return;
      resetOptions.style.display = "flex";
      resetOptionButtons.forEach((btn) => {
        btn.disabled = false;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = false;
      }
      if (resetOptionButtons.length) {
        setTimeout(() => resetOptionButtons[0].focus(), 0);
      }
    }

    async function handleScopedReset(scope, triggerButton) {
      if (!scope || !resetConfirmMessages[scope]) return;
      if (!ensureResetPermissions()) {
        hideResetOptions();
        return;
      }
      const confirmed = confirm(resetConfirmMessages[scope]);
      if (!confirmed) return;

      const previousResetText = resetEntriesBtn ? resetEntriesBtn.textContent : "";
      const previousTriggerText = triggerButton ? triggerButton.textContent : "";

      if (resetEntriesBtn) {
        resetEntriesBtn.disabled = true;
        resetEntriesBtn.textContent = "Sıfırlanıyor...";
      }
      resetOptionButtons.forEach((btn) => {
        btn.disabled = true;
      });
      if (resetCancelBtn) {
        resetCancelBtn.disabled = true;
      }
      if (triggerButton) {
        triggerButton.textContent = "Sıfırlanıyor...";
      }

      try {
        const response = await apiFetch("/calendar/reset", {
          method: "DELETE",
          body: JSON.stringify({ scope })
        });
        await response.json();
        await loadEntriesFromServer();
        alert(resetSuccessMessages[scope] || "Kayıtlar başarıyla silindi.");
      } catch (err) {
        alert(err.message || "Takvim sıfırlanamadı.");
      } finally {
        if (resetEntriesBtn) {
          resetEntriesBtn.disabled = false;
          resetEntriesBtn.textContent = previousResetText || "Sıfırla";
        }
        if (triggerButton && previousTriggerText) {
          triggerButton.textContent = previousTriggerText;
        }
        hideResetOptions();
      }
    }

    if (resetEntriesBtn) {
      resetEntriesBtn.addEventListener("click", () => {
        if (!ensureResetPermissions()) return;
        if (!resetOptions) return;
        const isHidden = getComputedStyle(resetOptions).display === "none";
        if (isHidden) {
          showResetOptions();
        } else {
          hideResetOptions();
        }
      });
    }

    resetOptionButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        handleScopedReset(btn.dataset.scope, btn);
      });
    });

    if (resetCancelBtn) {
      resetCancelBtn.addEventListener("click", () => {
        hideResetOptions();
      });
    }

    logoutBtn.addEventListener("click", () => {
      if (adminOverlay.classList.contains("active")) {
        closeAdminOverlay();
      }
      setCurrentUser(null);
      setAuthToken("");
      adminSelectedUserId = null;
      adminViewInfo.style.display = "none";
      entriesById = new Map();
      entriesByDate = new Map();
      selectedDateKey = null;
      currentDayItems = [];
      activeItemId = null;
      clearFormOnly();
      closeModal();
      modalFormSection.style.display = "none";
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
      showLoginOverlay(false);
    });

    /* Olaylar ve init */
    async function init() {
      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth();
      ensureRangeInputsInitialized();
      renderCalendar();
      if (authToken) {
        try {
          const meResponse = await apiFetch("/auth/me");
          const meData = await meResponse.json();
          setCurrentUser(meData);
          adminSelectedUserId = null;
          await loadEntriesFromServer();
          hideLoginOverlay();
        } catch (err) {
          console.error(err);
          setAuthToken("");
          setCurrentUser(null);
          entriesById = new Map();
          entriesByDate = new Map();
          showLoginOverlay();
        }
      } else {
        setCurrentUser(null);
        updateAuthUI();
        showLoginOverlay();
      }
    }

    prevBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    nextBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
      if (viewReports.style.display !== "none") renderReports();
    });

    // Yeni içerik
  toggleFormBtn.addEventListener("click", () => {
      if (!selectedDateKey) return;
      if (!authToken) {
        alert("Paylaşım oluşturmak için önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      activeItemId = null;
      clearFormOnly();
      modalFormSection.style.display = "";
      deleteBtn.disabled = true;
      renderModalSummaryList();
    });

    async function handleSave() {
      if (!authToken) {
        alert("Lütfen önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      if (!selectedDateKey) {
        alert("Önce takvimden bir gün seç.");
        return;
      }

      const selectedPlatforms = [];
      platformInputs.forEach((cb) => {
        if (cb.checked) selectedPlatforms.push(cb.value);
      });

      const filesVal = filesInput.value.trim();
      const textVal = textInput.value.trim();
      const timeVal = timeInput.value;
      const anyContent = filesVal || textVal || timeVal || selectedPlatforms.length;

      if (!anyContent) {
        alert("Kaydedilecek bir içerik yok.");
        return;
      }

      const existing = activeItemId ? entriesById.get(activeItemId) : null;
      const payload = {
        date: selectedDateKey,
        time: timeVal,
        text: textVal,
        files: filesVal,
        platforms: selectedPlatforms,
        communication: existing ? existing.communication || "" : "",
        communicationType: existing
          ? existing.communication_type || existing.communicationType || ""
          : "",
        status: existing ? existing.status || "" : ""
      };

      saveBtn.disabled = true;
      try {
        if (activeItemId && entriesById.has(activeItemId)) {
          await updateEntry(activeItemId, payload);
        } else {
          const created = await createEntry(payload);
          activeItemId = created.id;
        }
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        activeItemId = null;
        clearFormOnly();
        modalFormSection.style.display = "none";
        renderModalSummaryList();
        deleteBtn.disabled = true;
      } catch (err) {
        console.error(err);
        alert(err.message || "Kaydedilirken bir hata oluştu.");
      } finally {
        saveBtn.disabled = false;
      }
    }

    function handleClear() {
      clearFormOnly();
    }

    async function handleDelete() {
      if (!authToken) {
        alert("Lütfen önce giriş yap.");
        showLoginOverlay();
        return;
      }
      if (!isViewingOwnData()) {
        alert("Diğer kullanıcıların takviminde değişiklik yapamazsın.");
        return;
      }
      if (!selectedDateKey || !activeItemId) return;

      const confirmed = confirm("Bu paylaşımı silmek istediğine emin misin?");
      if (!confirmed) return;

      deleteBtn.disabled = true;
      try {
        await deleteEntry(activeItemId);
        activeItemId = null;
        clearFormOnly();
        modalFormSection.style.display = "none";
        currentDayItems = loadDayData(selectedDateKey).items;
        renderCalendar();
        if (viewReports.style.display !== "none") renderReports();
        renderModalSummaryList();
      } catch (err) {
        console.error(err);
        deleteBtn.disabled = false;
        alert(err.message || "Kayıt silinirken bir hata oluştu.");
      }
    }

    saveBtn.addEventListener("click", () => {
      handleSave();
    });
    clearBtn.addEventListener("click", handleClear);
    deleteBtn.addEventListener("click", () => {
      handleDelete();
    });

    modalCloseBtn.addEventListener("click", closeModal);
    dayModal.addEventListener("click", (e) => {
      if (e.target === dayModal) closeModal();
    });

    initTheme();
    init();
  </script>
</div>
</body>
</html>
